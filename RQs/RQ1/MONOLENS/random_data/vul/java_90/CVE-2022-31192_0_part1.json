{
    "cve_id": "CVE-2022-31192",
    "cwe_ids": [
        "CWE-601",
        "CWE-79"
    ],
    "cvss_vector": "CVSS:3.1/AV:N/AC:L/PR:N/UI:R/S:C/C:L/I:L/A:N",
    "cvss_is_v3": true,
    "repo_name": "DSpace",
    "commit_msg": "[DS-4383] Request Item Servlet escape HTML",
    "commit_hash": "28eb8158210d41168a62ed5f9e044f754513bc37",
    "git_url": "https://github.com/DSpace/DSpace/commit/28eb8158210d41168a62ed5f9e044f754513bc37",
    "file_path": "dspace-jspui/src/main/java/org/dspace/app/webui/servlet/RequestItemServlet.java",
    "func_name": "processForm",
    "func_before": "private void processForm (Context context,\n        HttpServletRequest request,\n        HttpServletResponse response)\n        throws ServletException, IOException, SQLException, AuthorizeException\n    {\n    \tboolean showRequestCopy = false;\n\t\tif (\"all\".equalsIgnoreCase(ConfigurationManager.getProperty(\"request.item.type\")) || \n\t\t\t\t(\"logged\".equalsIgnoreCase(ConfigurationManager.getProperty(\"request.item.type\")) &&\n\t\t\t\t\t\tcontext.getCurrentUser() != null))\n\t\t{\n\t\t\tshowRequestCopy = true;\n\t\t}\n\t\t\n\t\tif (!showRequestCopy)\n\t\t{\n\t\t\tthrow new AuthorizeException(\"The request copy feature is disabled\");\n\t\t}\n\t\t\n        // handle\n        String handle = request.getParameter(\"handle\");\n        \n        String bitstream_id=request.getParameter(\"bitstream-id\");\n        \n        // Title\n        String title = null;\n        Item item = null;\n        if (StringUtils.isNotBlank(handle))\n        {\n            item = (Item) HandleManager.resolveToObject(context, handle);\n            \n        }\n        if (item == null)\n        {   \n        \tJSPManager.showInvalidIDError(request, response, handle, -1);\n        }\n        Metadatum[] titleDC = item.getDC(\"title\", null, Item.ANY);\n        if (titleDC != null || titleDC.length > 0)\n        {\n            title = titleDC[0].value;\n        }\n        else\n\t\t{\n\t\t\ttitle = I18nUtil.getMessage(\"jsp.general.untitled\", context);\n\t\t}\n          \n        // User email from context\n        String requesterEmail = request.getParameter(\"email\");\n        EPerson currentUser = context.getCurrentUser();\n        String userName = null;\n        \n        if (currentUser != null)\n        {\n            requesterEmail = currentUser.getEmail();\n            userName = currentUser.getFullName();\n        }\n        \n        if (request.getParameter(\"submit\") != null)\n        {\n            String reqname = request.getParameter(\"reqname\");\n            String coment = request.getParameter(\"coment\");\n            if (coment == null || coment.equals(\"\"))\n                coment = \"\";\n            boolean allfiles = \"true\".equals(request.getParameter(\"allfiles\"));\n            \n            // Check all data is there\n            if (requesterEmail == null || requesterEmail.equals(\"\") ||\n                reqname == null || reqname.equals(\"\")) \n            {\n                request.setAttribute(\"handle\",handle);\n                request.setAttribute(\"bitstream-id\", bitstream_id);\n                request.setAttribute(\"reqname\", reqname);\n                request.setAttribute(\"email\", requesterEmail);\n                request.setAttribute(\"coment\", coment);\n                request.setAttribute(\"title\", title); \n                request.setAttribute(\"allfiles\", allfiles?\"true\":null); \n                \n                request.setAttribute(\"requestItem.problem\", new Boolean(true));\n                JSPManager.showJSP(request, response, \"/requestItem/request-form.jsp\");\n                return;\n            }\n\n            try\n            {\n                // All data is there, send the email\n\t\t\t\tEmail email = Email.getEmail(I18nUtil.getEmailFilename(\n\t\t\t\t\t\tcontext.getCurrentLocale(), \"request_item.author\"));\n\t\t\t\t\n\t\t\t\tRequestItemAuthor author = new DSpace()\n\t\t\t\t\t\t.getServiceManager()\n\t\t\t\t\t\t.getServiceByName(\n\t\t\t\t\t\t\t\tRequestItemAuthorExtractor.class.getName(),\n\t\t\t\t\t\t\t\tRequestItemAuthorExtractor.class)\n\t\t\t\t\t\t.getRequestItemAuthor(context, item);\n\t\t\t\t\n\t\t\t\tString authorEmail = author.getEmail();\n\t\t\t\tString authorName = author.getFullName();\n\t\t\t\t\n\t\t\t\temail.addRecipient(authorEmail);\n\n\t\t\t\temail.addArgument(reqname);\n\t\t\t\temail.addArgument(requesterEmail);\n\t\t\t\temail.addArgument(allfiles ? I18nUtil\n\t\t\t\t\t\t.getMessage(\"itemRequest.all\") : Bitstream.find(\n\t\t\t\t\t\tcontext, Integer.parseInt(bitstream_id)).getName());\n\t\t\t\temail.addArgument(HandleManager.getCanonicalForm(item\n\t\t\t\t\t\t.getHandle()));\n\t\t\t\temail.addArgument(title); // request item title\n\t\t\t\temail.addArgument(coment); // message\n\t\t\t\temail.addArgument(RequestItemManager.getLinkTokenEmail(context,\n\t\t\t\t\t\tbitstream_id, item.getID(), requesterEmail, reqname,\n\t\t\t\t\t\tallfiles));\n\t\t\t\t\n\t\t\t\temail.addArgument(authorName); // corresponding author name\n\t\t\t\temail.addArgument(authorEmail); // corresponding author email\n\t\t\t\temail.addArgument(ConfigurationManager\n\t\t\t\t\t\t.getProperty(\"dspace.name\"));\n\t\t\t\temail.addArgument(ConfigurationManager\n\t\t\t\t\t\t.getProperty(\"mail.helpdesk\"));\n\t\t\t\temail.setReplyTo(requesterEmail);\n\t\t\t\temail.send();\n\n                log.info(LogManager.getHeader(context,\n                    \"sent_email_requestItem\",\n                    \"submitter_id=\" + requesterEmail\n                        + \",bitstream_id=\"+bitstream_id\n                        + \",requestEmail=\"+requesterEmail));\n\n                request.setAttribute(\"handle\", handle);\n                JSPManager.showJSP(request, response,\n                    \"/requestItem/request-send.jsp\");\n            }\n            catch (MessagingException me)\n            {\n                log.warn(LogManager.getHeader(context,\n                    \"error_mailing_requestItem\",\n                    \"\"), me);\n               JSPManager.showInternalError(request, response);\n            }\n        }\n        else\n        {\n            // Display request copy form\n            log.info(LogManager.getHeader(context,\n                \"show_requestItem_form\",\n                \"problem=false\"));\n            request.setAttribute(\"handle\", handle);\n            request.setAttribute(\"bitstream-id\", bitstream_id);\n            request.setAttribute(\"email\", requesterEmail);\n            request.setAttribute(\"reqname\", userName);\n            request.setAttribute(\"title\", title);\n            request.setAttribute(\"allfiles\", \"true\");\n            JSPManager.showJSP(request, response, \"/requestItem/request-form.jsp\"); \n        }\n   }",
    "abstract_func_before": "private void processForm (Context VAR_0,\n        HttpServletRequest VAR_1,\n        HttpServletResponse VAR_2)\n        throws ServletException, IOException, SQLException, AuthorizeException\n    {\n    \tboolean VAR_3 = false;\n\t\tif (\"all\".equalsIgnoreCase(VAR_4.getProperty(\"request.item.type\")) || \n\t\t\t\t(\"logged\".equalsIgnoreCase(VAR_4.getProperty(\"request.item.type\")) &&\n\t\t\t\t\t\tVAR_0.getCurrentUser() != null))\n\t\t{\n\t\t\tVAR_3 = true;\n\t\t}\n\t\t\n\t\tif (!VAR_3)\n\t\t{\n\t\t\tthrow new AuthorizeException(\"The request copy feature is disabled\");\n\t\t}\n\t\t\n        /* COMMENT_0 */\n        String VAR_5 = VAR_1.getParameter(\"handle\");\n        \n        String VAR_6=VAR_1.getParameter(\"bitstream-id\");\n        \n        /* COMMENT_1 */\n        String VAR_7 = null;\n        Item VAR_8 = null;\n        if (VAR_9.isNotBlank(VAR_5))\n        {\n            VAR_8 = (Item) VAR_10.resolveToObject(VAR_0, VAR_5);\n            \n        }\n        if (VAR_8 == null)\n        {   \n        \tVAR_11.showInvalidIDError(VAR_1, VAR_2, VAR_5, -1);\n        }\n        Metadatum[] VAR_12 = VAR_8.getDC(\"title\", null, VAR_13.ANY);\n        if (VAR_12 != null || VAR_12.length > 0)\n        {\n            VAR_7 = VAR_12[0].value;\n        }\n        else\n\t\t{\n\t\t\tVAR_7 = VAR_14.getMessage(\"jsp.general.untitled\", VAR_0);\n\t\t}\n          \n        /* COMMENT_2 */\n        String VAR_15 = VAR_1.getParameter(\"email\");\n        EPerson VAR_16 = VAR_0.getCurrentUser();\n        String VAR_17 = null;\n        \n        if (VAR_16 != null)\n        {\n            VAR_15 = VAR_16.getEmail();\n            VAR_17 = VAR_16.getFullName();\n        }\n        \n        if (VAR_1.getParameter(\"submit\") != null)\n        {\n            String VAR_18 = VAR_1.getParameter(\"reqname\");\n            String VAR_19 = VAR_1.getParameter(\"coment\");\n            if (VAR_19 == null || VAR_19.equals(\"\"))\n                VAR_19 = \"\";\n            boolean VAR_20 = \"true\".equals(VAR_1.getParameter(\"allfiles\"));\n            \n            /* COMMENT_3 */\n            if (VAR_15 == null || VAR_15.equals(\"\") ||\n                VAR_18 == null || VAR_18.equals(\"\")) \n            {\n                VAR_1.setAttribute(\"handle\",VAR_5);\n                VAR_1.setAttribute(\"bitstream-id\", VAR_6);\n                VAR_1.setAttribute(\"reqname\", VAR_18);\n                VAR_1.setAttribute(\"email\", VAR_15);\n                VAR_1.setAttribute(\"coment\", VAR_19);\n                VAR_1.setAttribute(\"title\", VAR_7); \n                VAR_1.setAttribute(\"allfiles\", VAR_20?\"true\":null); \n                \n                VAR_1.setAttribute(\"requestItem.problem\", new Boolean(true));\n                VAR_11.showJSP(VAR_1, VAR_2, \"/requestItem/request-form.jsp\");\n                return;\n            }\n\n            try\n            {\n                /* COMMENT_4 */\n\t\t\t\tEmail VAR_21 = VAR_22.getEmail(VAR_14.getEmailFilename(\n\t\t\t\t\t\tVAR_0.getCurrentLocale(), \"request_item.author\"));\n\t\t\t\t\n\t\t\t\tRequestItemAuthor VAR_23 = new DSpace()\n\t\t\t\t\t\t.getServiceManager()\n\t\t\t\t\t\t.getServiceByName(\n\t\t\t\t\t\t\t\tRequestItemAuthorExtractor.class.getName(),\n\t\t\t\t\t\t\t\tRequestItemAuthorExtractor.class)\n\t\t\t\t\t\t.getRequestItemAuthor(VAR_0, VAR_8);\n\t\t\t\t\n\t\t\t\tString VAR_24 = VAR_23.getEmail();\n\t\t\t\tString VAR_25 = VAR_23.getFullName();\n\t\t\t\t\n\t\t\t\tVAR_21.addRecipient(VAR_24);\n\n\t\t\t\tVAR_21.addArgument(VAR_18);\n\t\t\t\tVAR_21.addArgument(VAR_15);\n\t\t\t\tVAR_21.addArgument(VAR_20 ? VAR_14\n\t\t\t\t\t\t.getMessage(\"itemRequest.all\") : VAR_26.find(\n\t\t\t\t\t\tVAR_0, VAR_27.parseInt(VAR_6)).getName());\n\t\t\t\tVAR_21.addArgument(VAR_10.getCanonicalForm(VAR_8\n\t\t\t\t\t\t.getHandle()));\n\t\t\t\tVAR_21.addArgument(VAR_7); /* COMMENT_5 */\n\t\t\t\tVAR_21.addArgument(VAR_19); /* COMMENT_6 */\n\t\t\t\tVAR_21.addArgument(VAR_28.getLinkTokenEmail(VAR_0,\n\t\t\t\t\t\tVAR_6, VAR_8.getID(), VAR_15, VAR_18,\n\t\t\t\t\t\tVAR_20));\n\t\t\t\t\n\t\t\t\tVAR_21.addArgument(VAR_25); /* COMMENT_7 */\n\t\t\t\tVAR_21.addArgument(VAR_24); /* COMMENT_8 */\n\t\t\t\tVAR_21.addArgument(VAR_4\n\t\t\t\t\t\t.getProperty(\"dspace.name\"));\n\t\t\t\tVAR_21.addArgument(VAR_4\n\t\t\t\t\t\t.getProperty(\"mail.helpdesk\"));\n\t\t\t\tVAR_21.setReplyTo(VAR_15);\n\t\t\t\tVAR_21.send();\n\n                VAR_29.info(VAR_30.getHeader(VAR_0,\n                    \"sent_email_requestItem\",\n                    \"submitter_id=\" + VAR_15\n                        + \",bitstream_id=\"+VAR_6\n                        + \",requestEmail=\"+VAR_15));\n\n                VAR_1.setAttribute(\"handle\", VAR_5);\n                VAR_11.showJSP(VAR_1, VAR_2,\n                    \"/requestItem/request-send.jsp\");\n            }\n            catch (MessagingException VAR_31)\n            {\n                VAR_29.warn(VAR_30.getHeader(VAR_0,\n                    \"error_mailing_requestItem\",\n                    \"\"), VAR_31);\n               VAR_11.showInternalError(VAR_1, VAR_2);\n            }\n        }\n        else\n        {\n            /* COMMENT_9 */\n            VAR_29.info(VAR_30.getHeader(VAR_0,\n                \"show_requestItem_form\",\n                \"problem=false\"));\n            VAR_1.setAttribute(\"handle\", VAR_5);\n            VAR_1.setAttribute(\"bitstream-id\", VAR_6);\n            VAR_1.setAttribute(\"email\", VAR_15);\n            VAR_1.setAttribute(\"reqname\", VAR_17);\n            VAR_1.setAttribute(\"title\", VAR_7);\n            VAR_1.setAttribute(\"allfiles\", \"true\");\n            VAR_11.showJSP(VAR_1, VAR_2, \"/requestItem/request-form.jsp\"); \n        }\n   }",
    "func_graph_path_before": "DSpace/28eb8158210d41168a62ed5f9e044f754513bc37/RequestItemServlet.java/vul/before/0.json",
    "func": "private void processForm (Context context,\n        HttpServletRequest request,\n        HttpServletResponse response)\n        throws ServletException, IOException, SQLException, AuthorizeException\n    {\n    \tboolean showRequestCopy = false;\n\t\tif (\"all\".equalsIgnoreCase(ConfigurationManager.getProperty(\"request.item.type\")) || \n\t\t\t\t(\"logged\".equalsIgnoreCase(ConfigurationManager.getProperty(\"request.item.type\")) &&\n\t\t\t\t\t\tcontext.getCurrentUser() != null))\n\t\t{\n\t\t\tshowRequestCopy = true;\n\t\t}\n\t\t\n\t\tif (!showRequestCopy)\n\t\t{\n\t\t\tthrow new AuthorizeException(\"The request copy feature is disabled\");\n\t\t}\n\t\t\n        // handle\n        String handle = request.getParameter(\"handle\");\n        \n        int  bitstream_id= UIUtil.getIntParameter(request, \"bitstream-id\");\n        \n        // Title\n        String title = null;\n        Item item = null;\n        if (StringUtils.isNotBlank(handle))\n        {\n            item = (Item) HandleManager.resolveToObject(context, handle);\n            \n        }\n        if (item == null)\n        {   \n        \tJSPManager.showInvalidIDError(request, response, handle, -1);\n        }\n        Metadatum[] titleDC = item.getDC(\"title\", null, Item.ANY);\n        if (titleDC != null || titleDC.length > 0)\n        {\n            title = titleDC[0].value;\n        }\n        else\n\t\t{\n\t\t\ttitle = I18nUtil.getMessage(\"jsp.general.untitled\", context);\n\t\t}\n          \n        // User email from context\n        String requesterEmail = StringEscapeUtils.escapeHtml4(request.getParameter(\"email\"));\n        EPerson currentUser = context.getCurrentUser();\n        String userName = null;\n        \n        if (currentUser != null)\n        {\n            requesterEmail = currentUser.getEmail();\n            userName = currentUser.getFullName();\n        }\n        \n        if (request.getParameter(\"submit\") != null)\n        {\n            String reqname = StringEscapeUtils.escapeHtml4(request.getParameter(\"reqname\"));\n            String coment = StringEscapeUtils.escapeHtml4(request.getParameter(\"coment\"));\n            if (coment == null || coment.equals(\"\"))\n                coment = \"\";\n            boolean allfiles = \"true\".equals(request.getParameter(\"allfiles\"));\n            \n            // Check all data is there\n            if (requesterEmail == null || requesterEmail.equals(\"\") ||\n                reqname == null || reqname.equals(\"\")) \n            {\n                request.setAttribute(\"handle\",handle);\n                request.setAttribute(\"bitstream-id\", bitstream_id);\n                request.setAttribute(\"reqname\", reqname);\n                request.setAttribute(\"email\", requesterEmail);\n                request.setAttribute(\"coment\", coment);\n                request.setAttribute(\"title\", title); \n                request.setAttribute(\"allfiles\", allfiles?\"true\":null); \n                \n                request.setAttribute(\"requestItem.problem\", new Boolean(true));\n                JSPManager.showJSP(request, response, \"/requestItem/request-form.jsp\");\n                return;\n            }\n\n            try\n            {\n                // All data is there, send the email\n\t\t\t\tEmail email = Email.getEmail(I18nUtil.getEmailFilename(\n\t\t\t\t\t\tcontext.getCurrentLocale(), \"request_item.author\"));\n\t\t\t\t\n\t\t\t\tRequestItemAuthor author = new DSpace()\n\t\t\t\t\t\t.getServiceManager()\n\t\t\t\t\t\t.getServiceByName(\n\t\t\t\t\t\t\t\tRequestItemAuthorExtractor.class.getName(),\n\t\t\t\t\t\t\t\tRequestItemAuthorExtractor.class)\n\t\t\t\t\t\t.getRequestItemAuthor(context, item);\n\t\t\t\t\n\t\t\t\tString authorEmail = author.getEmail();\n\t\t\t\tString authorName = author.getFullName();\n\t\t\t\t\n\t\t\t\temail.addRecipient(authorEmail);\n\n\t\t\t\temail.addArgument(reqname);\n\t\t\t\temail.addArgument(requesterEmail);\n\t\t\t\temail.addArgument(allfiles ? I18nUtil\n\t\t\t\t\t\t.getMessage(\"itemRequest.all\") : Bitstream.find(\n\t\t\t\t\t\tcontext, bitstream_id).getName());\n\t\t\t\temail.addArgument(HandleManager.getCanonicalForm(item\n\t\t\t\t\t\t.getHandle()));\n\t\t\t\temail.addArgument(title); // request item title\n\t\t\t\temail.addArgument(coment); // message\n\t\t\t\temail.addArgument(RequestItemManager.getLinkTokenEmail(context,\n\t\t\t\t\t\tbitstream_id, item.getID(), requesterEmail, reqname,\n\t\t\t\t\t\tallfiles));\n\t\t\t\t\n\t\t\t\temail.addArgument(authorName); // corresponding author name\n\t\t\t\temail.addArgument(authorEmail); // corresponding author email\n\t\t\t\temail.addArgument(ConfigurationManager\n\t\t\t\t\t\t.getProperty(\"dspace.name\"));\n\t\t\t\temail.addArgument(ConfigurationManager\n\t\t\t\t\t\t.getProperty(\"mail.helpdesk\"));\n\t\t\t\temail.setReplyTo(requesterEmail);\n\t\t\t\temail.send();\n\n                log.info(LogManager.getHeader(context,\n                    \"sent_email_requestItem\",\n                    \"submitter_id=\" + requesterEmail\n                        + \",bitstream_id=\"+bitstream_id\n                        + \",requestEmail=\"+requesterEmail));\n\n                request.setAttribute(\"handle\", handle);\n                JSPManager.showJSP(request, response,\n                    \"/requestItem/request-send.jsp\");\n            }\n            catch (MessagingException me)\n            {\n                log.warn(LogManager.getHeader(context,\n                    \"error_mailing_requestItem\",\n                    \"\"), me);\n               JSPManager.showInternalError(request, response);\n            }\n        }\n        else\n        {\n            // Display request copy form\n            log.info(LogManager.getHeader(context,\n                \"show_requestItem_form\",\n                \"problem=false\"));\n            request.setAttribute(\"handle\", handle);\n            request.setAttribute(\"bitstream-id\", bitstream_id);\n            request.setAttribute(\"email\", requesterEmail);\n            request.setAttribute(\"reqname\", userName);\n            request.setAttribute(\"title\", title);\n            request.setAttribute(\"allfiles\", \"true\");\n            JSPManager.showJSP(request, response, \"/requestItem/request-form.jsp\"); \n        }\n   }",
    "abstract_func": "private void processForm (Context VAR_0,\n        HttpServletRequest VAR_1,\n        HttpServletResponse VAR_2)\n        throws ServletException, IOException, SQLException, AuthorizeException\n    {\n    \tboolean VAR_3 = false;\n\t\tif (\"all\".equalsIgnoreCase(VAR_4.getProperty(\"request.item.type\")) || \n\t\t\t\t(\"logged\".equalsIgnoreCase(VAR_4.getProperty(\"request.item.type\")) &&\n\t\t\t\t\t\tVAR_0.getCurrentUser() != null))\n\t\t{\n\t\t\tVAR_3 = true;\n\t\t}\n\t\t\n\t\tif (!VAR_3)\n\t\t{\n\t\t\tthrow new AuthorizeException(\"The request copy feature is disabled\");\n\t\t}\n\t\t\n        /* COMMENT_0 */\n        String VAR_5 = VAR_1.getParameter(\"handle\");\n        \n        int  VAR_6= VAR_7.getIntParameter(VAR_1, \"bitstream-id\");\n        \n        /* COMMENT_1 */\n        String VAR_8 = null;\n        Item VAR_9 = null;\n        if (VAR_10.isNotBlank(VAR_5))\n        {\n            VAR_9 = (Item) VAR_11.resolveToObject(VAR_0, VAR_5);\n            \n        }\n        if (VAR_9 == null)\n        {   \n        \tVAR_12.showInvalidIDError(VAR_1, VAR_2, VAR_5, -1);\n        }\n        Metadatum[] VAR_13 = VAR_9.getDC(\"title\", null, VAR_14.ANY);\n        if (VAR_13 != null || VAR_13.length > 0)\n        {\n            VAR_8 = VAR_13[0].value;\n        }\n        else\n\t\t{\n\t\t\tVAR_8 = VAR_15.getMessage(\"jsp.general.untitled\", VAR_0);\n\t\t}\n          \n        /* COMMENT_2 */\n        String VAR_16 = VAR_17.escapeHtml4(VAR_1.getParameter(\"email\"));\n        EPerson VAR_18 = VAR_0.getCurrentUser();\n        String VAR_19 = null;\n        \n        if (VAR_18 != null)\n        {\n            VAR_16 = VAR_18.getEmail();\n            VAR_19 = VAR_18.getFullName();\n        }\n        \n        if (VAR_1.getParameter(\"submit\") != null)\n        {\n            String VAR_20 = VAR_17.escapeHtml4(VAR_1.getParameter(\"reqname\"));\n            String VAR_21 = VAR_17.escapeHtml4(VAR_1.getParameter(\"coment\"));\n            if (VAR_21 == null || VAR_21.equals(\"\"))\n                VAR_21 = \"\";\n            boolean VAR_22 = \"true\".equals(VAR_1.getParameter(\"allfiles\"));\n            \n            /* COMMENT_3 */\n            if (VAR_16 == null || VAR_16.equals(\"\") ||\n                VAR_20 == null || VAR_20.equals(\"\")) \n            {\n                VAR_1.setAttribute(\"handle\",VAR_5);\n                VAR_1.setAttribute(\"bitstream-id\", VAR_6);\n                VAR_1.setAttribute(\"reqname\", VAR_20);\n                VAR_1.setAttribute(\"email\", VAR_16);\n                VAR_1.setAttribute(\"coment\", VAR_21);\n                VAR_1.setAttribute(\"title\", VAR_8); \n                VAR_1.setAttribute(\"allfiles\", VAR_22?\"true\":null); \n                \n                VAR_1.setAttribute(\"requestItem.problem\", new Boolean(true));\n                VAR_12.showJSP(VAR_1, VAR_2, \"/requestItem/request-form.jsp\");\n                return;\n            }\n\n            try\n            {\n                /* COMMENT_4 */\n\t\t\t\tEmail VAR_23 = VAR_24.getEmail(VAR_15.getEmailFilename(\n\t\t\t\t\t\tVAR_0.getCurrentLocale(), \"request_item.author\"));\n\t\t\t\t\n\t\t\t\tRequestItemAuthor VAR_25 = new DSpace()\n\t\t\t\t\t\t.getServiceManager()\n\t\t\t\t\t\t.getServiceByName(\n\t\t\t\t\t\t\t\tRequestItemAuthorExtractor.class.getName(),\n\t\t\t\t\t\t\t\tRequestItemAuthorExtractor.class)\n\t\t\t\t\t\t.getRequestItemAuthor(VAR_0, VAR_9);\n\t\t\t\t\n\t\t\t\tString VAR_26 = VAR_25.getEmail();\n\t\t\t\tString VAR_27 = VAR_25.getFullName();\n\t\t\t\t\n\t\t\t\tVAR_23.addRecipient(VAR_26);\n\n\t\t\t\tVAR_23.addArgument(VAR_20);\n\t\t\t\tVAR_23.addArgument(VAR_16);\n\t\t\t\tVAR_23.addArgument(VAR_22 ? VAR_15\n\t\t\t\t\t\t.getMessage(\"itemRequest.all\") : VAR_28.find(\n\t\t\t\t\t\tVAR_0, VAR_6).getName());\n\t\t\t\tVAR_23.addArgument(VAR_11.getCanonicalForm(VAR_9\n\t\t\t\t\t\t.getHandle()));\n\t\t\t\tVAR_23.addArgument(VAR_8); /* COMMENT_5 */\n\t\t\t\tVAR_23.addArgument(VAR_21); /* COMMENT_6 */\n\t\t\t\tVAR_23.addArgument(VAR_29.getLinkTokenEmail(VAR_0,\n\t\t\t\t\t\tVAR_6, VAR_9.getID(), VAR_16, VAR_20,\n\t\t\t\t\t\tVAR_22));\n\t\t\t\t\n\t\t\t\tVAR_23.addArgument(VAR_27); /* COMMENT_7 */\n\t\t\t\tVAR_23.addArgument(VAR_26); /* COMMENT_8 */\n\t\t\t\tVAR_23.addArgument(VAR_4\n\t\t\t\t\t\t.getProperty(\"dspace.name\"));\n\t\t\t\tVAR_23.addArgument(VAR_4\n\t\t\t\t\t\t.getProperty(\"mail.helpdesk\"));\n\t\t\t\tVAR_23.setReplyTo(VAR_16);\n\t\t\t\tVAR_23.send();\n\n                VAR_30.info(VAR_31.getHeader(VAR_0,\n                    \"sent_email_requestItem\",\n                    \"submitter_id=\" + VAR_16\n                        + \",bitstream_id=\"+VAR_6\n                        + \",requestEmail=\"+VAR_16));\n\n                VAR_1.setAttribute(\"handle\", VAR_5);\n                VAR_12.showJSP(VAR_1, VAR_2,\n                    \"/requestItem/request-send.jsp\");\n            }\n            catch (MessagingException VAR_32)\n            {\n                VAR_30.warn(VAR_31.getHeader(VAR_0,\n                    \"error_mailing_requestItem\",\n                    \"\"), VAR_32);\n               VAR_12.showInternalError(VAR_1, VAR_2);\n            }\n        }\n        else\n        {\n            /* COMMENT_9 */\n            VAR_30.info(VAR_31.getHeader(VAR_0,\n                \"show_requestItem_form\",\n                \"problem=false\"));\n            VAR_1.setAttribute(\"handle\", VAR_5);\n            VAR_1.setAttribute(\"bitstream-id\", VAR_6);\n            VAR_1.setAttribute(\"email\", VAR_16);\n            VAR_1.setAttribute(\"reqname\", VAR_19);\n            VAR_1.setAttribute(\"title\", VAR_8);\n            VAR_1.setAttribute(\"allfiles\", \"true\");\n            VAR_12.showJSP(VAR_1, VAR_2, \"/requestItem/request-form.jsp\"); \n        }\n   }",
    "func_graph_path": "DSpace/28eb8158210d41168a62ed5f9e044f754513bc37/RequestItemServlet.java/vul/after/0.json",
    "diff_func": "--- func_before\n+++ func_after\n@@ -19,7 +19,7 @@\n         // handle\n         String handle = request.getParameter(\"handle\");\n         \n-        String bitstream_id=request.getParameter(\"bitstream-id\");\n+        int  bitstream_id= UIUtil.getIntParameter(request, \"bitstream-id\");\n         \n         // Title\n         String title = null;\n@@ -44,7 +44,7 @@\n \t\t}\n           \n         // User email from context\n-        String requesterEmail = request.getParameter(\"email\");\n+        String requesterEmail = StringEscapeUtils.escapeHtml4(request.getParameter(\"email\"));\n         EPerson currentUser = context.getCurrentUser();\n         String userName = null;\n         \n@@ -56,8 +56,8 @@\n         \n         if (request.getParameter(\"submit\") != null)\n         {\n-            String reqname = request.getParameter(\"reqname\");\n-            String coment = request.getParameter(\"coment\");\n+            String reqname = StringEscapeUtils.escapeHtml4(request.getParameter(\"reqname\"));\n+            String coment = StringEscapeUtils.escapeHtml4(request.getParameter(\"coment\"));\n             if (coment == null || coment.equals(\"\"))\n                 coment = \"\";\n             boolean allfiles = \"true\".equals(request.getParameter(\"allfiles\"));\n@@ -101,7 +101,7 @@\n \t\t\t\temail.addArgument(requesterEmail);\n \t\t\t\temail.addArgument(allfiles ? I18nUtil\n \t\t\t\t\t\t.getMessage(\"itemRequest.all\") : Bitstream.find(\n-\t\t\t\t\t\tcontext, Integer.parseInt(bitstream_id)).getName());\n+\t\t\t\t\t\tcontext, bitstream_id).getName());\n \t\t\t\temail.addArgument(HandleManager.getCanonicalForm(item\n \t\t\t\t\t\t.getHandle()));\n \t\t\t\temail.addArgument(title); // request item title",
    "diff_line_info": {
        "deleted_lines": [
            "        String bitstream_id=request.getParameter(\"bitstream-id\");",
            "        String requesterEmail = request.getParameter(\"email\");",
            "            String reqname = request.getParameter(\"reqname\");",
            "            String coment = request.getParameter(\"coment\");",
            "\t\t\t\t\t\tcontext, Integer.parseInt(bitstream_id)).getName());"
        ],
        "added_lines": [
            "        int  bitstream_id= UIUtil.getIntParameter(request, \"bitstream-id\");",
            "        String requesterEmail = StringEscapeUtils.escapeHtml4(request.getParameter(\"email\"));",
            "            String reqname = StringEscapeUtils.escapeHtml4(request.getParameter(\"reqname\"));",
            "            String coment = StringEscapeUtils.escapeHtml4(request.getParameter(\"coment\"));",
            "\t\t\t\t\t\tcontext, bitstream_id).getName());"
        ]
    },
    "is_vul": true,
    "pr_url": null,
    "description": "no more info"
}