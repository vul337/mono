{
    "cve_id": "CVE-2018-20595",
    "cwe_ids": [
        "CWE-352"
    ],
    "cvss_vector": "AV:N/AC:M/Au:N/C:P/I:P/A:P",
    "cvss_is_v3": false,
    "repo_name": "hs-web/hsweb-framework",
    "commit_msg": "fix #107 csrf",
    "commit_hash": "40929e9b0d336a26281a5ed2e0e721d54dd8d2f2",
    "git_url": "https://github.com/hs-web/hsweb-framework/commit/40929e9b0d336a26281a5ed2e0e721d54dd8d2f2",
    "file_path": "hsweb-system/hsweb-system-oauth2-client/hsweb-system-oauth2-client-web/src/main/java/org/hswebframework/web/authorization/oauth2/controller/OAuth2ClientController.java",
    "func_name": "callback",
    "func_before": "@GetMapping(\"/callback/{serverId}\")\n    @ApiOperation(value = \"OAuth2.0\u6388\u6743\u5b8c\u6210\u540e\u56de\u8c03\", hidden = true)\n    public RedirectView callback(@RequestParam(defaultValue = \"/\") String redirect,\n                                 @PathVariable String serverId,\n                                 @RequestParam String code,\n                                 @RequestParam String state,\n                                 HttpServletRequest request,\n                                 HttpSession session) throws UnsupportedEncodingException {\n        try {\n            String cachedState = (String) session.getAttribute(STATE_SESSION_KEY);\n            //  if (!state.equals(cachedState)) throw new BusinessException(\"state error\");\n            oAuth2RequestService.doEvent(serverId, new OAuth2CodeAuthBeforeEvent(code, state, request::getParameter));\n            return new RedirectView(URLDecoder.decode(redirect, \"UTF-8\"));\n        } finally {\n            session.removeAttribute(STATE_SESSION_KEY);\n        }\n    }",
    "abstract_func_before": "@GetMapping(\"/callback/{serverId}\")\n    @ApiOperation(VAR_0 = \"OAuth2.0\u6388\u6743\u5b8c\u6210\u540e\u56de\u8c03\", hidden = true)$$$$\n$$$$    public RedirectView callback(@RequestParam(VAR_2 = \"/\") String VAR_3,\n                                 @PathVariable String VAR_4,\n                                 @RequestParam String VAR_5,\n                                 @RequestParam String VAR_6,\n                                 HttpServletRequest VAR_7,\n                                 HttpSession VAR_8) throws UnsupportedEncodingException {\n        try {\n            String VAR_9 = (String) VAR_8.getAttribute(VAR_10);\n            /* COMMENT_0 */\n            VAR_11.doEvent(VAR_4, new OAuth2CodeAuthBeforeEvent(VAR_5, VAR_6, VAR_7::VAR_12));\n            return new RedirectView(VAR_13.decode(VAR_3, \"UTF-8\"));\n        } finally {\n            VAR_8.removeAttribute(VAR_10);\n        }\n    }",
    "func_graph_path_before": "hs-web/hsweb-framework/40929e9b0d336a26281a5ed2e0e721d54dd8d2f2/OAuth2ClientController.java/vul/before/0.json",
    "func": "@GetMapping(\"/callback/{serverId}\")\n    @ApiOperation(value = \"OAuth2.0\u6388\u6743\u5b8c\u6210\u540e\u56de\u8c03\", hidden = true)\n    public RedirectView callback(@RequestParam(defaultValue = \"/\") String redirect,\n                                 @PathVariable String serverId,\n                                 @RequestParam String code,\n                                 @RequestParam String state,\n                                 HttpServletRequest request,\n                                 HttpSession session) throws UnsupportedEncodingException {\n        try {\n            String cachedState = (String) session.getAttribute(STATE_SESSION_KEY);\n            if (!state.equals(cachedState)) {\n                throw new BusinessException(ErrorType.STATE_ERROR.name());\n            }\n            oAuth2RequestService.doEvent(serverId, new OAuth2CodeAuthBeforeEvent(code, state, request::getParameter));\n            return new RedirectView(URLDecoder.decode(redirect, \"UTF-8\"));\n        } finally {\n            session.removeAttribute(STATE_SESSION_KEY);\n        }\n    }",
    "abstract_func": "@GetMapping(\"/callback/{serverId}\")\n    @ApiOperation(VAR_0 = \"OAuth2.0\u6388\u6743\u5b8c\u6210\u540e\u56de\u8c03\", hidden = true)$$$$\n$$$$    public RedirectView callback(@RequestParam(VAR_2 = \"/\") String VAR_3,\n                                 @PathVariable String VAR_4,\n                                 @RequestParam String VAR_5,\n                                 @RequestParam String VAR_6,\n                                 HttpServletRequest VAR_7,\n                                 HttpSession VAR_8) throws UnsupportedEncodingException {\n        try {\n            String VAR_9 = (String) VAR_8.getAttribute(VAR_10);\n            if (!VAR_6.equals(VAR_9)) {\n                throw new BusinessException(VAR_11.STATE_ERROR.name());\n            }\n            VAR_12.doEvent(VAR_4, new OAuth2CodeAuthBeforeEvent(VAR_5, VAR_6, VAR_7::VAR_13));\n            return new RedirectView(VAR_14.decode(VAR_3, \"UTF-8\"));\n        } finally {\n            VAR_8.removeAttribute(VAR_10);\n        }\n    }",
    "func_graph_path": "hs-web/hsweb-framework/40929e9b0d336a26281a5ed2e0e721d54dd8d2f2/OAuth2ClientController.java/vul/after/0.json",
    "diff_func": "--- func_before\n+++ func_after\n@@ -8,7 +8,9 @@\n                                  HttpSession session) throws UnsupportedEncodingException {\n         try {\n             String cachedState = (String) session.getAttribute(STATE_SESSION_KEY);\n-            //  if (!state.equals(cachedState)) throw new BusinessException(\"state error\");\n+            if (!state.equals(cachedState)) {\n+                throw new BusinessException(ErrorType.STATE_ERROR.name());\n+            }\n             oAuth2RequestService.doEvent(serverId, new OAuth2CodeAuthBeforeEvent(code, state, request::getParameter));\n             return new RedirectView(URLDecoder.decode(redirect, \"UTF-8\"));\n         } finally {",
    "diff_line_info": {
        "deleted_lines": [
            "            //  if (!state.equals(cachedState)) throw new BusinessException(\"state error\");"
        ],
        "added_lines": [
            "            if (!state.equals(cachedState)) {",
            "                throw new BusinessException(ErrorType.STATE_ERROR.name());",
            "            }"
        ]
    },
    "is_vul": true,
    "pr_url": "https://github.com/hs-web/hsweb-framework/pull/108",
    "description": "1. \u4fee\u590dbug\r\n2. \u4f18\u5316\u6570\u636e\u6743\u9650\u63a7\u5236\r\n3. \u4f18\u5316\u81ea\u52a8\u5efa\u8868,\u589e\u52a0\u7d22\u5f15"
}