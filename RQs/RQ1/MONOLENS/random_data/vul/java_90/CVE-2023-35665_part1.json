{
    "cve_id": "CVE-2023-35665",
    "cwe_ids": [
        "CWE-Other",
        "CWE-862"
    ],
    "cvss_vector": "CVSS:3.1/AV:L/AC:L/PR:L/UI:N/S:U/C:H/I:H/A:H",
    "cvss_is_v3": true,
    "repo_name": "android",
    "commit_msg": "Fixed leak of cross user data in multiple settings.\n\n  - Any app is allowed to receive GET_CONTENT intent. Using this, an user puts back in the intent an uri with data of another user.\n  - Telephony service has INTERACT_ACROSS_USER permission. Using this, it reads and shows the deta to the evil user.\n\nFix: When telephony service gets the intent result, it checks if the uri is from the current user or not.\n\nBug: b/256591023 , b/256819787\n\nTest: The malicious behaviour was not being reproduced. Unable to import contact from other users data.\nTest2: Able to import contact from the primary user or uri with no user id\n(These settings are not available for secondary users)\n(cherry picked from https://googleplex-android-review.googlesource.com/q/commit:ab593467e900d4a6d25a34024a06195ae863f6dc)\nMerged-In: I1e3a643f17948153aecc1d0df9ffd9619ad678c1\nChange-Id: I1e3a643f17948153aecc1d0df9ffd9619ad678c1\n",
    "commit_hash": "674039e70e1c5bf29b808899ac80c709acc82290",
    "git_url": "https://android.googlesource.com/platform/packages/services/Telephony/+/674039e70e1c5bf29b808899ac80c709acc82290",
    "file_path": "src/com/android/phone/GsmUmtsCallForwardOptions.java",
    "func_name": "onActivityResult",
    "func_before": "@Override\n    protected void onActivityResult(int requestCode, int resultCode, Intent data) {\n        Log.d(LOG_TAG, \"onActivityResult: done\");\n        if (resultCode != RESULT_OK) {\n            Log.d(LOG_TAG, \"onActivityResult: contact picker result not OK.\");\n            return;\n        }\n        Cursor cursor = null;\n        try {\n            cursor = getContentResolver().query(data.getData(),\n                NUM_PROJECTION, null, null, null);\n            if ((cursor == null) || (!cursor.moveToFirst())) {\n                Log.d(LOG_TAG, \"onActivityResult: bad contact data, no results found.\");\n                return;\n            }\n\n            switch (requestCode) {\n                case CommandsInterface.CF_REASON_UNCONDITIONAL:\n                    mButtonCFU.onPickActivityResult(cursor.getString(0));\n                    break;\n                case CommandsInterface.CF_REASON_BUSY:\n                    mButtonCFB.onPickActivityResult(cursor.getString(0));\n                    break;\n                case CommandsInterface.CF_REASON_NO_REPLY:\n                    mButtonCFNRy.onPickActivityResult(cursor.getString(0));\n                    break;\n                case CommandsInterface.CF_REASON_NOT_REACHABLE:\n                    mButtonCFNRc.onPickActivityResult(cursor.getString(0));\n                    break;\n                default:\n                    // TODO: may need exception here.\n            }\n        } finally {\n            if (cursor != null) {\n                cursor.close();\n            }\n        }\n    }",
    "abstract_func_before": "@Override\n    protected void onActivityResult(int VAR_0, int VAR_1, Intent VAR_2) {\n        VAR_3.d(VAR_4, \"onActivityResult: done\");\n        if (VAR_1 != VAR_5) {\n            VAR_3.d(VAR_4, \"onActivityResult: contact picker result not OK.\");\n            return;\n        }\n        Cursor VAR_6 = null;\n        try {\n            VAR_6 = getContentResolver().query(VAR_2.getData(),\n                VAR_7, null, null, null);\n            if ((VAR_6 == null) || (!VAR_6.moveToFirst())) {\n                VAR_3.d(VAR_4, \"onActivityResult: bad contact data, no results found.\");\n                return;\n            }\n\n            switch (VAR_0) {\n                case VAR_8.CF_REASON_UNCONDITIONAL:\n                    VAR_9.onPickActivityResult(VAR_6.getString(0));\n                    break;\n                case VAR_8.CF_REASON_BUSY:\n                    VAR_10.onPickActivityResult(VAR_6.getString(0));\n                    break;\n                case VAR_8.CF_REASON_NO_REPLY:\n                    VAR_11.onPickActivityResult(VAR_6.getString(0));\n                    break;\n                case VAR_8.CF_REASON_NOT_REACHABLE:\n                    VAR_12.onPickActivityResult(VAR_6.getString(0));\n                    break;\n                default:\n                    /* COMMENT_0 */\n            }\n        } finally {\n            if (VAR_6 != null) {\n                VAR_6.close();\n            }\n        }\n    }",
    "func_graph_path_before": "android/674039e70e1c5bf29b808899ac80c709acc82290/GsmUmtsCallForwardOptions.java/vul/before/0.json",
    "func": "@Override\n    protected void onActivityResult(int requestCode, int resultCode, Intent data) {\n        Log.d(LOG_TAG, \"onActivityResult: done\");\n        if (resultCode != RESULT_OK) {\n            Log.d(LOG_TAG, \"onActivityResult: contact picker result not OK.\");\n            return;\n        }\n        Cursor cursor = null;\n        try {\n            // check if the URI returned by the user belongs to the user\n            final int currentUser = UserHandle.getUserId(Process.myUid());\n            if (currentUser\n                    != ContentProvider.getUserIdFromUri(data.getData(), currentUser)) {\n\n                Log.w(LOG_TAG, \"onActivityResult: Contact data of different user, \"\n                        + \"cannot access\");\n                return;\n            }\n            cursor = getContentResolver().query(data.getData(),\n                NUM_PROJECTION, null, null, null);\n            if ((cursor == null) || (!cursor.moveToFirst())) {\n                Log.d(LOG_TAG, \"onActivityResult: bad contact data, no results found.\");\n                return;\n            }\n\n            switch (requestCode) {\n                case CommandsInterface.CF_REASON_UNCONDITIONAL:\n                    mButtonCFU.onPickActivityResult(cursor.getString(0));\n                    break;\n                case CommandsInterface.CF_REASON_BUSY:\n                    mButtonCFB.onPickActivityResult(cursor.getString(0));\n                    break;\n                case CommandsInterface.CF_REASON_NO_REPLY:\n                    mButtonCFNRy.onPickActivityResult(cursor.getString(0));\n                    break;\n                case CommandsInterface.CF_REASON_NOT_REACHABLE:\n                    mButtonCFNRc.onPickActivityResult(cursor.getString(0));\n                    break;\n                default:\n                    // TODO: may need exception here.\n            }\n        } finally {\n            if (cursor != null) {\n                cursor.close();\n            }\n        }\n    }",
    "abstract_func": "@Override\n    protected void onActivityResult(int VAR_0, int VAR_1, Intent VAR_2) {\n        VAR_3.d(VAR_4, \"onActivityResult: done\");\n        if (VAR_1 != VAR_5) {\n            VAR_3.d(VAR_4, \"onActivityResult: contact picker result not OK.\");\n            return;\n        }\n        Cursor VAR_6 = null;\n        try {\n            /* COMMENT_0 */\n            final int VAR_7 = VAR_8.getUserId(VAR_9.myUid());\n            if (VAR_7\n                    != VAR_10.getUserIdFromUri(VAR_2.getData(), VAR_7)) {\n\n                VAR_3.w(VAR_4, \"onActivityResult: Contact data of different user, \"\n                        + \"cannot access\");\n                return;\n            }\n            VAR_6 = getContentResolver().query(VAR_2.getData(),\n                VAR_11, null, null, null);\n            if ((VAR_6 == null) || (!VAR_6.moveToFirst())) {\n                VAR_3.d(VAR_4, \"onActivityResult: bad contact data, no results found.\");\n                return;\n            }\n\n            switch (VAR_0) {\n                case VAR_12.CF_REASON_UNCONDITIONAL:\n                    VAR_13.onPickActivityResult(VAR_6.getString(0));\n                    break;\n                case VAR_12.CF_REASON_BUSY:\n                    VAR_14.onPickActivityResult(VAR_6.getString(0));\n                    break;\n                case VAR_12.CF_REASON_NO_REPLY:\n                    VAR_15.onPickActivityResult(VAR_6.getString(0));\n                    break;\n                case VAR_12.CF_REASON_NOT_REACHABLE:\n                    VAR_16.onPickActivityResult(VAR_6.getString(0));\n                    break;\n                default:\n                    /* COMMENT_1 */\n            }\n        } finally {\n            if (VAR_6 != null) {\n                VAR_6.close();\n            }\n        }\n    }",
    "func_graph_path": "android/674039e70e1c5bf29b808899ac80c709acc82290/GsmUmtsCallForwardOptions.java/vul/after/0.json",
    "diff_func": "--- func_before\n+++ func_after\n@@ -7,6 +7,15 @@\n         }\n         Cursor cursor = null;\n         try {\n+            // check if the URI returned by the user belongs to the user\n+            final int currentUser = UserHandle.getUserId(Process.myUid());\n+            if (currentUser\n+                    != ContentProvider.getUserIdFromUri(data.getData(), currentUser)) {\n+\n+                Log.w(LOG_TAG, \"onActivityResult: Contact data of different user, \"\n+                        + \"cannot access\");\n+                return;\n+            }\n             cursor = getContentResolver().query(data.getData(),\n                 NUM_PROJECTION, null, null, null);\n             if ((cursor == null) || (!cursor.moveToFirst())) {",
    "diff_line_info": {
        "deleted_lines": [],
        "added_lines": [
            "            // check if the URI returned by the user belongs to the user",
            "            final int currentUser = UserHandle.getUserId(Process.myUid());",
            "            if (currentUser",
            "                    != ContentProvider.getUserIdFromUri(data.getData(), currentUser)) {",
            "",
            "                Log.w(LOG_TAG, \"onActivityResult: Contact data of different user, \"",
            "                        + \"cannot access\");",
            "                return;",
            "            }"
        ]
    },
    "is_vul": true,
    "pr_url": null,
    "description": "no more info"
}