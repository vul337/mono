{
    "cve_id": "CVE-2023-41044",
    "cwe_ids": [
        "CWE-22"
    ],
    "cvss_vector": "CVSS:3.1/AV:N/AC:L/PR:H/UI:N/S:U/C:L/I:L/A:N",
    "cvss_is_v3": true,
    "repo_name": "Graylog2/graylog2-server",
    "commit_msg": "Merge pull request from GHSA-2q4p-f6gf-mqr5\n\n* Fix filename validation in Support Bundle handling\n\nThe previous implementation of \"SupportBundle#ensureFileWithinBundleDir\"\nwas affected by a partial path traversal vulnerability and allowed\nauthenticated users with the Admin role to download or delete files in\nsibling directories of the support bundle data directory.\n\nSee: https://github.com/Graylog2/graylog2-server/security/advisories/GHSA-2q4p-f6gf-mqr5\n\n* Add changelog snippet\n\n* Fix bundle download with relative data_dir config\n\n* Fix test for the assertj version we are using in 5.1\n\n* Fix another test case",
    "commit_hash": "02b8792e6f4b829f0c1d87fcbf2d58b73458b938",
    "git_url": "https://github.com/Graylog2/graylog2-server/commit/02b8792e6f4b829f0c1d87fcbf2d58b73458b938",
    "file_path": "graylog2-server/src/main/java/org/graylog2/rest/resources/system/debug/bundle/SupportBundleService.java",
    "func_name": "ensureFileWithinBundleDir",
    "func_before": "private void ensureFileWithinBundleDir(String filename) throws IOException {\n        if (!bundleDir.resolve(filename).toFile().getCanonicalPath().startsWith(bundleDir.toFile().getCanonicalPath())) {\n            throw new NotFoundException();\n        }\n    }",
    "abstract_func_before": "private void ensureFileWithinBundleDir(String VAR_0) throws IOException {\n        if (!VAR_1.resolve(VAR_0).toFile().getCanonicalPath().startsWith(VAR_1.toFile().getCanonicalPath())) {\n            throw new NotFoundException();\n        }\n    }",
    "func_graph_path_before": "Graylog2/graylog2-server/02b8792e6f4b829f0c1d87fcbf2d58b73458b938/SupportBundleService.java/vul/before/2.json",
    "func": "@VisibleForTesting\n    void ensureFileWithinBundleDir(Path bundleDir, String filename) {\n        if (!bundleDir.resolve(filename).toAbsolutePath().normalize().startsWith(bundleDir.toAbsolutePath().normalize())) {\n            throw new NotFoundException();\n        }\n    }",
    "abstract_func": "@VisibleForTesting\n    void ensureFileWithinBundleDir(Path VAR_0, String VAR_1) {\n        if (!VAR_0.resolve(VAR_1).toAbsolutePath().normalize().startsWith(VAR_0.toAbsolutePath().normalize())) {\n            throw new NotFoundException();\n        }\n    }",
    "func_graph_path": "Graylog2/graylog2-server/02b8792e6f4b829f0c1d87fcbf2d58b73458b938/SupportBundleService.java/vul/after/2.json",
    "diff_func": "--- func_before\n+++ func_after\n@@ -1,5 +1,6 @@\n-private void ensureFileWithinBundleDir(String filename) throws IOException {\n-        if (!bundleDir.resolve(filename).toFile().getCanonicalPath().startsWith(bundleDir.toFile().getCanonicalPath())) {\n+@VisibleForTesting\n+    void ensureFileWithinBundleDir(Path bundleDir, String filename) {\n+        if (!bundleDir.resolve(filename).toAbsolutePath().normalize().startsWith(bundleDir.toAbsolutePath().normalize())) {\n             throw new NotFoundException();\n         }\n     }",
    "diff_line_info": {
        "deleted_lines": [
            "private void ensureFileWithinBundleDir(String filename) throws IOException {",
            "        if (!bundleDir.resolve(filename).toFile().getCanonicalPath().startsWith(bundleDir.toFile().getCanonicalPath())) {"
        ],
        "added_lines": [
            "@VisibleForTesting",
            "    void ensureFileWithinBundleDir(Path bundleDir, String filename) {",
            "        if (!bundleDir.resolve(filename).toAbsolutePath().normalize().startsWith(bundleDir.toAbsolutePath().normalize())) {"
        ]
    },
    "is_vul": true,
    "pr_url": null,
    "description": "no more info"
}