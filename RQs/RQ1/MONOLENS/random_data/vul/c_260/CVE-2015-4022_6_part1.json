{
    "cve_id": "CVE-2015-4022",
    "cwe_ids": [
        "CWE-119",
        "CWE-189"
    ],
    "cvss_vector": "AV:N/AC:L/Au:N/C:P/I:P/A:P",
    "cvss_is_v3": false,
    "repo_name": "php/php-src",
    "commit_msg": "Fix bug #69545 - avoid overflow when reading list",
    "commit_hash": "739adee1912176aacf351edc5751a02ded6ef1ec",
    "git_url": "https://github.com/php/php-src/commit/739adee1912176aacf351edc5751a02ded6ef1ec",
    "file_path": "ext/ftp/ftp.c",
    "func_name": "ftp_login",
    "func_before": "int\nftp_login(ftpbuf_t *ftp, const char *user, const char *pass TSRMLS_DC)\n{\n#if HAVE_OPENSSL_EXT\n\tSSL_CTX\t*ctx = NULL;\n\tlong ssl_ctx_options = SSL_OP_ALL;\n#endif\n\tif (ftp == NULL) {\n\t\treturn 0;\n\t}\n\n#if HAVE_OPENSSL_EXT\n\tif (ftp->use_ssl && !ftp->ssl_active) {\n\t\tif (!ftp_putcmd(ftp, \"AUTH\", \"TLS\")) {\n\t\t\treturn 0;\n\t\t}\n\t\tif (!ftp_getresp(ftp)) {\n\t\t\treturn 0;\n\t\t}\n\t\t\t\n\t\tif (ftp->resp != 234) {\n\t\t\tif (!ftp_putcmd(ftp, \"AUTH\", \"SSL\")) {\n\t\t\t\treturn 0;\n\t\t\t}\n\t\t\tif (!ftp_getresp(ftp)) {\n\t\t\t\treturn 0;\n\t\t\t}\n\t\t\t\t\n\t\t\tif (ftp->resp != 334) {\n\t\t\t\treturn 0;\n\t\t\t} else {\n\t\t\t\tftp->old_ssl = 1;\n\t\t\t\tftp->use_ssl_for_data = 1;\n\t\t\t}\n\t\t}\n\t\t\n\t\tctx = SSL_CTX_new(SSLv23_client_method());\n\t\tif (ctx == NULL) {\n\t\t\tphp_error_docref(NULL TSRMLS_CC, E_WARNING, \"failed to create the SSL context\");\n\t\t\treturn 0;\n\t\t}\n\n#if OPENSSL_VERSION_NUMBER >= 0x0090605fL\n\t\tssl_ctx_options &= ~SSL_OP_DONT_INSERT_EMPTY_FRAGMENTS;\n#endif\n\t\tSSL_CTX_set_options(ctx, ssl_ctx_options);\n\n\t\tftp->ssl_handle = SSL_new(ctx);\n\t\tif (ftp->ssl_handle == NULL) {\n\t\t\tphp_error_docref(NULL TSRMLS_CC, E_WARNING, \"failed to create the SSL handle\");\n\t\t\tSSL_CTX_free(ctx);\n\t\t\treturn 0;\n\t\t}\n\n\t\tSSL_set_fd(ftp->ssl_handle, ftp->fd);\n\n\t\tif (SSL_connect(ftp->ssl_handle) <= 0) {\n\t\t\tphp_error_docref(NULL TSRMLS_CC, E_WARNING, \"SSL/TLS handshake failed\");\n\t\t\tSSL_shutdown(ftp->ssl_handle);\n\t\t\tSSL_free(ftp->ssl_handle);\n\t\t\treturn 0;\n\t\t}\n\n\t\tftp->ssl_active = 1;\n\n\t\tif (!ftp->old_ssl) {\n\n\t\t\t/* set protection buffersize to zero */\n\t\t\tif (!ftp_putcmd(ftp, \"PBSZ\", \"0\")) {\n\t\t\t\treturn 0;\n\t\t\t}\n\t\t\tif (!ftp_getresp(ftp)) {\n\t\t\t\treturn 0;\n\t\t\t}\n\n\t\t\t/* enable data conn encryption */\n\t\t\tif (!ftp_putcmd(ftp, \"PROT\", \"P\")) {\n\t\t\t\treturn 0;\n\t\t\t}\n\t\t\tif (!ftp_getresp(ftp)) {\n\t\t\t\treturn 0;\n\t\t\t}\n\t\t\t\n\t\t\tftp->use_ssl_for_data = (ftp->resp >= 200 && ftp->resp <=299);\t\t\n\t\t}\n\t}\n#endif\n\n\tif (!ftp_putcmd(ftp, \"USER\", user)) {\n\t\treturn 0;\n\t}\n\tif (!ftp_getresp(ftp)) {\n\t\treturn 0;\n\t}\n\tif (ftp->resp == 230) {\n\t\treturn 1;\n\t}\n\tif (ftp->resp != 331) {\n\t\treturn 0;\n\t}\n\tif (!ftp_putcmd(ftp, \"PASS\", pass)) {\n\t\treturn 0;\n\t}\n\tif (!ftp_getresp(ftp)) {\n\t\treturn 0;\n\t}\n\treturn (ftp->resp == 230);\n}",
    "abstract_func_before": "int\nftp_login(ftpbuf_t *VAR_0, const char *VAR_1, const char *VAR_2 TSRMLS_DC)\n{\n#if VAR_3\n\tSSL_CTX\t*VAR_4 = NULL;\n\tlong VAR_5 = VAR_6;\n#endif\n\tif (VAR_0 == NULL) {\n\t\treturn 0;\n\t}\n\n#if VAR_3\n\tif (VAR_0->use_ssl && !VAR_0->ssl_active) {\n\t\tif (!ftp_putcmd(VAR_0, \"AUTH\", \"TLS\")) {\n\t\t\treturn 0;\n\t\t}\n\t\tif (!ftp_getresp(VAR_0)) {\n\t\t\treturn 0;\n\t\t}\n\t\t\t\n\t\tif (VAR_0->resp != 234) {\n\t\t\tif (!ftp_putcmd(VAR_0, \"AUTH\", \"SSL\")) {\n\t\t\t\treturn 0;\n\t\t\t}\n\t\t\tif (!ftp_getresp(VAR_0)) {\n\t\t\t\treturn 0;\n\t\t\t}\n\t\t\t\t\n\t\t\tif (VAR_0->resp != 334) {\n\t\t\t\treturn 0;\n\t\t\t} else {\n\t\t\t\tVAR_0->old_ssl = 1;\n\t\t\t\tVAR_0->use_ssl_for_data = 1;\n\t\t\t}\n\t\t}\n\t\t\n\t\tVAR_4 = SSL_CTX_new(SSLv23_client_method());\n\t\tif (VAR_4 == NULL) {\n\t\t\tVAR_7(NULL VAR_8, VAR_9, \"failed to create the SSL context\");\n\t\t\treturn 0;\n\t\t}\n\n#if VAR_10 >= 0x0090605fL\n\t\tVAR_5 &= ~VAR_11;\n#endif\n\t\tSSL_CTX_set_options(VAR_4, VAR_5);\n\n\t\tVAR_0->ssl_handle = SSL_new(VAR_4);\n\t\tif (VAR_0->ssl_handle == NULL) {\n\t\t\tVAR_7(NULL VAR_8, VAR_9, \"failed to create the SSL handle\");\n\t\t\tSSL_CTX_free(VAR_4);\n\t\t\treturn 0;\n\t\t}\n\n\t\tSSL_set_fd(VAR_0->ssl_handle, VAR_0->fd);\n\n\t\tif (SSL_connect(VAR_0->ssl_handle) <= 0) {\n\t\t\tVAR_7(NULL VAR_8, VAR_9, \"SSL/TLS handshake failed\");\n\t\t\tSSL_shutdown(VAR_0->ssl_handle);\n\t\t\tSSL_free(VAR_0->ssl_handle);\n\t\t\treturn 0;\n\t\t}\n\n\t\tVAR_0->ssl_active = 1;\n\n\t\tif (!VAR_0->old_ssl) {\n\n\t\t\t/* COMMENT_0 */\n\t\t\tif (!ftp_putcmd(VAR_0, \"PBSZ\", \"0\")) {\n\t\t\t\treturn 0;\n\t\t\t}\n\t\t\tif (!ftp_getresp(VAR_0)) {\n\t\t\t\treturn 0;\n\t\t\t}\n\n\t\t\t/* COMMENT_1 */\n\t\t\tif (!ftp_putcmd(VAR_0, \"PROT\", \"P\")) {\n\t\t\t\treturn 0;\n\t\t\t}\n\t\t\tif (!ftp_getresp(VAR_0)) {\n\t\t\t\treturn 0;\n\t\t\t}\n\t\t\t\n\t\t\tVAR_0->use_ssl_for_data = (VAR_0->resp >= 200 && VAR_0->resp <=299);\t\t\n\t\t}\n\t}\n#endif\n\n\tif (!ftp_putcmd(VAR_0, \"USER\", VAR_1)) {\n\t\treturn 0;\n\t}\n\tif (!ftp_getresp(VAR_0)) {\n\t\treturn 0;\n\t}\n\tif (VAR_0->resp == 230) {\n\t\treturn 1;\n\t}\n\tif (VAR_0->resp != 331) {\n\t\treturn 0;\n\t}\n\tif (!ftp_putcmd(VAR_0, \"PASS\", VAR_2)) {\n\t\treturn 0;\n\t}\n\tif (!ftp_getresp(VAR_0)) {\n\t\treturn 0;\n\t}\n\treturn (VAR_0->resp == 230);\n}",
    "func_graph_path_before": null,
    "func": "int\nftp_login(ftpbuf_t *ftp, const char *user, const char *pass TSRMLS_DC)\n{\n#if HAVE_OPENSSL_EXT\n\tSSL_CTX\t*ctx = NULL;\n\tlong ssl_ctx_options = SSL_OP_ALL;\n#endif\n\tif (ftp == NULL) {\n\t\treturn 0;\n\t}\n\n#if HAVE_OPENSSL_EXT\n\tif (ftp->use_ssl && !ftp->ssl_active) {\n\t\tif (!ftp_putcmd(ftp, \"AUTH\", \"TLS\")) {\n\t\t\treturn 0;\n\t\t}\n\t\tif (!ftp_getresp(ftp)) {\n\t\t\treturn 0;\n\t\t}\n\n\t\tif (ftp->resp != 234) {\n\t\t\tif (!ftp_putcmd(ftp, \"AUTH\", \"SSL\")) {\n\t\t\t\treturn 0;\n\t\t\t}\n\t\t\tif (!ftp_getresp(ftp)) {\n\t\t\t\treturn 0;\n\t\t\t}\n\n\t\t\tif (ftp->resp != 334) {\n\t\t\t\treturn 0;\n\t\t\t} else {\n\t\t\t\tftp->old_ssl = 1;\n\t\t\t\tftp->use_ssl_for_data = 1;\n\t\t\t}\n\t\t}\n\n\t\tctx = SSL_CTX_new(SSLv23_client_method());\n\t\tif (ctx == NULL) {\n\t\t\tphp_error_docref(NULL TSRMLS_CC, E_WARNING, \"failed to create the SSL context\");\n\t\t\treturn 0;\n\t\t}\n\n#if OPENSSL_VERSION_NUMBER >= 0x0090605fL\n\t\tssl_ctx_options &= ~SSL_OP_DONT_INSERT_EMPTY_FRAGMENTS;\n#endif\n\t\tSSL_CTX_set_options(ctx, ssl_ctx_options);\n\n\t\tftp->ssl_handle = SSL_new(ctx);\n\t\tif (ftp->ssl_handle == NULL) {\n\t\t\tphp_error_docref(NULL TSRMLS_CC, E_WARNING, \"failed to create the SSL handle\");\n\t\t\tSSL_CTX_free(ctx);\n\t\t\treturn 0;\n\t\t}\n\n\t\tSSL_set_fd(ftp->ssl_handle, ftp->fd);\n\n\t\tif (SSL_connect(ftp->ssl_handle) <= 0) {\n\t\t\tphp_error_docref(NULL TSRMLS_CC, E_WARNING, \"SSL/TLS handshake failed\");\n\t\t\tSSL_shutdown(ftp->ssl_handle);\n\t\t\tSSL_free(ftp->ssl_handle);\n\t\t\treturn 0;\n\t\t}\n\n\t\tftp->ssl_active = 1;\n\n\t\tif (!ftp->old_ssl) {\n\n\t\t\t/* set protection buffersize to zero */\n\t\t\tif (!ftp_putcmd(ftp, \"PBSZ\", \"0\")) {\n\t\t\t\treturn 0;\n\t\t\t}\n\t\t\tif (!ftp_getresp(ftp)) {\n\t\t\t\treturn 0;\n\t\t\t}\n\n\t\t\t/* enable data conn encryption */\n\t\t\tif (!ftp_putcmd(ftp, \"PROT\", \"P\")) {\n\t\t\t\treturn 0;\n\t\t\t}\n\t\t\tif (!ftp_getresp(ftp)) {\n\t\t\t\treturn 0;\n\t\t\t}\n\n\t\t\tftp->use_ssl_for_data = (ftp->resp >= 200 && ftp->resp <=299);\n\t\t}\n\t}\n#endif\n\n\tif (!ftp_putcmd(ftp, \"USER\", user)) {\n\t\treturn 0;\n\t}\n\tif (!ftp_getresp(ftp)) {\n\t\treturn 0;\n\t}\n\tif (ftp->resp == 230) {\n\t\treturn 1;\n\t}\n\tif (ftp->resp != 331) {\n\t\treturn 0;\n\t}\n\tif (!ftp_putcmd(ftp, \"PASS\", pass)) {\n\t\treturn 0;\n\t}\n\tif (!ftp_getresp(ftp)) {\n\t\treturn 0;\n\t}\n\treturn (ftp->resp == 230);\n}",
    "abstract_func": "int\nftp_login(ftpbuf_t *VAR_0, const char *VAR_1, const char *VAR_2 TSRMLS_DC)\n{\n#if VAR_3\n\tSSL_CTX\t*VAR_4 = NULL;\n\tlong VAR_5 = VAR_6;\n#endif\n\tif (VAR_0 == NULL) {\n\t\treturn 0;\n\t}\n\n#if VAR_3\n\tif (VAR_0->use_ssl && !VAR_0->ssl_active) {\n\t\tif (!ftp_putcmd(VAR_0, \"AUTH\", \"TLS\")) {\n\t\t\treturn 0;\n\t\t}\n\t\tif (!ftp_getresp(VAR_0)) {\n\t\t\treturn 0;\n\t\t}\n\n\t\tif (VAR_0->resp != 234) {\n\t\t\tif (!ftp_putcmd(VAR_0, \"AUTH\", \"SSL\")) {\n\t\t\t\treturn 0;\n\t\t\t}\n\t\t\tif (!ftp_getresp(VAR_0)) {\n\t\t\t\treturn 0;\n\t\t\t}\n\n\t\t\tif (VAR_0->resp != 334) {\n\t\t\t\treturn 0;\n\t\t\t} else {\n\t\t\t\tVAR_0->old_ssl = 1;\n\t\t\t\tVAR_0->use_ssl_for_data = 1;\n\t\t\t}\n\t\t}\n\n\t\tVAR_4 = SSL_CTX_new(SSLv23_client_method());\n\t\tif (VAR_4 == NULL) {\n\t\t\tVAR_7(NULL VAR_8, VAR_9, \"failed to create the SSL context\");\n\t\t\treturn 0;\n\t\t}\n\n#if VAR_10 >= 0x0090605fL\n\t\tVAR_5 &= ~VAR_11;\n#endif\n\t\tSSL_CTX_set_options(VAR_4, VAR_5);\n\n\t\tVAR_0->ssl_handle = SSL_new(VAR_4);\n\t\tif (VAR_0->ssl_handle == NULL) {\n\t\t\tVAR_7(NULL VAR_8, VAR_9, \"failed to create the SSL handle\");\n\t\t\tSSL_CTX_free(VAR_4);\n\t\t\treturn 0;\n\t\t}\n\n\t\tSSL_set_fd(VAR_0->ssl_handle, VAR_0->fd);\n\n\t\tif (SSL_connect(VAR_0->ssl_handle) <= 0) {\n\t\t\tVAR_7(NULL VAR_8, VAR_9, \"SSL/TLS handshake failed\");\n\t\t\tSSL_shutdown(VAR_0->ssl_handle);\n\t\t\tSSL_free(VAR_0->ssl_handle);\n\t\t\treturn 0;\n\t\t}\n\n\t\tVAR_0->ssl_active = 1;\n\n\t\tif (!VAR_0->old_ssl) {\n\n\t\t\t/* COMMENT_0 */\n\t\t\tif (!ftp_putcmd(VAR_0, \"PBSZ\", \"0\")) {\n\t\t\t\treturn 0;\n\t\t\t}\n\t\t\tif (!ftp_getresp(VAR_0)) {\n\t\t\t\treturn 0;\n\t\t\t}\n\n\t\t\t/* COMMENT_1 */\n\t\t\tif (!ftp_putcmd(VAR_0, \"PROT\", \"P\")) {\n\t\t\t\treturn 0;\n\t\t\t}\n\t\t\tif (!ftp_getresp(VAR_0)) {\n\t\t\t\treturn 0;\n\t\t\t}\n\n\t\t\tVAR_0->use_ssl_for_data = (VAR_0->resp >= 200 && VAR_0->resp <=299);\n\t\t}\n\t}\n#endif\n\n\tif (!ftp_putcmd(VAR_0, \"USER\", VAR_1)) {\n\t\treturn 0;\n\t}\n\tif (!ftp_getresp(VAR_0)) {\n\t\treturn 0;\n\t}\n\tif (VAR_0->resp == 230) {\n\t\treturn 1;\n\t}\n\tif (VAR_0->resp != 331) {\n\t\treturn 0;\n\t}\n\tif (!ftp_putcmd(VAR_0, \"PASS\", VAR_2)) {\n\t\treturn 0;\n\t}\n\tif (!ftp_getresp(VAR_0)) {\n\t\treturn 0;\n\t}\n\treturn (VAR_0->resp == 230);\n}",
    "func_graph_path": null,
    "diff_func": "--- func_before\n+++ func_after\n@@ -17,7 +17,7 @@\n \t\tif (!ftp_getresp(ftp)) {\n \t\t\treturn 0;\n \t\t}\n-\t\t\t\n+\n \t\tif (ftp->resp != 234) {\n \t\t\tif (!ftp_putcmd(ftp, \"AUTH\", \"SSL\")) {\n \t\t\t\treturn 0;\n@@ -25,7 +25,7 @@\n \t\t\tif (!ftp_getresp(ftp)) {\n \t\t\t\treturn 0;\n \t\t\t}\n-\t\t\t\t\n+\n \t\t\tif (ftp->resp != 334) {\n \t\t\t\treturn 0;\n \t\t\t} else {\n@@ -33,7 +33,7 @@\n \t\t\t\tftp->use_ssl_for_data = 1;\n \t\t\t}\n \t\t}\n-\t\t\n+\n \t\tctx = SSL_CTX_new(SSLv23_client_method());\n \t\tif (ctx == NULL) {\n \t\t\tphp_error_docref(NULL TSRMLS_CC, E_WARNING, \"failed to create the SSL context\");\n@@ -80,8 +80,8 @@\n \t\t\tif (!ftp_getresp(ftp)) {\n \t\t\t\treturn 0;\n \t\t\t}\n-\t\t\t\n-\t\t\tftp->use_ssl_for_data = (ftp->resp >= 200 && ftp->resp <=299);\t\t\n+\n+\t\t\tftp->use_ssl_for_data = (ftp->resp >= 200 && ftp->resp <=299);\n \t\t}\n \t}\n #endif",
    "diff_line_info": {
        "deleted_lines": [
            "\t\t\t",
            "\t\t\t\t",
            "\t\t",
            "\t\t\t",
            "\t\t\tftp->use_ssl_for_data = (ftp->resp >= 200 && ftp->resp <=299);\t\t"
        ],
        "added_lines": [
            "",
            "",
            "",
            "",
            "\t\t\tftp->use_ssl_for_data = (ftp->resp >= 200 && ftp->resp <=299);"
        ]
    },
    "is_vul": true,
    "pr_url": null,
    "description": "no more info"
}