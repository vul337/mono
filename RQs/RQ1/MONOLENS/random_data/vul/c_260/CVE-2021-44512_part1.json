{
    "cve_id": "CVE-2021-44512",
    "cwe_ids": [
        "CWE-732",
        "CWE-362"
    ],
    "cvss_vector": "AV:L/AC:M/Au:N/C:P/I:P/A:P",
    "cvss_is_v3": false,
    "repo_name": "tmate-io/tmate-ssh-server",
    "commit_msg": "Harden /tmp/tmate directory\n\nSuggested by Matthias Gerstner",
    "commit_hash": "1c020d1f5ca462f5b150b46a027aaa1bbe3c9596",
    "git_url": "https://github.com/tmate-io/tmate-ssh-server/commit/1c020d1f5ca462f5b150b46a027aaa1bbe3c9596",
    "file_path": "tmate-main.c",
    "func_name": "main",
    "func_before": "int main(int argc, char **argv, char **envp)\n{\n\tint opt;\n\n\twhile ((opt = getopt(argc, argv, \"b:h:k:p:q:w:z:xv\")) != -1) {\n\t\tswitch (opt) {\n\t\tcase 'b':\n\t\t\ttmate_settings->bind_addr = xstrdup(optarg);\n\t\t\tbreak;\n\t\tcase 'h':\n\t\t\ttmate_settings->tmate_host = xstrdup(optarg);\n\t\t\tbreak;\n\t\tcase 'k':\n\t\t\ttmate_settings->keys_dir = xstrdup(optarg);\n\t\t\tbreak;\n\t\tcase 'p':\n\t\t\ttmate_settings->ssh_port = atoi(optarg);\n\t\t\tbreak;\n\t\tcase 'q':\n\t\t\ttmate_settings->ssh_port_advertized = atoi(optarg);\n\t\t\tbreak;\n\t\tcase 'w':\n\t\t\ttmate_settings->websocket_hostname = xstrdup(optarg);\n\t\t\tbreak;\n\t\tcase 'z':\n\t\t\ttmate_settings->websocket_port = atoi(optarg);\n\t\t\tbreak;\n\t\tcase 'x':\n\t\t\ttmate_settings->use_proxy_protocol = true;\n\t\t\tbreak;\n\t\tcase 'v':\n\t\t\ttmate_settings->log_level++;\n\t\t\tbreak;\n\t\tdefault:\n\t\t\tusage();\n\t\t\treturn 1;\n\t\t}\n\t}\n\n\tinit_logging(tmate_settings->log_level);\n\n\tsetup_locale();\n\n\tif (!tmate_settings->tmate_host)\n\t\ttmate_settings->tmate_host = get_full_hostname();\n\n\tcmdline = *argv;\n\tcmdline_end = *envp;\n\n\ttmate_preload_trace_lib();\n\ttmate_catch_sigsegv();\n\ttmate_init_rand();\n\n\tif ((mkdir(TMATE_WORKDIR, 0701)             < 0 && errno != EEXIST) ||\n\t    (mkdir(TMATE_WORKDIR \"/sessions\", 0703) < 0 && errno != EEXIST) ||\n\t    (mkdir(TMATE_WORKDIR \"/jail\", 0700)     < 0 && errno != EEXIST))\n\t\ttmate_fatal(\"Cannot prepare session in \" TMATE_WORKDIR);\n\n\t/* The websocket server needs to access the /session dir to rename sockets */\n\tif ((chmod(TMATE_WORKDIR, 0701)             < 0) ||\n\t    (chmod(TMATE_WORKDIR \"/sessions\", 0703) < 0) ||\n\t    (chmod(TMATE_WORKDIR \"/jail\", 0700)     < 0))\n\t\ttmate_fatal(\"Cannot prepare session in \" TMATE_WORKDIR);\n\n\ttmate_ssh_server_main(tmate_session,\n\t\t\t      tmate_settings->keys_dir, tmate_settings->bind_addr, tmate_settings->ssh_port);\n\treturn 0;\n}",
    "abstract_func_before": "int main(int VAR_0, char **VAR_1, char **VAR_2)\n{\n\tint VAR_3;\n\n\twhile ((VAR_3 = getopt(VAR_0, VAR_1, \"b:h:k:p:q:w:z:xv\")) != -1) {\n\t\tswitch (VAR_3) {\n\t\tcase 'b':\n\t\t\tVAR_4->bind_addr = xstrdup(VAR_5);\n\t\t\tbreak;\n\t\tcase 'h':\n\t\t\tVAR_4->tmate_host = xstrdup(VAR_5);\n\t\t\tbreak;\n\t\tcase 'k':\n\t\t\tVAR_4->keys_dir = xstrdup(VAR_5);\n\t\t\tbreak;\n\t\tcase 'p':\n\t\t\tVAR_4->ssh_port = atoi(VAR_5);\n\t\t\tbreak;\n\t\tcase 'q':\n\t\t\tVAR_4->ssh_port_advertized = atoi(VAR_5);\n\t\t\tbreak;\n\t\tcase 'w':\n\t\t\tVAR_4->websocket_hostname = xstrdup(VAR_5);\n\t\t\tbreak;\n\t\tcase 'z':\n\t\t\tVAR_4->websocket_port = atoi(VAR_5);\n\t\t\tbreak;\n\t\tcase 'x':\n\t\t\tVAR_4->use_proxy_protocol = true;\n\t\t\tbreak;\n\t\tcase 'v':\n\t\t\tVAR_4->log_level++;\n\t\t\tbreak;\n\t\tdefault:\n\t\t\tusage();\n\t\t\treturn 1;\n\t\t}\n\t}\n\n\tinit_logging(VAR_4->log_level);\n\n\tsetup_locale();\n\n\tif (!VAR_4->tmate_host)\n\t\tVAR_4->tmate_host = get_full_hostname();\n\n\tVAR_6 = *VAR_1;\n\tVAR_7 = *VAR_2;\n\n\ttmate_preload_trace_lib();\n\ttmate_catch_sigsegv();\n\ttmate_init_rand();\n\n\tif ((mkdir(VAR_8, 0701)             < 0 && VAR_9 != VAR_10) ||\n\t    (VAR_11(VAR_8 \"/sessions\", 0703) < 0 && VAR_9 != VAR_10) ||\n\t    (VAR_11(VAR_8 \"/jail\", 0700)     < 0 && VAR_9 != VAR_10))\n\t\ttmate_fatal(\"Cannot prepare session in \" VAR_8);\n\n\t/* COMMENT_0 */\n\tif ((chmod(VAR_8, 0701)             < 0) ||\n\t    (VAR_12(VAR_8 \"/sessions\", 0703) < 0) ||\n\t    (VAR_12(VAR_8 \"/jail\", 0700)     < 0))\n\t\ttmate_fatal(\"Cannot prepare session in \" VAR_8);\n\n\ttmate_ssh_server_main(VAR_13,\n\t\t\t      VAR_4->keys_dir, VAR_4->bind_addr, VAR_4->ssh_port);\n\treturn 0;\n}",
    "func_graph_path_before": "tmate-io/tmate-ssh-server/1c020d1f5ca462f5b150b46a027aaa1bbe3c9596/tmate-main.c/vul/before/0.json",
    "func": "int main(int argc, char **argv, char **envp)\n{\n\tint opt;\n\n\twhile ((opt = getopt(argc, argv, \"b:h:k:p:q:w:z:xv\")) != -1) {\n\t\tswitch (opt) {\n\t\tcase 'b':\n\t\t\ttmate_settings->bind_addr = xstrdup(optarg);\n\t\t\tbreak;\n\t\tcase 'h':\n\t\t\ttmate_settings->tmate_host = xstrdup(optarg);\n\t\t\tbreak;\n\t\tcase 'k':\n\t\t\ttmate_settings->keys_dir = xstrdup(optarg);\n\t\t\tbreak;\n\t\tcase 'p':\n\t\t\ttmate_settings->ssh_port = atoi(optarg);\n\t\t\tbreak;\n\t\tcase 'q':\n\t\t\ttmate_settings->ssh_port_advertized = atoi(optarg);\n\t\t\tbreak;\n\t\tcase 'w':\n\t\t\ttmate_settings->websocket_hostname = xstrdup(optarg);\n\t\t\tbreak;\n\t\tcase 'z':\n\t\t\ttmate_settings->websocket_port = atoi(optarg);\n\t\t\tbreak;\n\t\tcase 'x':\n\t\t\ttmate_settings->use_proxy_protocol = true;\n\t\t\tbreak;\n\t\tcase 'v':\n\t\t\ttmate_settings->log_level++;\n\t\t\tbreak;\n\t\tdefault:\n\t\t\tusage();\n\t\t\treturn 1;\n\t\t}\n\t}\n\n\tinit_logging(tmate_settings->log_level);\n\n\tsetup_locale();\n\n\tif (!tmate_settings->tmate_host)\n\t\ttmate_settings->tmate_host = get_full_hostname();\n\n\tcmdline = *argv;\n\tcmdline_end = *envp;\n\n\ttmate_preload_trace_lib();\n\ttmate_catch_sigsegv();\n\ttmate_init_rand();\n\n\tif ((mkdir(TMATE_WORKDIR, 0700)             < 0 && errno != EEXIST) ||\n\t    (mkdir(TMATE_WORKDIR \"/sessions\", 0700) < 0 && errno != EEXIST) ||\n\t    (mkdir(TMATE_WORKDIR \"/jail\", 0700)     < 0 && errno != EEXIST))\n\t\ttmate_fatal(\"Cannot prepare session in \" TMATE_WORKDIR);\n\n\tif ((chmod(TMATE_WORKDIR, 0700)             < 0) ||\n\t    (chmod(TMATE_WORKDIR \"/sessions\", 0700) < 0) ||\n\t    (chmod(TMATE_WORKDIR \"/jail\", 0700)     < 0))\n\t\ttmate_fatal(\"Cannot prepare session in \" TMATE_WORKDIR);\n\n\tif (check_owned_directory_mode(TMATE_WORKDIR, 0700) ||\n\t    check_owned_directory_mode(TMATE_WORKDIR \"/sessions\", 0700) ||\n\t    check_owned_directory_mode(TMATE_WORKDIR \"/jail\", 0700))\n\t\ttmate_fatal(TMATE_WORKDIR \" and subdirectories has incorrect ownership/mode. \"\n\t\t\t    \"Try deleting \" TMATE_WORKDIR \" and try again\");\n\n\ttmate_ssh_server_main(tmate_session,\n\t\t\t      tmate_settings->keys_dir, tmate_settings->bind_addr, tmate_settings->ssh_port);\n\treturn 0;\n}",
    "abstract_func": "int main(int VAR_0, char **VAR_1, char **VAR_2)\n{\n\tint VAR_3;\n\n\twhile ((VAR_3 = getopt(VAR_0, VAR_1, \"b:h:k:p:q:w:z:xv\")) != -1) {\n\t\tswitch (VAR_3) {\n\t\tcase 'b':\n\t\t\tVAR_4->bind_addr = xstrdup(VAR_5);\n\t\t\tbreak;\n\t\tcase 'h':\n\t\t\tVAR_4->tmate_host = xstrdup(VAR_5);\n\t\t\tbreak;\n\t\tcase 'k':\n\t\t\tVAR_4->keys_dir = xstrdup(VAR_5);\n\t\t\tbreak;\n\t\tcase 'p':\n\t\t\tVAR_4->ssh_port = atoi(VAR_5);\n\t\t\tbreak;\n\t\tcase 'q':\n\t\t\tVAR_4->ssh_port_advertized = atoi(VAR_5);\n\t\t\tbreak;\n\t\tcase 'w':\n\t\t\tVAR_4->websocket_hostname = xstrdup(VAR_5);\n\t\t\tbreak;\n\t\tcase 'z':\n\t\t\tVAR_4->websocket_port = atoi(VAR_5);\n\t\t\tbreak;\n\t\tcase 'x':\n\t\t\tVAR_4->use_proxy_protocol = true;\n\t\t\tbreak;\n\t\tcase 'v':\n\t\t\tVAR_4->log_level++;\n\t\t\tbreak;\n\t\tdefault:\n\t\t\tusage();\n\t\t\treturn 1;\n\t\t}\n\t}\n\n\tinit_logging(VAR_4->log_level);\n\n\tsetup_locale();\n\n\tif (!VAR_4->tmate_host)\n\t\tVAR_4->tmate_host = get_full_hostname();\n\n\tVAR_6 = *VAR_1;\n\tVAR_7 = *VAR_2;\n\n\ttmate_preload_trace_lib();\n\ttmate_catch_sigsegv();\n\ttmate_init_rand();\n\n\tif ((mkdir(VAR_8, 0700)             < 0 && VAR_9 != VAR_10) ||\n\t    (VAR_11(VAR_8 \"/sessions\", 0700) < 0 && VAR_9 != VAR_10) ||\n\t    (VAR_11(VAR_8 \"/jail\", 0700)     < 0 && VAR_9 != VAR_10))\n\t\ttmate_fatal(\"Cannot prepare session in \" VAR_8);\n\n\tif ((chmod(VAR_8, 0700)             < 0) ||\n\t    (VAR_12(VAR_8 \"/sessions\", 0700) < 0) ||\n\t    (VAR_12(VAR_8 \"/jail\", 0700)     < 0))\n\t\ttmate_fatal(\"Cannot prepare session in \" VAR_8);\n\n\tif (check_owned_directory_mode(VAR_8, 0700) ||\n\t    check_owned_directory_mode(VAR_8 \"/sessions\", 0700) ||\n\t    check_owned_directory_mode(VAR_8 \"/jail\", 0700))\n\t\ttmate_fatal(VAR_8 \" and subdirectories has incorrect ownership/mode. \"\n\t\t\t    \"Try deleting \" VAR_8 \" and try again\");\n\n\ttmate_ssh_server_main(VAR_13,\n\t\t\t      VAR_4->keys_dir, VAR_4->bind_addr, VAR_4->ssh_port);\n\treturn 0;\n}",
    "func_graph_path": "tmate-io/tmate-ssh-server/1c020d1f5ca462f5b150b46a027aaa1bbe3c9596/tmate-main.c/vul/after/0.json",
    "diff_func": "--- func_before\n+++ func_after\n@@ -51,16 +51,21 @@\n \ttmate_catch_sigsegv();\n \ttmate_init_rand();\n \n-\tif ((mkdir(TMATE_WORKDIR, 0701)             < 0 && errno != EEXIST) ||\n-\t    (mkdir(TMATE_WORKDIR \"/sessions\", 0703) < 0 && errno != EEXIST) ||\n+\tif ((mkdir(TMATE_WORKDIR, 0700)             < 0 && errno != EEXIST) ||\n+\t    (mkdir(TMATE_WORKDIR \"/sessions\", 0700) < 0 && errno != EEXIST) ||\n \t    (mkdir(TMATE_WORKDIR \"/jail\", 0700)     < 0 && errno != EEXIST))\n \t\ttmate_fatal(\"Cannot prepare session in \" TMATE_WORKDIR);\n \n-\t/* The websocket server needs to access the /session dir to rename sockets */\n-\tif ((chmod(TMATE_WORKDIR, 0701)             < 0) ||\n-\t    (chmod(TMATE_WORKDIR \"/sessions\", 0703) < 0) ||\n+\tif ((chmod(TMATE_WORKDIR, 0700)             < 0) ||\n+\t    (chmod(TMATE_WORKDIR \"/sessions\", 0700) < 0) ||\n \t    (chmod(TMATE_WORKDIR \"/jail\", 0700)     < 0))\n \t\ttmate_fatal(\"Cannot prepare session in \" TMATE_WORKDIR);\n+\n+\tif (check_owned_directory_mode(TMATE_WORKDIR, 0700) ||\n+\t    check_owned_directory_mode(TMATE_WORKDIR \"/sessions\", 0700) ||\n+\t    check_owned_directory_mode(TMATE_WORKDIR \"/jail\", 0700))\n+\t\ttmate_fatal(TMATE_WORKDIR \" and subdirectories has incorrect ownership/mode. \"\n+\t\t\t    \"Try deleting \" TMATE_WORKDIR \" and try again\");\n \n \ttmate_ssh_server_main(tmate_session,\n \t\t\t      tmate_settings->keys_dir, tmate_settings->bind_addr, tmate_settings->ssh_port);",
    "diff_line_info": {
        "deleted_lines": [
            "\tif ((mkdir(TMATE_WORKDIR, 0701)             < 0 && errno != EEXIST) ||",
            "\t    (mkdir(TMATE_WORKDIR \"/sessions\", 0703) < 0 && errno != EEXIST) ||",
            "\t/* The websocket server needs to access the /session dir to rename sockets */",
            "\tif ((chmod(TMATE_WORKDIR, 0701)             < 0) ||",
            "\t    (chmod(TMATE_WORKDIR \"/sessions\", 0703) < 0) ||"
        ],
        "added_lines": [
            "\tif ((mkdir(TMATE_WORKDIR, 0700)             < 0 && errno != EEXIST) ||",
            "\t    (mkdir(TMATE_WORKDIR \"/sessions\", 0700) < 0 && errno != EEXIST) ||",
            "\tif ((chmod(TMATE_WORKDIR, 0700)             < 0) ||",
            "\t    (chmod(TMATE_WORKDIR \"/sessions\", 0700) < 0) ||",
            "",
            "\tif (check_owned_directory_mode(TMATE_WORKDIR, 0700) ||",
            "\t    check_owned_directory_mode(TMATE_WORKDIR \"/sessions\", 0700) ||",
            "\t    check_owned_directory_mode(TMATE_WORKDIR \"/jail\", 0700))",
            "\t\ttmate_fatal(TMATE_WORKDIR \" and subdirectories has incorrect ownership/mode. \"",
            "\t\t\t    \"Try deleting \" TMATE_WORKDIR \" and try again\");"
        ]
    },
    "is_vul": true,
    "pr_url": null,
    "description": "no more info"
}