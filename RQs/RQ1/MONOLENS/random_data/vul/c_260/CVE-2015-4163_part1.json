{
    "cve_id": "CVE-2015-4163",
    "cwe_ids": [
        "CWE-Other"
    ],
    "cvss_vector": "AV:L/AC:L/Au:N/C:N/I:N/A:C",
    "cvss_is_v3": false,
    "repo_name": "xen-project/xen",
    "commit_msg": "gnttab: add missing version check to GNTTABOP_swap_grant_ref handling\n\n... avoiding NULL derefs when the version to use wasn't set yet (via\nGNTTABOP_setup_table or GNTTABOP_set_version).\n\nThis is CVE-2015-4163 / XSA-134.\n\nSigned-off-by: Jan Beulich <jbeulich@suse.com>\nAcked-by: Ian Campbell <ian.campbell@citrix.com>",
    "commit_hash": "5d5c09d853d3f212861f70c577c65d1703f752ae",
    "git_url": "https://github.com/xen-project/xen/commit/5d5c09d853d3f212861f70c577c65d1703f752ae",
    "file_path": "xen/common/grant_table.c",
    "func_name": "__gnttab_swap_grant_ref",
    "func_before": "static s16\n__gnttab_swap_grant_ref(grant_ref_t ref_a, grant_ref_t ref_b)\n{\n    struct domain *d = rcu_lock_current_domain();\n    struct grant_table *gt = d->grant_table;\n    struct active_grant_entry *act;\n    s16 rc = GNTST_okay;\n\n    spin_lock(&gt->lock);\n\n    /* Bounds check on the grant refs */\n    if ( unlikely(ref_a >= nr_grant_entries(d->grant_table)))\n        PIN_FAIL(out, GNTST_bad_gntref, \"Bad ref-a (%d).\\n\", ref_a);\n    if ( unlikely(ref_b >= nr_grant_entries(d->grant_table)))\n        PIN_FAIL(out, GNTST_bad_gntref, \"Bad ref-b (%d).\\n\", ref_b);\n\n    act = &active_entry(gt, ref_a);\n    if ( act->pin )\n        PIN_FAIL(out, GNTST_eagain, \"ref a %ld busy\\n\", (long)ref_a);\n\n    act = &active_entry(gt, ref_b);\n    if ( act->pin )\n        PIN_FAIL(out, GNTST_eagain, \"ref b %ld busy\\n\", (long)ref_b);\n\n    if ( gt->gt_version == 1 )\n    {\n        grant_entry_v1_t shared;\n\n        shared = shared_entry_v1(gt, ref_a);\n        shared_entry_v1(gt, ref_a) = shared_entry_v1(gt, ref_b);\n        shared_entry_v1(gt, ref_b) = shared;\n    }\n    else\n    {\n        grant_entry_v2_t shared;\n        grant_status_t status;\n\n        shared = shared_entry_v2(gt, ref_a);\n        status = status_entry(gt, ref_a);\n\n        shared_entry_v2(gt, ref_a) = shared_entry_v2(gt, ref_b);\n        status_entry(gt, ref_a) = status_entry(gt, ref_b);\n\n        shared_entry_v2(gt, ref_b) = shared;\n        status_entry(gt, ref_b) = status;\n    }\n\nout:\n    spin_unlock(&gt->lock);\n\n    rcu_unlock_domain(d);\n\n    return rc;\n}",
    "abstract_func_before": "static s16\n__gnttab_swap_grant_ref(grant_ref_t VAR_0, grant_ref_t VAR_1)\n{\n    struct domain *VAR_2 = rcu_lock_current_domain();\n    struct grant_table *VAR_3 = VAR_2->grant_table;\n    struct active_grant_entry *VAR_4;\n    s16 VAR_5 = VAR_6;\n\n    spin_lock(&VAR_3->lock);\n\n    /* COMMENT_0 */\n    if ( unlikely(VAR_0 >= nr_grant_entries(VAR_2->grant_table)))\n        PIN_FAIL(VAR_7, VAR_8, \"Bad ref-a (%d).\\n\", VAR_0);\n    if ( unlikely(VAR_1 >= nr_grant_entries(VAR_2->grant_table)))\n        PIN_FAIL(VAR_7, VAR_8, \"Bad ref-b (%d).\\n\", VAR_1);\n\n    VAR_4 = &active_entry(VAR_3, VAR_0);\n    if ( VAR_4->pin )\n        PIN_FAIL(VAR_7, VAR_9, \"ref a %ld busy\\n\", (long)VAR_0);\n\n    VAR_4 = &active_entry(VAR_3, VAR_1);\n    if ( VAR_4->pin )\n        PIN_FAIL(VAR_7, VAR_9, \"ref b %ld busy\\n\", (long)VAR_1);\n\n    if ( VAR_3->gt_version == 1 )\n    {\n        grant_entry_v1_t VAR_10;\n\n        VAR_10 = shared_entry_v1(VAR_3, VAR_0);\n        shared_entry_v1(VAR_3, VAR_0) = shared_entry_v1(VAR_3, VAR_1);\n        shared_entry_v1(VAR_3, VAR_1) = VAR_10;\n    }\n    else\n    {\n        grant_entry_v2_t VAR_10;\n        grant_status_t VAR_11;\n\n        VAR_10 = shared_entry_v2(VAR_3, VAR_0);\n        VAR_11 = status_entry(VAR_3, VAR_0);\n\n        shared_entry_v2(VAR_3, VAR_0) = shared_entry_v2(VAR_3, VAR_1);\n        status_entry(VAR_3, VAR_0) = status_entry(VAR_3, VAR_1);\n\n        shared_entry_v2(VAR_3, VAR_1) = VAR_10;\n        status_entry(VAR_3, VAR_1) = VAR_11;\n    }\n\nout:\n    spin_unlock(&VAR_3->lock);\n\n    rcu_unlock_domain(VAR_2);\n\n    return VAR_5;\n}",
    "func_graph_path_before": "xen-project/xen/5d5c09d853d3f212861f70c577c65d1703f752ae/grant_table.c/vul/before/0.json",
    "func": "static s16\n__gnttab_swap_grant_ref(grant_ref_t ref_a, grant_ref_t ref_b)\n{\n    struct domain *d = rcu_lock_current_domain();\n    struct grant_table *gt = d->grant_table;\n    struct active_grant_entry *act;\n    s16 rc = GNTST_okay;\n\n    spin_lock(&gt->lock);\n\n    if ( gt->gt_version == 0 )\n        PIN_FAIL(out, GNTST_general_error, \"grant table not yet set up\\n\");\n\n    /* Bounds check on the grant refs */\n    if ( unlikely(ref_a >= nr_grant_entries(d->grant_table)))\n        PIN_FAIL(out, GNTST_bad_gntref, \"Bad ref-a (%d).\\n\", ref_a);\n    if ( unlikely(ref_b >= nr_grant_entries(d->grant_table)))\n        PIN_FAIL(out, GNTST_bad_gntref, \"Bad ref-b (%d).\\n\", ref_b);\n\n    act = &active_entry(gt, ref_a);\n    if ( act->pin )\n        PIN_FAIL(out, GNTST_eagain, \"ref a %ld busy\\n\", (long)ref_a);\n\n    act = &active_entry(gt, ref_b);\n    if ( act->pin )\n        PIN_FAIL(out, GNTST_eagain, \"ref b %ld busy\\n\", (long)ref_b);\n\n    if ( gt->gt_version == 1 )\n    {\n        grant_entry_v1_t shared;\n\n        shared = shared_entry_v1(gt, ref_a);\n        shared_entry_v1(gt, ref_a) = shared_entry_v1(gt, ref_b);\n        shared_entry_v1(gt, ref_b) = shared;\n    }\n    else\n    {\n        grant_entry_v2_t shared;\n        grant_status_t status;\n\n        shared = shared_entry_v2(gt, ref_a);\n        status = status_entry(gt, ref_a);\n\n        shared_entry_v2(gt, ref_a) = shared_entry_v2(gt, ref_b);\n        status_entry(gt, ref_a) = status_entry(gt, ref_b);\n\n        shared_entry_v2(gt, ref_b) = shared;\n        status_entry(gt, ref_b) = status;\n    }\n\nout:\n    spin_unlock(&gt->lock);\n\n    rcu_unlock_domain(d);\n\n    return rc;\n}",
    "abstract_func": "static s16\n__gnttab_swap_grant_ref(grant_ref_t VAR_0, grant_ref_t VAR_1)\n{\n    struct domain *VAR_2 = rcu_lock_current_domain();\n    struct grant_table *VAR_3 = VAR_2->grant_table;\n    struct active_grant_entry *VAR_4;\n    s16 VAR_5 = VAR_6;\n\n    spin_lock(&VAR_3->lock);\n\n    if ( VAR_3->gt_version == 0 )\n        PIN_FAIL(VAR_7, VAR_8, \"grant table not yet set up\\n\");\n\n    /* COMMENT_0 */\n    if ( unlikely(VAR_0 >= nr_grant_entries(VAR_2->grant_table)))\n        PIN_FAIL(VAR_7, VAR_9, \"Bad ref-a (%d).\\n\", VAR_0);\n    if ( unlikely(VAR_1 >= nr_grant_entries(VAR_2->grant_table)))\n        PIN_FAIL(VAR_7, VAR_9, \"Bad ref-b (%d).\\n\", VAR_1);\n\n    VAR_4 = &active_entry(VAR_3, VAR_0);\n    if ( VAR_4->pin )\n        PIN_FAIL(VAR_7, VAR_10, \"ref a %ld busy\\n\", (long)VAR_0);\n\n    VAR_4 = &active_entry(VAR_3, VAR_1);\n    if ( VAR_4->pin )\n        PIN_FAIL(VAR_7, VAR_10, \"ref b %ld busy\\n\", (long)VAR_1);\n\n    if ( VAR_3->gt_version == 1 )\n    {\n        grant_entry_v1_t VAR_11;\n\n        VAR_11 = shared_entry_v1(VAR_3, VAR_0);\n        shared_entry_v1(VAR_3, VAR_0) = shared_entry_v1(VAR_3, VAR_1);\n        shared_entry_v1(VAR_3, VAR_1) = VAR_11;\n    }\n    else\n    {\n        grant_entry_v2_t VAR_11;\n        grant_status_t VAR_12;\n\n        VAR_11 = shared_entry_v2(VAR_3, VAR_0);\n        VAR_12 = status_entry(VAR_3, VAR_0);\n\n        shared_entry_v2(VAR_3, VAR_0) = shared_entry_v2(VAR_3, VAR_1);\n        status_entry(VAR_3, VAR_0) = status_entry(VAR_3, VAR_1);\n\n        shared_entry_v2(VAR_3, VAR_1) = VAR_11;\n        status_entry(VAR_3, VAR_1) = VAR_12;\n    }\n\nout:\n    spin_unlock(&VAR_3->lock);\n\n    rcu_unlock_domain(VAR_2);\n\n    return VAR_5;\n}",
    "func_graph_path": "xen-project/xen/5d5c09d853d3f212861f70c577c65d1703f752ae/grant_table.c/vul/after/0.json",
    "diff_func": "--- func_before\n+++ func_after\n@@ -7,6 +7,9 @@\n     s16 rc = GNTST_okay;\n \n     spin_lock(&gt->lock);\n+\n+    if ( gt->gt_version == 0 )\n+        PIN_FAIL(out, GNTST_general_error, \"grant table not yet set up\\n\");\n \n     /* Bounds check on the grant refs */\n     if ( unlikely(ref_a >= nr_grant_entries(d->grant_table)))",
    "diff_line_info": {
        "deleted_lines": [],
        "added_lines": [
            "",
            "    if ( gt->gt_version == 0 )",
            "        PIN_FAIL(out, GNTST_general_error, \"grant table not yet set up\\n\");"
        ]
    },
    "is_vul": true,
    "pr_url": null,
    "description": "no more info"
}