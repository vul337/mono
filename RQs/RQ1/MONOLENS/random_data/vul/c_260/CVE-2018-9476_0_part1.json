{
    "cve_id": "CVE-2018-9476",
    "cwe_ids": [
        "CWE-416"
    ],
    "cvss_vector": "AV:N/AC:L/Au:N/C:C/I:C/A:C",
    "cvss_is_v3": false,
    "repo_name": "android",
    "commit_msg": "DO NOT MERGE AVRC: Copy browse.p_browse_data in btif_av_event_deep_copy\n\np_msg_src->browse.p_browse_data is not copied, but used after the\noriginal pointer is freed\n\nBug: 109699112\nTest: manual\nChange-Id: I1d014eb9a8911da6913173a9b11218bf1c89e16e\n(cherry picked from commit 1d9a58768e6573899c7e80c2b3f52e22f2d8f58b)\n",
    "commit_hash": "dd28d8ddf2985d654781770c691c60b45d7f32b4",
    "git_url": "https://android.googlesource.com/platform/system/bt/+/dd28d8ddf2985d654781770c691c60b45d7f32b4",
    "file_path": "btif/src/btif_av.cc",
    "func_name": "btif_av_event_deep_copy",
    "func_before": "void btif_av_event_deep_copy(uint16_t event, char* p_dest, char* p_src) {\n  BTIF_TRACE_DEBUG(\"%s\", __func__);\n  tBTA_AV* av_src = (tBTA_AV*)p_src;\n  tBTA_AV* av_dest = (tBTA_AV*)p_dest;\n\n  // First copy the structure\n  maybe_non_aligned_memcpy(av_dest, av_src, sizeof(*av_src));\n  switch (event) {\n    case BTA_AV_META_MSG_EVT:\n      if (av_src->meta_msg.p_data && av_src->meta_msg.len) {\n        av_dest->meta_msg.p_data = (uint8_t*)osi_calloc(av_src->meta_msg.len);\n        memcpy(av_dest->meta_msg.p_data, av_src->meta_msg.p_data,\n               av_src->meta_msg.len);\n      }\n\n      if (av_src->meta_msg.p_msg) {\n        av_dest->meta_msg.p_msg = (tAVRC_MSG*)osi_calloc(sizeof(tAVRC_MSG));\n        memcpy(av_dest->meta_msg.p_msg, av_src->meta_msg.p_msg,\n               sizeof(tAVRC_MSG));\n\n        tAVRC_MSG* p_msg_src = av_src->meta_msg.p_msg;\n        tAVRC_MSG* p_msg_dest = av_dest->meta_msg.p_msg;\n\n        if ((p_msg_src->hdr.opcode == AVRC_OP_VENDOR) &&\n            (p_msg_src->vendor.p_vendor_data && p_msg_src->vendor.vendor_len)) {\n          p_msg_dest->vendor.p_vendor_data =\n              (uint8_t*)osi_calloc(p_msg_src->vendor.vendor_len);\n          memcpy(p_msg_dest->vendor.p_vendor_data,\n                 p_msg_src->vendor.p_vendor_data, p_msg_src->vendor.vendor_len);\n        }\n      }\n      break;\n\n    default:\n      break;\n  }\n}",
    "abstract_func_before": "void btif_av_event_deep_copy(uint16_t VAR_0, char* VAR_1, char* VAR_2) {\n  BTIF_TRACE_DEBUG(\"%s\", VAR_3);\n  tBTA_AV* VAR_4 = (tBTA_AV*)VAR_2;\n  tBTA_AV* VAR_5 = (tBTA_AV*)VAR_1;\n\n  /* COMMENT_0 */\n  maybe_non_aligned_memcpy(VAR_5, VAR_4, sizeof(*VAR_4));\n  switch (VAR_0) {\n    case VAR_6:\n      if (VAR_4->meta_msg.p_data && VAR_4->meta_msg.len) {\n        VAR_5->meta_msg.p_data = (uint8_t*)osi_calloc(VAR_4->meta_msg.len);\n        memcpy(VAR_5->meta_msg.p_data, VAR_4->meta_msg.p_data,\n               VAR_4->meta_msg.len);\n      }\n\n      if (VAR_4->meta_msg.p_msg) {\n        VAR_5->meta_msg.p_msg = (tAVRC_MSG*)osi_calloc(sizeof(tAVRC_MSG));\n        memcpy(VAR_5->meta_msg.p_msg, VAR_4->meta_msg.p_msg,\n               sizeof(tAVRC_MSG));\n\n        tAVRC_MSG* VAR_7 = VAR_4->meta_msg.p_msg;\n        tAVRC_MSG* VAR_8 = VAR_5->meta_msg.p_msg;\n\n        if ((VAR_7->hdr.opcode == VAR_9) &&\n            (VAR_7->vendor.p_vendor_data && VAR_7->vendor.vendor_len)) {\n          VAR_8->vendor.p_vendor_data =\n              (uint8_t*)osi_calloc(VAR_7->vendor.vendor_len);\n          memcpy(VAR_8->vendor.p_vendor_data,\n                 VAR_7->vendor.p_vendor_data, VAR_7->vendor.vendor_len);\n        }\n      }\n      break;\n\n    default:\n      break;\n  }\n}",
    "func_graph_path_before": "android/dd28d8ddf2985d654781770c691c60b45d7f32b4/btif_av.cc/vul/before/1.json",
    "func": "void btif_av_event_deep_copy(uint16_t event, char* p_dest, char* p_src) {\n  BTIF_TRACE_DEBUG(\"%s\", __func__);\n  tBTA_AV* av_src = (tBTA_AV*)p_src;\n  tBTA_AV* av_dest = (tBTA_AV*)p_dest;\n\n  // First copy the structure\n  maybe_non_aligned_memcpy(av_dest, av_src, sizeof(*av_src));\n  switch (event) {\n    case BTA_AV_META_MSG_EVT:\n      if (av_src->meta_msg.p_data && av_src->meta_msg.len) {\n        av_dest->meta_msg.p_data = (uint8_t*)osi_calloc(av_src->meta_msg.len);\n        memcpy(av_dest->meta_msg.p_data, av_src->meta_msg.p_data,\n               av_src->meta_msg.len);\n      }\n\n      if (av_src->meta_msg.p_msg) {\n        av_dest->meta_msg.p_msg = (tAVRC_MSG*)osi_calloc(sizeof(tAVRC_MSG));\n        memcpy(av_dest->meta_msg.p_msg, av_src->meta_msg.p_msg,\n               sizeof(tAVRC_MSG));\n\n        tAVRC_MSG* p_msg_src = av_src->meta_msg.p_msg;\n        tAVRC_MSG* p_msg_dest = av_dest->meta_msg.p_msg;\n\n        if ((p_msg_src->hdr.opcode == AVRC_OP_VENDOR) &&\n            (p_msg_src->vendor.p_vendor_data && p_msg_src->vendor.vendor_len)) {\n          p_msg_dest->vendor.p_vendor_data =\n              (uint8_t*)osi_calloc(p_msg_src->vendor.vendor_len);\n          memcpy(p_msg_dest->vendor.p_vendor_data,\n                 p_msg_src->vendor.p_vendor_data, p_msg_src->vendor.vendor_len);\n        }\n        if ((p_msg_src->hdr.opcode == AVRC_OP_BROWSE) &&\n            p_msg_src->browse.p_browse_data && p_msg_src->browse.browse_len) {\n          p_msg_dest->browse.p_browse_data =\n              (uint8_t*)osi_calloc(p_msg_src->browse.browse_len);\n          memcpy(p_msg_dest->browse.p_browse_data,\n                 p_msg_src->browse.p_browse_data, p_msg_src->browse.browse_len);\n          android_errorWriteLog(0x534e4554, \"109699112\");\n        }\n      }\n      break;\n\n    default:\n      break;\n  }\n}",
    "abstract_func": "void btif_av_event_deep_copy(uint16_t VAR_0, char* VAR_1, char* VAR_2) {\n  BTIF_TRACE_DEBUG(\"%s\", VAR_3);\n  tBTA_AV* VAR_4 = (tBTA_AV*)VAR_2;\n  tBTA_AV* VAR_5 = (tBTA_AV*)VAR_1;\n\n  /* COMMENT_0 */\n  maybe_non_aligned_memcpy(VAR_5, VAR_4, sizeof(*VAR_4));\n  switch (VAR_0) {\n    case VAR_6:\n      if (VAR_4->meta_msg.p_data && VAR_4->meta_msg.len) {\n        VAR_5->meta_msg.p_data = (uint8_t*)osi_calloc(VAR_4->meta_msg.len);\n        memcpy(VAR_5->meta_msg.p_data, VAR_4->meta_msg.p_data,\n               VAR_4->meta_msg.len);\n      }\n\n      if (VAR_4->meta_msg.p_msg) {\n        VAR_5->meta_msg.p_msg = (tAVRC_MSG*)osi_calloc(sizeof(tAVRC_MSG));\n        memcpy(VAR_5->meta_msg.p_msg, VAR_4->meta_msg.p_msg,\n               sizeof(tAVRC_MSG));\n\n        tAVRC_MSG* VAR_7 = VAR_4->meta_msg.p_msg;\n        tAVRC_MSG* VAR_8 = VAR_5->meta_msg.p_msg;\n\n        if ((VAR_7->hdr.opcode == VAR_9) &&\n            (VAR_7->vendor.p_vendor_data && VAR_7->vendor.vendor_len)) {\n          VAR_8->vendor.p_vendor_data =\n              (uint8_t*)osi_calloc(VAR_7->vendor.vendor_len);\n          memcpy(VAR_8->vendor.p_vendor_data,\n                 VAR_7->vendor.p_vendor_data, VAR_7->vendor.vendor_len);\n        }\n        if ((VAR_7->hdr.opcode == VAR_10) &&\n            VAR_7->browse.p_browse_data && VAR_7->browse.browse_len) {\n          VAR_8->browse.p_browse_data =\n              (uint8_t*)osi_calloc(VAR_7->browse.browse_len);\n          memcpy(VAR_8->browse.p_browse_data,\n                 VAR_7->browse.p_browse_data, VAR_7->browse.browse_len);\n          android_errorWriteLog(0x534e4554, \"109699112\");\n        }\n      }\n      break;\n\n    default:\n      break;\n  }\n}",
    "func_graph_path": "android/dd28d8ddf2985d654781770c691c60b45d7f32b4/btif_av.cc/vul/after/1.json",
    "diff_func": "--- func_before\n+++ func_after\n@@ -28,6 +28,14 @@\n           memcpy(p_msg_dest->vendor.p_vendor_data,\n                  p_msg_src->vendor.p_vendor_data, p_msg_src->vendor.vendor_len);\n         }\n+        if ((p_msg_src->hdr.opcode == AVRC_OP_BROWSE) &&\n+            p_msg_src->browse.p_browse_data && p_msg_src->browse.browse_len) {\n+          p_msg_dest->browse.p_browse_data =\n+              (uint8_t*)osi_calloc(p_msg_src->browse.browse_len);\n+          memcpy(p_msg_dest->browse.p_browse_data,\n+                 p_msg_src->browse.p_browse_data, p_msg_src->browse.browse_len);\n+          android_errorWriteLog(0x534e4554, \"109699112\");\n+        }\n       }\n       break;\n ",
    "diff_line_info": {
        "deleted_lines": [],
        "added_lines": [
            "        if ((p_msg_src->hdr.opcode == AVRC_OP_BROWSE) &&",
            "            p_msg_src->browse.p_browse_data && p_msg_src->browse.browse_len) {",
            "          p_msg_dest->browse.p_browse_data =",
            "              (uint8_t*)osi_calloc(p_msg_src->browse.browse_len);",
            "          memcpy(p_msg_dest->browse.p_browse_data,",
            "                 p_msg_src->browse.p_browse_data, p_msg_src->browse.browse_len);",
            "          android_errorWriteLog(0x534e4554, \"109699112\");",
            "        }"
        ]
    },
    "is_vul": true,
    "pr_url": null,
    "description": "no more info"
}