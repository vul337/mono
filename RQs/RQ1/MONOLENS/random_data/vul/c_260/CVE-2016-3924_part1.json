{
    "cve_id": "CVE-2016-3924",
    "cwe_ids": [
        "CWE-200"
    ],
    "cvss_vector": "AV:N/AC:M/Au:N/C:P/I:N/A:N",
    "cvss_is_v3": false,
    "repo_name": "android",
    "commit_msg": "Add EFFECT_CMD_SET_PARAM parameter checking\n\nBug: 30204301\nChange-Id: Ib9c3ee1c2f23c96f8f7092dd9e146bc453d7a290\n(cherry picked from commit e4a1d91501d47931dbae19c47815952378787ab6)\n",
    "commit_hash": "c894aa36be535886a8e5ff02cdbcd07dd24618f6",
    "git_url": "https://android.googlesource.com/platform/frameworks/av/+/c894aa36be535886a8e5ff02cdbcd07dd24618f6",
    "file_path": "services/audioflinger/Effects.cpp",
    "func_name": "AudioFlinger::EffectModule::command",
    "func_before": "status_t AudioFlinger::EffectModule::command(uint32_t cmdCode,\n                                             uint32_t cmdSize,\n                                             void *pCmdData,\n                                             uint32_t *replySize,\n                                             void *pReplyData)\n{\n    Mutex::Autolock _l(mLock);\n    ALOGVV(\"command(), cmdCode: %d, mEffectInterface: %p\", cmdCode, mEffectInterface);\n\n    if (mState == DESTROYED || mEffectInterface == NULL) {\n        return NO_INIT;\n    }\n    if (mStatus != NO_ERROR) {\n        return mStatus;\n    }\n    if (cmdCode == EFFECT_CMD_GET_PARAM &&\n            (*replySize < sizeof(effect_param_t) ||\n                    ((effect_param_t *)pCmdData)->psize > *replySize - sizeof(effect_param_t))) {\n        android_errorWriteLog(0x534e4554, \"29251553\");\n        return -EINVAL;\n    }\n    status_t status = (*mEffectInterface)->command(mEffectInterface,\n                                                   cmdCode,\n                                                   cmdSize,\n                                                   pCmdData,\n                                                   replySize,\n                                                   pReplyData);\n    if (cmdCode != EFFECT_CMD_GET_PARAM && status == NO_ERROR) {\n        uint32_t size = (replySize == NULL) ? 0 : *replySize;\n        for (size_t i = 1; i < mHandles.size(); i++) {\n            EffectHandle *h = mHandles[i];\n            if (h != NULL && !h->destroyed_l()) {\n                h->commandExecuted(cmdCode, cmdSize, pCmdData, size, pReplyData);\n            }\n        }\n    }\n    return status;\n}",
    "abstract_func_before": "status_t AudioFlinger::EffectModule::command(uint32_t VAR_0,\n                                             uint32_t VAR_1,\n                                             void *VAR_2,\n                                             uint32_t *VAR_3,\n                                             void *VAR_4)\n{\n    Mutex::Autolock _l(mLock);\n    ALOGVV(\"command(), cmdCode: %d, mEffectInterface: %p\", VAR_0, VAR_5);\n\n    if (VAR_6 == VAR_7 || VAR_5 == NULL) {\n        return VAR_8;\n    }\n    if (VAR_9 != VAR_10) {\n        return VAR_9;\n    }\n    if (VAR_0 == VAR_11 &&\n            (*VAR_3 < sizeof(VAR_12) ||\n                    ((effect_param_t *)VAR_2)->psize > *VAR_3 - sizeof(effect_param_t))) {\n        android_errorWriteLog(0x534e4554, \"29251553\");\n        return -VAR_13;\n    }\n    status_t VAR_14 = (*VAR_5)->command(VAR_5,\n                                                   VAR_0,\n                                                   VAR_1,\n                                                   VAR_2,\n                                                   VAR_3,\n                                                   VAR_4);\n    if (VAR_0 != VAR_11 && VAR_14 == VAR_10) {\n        uint32_t VAR_15 = (VAR_3 == NULL) ? 0 : *VAR_3;\n        for (size_t VAR_16 = 1; VAR_16 < VAR_17.size(); VAR_16++) {\n            EffectHandle *VAR_18 = VAR_17[VAR_16];\n            if (VAR_18 != NULL && !VAR_18->destroyed_l()) {\n                VAR_18->commandExecuted(VAR_0, VAR_1, VAR_2, VAR_15, VAR_4);\n            }\n        }\n    }\n    return VAR_14;\n}",
    "func_graph_path_before": "android/c894aa36be535886a8e5ff02cdbcd07dd24618f6/Effects.cpp/vul/before/0.json",
    "func": "status_t AudioFlinger::EffectModule::command(uint32_t cmdCode,\n                                             uint32_t cmdSize,\n                                             void *pCmdData,\n                                             uint32_t *replySize,\n                                             void *pReplyData)\n{\n    Mutex::Autolock _l(mLock);\n    ALOGVV(\"command(), cmdCode: %d, mEffectInterface: %p\", cmdCode, mEffectInterface);\n\n    if (mState == DESTROYED || mEffectInterface == NULL) {\n        return NO_INIT;\n    }\n    if (mStatus != NO_ERROR) {\n        return mStatus;\n    }\n    if (cmdCode == EFFECT_CMD_GET_PARAM &&\n            (*replySize < sizeof(effect_param_t) ||\n                    ((effect_param_t *)pCmdData)->psize > *replySize - sizeof(effect_param_t))) {\n        android_errorWriteLog(0x534e4554, \"29251553\");\n        return -EINVAL;\n    }\n    if ((cmdCode == EFFECT_CMD_SET_PARAM\n            || cmdCode == EFFECT_CMD_SET_PARAM_DEFERRED) &&  // DEFERRED not generally used\n        (sizeof(effect_param_t) > cmdSize\n            || ((effect_param_t *)pCmdData)->psize > cmdSize\n                                                     - sizeof(effect_param_t)\n            || ((effect_param_t *)pCmdData)->vsize > cmdSize\n                                                     - sizeof(effect_param_t)\n                                                     - ((effect_param_t *)pCmdData)->psize\n            || roundUpDelta(((effect_param_t *)pCmdData)->psize, (uint32_t)sizeof(int)) >\n                                                     cmdSize\n                                                     - sizeof(effect_param_t)\n                                                     - ((effect_param_t *)pCmdData)->psize\n                                                     - ((effect_param_t *)pCmdData)->vsize)) {\n        android_errorWriteLog(0x534e4554, \"30204301\");\n        return -EINVAL;\n    }\n    status_t status = (*mEffectInterface)->command(mEffectInterface,\n                                                   cmdCode,\n                                                   cmdSize,\n                                                   pCmdData,\n                                                   replySize,\n                                                   pReplyData);\n    if (cmdCode != EFFECT_CMD_GET_PARAM && status == NO_ERROR) {\n        uint32_t size = (replySize == NULL) ? 0 : *replySize;\n        for (size_t i = 1; i < mHandles.size(); i++) {\n            EffectHandle *h = mHandles[i];\n            if (h != NULL && !h->destroyed_l()) {\n                h->commandExecuted(cmdCode, cmdSize, pCmdData, size, pReplyData);\n            }\n        }\n    }\n    return status;\n}",
    "abstract_func": "status_t AudioFlinger::EffectModule::command(uint32_t VAR_0,\n                                             uint32_t VAR_1,\n                                             void *VAR_2,\n                                             uint32_t *VAR_3,\n                                             void *VAR_4)\n{\n    Mutex::Autolock _l(mLock);\n    ALOGVV(\"command(), cmdCode: %d, mEffectInterface: %p\", VAR_0, VAR_5);\n\n    if (VAR_6 == VAR_7 || VAR_5 == NULL) {\n        return VAR_8;\n    }\n    if (VAR_9 != VAR_10) {\n        return VAR_9;\n    }\n    if (VAR_0 == VAR_11 &&\n            (*VAR_3 < sizeof(VAR_12) ||\n                    ((effect_param_t *)VAR_2)->psize > *VAR_3 - sizeof(effect_param_t))) {\n        android_errorWriteLog(0x534e4554, \"29251553\");\n        return -VAR_13;\n    }\n    if ((VAR_0 == VAR_14\n            || VAR_0 == VAR_15) &&  /* COMMENT_0 */\n        (sizeof(effect_param_t) > VAR_1\n            || ((effect_param_t *)VAR_2)->psize > VAR_1\n                                                     - sizeof(effect_param_t)\n            || ((effect_param_t *)VAR_2)->vsize > VAR_1\n                                                     - sizeof(effect_param_t)\n                                                     - ((effect_param_t *)VAR_2)->psize\n            || roundUpDelta(((effect_param_t *)VAR_2)->psize, (uint32_t)sizeof(int)) >\n                                                     VAR_1\n                                                     - sizeof(effect_param_t)\n                                                     - ((effect_param_t *)VAR_2)->psize\n                                                     - ((effect_param_t *)VAR_2)->vsize)) {\n        android_errorWriteLog(0x534e4554, \"30204301\");\n        return -VAR_13;\n    }\n    status_t VAR_16 = (*VAR_5)->command(VAR_5,\n                                                   VAR_0,\n                                                   VAR_1,\n                                                   VAR_2,\n                                                   VAR_3,\n                                                   VAR_4);\n    if (VAR_0 != VAR_11 && VAR_16 == VAR_10) {\n        uint32_t VAR_17 = (VAR_3 == NULL) ? 0 : *VAR_3;\n        for (size_t VAR_18 = 1; VAR_18 < VAR_19.size(); VAR_18++) {\n            EffectHandle *VAR_20 = VAR_19[VAR_18];\n            if (VAR_20 != NULL && !VAR_20->destroyed_l()) {\n                VAR_20->commandExecuted(VAR_0, VAR_1, VAR_2, VAR_17, VAR_4);\n            }\n        }\n    }\n    return VAR_16;\n}",
    "func_graph_path": "android/c894aa36be535886a8e5ff02cdbcd07dd24618f6/Effects.cpp/vul/after/0.json",
    "diff_func": "--- func_before\n+++ func_after\n@@ -19,6 +19,22 @@\n         android_errorWriteLog(0x534e4554, \"29251553\");\n         return -EINVAL;\n     }\n+    if ((cmdCode == EFFECT_CMD_SET_PARAM\n+            || cmdCode == EFFECT_CMD_SET_PARAM_DEFERRED) &&  // DEFERRED not generally used\n+        (sizeof(effect_param_t) > cmdSize\n+            || ((effect_param_t *)pCmdData)->psize > cmdSize\n+                                                     - sizeof(effect_param_t)\n+            || ((effect_param_t *)pCmdData)->vsize > cmdSize\n+                                                     - sizeof(effect_param_t)\n+                                                     - ((effect_param_t *)pCmdData)->psize\n+            || roundUpDelta(((effect_param_t *)pCmdData)->psize, (uint32_t)sizeof(int)) >\n+                                                     cmdSize\n+                                                     - sizeof(effect_param_t)\n+                                                     - ((effect_param_t *)pCmdData)->psize\n+                                                     - ((effect_param_t *)pCmdData)->vsize)) {\n+        android_errorWriteLog(0x534e4554, \"30204301\");\n+        return -EINVAL;\n+    }\n     status_t status = (*mEffectInterface)->command(mEffectInterface,\n                                                    cmdCode,\n                                                    cmdSize,",
    "diff_line_info": {
        "deleted_lines": [],
        "added_lines": [
            "    if ((cmdCode == EFFECT_CMD_SET_PARAM",
            "            || cmdCode == EFFECT_CMD_SET_PARAM_DEFERRED) &&  // DEFERRED not generally used",
            "        (sizeof(effect_param_t) > cmdSize",
            "            || ((effect_param_t *)pCmdData)->psize > cmdSize",
            "                                                     - sizeof(effect_param_t)",
            "            || ((effect_param_t *)pCmdData)->vsize > cmdSize",
            "                                                     - sizeof(effect_param_t)",
            "                                                     - ((effect_param_t *)pCmdData)->psize",
            "            || roundUpDelta(((effect_param_t *)pCmdData)->psize, (uint32_t)sizeof(int)) >",
            "                                                     cmdSize",
            "                                                     - sizeof(effect_param_t)",
            "                                                     - ((effect_param_t *)pCmdData)->psize",
            "                                                     - ((effect_param_t *)pCmdData)->vsize)) {",
            "        android_errorWriteLog(0x534e4554, \"30204301\");",
            "        return -EINVAL;",
            "    }"
        ]
    },
    "is_vul": true,
    "pr_url": null,
    "description": "no more info"
}