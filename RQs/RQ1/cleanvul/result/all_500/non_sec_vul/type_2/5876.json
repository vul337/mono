{
  "id": 5876,
  "language": "C/C++",
  "commit_url": "https://github.com/NagiosEnterprises/nagioscore/commit/c29557dec91eba2306f5fb11b8da4474ba63f8c4",
  "commit_sha": "c29557dec91eba2306f5fb11b8da4474ba63f8c4",
  "commit_msg": "Merge branch 'maint'",
  "pr_url": null,
  "pr_info": "no more info",
  "file_name": "base/logging.c",
  "func_name": "open_log_file",
  "func_before": "static FILE *open_log_file(void)\n{\n\tif(log_fp) /* keep it open unless we rotate */\n\t\treturn log_fp;\n\n\tlog_fp = fopen(log_file, \"a+\");\n\tif(log_fp == NULL) {\n\t\tif (daemon_mode == FALSE) {\n\t\t\tprintf(\"Warning: Cannot open log file '%s' for writing\\n\", log_file);\n\t\t\t}\n\t\treturn NULL;\n\t\t}\n\n\t(void)fcntl(fileno(log_fp), F_SETFD, FD_CLOEXEC);\n\treturn log_fp;\n}",
  "func_after": "static FILE *open_log_file(void)\n{\n\tint fh;\n\tstruct stat st;\n\n\tif(log_fp) /* keep it open unless we rotate */\n\t\treturn log_fp;\n\n\tif ((fh = open(log_file, O_RDWR|O_APPEND|O_CREAT|O_NOFOLLOW, S_IRUSR|S_IWUSR)) == -1) {\n\t\tif (daemon_mode == FALSE)\n\t\t\tprintf(\"Warning: Cannot open log file '%s' for writing\\n\", log_file);\n\t\treturn NULL;\n\t}\n\tlog_fp = fdopen(fh, \"a+\");\n\tif(log_fp == NULL) {\n\t\tif (daemon_mode == FALSE)\n\t\t\tprintf(\"Warning: Cannot open log file '%s' for writing\\n\", log_file);\n\t\treturn NULL;\n\t\t}\n\n\tif ((fstat(fh, &st)) == -1) {\n\t\tlog_fp = NULL;\n\t\tclose(fh);\n\t\tif (daemon_mode == FALSE)\n\t\t\tprintf(\"Warning: Cannot fstat log file '%s'\\n\", log_file);\n\t\treturn NULL;\n\t}\n\tif (st.st_nlink != 1 || (st.st_mode & S_IFMT) != S_IFREG) {\n\t\tlog_fp = NULL;\n\t\tclose(fh);\n\t\tif (daemon_mode == FALSE)\n\t\t\tprintf(\"Warning: log file '%s' has an invalid mode\\n\", log_file);\n\t\treturn NULL;\n\t}\n\n\t(void)fcntl(fileno(log_fp), F_SETFD, FD_CLOEXEC);\n\treturn log_fp;\n}",
  "diff_func": "--- func_before\n+++ func_after\n static FILE *open_log_file(void)\n {\n+\tint fh;\n+\tstruct stat st;\n+\n \tif(log_fp) /* keep it open unless we rotate */\n \t\treturn log_fp;\n \n+\tif ((fh = open(log_file, O_RDWR|O_APPEND|O_CREAT|O_NOFOLLOW, S_IRUSR|S_IWUSR)) == -1) {\n+\t\tif (daemon_mode == FALSE)\n+\t\t\tprintf(\"Warning: Cannot open log file '%s' for writing\\n\", log_file);\n+\t\treturn NULL;\n+\t}\n-\tlog_fp = fopen(log_file, \"a+\");\n+\tlog_fp = fdopen(fh, \"a+\");\n \tif(log_fp == NULL) {\n-\t\tif (daemon_mode == FALSE) {\n+\t\tif (daemon_mode == FALSE)\n \t\t\tprintf(\"Warning: Cannot open log file '%s' for writing\\n\", log_file);\n-\t\t\t}\n \t\treturn NULL;\n \t\t}\n+\n+\tif ((fstat(fh, &st)) == -1) {\n+\t\tlog_fp = NULL;\n+\t\tclose(fh);\n+\t\tif (daemon_mode == FALSE)\n+\t\t\tprintf(\"Warning: Cannot fstat log file '%s'\\n\", log_file);\n+\t\treturn NULL;\n+\t}\n+\tif (st.st_nlink != 1 || (st.st_mode & S_IFMT) != S_IFREG) {\n+\t\tlog_fp = NULL;\n+\t\tclose(fh);\n+\t\tif (daemon_mode == FALSE)\n+\t\t\tprintf(\"Warning: log file '%s' has an invalid mode\\n\", log_file);\n+\t\treturn NULL;\n+\t}\n \n \t(void)fcntl(fileno(log_fp), F_SETFD, FD_CLOEXEC);\n \treturn log_fp;\n }",
  "diff_source": "custom",
  "Bug Filter": "Supporting & Non-Core Improvements",
  "Bug Filter Confidence": 0.85,
  "Bug Filter Response": "The patch modifies how a log file is opened and adds security checks, improving robustness without directly fixing a known security issue.\n\n**Final Output:**\n\nThe patch is classified as **Supporting & Non-Core Improvements** with a confidence score of 0.85.\n\n**Final Classification:** Supporting & Non-Core Improvements; **Confidence:** 0.85"
}