{
  "id": 2620,
  "language": "Java",
  "commit_url": "https://github.com/GrapheneOS/platform_frameworks_base/commit/c668064c04be23384a02cc404e49c6261e76e21f",
  "commit_sha": "c668064c04be23384a02cc404e49c6261e76e21f",
  "commit_msg": "[RESTRICT AUTOMERGE]Only allow system and same app to apply relinquishTaskIdentity\n\nAny malicious application could hijack tasks by\nandroid:relinquishTaskIdentity. This vulnerability can perform UI\nspoofing or spy on userâ€™s activities.\n\nThis CL limit the usage which only allow system and same app to apply\nrelinquishTaskIdentity.\n\nBug: 185810717\nTest: atest IntentTests\n      atest testActivityWithRelinquishTaskIdentity\n      atest com.android.server.wm.TaskTests\nChange-Id: I55fe8938cd9a0dd7c0268e1cfec89d4e95eee049",
  "pr_url": null,
  "pr_info": "no more info",
  "file_name": "services/core/java/com/android/server/wm/Task.java",
  "func_name": "processActivity",
  "func_before": "private boolean processActivity(ActivityRecord r,\n                boolean ignoreRelinquishIdentity, boolean setToBottomIfNone) {\n            if (mRoot == null && setToBottomIfNone) {\n                // This is the first activity we are process. Set it as the candidate root in case\n                // we don't find a better one.\n                mRoot = r;\n            }\n\n            if (r.finishing) return false;\n\n            // Set this as the candidate root since it isn't finishing.\n            mRoot = r;\n\n            // Only end search if we are ignore relinquishing identity or we are not relinquishing.\n            return ignoreRelinquishIdentity\n                    || mNeverRelinquishIdentity\n                    || (r.info.flags & FLAG_RELINQUISH_TASK_IDENTITY) == 0;\n        }",
  "func_after": "private boolean processActivity(ActivityRecord r,\n                boolean ignoreRelinquishIdentity, boolean setToBottomIfNone) {\n            if (mRoot == null && setToBottomIfNone) {\n                // This is the first activity we are process. Set it as the candidate root in case\n                // we don't find a better one.\n                mRoot = r;\n            }\n\n            if (r.finishing) return false;\n\n            if (mRoot == null || mRoot.finishing) {\n                // Set this as the candidate root since it isn't finishing.\n                mRoot = r;\n            }\n\n            final int uid = mRoot == r ? effectiveUid : r.info.applicationInfo.uid;\n            if (ignoreRelinquishIdentity\n                    || (mRoot.info.flags & FLAG_RELINQUISH_TASK_IDENTITY) == 0\n                    || (mRoot.info.applicationInfo.uid != Process.SYSTEM_UID\n                    && !mRoot.info.applicationInfo.isSystemApp()\n                    && mRoot.info.applicationInfo.uid != uid)) {\n                // No need to relinquish identity, end search.\n                return true;\n            }\n\n            // Relinquish to next activity\n            mRoot = r;\n            return false;\n        }",
  "diff_func": "--- func_before\n+++ func_after\n private boolean processActivity(ActivityRecord r,\n                 boolean ignoreRelinquishIdentity, boolean setToBottomIfNone) {\n             if (mRoot == null && setToBottomIfNone) {\n                 // This is the first activity we are process. Set it as the candidate root in case\n                 // we don't find a better one.\n                 mRoot = r;\n             }\n \n             if (r.finishing) return false;\n \n+            if (mRoot == null || mRoot.finishing) {\n-            // Set this as the candidate root since it isn't finishing.\n+                // Set this as the candidate root since it isn't finishing.\n+                mRoot = r;\n+            }\n+\n+            final int uid = mRoot == r ? effectiveUid : r.info.applicationInfo.uid;\n+            if (ignoreRelinquishIdentity\n+                    || (mRoot.info.flags & FLAG_RELINQUISH_TASK_IDENTITY) == 0\n+                    || (mRoot.info.applicationInfo.uid != Process.SYSTEM_UID\n+                    && !mRoot.info.applicationInfo.isSystemApp()\n+                    && mRoot.info.applicationInfo.uid != uid)) {\n+                // No need to relinquish identity, end search.\n+                return true;\n+            }\n+\n+            // Relinquish to next activity\n             mRoot = r;\n+            return false;\n-\n-            // Only end search if we are ignore relinquishing identity or we are not relinquishing.\n-            return ignoreRelinquishIdentity\n-                    || mNeverRelinquishIdentity\n-                    || (r.info.flags & FLAG_RELINQUISH_TASK_IDENTITY) == 0;\n         }",
  "diff_source": "custom",
  "Bug Filter": "Security Vulnerability Fix\n\nConfidence Score: 0.95",
  "Bug Filter Confidence": 0.95,
  "Bug Filter Response": "\n\n**Final Output:**\n\nAnalysis:\n- The patch addresses a security vulnerability where malicious applications could exploit the `relinquishTaskIdentity` feature to hijack tasks, leading to UI spoofing or spying.\n- The code changes introduce checks to ensure only the system or the same app can use this feature, preventing unauthorized access and misuse.\n\nFinal Classification: Security Vulnerability Fix\n\nConfidence Score: 0.95"
}