{
  "id": 2019,
  "language": "Java",
  "commit_url": "https://github.com/AOSPA/android_frameworks_base/commit/7221a25a035bc7397492e15460b40395efce7023",
  "commit_sha": "7221a25a035bc7397492e15460b40395efce7023",
  "commit_msg": "[RESTRICT AUTOMERGE]Only allow system and same app to apply relinquishTaskIdentity\n\nAny malicious application could hijack tasks by\nandroid:relinquishTaskIdentity. This vulnerability can perform UI\nspoofing or spy on userâ€™s activities.\n\nThis CL limit the usage which only allow system and same app to apply\nrelinquishTaskIdentity. Based on the condition of updateIdentity from\nTask#setIntent, update the intent with the parent's task together to\nalign with original code logic. Moreover, we shouldn't save launch\nparams for such tasks with null realActivity.\n\nBug: 185810717\nBug: 218243793\nTest: atest IntentTests\n      atest ActivityStarterTests\n      atest TaskRecordTests\n      atest testSplitscreenPortraitAppOrientationRequests\nChange-Id: I42c671e66c39c82be1dcef1f374d56d4593f9f57",
  "pr_url": null,
  "pr_info": "no more info",
  "file_name": "services/core/java/com/android/server/wm/LaunchParamsPersister.java",
  "func_name": "saveTask",
  "func_before": "void saveTask(Task task, DisplayContent display) {\n        final ComponentName name = task.realActivity;\n        final int userId = task.mUserId;\n        PersistableLaunchParams params;\n        ArrayMap<ComponentName, PersistableLaunchParams> map = mLaunchParamsMap.get(userId);\n        if (map == null) {\n            map = new ArrayMap<>();\n            mLaunchParamsMap.put(userId, map);\n        }\n\n        params = map.computeIfAbsent(name, componentName -> new PersistableLaunchParams());\n        final boolean changed = saveTaskToLaunchParam(task, display, params);\n\n        addComponentNameToLaunchParamAffinityMapIfNotNull(name, params.mWindowLayoutAffinity);\n\n        if (changed) {\n            mPersisterQueue.updateLastOrAddItem(\n                    new LaunchParamsWriteQueueItem(userId, name, params),\n                    /* flush */ false);\n        }\n    }",
  "func_after": "void saveTask(Task task, DisplayContent display) {\n        final ComponentName name = task.realActivity;\n        if (name == null) {\n            return;\n        }\n        final int userId = task.mUserId;\n        PersistableLaunchParams params;\n        ArrayMap<ComponentName, PersistableLaunchParams> map = mLaunchParamsMap.get(userId);\n        if (map == null) {\n            map = new ArrayMap<>();\n            mLaunchParamsMap.put(userId, map);\n        }\n\n        params = map.computeIfAbsent(name, componentName -> new PersistableLaunchParams());\n        final boolean changed = saveTaskToLaunchParam(task, display, params);\n\n        addComponentNameToLaunchParamAffinityMapIfNotNull(name, params.mWindowLayoutAffinity);\n\n        if (changed) {\n            mPersisterQueue.updateLastOrAddItem(\n                    new LaunchParamsWriteQueueItem(userId, name, params),\n                    /* flush */ false);\n        }\n    }",
  "diff_func": "--- func_before\n+++ func_after\n void saveTask(Task task, DisplayContent display) {\n         final ComponentName name = task.realActivity;\n+        if (name == null) {\n+            return;\n+        }\n         final int userId = task.mUserId;\n         PersistableLaunchParams params;\n         ArrayMap<ComponentName, PersistableLaunchParams> map = mLaunchParamsMap.get(userId);\n         if (map == null) {\n             map = new ArrayMap<>();\n             mLaunchParamsMap.put(userId, map);\n         }\n \n         params = map.computeIfAbsent(name, componentName -> new PersistableLaunchParams());\n         final boolean changed = saveTaskToLaunchParam(task, display, params);\n \n         addComponentNameToLaunchParamAffinityMapIfNotNull(name, params.mWindowLayoutAffinity);\n \n         if (changed) {\n             mPersisterQueue.updateLastOrAddItem(\n                     new LaunchParamsWriteQueueItem(userId, name, params),\n                     /* flush */ false);\n         }\n     }",
  "diff_source": "custom",
  "Bug Filter": "** Security Vulnerability Fix  \n**Confidence Score:** 1.0",
  "Bug Filter Confidence": 1.0,
  "Bug Filter Response": "\n\nThe patch addresses a security vulnerability by restricting the use of relinquishTaskIdentity to prevent malicious hijacking of tasks. The code change modifies the saveTask function to prevent saving launch parameters for tasks with a null realActivity, thus mitigating the security risk.\n\n**Final Classification:** Security Vulnerability Fix  \n**Confidence Score:** 1.0"
}