{
  "id": 562,
  "language": "Java",
  "commit_url": "https://github.com/apache/pulsar/commit/bf513e24432d51b079f0a9ad5da699d48c2d58b2",
  "commit_sha": "bf513e24432d51b079f0a9ad5da699d48c2d58b2",
  "commit_msg": "[Branch-2.9] Fix passing incorrect authentication data (#16347)",
  "pr_url": "https://github.com/apache/pulsar/pull/16347",
  "pr_info": "### Motivation\r\n\r\nCherry-picked pr #16201\r\n",
  "file_name": "pulsar-broker/src/main/java/org/apache/pulsar/broker/service/ServerCnx.java",
  "func_name": "isTopicOperationAllowed",
  "func_before": "private CompletableFuture<Boolean> isTopicOperationAllowed(TopicName topicName, String subscriptionName,\n                                                               TopicOperation operation) {\n        if (service.isAuthorizationEnabled()) {\n            AuthenticationDataSource authData =\n                    new AuthenticationDataSubscription(getAuthenticationData(), subscriptionName);\n            return isTopicOperationAllowed(topicName, operation, authData);\n        } else {\n            return CompletableFuture.completedFuture(true);\n        }\n    }",
  "func_after": "private CompletableFuture<Boolean> isTopicOperationAllowed(TopicName topicName, String subscriptionName,\n                                                               TopicOperation operation) {\n        if (service.isAuthorizationEnabled()) {\n            AuthenticationDataSource authData =\n                    new AuthenticationDataSubscription(getAuthenticationData(), subscriptionName);\n            AuthenticationDataSource authDataSource =\n                    new AuthenticationDataSubscription(authenticationData, subscriptionName);\n            AuthenticationDataSource originalAuthDataSource = null;\n            if (originalAuthData != null) {\n                originalAuthDataSource = new AuthenticationDataSubscription(originalAuthData, subscriptionName);\n            }\n            return isTopicOperationAllowed(topicName, operation, authDataSource, originalAuthDataSource);\n        } else {\n            return CompletableFuture.completedFuture(true);\n        }\n    }",
  "diff_func": "--- func_before\n+++ func_after\n@@ -407 +409 @@\n-            return isTopicOperationAllowed(topicName, operation, authData);\n+            AuthenticationDataSource authDataSource =\n+                    new AuthenticationDataSubscription(authenticationData, subscriptionName);\n+            AuthenticationDataSource originalAuthDataSource = null;\n+            if (originalAuthData != null) {\n+                originalAuthDataSource = new AuthenticationDataSubscription(originalAuthData, subscriptionName);\n+            }\n@@ -442 +450 @@\n-            isTopicOperationAllowed(topicName, TopicOperation.LOOKUP, getAuthenticationData()).thenApply(\n+            isTopicOperationAllowed(topicName, TopicOperation.LOOKUP, authenticationData, originalAuthData).thenApply(\n isAuthorized -> {\n if (isAuthorized) {\n lookupTopicAsync(getBrokerService().pulsar(), topicName, authoritative,\n-            isTopicOperationAllowed(topicName, TopicOperation.LOOKUP, getAuthenticationData()).thenApply(\n+            isTopicOperationAllowed(topicName, TopicOperation.LOOKUP, authenticationData, originalAuthData).thenApply(\n isAuthorized -> {\n if (isAuthorized) {\n unsafeGetPartitionedTopicMetadataAsync(getBrokerService().pulsar(), topicName)",
  "diff_source": "api",
  "Bug Filter": "Security Vulnerability Fix  \nConfidence Score: 0.95",
  "Bug Filter Confidence": 0.95,
  "Bug Filter Response": "\n\n**Final Output:**\n\nAnalysis: The patch modifies the `isTopicOperationAllowed` function to correctly handle authentication data, preventing potential unauthorized access. The changes suggest fixing an issue where incorrect data was passed, which could have led to security breaches.\n\nFinal Classification: Security Vulnerability Fix  \nConfidence Score: 0.95"
}