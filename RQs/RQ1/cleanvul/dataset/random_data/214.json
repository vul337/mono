{
  "id": 214,
  "language": "Java",
  "commit_url": "https://github.com/aosp-mirror/platform_frameworks_base/commit/480a28fc3dae4497da8249dae8dbf71fcac1643c",
  "commit_sha": "480a28fc3dae4497da8249dae8dbf71fcac1643c",
  "commit_msg": "[RESTRICT AUTOMERGE] [SettingsProvider] mem limit should be checked before settings are updated\n\nPreviously, a setting is updated before the memory usage limit\ncheck, which can be exploited by malicious apps and cause OoM DoS.\n\nThis CL changes the logic to checkMemLimit -> update -> updateMemUsage.\n\nBUG: 239415861\nTest: atest com.android.providers.settings.SettingsStateTest\n\n(cherry picked from commit 8eeb92950f4a7012d4cf282106a1418fd211f475)\nMerged-In: I20551a2dba9aa79efa0c064824f349f551c2c2e4\nChange-Id: I20551a2dba9aa79efa0c064824f349f551c2c2e4\n(cherry picked from commit de2ba563d737ad3e8dae97fb488afdc7967e827e)\nMerged-In: I20551a2dba9aa79efa0c064824f349f551c2c2e4",
  "pr_url": null,
  "pr_info": "no more info",
  "file_name": "packages/SettingsProvider/src/com/android/providers/settings/SettingsState.java",
  "func_name": "GuardedBy",
  "func_before": "@GuardedBy(\"mLock\")\n    public void resetSettingDefaultValueLocked(String name) {\n        Setting oldSetting = getSettingLocked(name);\n        if (oldSetting != null && !oldSetting.isNull() && oldSetting.getDefaultValue() != null) {\n            String oldValue = oldSetting.getValue();\n            String oldDefaultValue = oldSetting.getDefaultValue();\n            Setting newSetting = new Setting(name, oldSetting.getValue(), null,\n                    oldSetting.getPackageName(), oldSetting.getTag(), false,\n                    oldSetting.getId());\n            mSettings.put(name, newSetting);\n            updateMemoryUsagePerPackageLocked(newSetting.getPackageName(), oldValue,\n                    newSetting.getValue(), oldDefaultValue, newSetting.getDefaultValue());\n            scheduleWriteIfNeededLocked();\n        }\n    }",
  "func_after": "@GuardedBy(\"mLock\")\n    public void resetSettingDefaultValueLocked(String name) {\n        Setting oldSetting = getSettingLocked(name);\n        if (oldSetting != null && !oldSetting.isNull() && oldSetting.getDefaultValue() != null) {\n            String oldValue = oldSetting.getValue();\n            String oldDefaultValue = oldSetting.getDefaultValue();\n            Setting newSetting = new Setting(name, oldSetting.getValue(), null,\n                    oldSetting.getPackageName(), oldSetting.getTag(), false,\n                    oldSetting.getId());\n            int newSize = getNewMemoryUsagePerPackageLocked(newSetting.getPackageName(), oldValue,\n                    newSetting.getValue(), oldDefaultValue, newSetting.getDefaultValue());\n            checkNewMemoryUsagePerPackageLocked(newSetting.getPackageName(), newSize);\n            mSettings.put(name, newSetting);\n            updateMemoryUsagePerPackageLocked(newSetting.getPackageName(), newSize);\n            scheduleWriteIfNeededLocked();\n        }\n    }",
  "diff_func": "--- func_before\n+++ func_after\n @GuardedBy(\"mLock\")\n     public void resetSettingDefaultValueLocked(String name) {\n         Setting oldSetting = getSettingLocked(name);\n         if (oldSetting != null && !oldSetting.isNull() && oldSetting.getDefaultValue() != null) {\n             String oldValue = oldSetting.getValue();\n             String oldDefaultValue = oldSetting.getDefaultValue();\n             Setting newSetting = new Setting(name, oldSetting.getValue(), null,\n                     oldSetting.getPackageName(), oldSetting.getTag(), false,\n                     oldSetting.getId());\n+            int newSize = getNewMemoryUsagePerPackageLocked(newSetting.getPackageName(), oldValue,\n+                    newSetting.getValue(), oldDefaultValue, newSetting.getDefaultValue());\n+            checkNewMemoryUsagePerPackageLocked(newSetting.getPackageName(), newSize);\n             mSettings.put(name, newSetting);\n-            updateMemoryUsagePerPackageLocked(newSetting.getPackageName(), oldValue,\n+            updateMemoryUsagePerPackageLocked(newSetting.getPackageName(), newSize);\n-                    newSetting.getValue(), oldDefaultValue, newSetting.getDefaultValue());\n             scheduleWriteIfNeededLocked();\n         }\n     }",
  "diff_source": "custom"
}