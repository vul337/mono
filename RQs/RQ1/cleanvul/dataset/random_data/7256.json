{
  "id": 7256,
  "language": "C/C++",
  "commit_url": "https://github.com/openenclave/openenclave/commit/bcac8e7acb514429fee9e0b5d0c7a0308fd4d76b",
  "commit_sha": "bcac8e7acb514429fee9e0b5d0c7a0308fd4d76b",
  "commit_msg": "Merge pull request from GHSA-525h-wxcc-f66m\n\nSigned-off-by: Ming-Wei Shih <mishih@microsoft.com>",
  "pr_url": null,
  "pr_info": "no more info",
  "file_name": "syscall/devices/hostsock/hostsock.c",
  "func_name": "_hostsock_getpeername",
  "func_before": "static int _hostsock_getpeername(\n    oe_fd_t* sock_,\n    struct oe_sockaddr* addr,\n    oe_socklen_t* addrlen)\n{\n    int ret = -1;\n    sock_t* sock = _cast_sock(sock_);\n    oe_socklen_t addrlen_in = 0;\n\n    oe_errno = 0;\n\n    if (!sock)\n        OE_RAISE_ERRNO(OE_EINVAL);\n\n    if (addrlen)\n        addrlen_in = *addrlen;\n\n    if (oe_syscall_getpeername_ocall(\n            &ret,\n            sock->host_fd,\n            (struct oe_sockaddr*)addr,\n            addrlen_in,\n            addrlen) != OE_OK)\n    {\n        OE_RAISE_ERRNO(OE_EINVAL);\n    }\n\ndone:\n\n    return ret;\n}",
  "func_after": "static int _hostsock_getpeername(\n    oe_fd_t* sock_,\n    struct oe_sockaddr* addr,\n    oe_socklen_t* addrlen)\n{\n    int ret = -1;\n    sock_t* sock = _cast_sock(sock_);\n    oe_socklen_t addrlen_in = 0;\n    oe_socklen_t addrlen_out = 0;\n\n    oe_errno = 0;\n\n    if (!sock || !addr || !addrlen)\n        OE_RAISE_ERRNO(OE_EINVAL);\n\n    addrlen_in = *addrlen;\n    if (addrlen_in < 0)\n        OE_RAISE_ERRNO(OE_EINVAL);\n\n    if (oe_syscall_getpeername_ocall(\n            &ret,\n            sock->host_fd,\n            (struct oe_sockaddr*)addr,\n            addrlen_in,\n            &addrlen_out) != OE_OK)\n    {\n        OE_RAISE_ERRNO(OE_EINVAL);\n    }\n\n    /*\n     * Error out the case if the addrlen_out is greater than the size\n     * of sockaddr_storage.\n     */\n    if (addrlen_out > sizeof(struct oe_sockaddr_storage))\n        OE_RAISE_ERRNO(OE_EINVAL);\n\n    /*\n     * Note that the returned value can still exceed the supplied one,\n     * which indicates a truncation. Refer to\n     * https://pubs.opengroup.org/onlinepubs/9699919799/functions/getpeername.html\n     * for more detail.\n     */\n    *addrlen = addrlen_out;\n\ndone:\n\n    return ret;\n}",
  "diff_func": "--- func_before\n+++ func_after\n static int _hostsock_getpeername(\n     oe_fd_t* sock_,\n     struct oe_sockaddr* addr,\n     oe_socklen_t* addrlen)\n {\n     int ret = -1;\n     sock_t* sock = _cast_sock(sock_);\n     oe_socklen_t addrlen_in = 0;\n+    oe_socklen_t addrlen_out = 0;\n \n     oe_errno = 0;\n \n-    if (!sock)\n+    if (!sock || !addr || !addrlen)\n         OE_RAISE_ERRNO(OE_EINVAL);\n \n-    if (addrlen)\n-        addrlen_in = *addrlen;\n+    addrlen_in = *addrlen;\n+    if (addrlen_in < 0)\n+        OE_RAISE_ERRNO(OE_EINVAL);\n \n     if (oe_syscall_getpeername_ocall(\n             &ret,\n             sock->host_fd,\n             (struct oe_sockaddr*)addr,\n             addrlen_in,\n-            addrlen) != OE_OK)\n+            &addrlen_out) != OE_OK)\n     {\n         OE_RAISE_ERRNO(OE_EINVAL);\n     }\n+\n+    /*\n+     * Error out the case if the addrlen_out is greater than the size\n+     * of sockaddr_storage.\n+     */\n+    if (addrlen_out > sizeof(struct oe_sockaddr_storage))\n+        OE_RAISE_ERRNO(OE_EINVAL);\n+\n+    /*\n+     * Note that the returned value can still exceed the supplied one,\n+     * which indicates a truncation. Refer to\n+     * https://pubs.opengroup.org/onlinepubs/9699919799/functions/getpeername.html\n+     * for more detail.\n+     */\n+    *addrlen = addrlen_out;\n \n done:\n \n     return ret;\n }",
  "diff_source": "custom"
}