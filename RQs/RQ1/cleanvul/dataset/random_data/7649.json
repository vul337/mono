{
  "id": 7649,
  "language": "JavaScript",
  "commit_url": "https://github.com/grafana/piechart-panel/commit/d06702de9949d50287806a53f341ceeb6f49789f",
  "commit_sha": "d06702de9949d50287806a53f341ceeb6f49789f",
  "commit_msg": "Sanitize legend data",
  "pr_url": "https://github.com/grafana/piechart-panel/pull/163",
  "pr_info": "Sanitizes user-supplied data in the piechart.\r\n\r\nAdds no new dependencies, just makes use of the already installed lodash.",
  "file_name": "dist/legend.js",
  "func_name": "render",
  "func_before": "function render() {\n              if (panel.legendType === \"On graph\" || !panel.legend.show) {\n                $container.empty();\n                elem.find(\".piechart-legend\").css(\"padding-top\", 0);\n                return;\n              } else {\n                elem.find(\".piechart-legend\").css(\"padding-top\", 6);\n              }\n\n              if (firstRender) {\n                elem.append($container);\n                $container.on(\"click\", \".piechart-legend-icon\", openColorSelector);\n                $container.on(\"click\", \".piechart-legend-alias\", toggleSeries);\n                $container.on(\"click\", \"th\", sortLegend);\n                firstRender = false;\n              }\n\n              seriesList = data;\n              dataList = ctrl.data;\n\n              $container.empty();\n\n              var width = panel.legendType == \"Right side\" && panel.legend.sideWidth ? panel.legend.sideWidth + \"px\" : \"\";\n              var ieWidth = panel.legendType == \"Right side\" && panel.legend.sideWidth ? panel.legend.sideWidth - 1 + \"px\" : \"\";\n              elem.css(\"min-width\", width);\n              elem.css(\"width\", ieWidth);\n\n              var showValues = panel.legend.values || panel.legend.percentage;\n              var tableLayout = (panel.legendType === \"Under graph\" || panel.legendType === \"Right side\") && showValues;\n\n              $container.toggleClass(\"piechart-legend-table\", tableLayout);\n\n              var legendHeader;\n              if (tableLayout) {\n                var header = '<tr><th colspan=\"2\" style=\"text-align:left\"></th>';\n                if (panel.legend.values) {\n                  header += getLegendHeaderHtml(ctrl.panel.valueName);\n                }\n                if (panel.legend.percentage) {\n                  header += getLegendPercentageHtml(ctrl.panel.valueName);\n                }\n                header += \"</tr>\";\n                legendHeader = $(header);\n              }\n\n              if (panel.legend.percentage) {\n                var total = 0;\n                for (i = 0; i < seriesList.length; i++) {\n                  total += seriesList[i].stats[ctrl.panel.valueName];\n                }\n              }\n\n              var seriesShown = 0;\n              var seriesElements = [];\n\n              for (i = 0; i < seriesList.length; i++) {\n                var series = seriesList[i];\n                var seriesData = dataList[i];\n\n                // ignore empty series\n                if (panel.legend.hideEmpty && series.allIsNull) {\n                  continue;\n                }\n                // ignore series excluded via override\n                if (!series.legend) {\n                  continue;\n                }\n\n                var decimal = 0;\n                if (ctrl.panel.legend.percentageDecimals) {\n                  decimal = ctrl.panel.legend.percentageDecimals;\n                }\n\n                var html = '<div class=\"piechart-legend-series';\n                if (ctrl.hiddenSeries[seriesData.label]) {\n                  html += \" piechart-legend-series-hidden\";\n                }\n                html += '\" data-series-index=\"' + i + '\">';\n                html += '<span class=\"piechart-legend-icon\" style=\"float:none;\">';\n                html += '<i class=\"fa fa-minus pointer\" style=\"color:' + seriesData.color + '\"></i>';\n                html += \"</span>\";\n\n                html += '<a class=\"piechart-legend-alias\" style=\"float:none;\">' + seriesData.label + \"</a>\";\n\n                if (showValues && tableLayout) {\n                  var value = seriesData.legendData;\n                  if (panel.legend.values) {\n                    html += '<div class=\"piechart-legend-value\">' + ctrl.formatValue(value) + \"</div>\";\n                  }\n                  if (total) {\n                    var pvalue = (value / total * 100).toFixed(decimal) + \"%\";\n                    html += '<div class=\"piechart-legend-value\">' + pvalue + \"</div>\";\n                  }\n                }\n\n                html += \"</div>\";\n\n                seriesElements.push($(html));\n                seriesShown++;\n              }\n              if (tableLayout) {\n                var topPadding = 6;\n                var tbodyElem = $(\"<tbody></tbody>\");\n                // tbodyElem.css(\"max-height\", maxHeight - topPadding);\n                tbodyElem.append(legendHeader);\n                tbodyElem.append(seriesElements);\n                $container.append(tbodyElem);\n              } else {\n                $container.append(seriesElements);\n              }\n\n              if (panel.legendType === \"Under graph\") {\n                addScrollbar();\n              } else {\n                destroyScrollbar();\n              }\n            }",
  "func_after": "function render() {\n              if (panel.legendType === \"On graph\" || !panel.legend.show) {\n                $container.empty();\n                elem.find(\".piechart-legend\").css(\"padding-top\", 0);\n                return;\n              } else {\n                elem.find(\".piechart-legend\").css(\"padding-top\", 6);\n              }\n\n              if (firstRender) {\n                elem.append($container);\n                $container.on(\"click\", \".piechart-legend-icon\", openColorSelector);\n                $container.on(\"click\", \".piechart-legend-alias\", toggleSeries);\n                $container.on(\"click\", \"th\", sortLegend);\n                firstRender = false;\n              }\n\n              seriesList = data;\n              dataList = ctrl.data;\n\n              $container.empty();\n\n              var width = panel.legendType == \"Right side\" && panel.legend.sideWidth ? panel.legend.sideWidth + \"px\" : \"\";\n              var ieWidth = panel.legendType == \"Right side\" && panel.legend.sideWidth ? panel.legend.sideWidth - 1 + \"px\" : \"\";\n              elem.css(\"min-width\", width);\n              elem.css(\"width\", ieWidth);\n\n              var showValues = panel.legend.values || panel.legend.percentage;\n              var tableLayout = (panel.legendType === \"Under graph\" || panel.legendType === \"Right side\") && showValues;\n\n              $container.toggleClass(\"piechart-legend-table\", tableLayout);\n\n              var legendHeader;\n              if (tableLayout) {\n                var header = '<tr><th colspan=\"2\" style=\"text-align:left\"></th>';\n                if (panel.legend.values) {\n                  header += getLegendHeaderHtml(ctrl.panel.valueName);\n                }\n                if (panel.legend.percentage) {\n                  header += getLegendPercentageHtml(ctrl.panel.valueName);\n                }\n                header += \"</tr>\";\n                legendHeader = $(header);\n              }\n\n              if (panel.legend.percentage) {\n                var total = 0;\n                for (i = 0; i < seriesList.length; i++) {\n                  total += seriesList[i].stats[ctrl.panel.valueName];\n                }\n              }\n\n              var seriesShown = 0;\n              var seriesElements = [];\n\n              for (i = 0; i < seriesList.length; i++) {\n                var series = seriesList[i];\n                var seriesData = dataList[i];\n\n                // ignore empty series\n                if (panel.legend.hideEmpty && series.allIsNull) {\n                  continue;\n                }\n                // ignore series excluded via override\n                if (!series.legend) {\n                  continue;\n                }\n\n                var decimal = 0;\n                if (ctrl.panel.legend.percentageDecimals) {\n                  decimal = ctrl.panel.legend.percentageDecimals;\n                }\n\n                var html = '<div class=\"piechart-legend-series';\n                if (ctrl.hiddenSeries[seriesData.label]) {\n                  html += \" piechart-legend-series-hidden\";\n                }\n                html += '\" data-series-index=\"' + i + '\">';\n                html += '<span class=\"piechart-legend-icon\" style=\"float:none;\">';\n                html += '<i class=\"fa fa-minus pointer\" style=\"color:' + seriesData.color + '\"></i>';\n                html += \"</span>\";\n\n                html += '<a class=\"piechart-legend-alias\" style=\"float:none;\">' + _.escape(seriesData.label) + \"</a>\";\n\n                if (showValues && tableLayout) {\n                  var value = seriesData.legendData;\n                  if (panel.legend.values) {\n                    html += '<div class=\"piechart-legend-value\">' + ctrl.formatValue(value) + \"</div>\";\n                  }\n                  if (total) {\n                    var pvalue = (value / total * 100).toFixed(decimal) + \"%\";\n                    html += '<div class=\"piechart-legend-value\">' + pvalue + \"</div>\";\n                  }\n                }\n\n                html += \"</div>\";\n\n                seriesElements.push($(html));\n                seriesShown++;\n              }\n              if (tableLayout) {\n                var topPadding = 6;\n                var tbodyElem = $(\"<tbody></tbody>\");\n                // tbodyElem.css(\"max-height\", maxHeight - topPadding);\n                tbodyElem.append(legendHeader);\n                tbodyElem.append(seriesElements);\n                $container.append(tbodyElem);\n              } else {\n                $container.append(seriesElements);\n              }\n\n              if (panel.legendType === \"Under graph\") {\n                addScrollbar();\n              } else {\n                destroyScrollbar();\n              }\n            }",
  "diff_func": "--- func_before\n+++ func_after\n function render() {\n               if (panel.legendType === \"On graph\" || !panel.legend.show) {\n                 $container.empty();\n                 elem.find(\".piechart-legend\").css(\"padding-top\", 0);\n                 return;\n               } else {\n                 elem.find(\".piechart-legend\").css(\"padding-top\", 6);\n               }\n \n               if (firstRender) {\n                 elem.append($container);\n                 $container.on(\"click\", \".piechart-legend-icon\", openColorSelector);\n                 $container.on(\"click\", \".piechart-legend-alias\", toggleSeries);\n                 $container.on(\"click\", \"th\", sortLegend);\n                 firstRender = false;\n               }\n \n               seriesList = data;\n               dataList = ctrl.data;\n \n               $container.empty();\n \n               var width = panel.legendType == \"Right side\" && panel.legend.sideWidth ? panel.legend.sideWidth + \"px\" : \"\";\n               var ieWidth = panel.legendType == \"Right side\" && panel.legend.sideWidth ? panel.legend.sideWidth - 1 + \"px\" : \"\";\n               elem.css(\"min-width\", width);\n               elem.css(\"width\", ieWidth);\n \n               var showValues = panel.legend.values || panel.legend.percentage;\n               var tableLayout = (panel.legendType === \"Under graph\" || panel.legendType === \"Right side\") && showValues;\n \n               $container.toggleClass(\"piechart-legend-table\", tableLayout);\n \n               var legendHeader;\n               if (tableLayout) {\n                 var header = '<tr><th colspan=\"2\" style=\"text-align:left\"></th>';\n                 if (panel.legend.values) {\n                   header += getLegendHeaderHtml(ctrl.panel.valueName);\n                 }\n                 if (panel.legend.percentage) {\n                   header += getLegendPercentageHtml(ctrl.panel.valueName);\n                 }\n                 header += \"</tr>\";\n                 legendHeader = $(header);\n               }\n \n      ",
  "diff_source": "custom"
}