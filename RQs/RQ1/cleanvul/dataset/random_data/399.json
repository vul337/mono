{
  "id": 399,
  "language": "Java",
  "commit_url": "https://github.com/aosp-mirror/platform_frameworks_base/commit/7221a25a035bc7397492e15460b40395efce7023",
  "commit_sha": "7221a25a035bc7397492e15460b40395efce7023",
  "commit_msg": "[RESTRICT AUTOMERGE]Only allow system and same app to apply relinquishTaskIdentity\n\nAny malicious application could hijack tasks by\nandroid:relinquishTaskIdentity. This vulnerability can perform UI\nspoofing or spy on userâ€™s activities.\n\nThis CL limit the usage which only allow system and same app to apply\nrelinquishTaskIdentity. Based on the condition of updateIdentity from\nTask#setIntent, update the intent with the parent's task together to\nalign with original code logic. Moreover, we shouldn't save launch\nparams for such tasks with null realActivity.\n\nBug: 185810717\nBug: 218243793\nTest: atest IntentTests\n      atest ActivityStarterTests\n      atest TaskRecordTests\n      atest testSplitscreenPortraitAppOrientationRequests\nChange-Id: I42c671e66c39c82be1dcef1f374d56d4593f9f57",
  "pr_url": null,
  "pr_info": "no more info",
  "file_name": "services/core/java/com/android/server/wm/Task.java",
  "func_name": "processActivity",
  "func_before": "private boolean processActivity(ActivityRecord r,\n                boolean ignoreRelinquishIdentity, boolean setToBottomIfNone) {\n            if (mRoot == null && setToBottomIfNone) {\n                // This is the first activity we are process. Set it as the candidate root in case\n                // we don't find a better one.\n                mRoot = r;\n            }\n\n            if (r.finishing) return false;\n\n            // Set this as the candidate root since it isn't finishing.\n            mRoot = r;\n\n            // Only end search if we are ignore relinquishing identity or we are not relinquishing.\n            return ignoreRelinquishIdentity || (r.info.flags & FLAG_RELINQUISH_TASK_IDENTITY) == 0;\n        }",
  "func_after": "private boolean processActivity(ActivityRecord r,\n                boolean ignoreRelinquishIdentity, boolean setToBottomIfNone) {\n            if (mRoot == null && setToBottomIfNone) {\n                // This is the first activity we are process. Set it as the candidate root in case\n                // we don't find a better one.\n                mRoot = r;\n            }\n\n            if (r.finishing) return false;\n\n            if (mRoot == null || mRoot.finishing) {\n                // Set this as the candidate root since it isn't finishing.\n                mRoot = r;\n            }\n\n            final int uid = mRoot == r ? effectiveUid : r.info.applicationInfo.uid;\n            if (ignoreRelinquishIdentity\n                    || (mRoot.info.flags & FLAG_RELINQUISH_TASK_IDENTITY) == 0\n                    || (mRoot.info.applicationInfo.uid != Process.SYSTEM_UID\n                    && !mRoot.info.applicationInfo.isSystemApp()\n                    && mRoot.info.applicationInfo.uid != uid)) {\n                // No need to relinquish identity, end search.\n                return true;\n            }\n\n            // Relinquish to next activity\n            mRoot = r;\n            return false;\n        }",
  "diff_func": "--- func_before\n+++ func_after\n private boolean processActivity(ActivityRecord r,\n                 boolean ignoreRelinquishIdentity, boolean setToBottomIfNone) {\n             if (mRoot == null && setToBottomIfNone) {\n                 // This is the first activity we are process. Set it as the candidate root in case\n                 // we don't find a better one.\n                 mRoot = r;\n             }\n \n             if (r.finishing) return false;\n \n+            if (mRoot == null || mRoot.finishing) {\n-            // Set this as the candidate root since it isn't finishing.\n+                // Set this as the candidate root since it isn't finishing.\n+                mRoot = r;\n+            }\n+\n+            final int uid = mRoot == r ? effectiveUid : r.info.applicationInfo.uid;\n+            if (ignoreRelinquishIdentity\n+                    || (mRoot.info.flags & FLAG_RELINQUISH_TASK_IDENTITY) == 0\n+                    || (mRoot.info.applicationInfo.uid != Process.SYSTEM_UID\n+                    && !mRoot.info.applicationInfo.isSystemApp()\n+                    && mRoot.info.applicationInfo.uid != uid)) {\n+                // No need to relinquish identity, end search.\n+                return true;\n+            }\n+\n+            // Relinquish to next activity\n             mRoot = r;\n+            return false;\n-\n-            // Only end search if we are ignore relinquishing identity or we are not relinquishing.\n-            return ignoreRelinquishIdentity || (r.info.flags & FLAG_RELINQUISH_TASK_IDENTITY) == 0;\n         }",
  "diff_source": "custom"
}