{
  "id": 4296,
  "language": "C/C++",
  "commit_url": "https://github.com/git-for-windows/git/commit/98d736c01e9642cd5d5c5716dba6cffd65890316",
  "commit_sha": "98d736c01e9642cd5d5c5716dba6cffd65890316",
  "commit_msg": "winansi: check result and Buffer before using Name\n\nNtQueryObject under Wine can return a success but fill out no name.\nIn those situations, Wine will set Buffer to NULL, and set result to\nthe sizeof(OBJECT_NAME_INFORMATION).\n\nRunning a command such as\n\necho \"$(git.exe --version 2>/dev/null)\"\n\nwill crash due to a NULL pointer dereference when the code attempts to\nnull terminate the buffer, although, weirdly, removing the subshell or\nredirecting stdout to a file will not trigger the crash.\n\nCode has been added to also check Buffer and Length to ensure the check\nis as robust as possible due to the current behavior being fragile at\nbest, and could potentially change in the future\n\nThis code is based on the behavior of NtQueryObject under wine and\nreactos.\n\nSigned-off-by: Christopher Degawa <ccom@randomderp.com>",
  "pr_url": "https://github.com/git-for-windows/git/pull/4219",
  "pr_info": "This PR takes the embargoed release tag `v2.39.1.windows.1` and merges it into the `main` branch.\r\n\r\nIt likely that I messed something up in the order of releasing the security release and merging the [security advisory](https://github.com/git-for-windows/git/security/advisories/GHSA-v4px-mx59-w99c).",
  "file_name": "compat/winansi.c",
  "func_name": "detect_msys_tty",
  "func_before": "static void detect_msys_tty(int fd)\n{\n\tULONG result;\n\tBYTE buffer[1024];\n\tPOBJECT_NAME_INFORMATION nameinfo = (POBJECT_NAME_INFORMATION) buffer;\n\tPWSTR name;\n\n\t/* check if fd is a pipe */\n\tHANDLE h = (HANDLE) _get_osfhandle(fd);\n\tif (GetFileType(h) != FILE_TYPE_PIPE)\n\t\treturn;\n\n\t/* get pipe name */\n\tif (!NT_SUCCESS(NtQueryObject(h, ObjectNameInformation,\n\t\t\tbuffer, sizeof(buffer) - 2, &result)))\n\t\treturn;\n\tname = nameinfo->Name.Buffer;\n\tname[nameinfo->Name.Length / sizeof(*name)] = 0;\n\n\t/*\n\t * Check if this could be a MSYS2 pty pipe ('msys-XXXX-ptyN-XX')\n\t * or a cygwin pty pipe ('cygwin-XXXX-ptyN-XX')\n\t */\n\tif ((!wcsstr(name, L\"msys-\") && !wcsstr(name, L\"cygwin-\")) ||\n\t\t\t!wcsstr(name, L\"-pty\"))\n\t\treturn;\n\n\tif (fd == 2)\n\t\tsetvbuf(stderr, NULL, _IONBF, BUFSIZ);\n\tfd_is_interactive[fd] |= FD_MSYS;\n}",
  "func_after": "static void detect_msys_tty(int fd)\n{\n\tULONG result;\n\tBYTE buffer[1024];\n\tPOBJECT_NAME_INFORMATION nameinfo = (POBJECT_NAME_INFORMATION) buffer;\n\tPWSTR name;\n\n\t/* check if fd is a pipe */\n\tHANDLE h = (HANDLE) _get_osfhandle(fd);\n\tif (GetFileType(h) != FILE_TYPE_PIPE)\n\t\treturn;\n\n\t/* get pipe name */\n\tif (!NT_SUCCESS(NtQueryObject(h, ObjectNameInformation,\n\t\t\tbuffer, sizeof(buffer) - 2, &result)))\n\t\treturn;\n\tif (result < sizeof(*nameinfo) || !nameinfo->Name.Buffer ||\n\t\t!nameinfo->Name.Length)\n\t\treturn;\n\tname = nameinfo->Name.Buffer;\n\tname[nameinfo->Name.Length / sizeof(*name)] = 0;\n\n\t/*\n\t * Check if this could be a MSYS2 pty pipe ('msys-XXXX-ptyN-XX')\n\t * or a cygwin pty pipe ('cygwin-XXXX-ptyN-XX')\n\t */\n\tif ((!wcsstr(name, L\"msys-\") && !wcsstr(name, L\"cygwin-\")) ||\n\t\t\t!wcsstr(name, L\"-pty\"))\n\t\treturn;\n\n\tif (fd == 2)\n\t\tsetvbuf(stderr, NULL, _IONBF, BUFSIZ);\n\tfd_is_interactive[fd] |= FD_MSYS;\n}",
  "diff_func": "--- func_before\n+++ func_after\n static void detect_msys_tty(int fd)\n {\n \tULONG result;\n \tBYTE buffer[1024];\n \tPOBJECT_NAME_INFORMATION nameinfo = (POBJECT_NAME_INFORMATION) buffer;\n \tPWSTR name;\n \n \t/* check if fd is a pipe */\n \tHANDLE h = (HANDLE) _get_osfhandle(fd);\n \tif (GetFileType(h) != FILE_TYPE_PIPE)\n \t\treturn;\n \n \t/* get pipe name */\n \tif (!NT_SUCCESS(NtQueryObject(h, ObjectNameInformation,\n \t\t\tbuffer, sizeof(buffer) - 2, &result)))\n \t\treturn;\n+\tif (result < sizeof(*nameinfo) || !nameinfo->Name.Buffer ||\n+\t\t!nameinfo->Name.Length)\n+\t\treturn;\n \tname = nameinfo->Name.Buffer;\n \tname[nameinfo->Name.Length / sizeof(*name)] = 0;\n \n \t/*\n \t * Check if this could be a MSYS2 pty pipe ('msys-XXXX-ptyN-XX')\n \t * or a cygwin pty pipe ('cygwin-XXXX-ptyN-XX')\n \t */\n \tif ((!wcsstr(name, L\"msys-\") && !wcsstr(name, L\"cygwin-\")) ||\n \t\t\t!wcsstr(name, L\"-pty\"))\n \t\treturn;\n \n \tif (fd == 2)\n \t\tsetvbuf(stderr, NULL, _IONBF, BUFSIZ);\n \tfd_is_interactive[fd] |= FD_MSYS;\n }",
  "diff_source": "custom"
}