{
  "id": 459,
  "language": "c",
  "cwe": "CWE-362",
  "commit_url": "https://github.com/viaembedded/arm-soc/commit/a2b9e6c1a35afcc0973acb72e591c714e78885ff",
  "commit_sha": "a2b9e6c1a35afcc0973acb72e591c714e78885ff",
  "commit_msg": "KVM: x86: Don't report guest userspace emulation error to userspace\n\nCommit fc3a9157d314 (\"KVM: X86: Don't report L2 emulation failures to\nuser-space\") disabled the reporting of L2 (nested guest) emulation failures to\nuserspace due to race-condition between a vmexit and the instruction emulator.\nThe same rational applies also to userspace applications that are permitted by\nthe guest OS to access MMIO area or perform PIO.\n\nThis patch extends the current behavior - of injecting a #UD instead of\nreporting it to userspace - also for guest userspace code.\n\nSigned-off-by: Nadav Amit <namit@cs.technion.ac.il>\nSigned-off-by: Paolo Bonzini <pbonzini@redhat.com>",
  "pr_url": null,
  "pr_info": null,
  "file_name": "arch/x86/kvm/x86.c",
  "func_name": "",
  "raw_func_from_json": "static int handle_emulation_failure(struct kvm_vcpu *vcpu)\n{\n\tint r = EMULATE_DONE;\n \n \t++vcpu->stat.insn_emulation_fail;\n \ttrace_kvm_emulate_insn_failed(vcpu);\n\tif (!is_guest_mode(vcpu)) {\n \t\tvcpu->run->exit_reason = KVM_EXIT_INTERNAL_ERROR;\n \t\tvcpu->run->internal.suberror = KVM_INTERNAL_ERROR_EMULATION;\n \t\tvcpu->run->internal.ndata = 0;\n\t\tr = EMULATE_FAIL;\n\t}\n\tkvm_queue_exception(vcpu, UD_VECTOR);\n\n\treturn r;\n}\n",
  "diff_func": "@@ -5000,7 +5000,7 @@ static int handle_emulation_failure(struct kvm_vcpu *vcpu)\n \n \t++vcpu->stat.insn_emulation_fail;\n \ttrace_kvm_emulate_insn_failed(vcpu);\n-\tif (!is_guest_mode(vcpu)) {\n+\tif (!is_guest_mode(vcpu) && kvm_x86_ops->get_cpl(vcpu) == 0) {\n \t\tvcpu->run->exit_reason = KVM_EXIT_INTERNAL_ERROR;\n \t\tvcpu->run->internal.suberror = KVM_INTERNAL_ERROR_EMULATION;\n \t\tvcpu->run->internal.ndata = 0;",
  "project": "linux",
  "commit_id": "a2b9e6c1a35afcc0973acb72e591c714e78885ff",
  "target": 1,
  "func": "static int handle_emulation_failure(struct kvm_vcpu *vcpu)\n{\n\tint r = EMULATE_DONE;\n \n \t++vcpu->stat.insn_emulation_fail;\n \ttrace_kvm_emulate_insn_failed(vcpu);\n\tif (!is_guest_mode(vcpu)) {\n \t\tvcpu->run->exit_reason = KVM_EXIT_INTERNAL_ERROR;\n \t\tvcpu->run->internal.suberror = KVM_INTERNAL_ERROR_EMULATION;\n \t\tvcpu->run->internal.ndata = 0;\n\t\tr = EMULATE_FAIL;\n\t}\n\tkvm_queue_exception(vcpu, UD_VECTOR);\n\n\treturn r;\n}\n",
  "big_vul_idx": 179424,
  "idx": 1191,
  "hash": 44326647696150177215031281260553621216
}