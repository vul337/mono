{
  "id": 1046,
  "language": "c",
  "cwe": "",
  "commit_url": "https://github.com/droidian/xorg-server/commit/da15c7413916f754708c62c2089265528cd661e2",
  "commit_sha": "da15c7413916f754708c62c2089265528cd661e2",
  "commit_msg": "LogFilePrep: add a comment to the unsafe format string.\n\nCVE-2018-14665 also made it possible to exploit this to access\nmemory. With -logfile forbidden when running with elevated privileges\nthis is no longer an issue.\n\nSigned-off-by: Matthieu Herrb <matthieu@herrb.eu>\nReviewed-by: Adam Jackson <ajax@redhat.com>\n(cherry picked from commit 248d164eae27f1f310266d78e52f13f64362f81e)",
  "pr_url": null,
  "pr_info": null,
  "file_name": "os/log.c",
  "func_name": "",
  "raw_func_from_json": "LogFilePrep(const char *fname, const char *backup, const char *idstring)\n{\n    char *logFileName = NULL;\n\n    if (asprintf(&logFileName, fname, idstring) == -1)\n        FatalError(\"Cannot allocate space for the log file name\\n\");\n\n    if (backup && *backup) {\n        struct stat buf;\n\n        if (!stat(logFileName, &buf) && S_ISREG(buf.st_mode)) {\n            char *suffix;\n            char *oldLog;\n\n            if ((asprintf(&suffix, backup, idstring) == -1) ||\n                (asprintf(&oldLog, \"%s%s\", logFileName, suffix) == -1)) {\n                FatalError(\"Cannot allocate space for the log file name\\n\");\n            }\n            free(suffix);\n\n            if (rename(logFileName, oldLog) == -1) {\n                FatalError(\"Cannot move old log file \\\"%s\\\" to \\\"%s\\\"\\n\",\n                           logFileName, oldLog);\n            }\n            free(oldLog);\n        }\n    }\n    else {\n        if (remove(logFileName) != 0 && errno != ENOENT) {\n            FatalError(\"Cannot remove old log file \\\"%s\\\": %s\\n\",\n                       logFileName, strerror(errno));\n        }\n    }\n\n    return logFileName;\n}",
  "diff_func": "@@ -194,6 +194,8 @@ LogFilePrep(const char *fname, const char *backup, const char *idstring)\n {\n     char *logFileName = NULL;\n \n+    /* the format string below is controlled by the user,\n+       this code should never be called with elevated privileges */\n     if (asprintf(&logFileName, fname, idstring) == -1)\n         FatalError(\"Cannot allocate space for the log file name\\n\");\n ",
  "func": "LogFilePrep(const char *fname, const char *backup, const char *idstring)\n{\n    char *logFileName = NULL;\n\n    if (asprintf(&logFileName, fname, idstring) == -1)\n        FatalError(\"Cannot allocate space for the log file name\\n\");\n\n    if (backup && *backup) {\n        struct stat buf;\n\n        if (!stat(logFileName, &buf) && S_ISREG(buf.st_mode)) {\n            char *suffix;\n            char *oldLog;\n\n            if ((asprintf(&suffix, backup, idstring) == -1) ||\n                (asprintf(&oldLog, \"%s%s\", logFileName, suffix) == -1)) {\n                FatalError(\"Cannot allocate space for the log file name\\n\");\n            }\n            free(suffix);\n\n            if (rename(logFileName, oldLog) == -1) {\n                FatalError(\"Cannot move old log file \\\"%s\\\" to \\\"%s\\\"\\n\",\n                           logFileName, oldLog);\n            }\n            free(oldLog);\n        }\n    }\n    else {\n        if (remove(logFileName) != 0 && errno != ENOENT) {\n            FatalError(\"Cannot remove old log file \\\"%s\\\": %s\\n\",\n                       logFileName, strerror(errno));\n        }\n    }\n\n    return logFileName;\n}",
  "project": "xserver",
  "hash": 56456244053678581768053709472605633090,
  "size": 36,
  "commit_id": "da15c7413916f754708c62c2089265528cd661e2",
  "message": "LogFilePrep: add a comment to the unsafe format string.\n\nCVE-2018-14665 also made it possible to exploit this to access\nmemory. With -logfile forbidden when running with elevated privileges\nthis is no longer an issue.\n\nSigned-off-by: Matthieu Herrb <matthieu@herrb.eu>\nReviewed-by: Adam Jackson <ajax@redhat.com>\n(cherry picked from commit 248d164eae27f1f310266d78e52f13f64362f81e)",
  "target": 1,
  "dataset": "other",
  "idx": 210834
}