{
  "id": 769,
  "language": "c",
  "cwe": "",
  "commit_url": "https://github.com/rhboot/pesign/commit/b879dda52f8122de697d145977c285fb0a022d76",
  "commit_sha": "b879dda52f8122de697d145977c285fb0a022d76",
  "commit_msg": "Handle NULL pwdata in cms_set_pw_data()\n\nWhen 12f16710ee44ef64ddb044a3523c3c4c4d90039a rewrote this function, it\ndidn't handle the NULL pwdata invocation from daemon.c.  This leads to a\nexplicit NULL dereference and crash on all attempts to daemonize pesign.\n\nSigned-off-by: Robbie Harwood <rharwood@redhat.com>",
  "pr_url": "https://github.com/rhboot/pesign/pull/79",
  "pr_info": "Replaces #77 ",
  "file_name": "src/cms_common.c",
  "func_name": "",
  "raw_func_from_json": "void cms_set_pw_data(cms_context *cms, secuPWData *pwdata)\n{\n\tingress();\n\n\tswitch (cms->pwdata.source) {\n\tcase PW_SOURCE_INVALID:\n\tcase PW_PROMPT:\n\tcase PW_DEVICE:\n\tcase PW_SOURCE_MAX:\n\t\tbreak;\n\n\tcase PW_FROMFD:\n\t\tif (cms->pwdata.intdata >= 0 &&\n\t\t    !(pwdata->source == PW_FROMFD &&\n\t\t      cms->pwdata.intdata == pwdata->intdata))\n\t\t\tclose(cms->pwdata.intdata);\n\t\tbreak;\n\n\tcase PW_FROMFILEDB:\n\tcase PW_FROMENV:\n\tcase PW_FROMFILE:\n\tcase PW_PLAINTEXT:\n\t\tmemset(cms->pwdata.data, 0, strlen(cms->pwdata.data));\n\t\txfree(cms->pwdata.data);\n\t\tbreak;\n\n\tcase PW_DATABASE:\n\t\txfree(cms->pwdata.data);\n\t\tbreak;\n\t}\n\tmemmove(&cms->pwdata, pwdata, sizeof(*pwdata));\n\n\tdprintf(\"pwdata:%p\", pwdata);\n\tdprintf(\"pwdata->source:%d\", pwdata->source);\n\tdprintf(\"pwdata->data:%p (\\\"%s\\\")\", pwdata->data,\n\t\tpwdata->data ? pwdata->data : \"(null)\");\n\tegress();\n}",
  "diff_func": "@@ -313,7 +313,7 @@ void cms_set_pw_data(cms_context *cms, secuPWData *pwdata)\n \n \tcase PW_FROMFD:\n \t\tif (cms->pwdata.intdata >= 0 &&\n-\t\t    !(pwdata->source == PW_FROMFD &&\n+\t\t    !(pwdata && pwdata->source == PW_FROMFD &&\n \t\t      cms->pwdata.intdata == pwdata->intdata))\n \t\t\tclose(cms->pwdata.intdata);\n \t\tbreak;\n@@ -330,12 +330,18 @@ void cms_set_pw_data(cms_context *cms, secuPWData *pwdata)\n \t\txfree(cms->pwdata.data);\n \t\tbreak;\n \t}\n-\tmemmove(&cms->pwdata, pwdata, sizeof(*pwdata));\n \n-\tdprintf(\"pwdata:%p\", pwdata);\n-\tdprintf(\"pwdata->source:%d\", pwdata->source);\n-\tdprintf(\"pwdata->data:%p (\\\"%s\\\")\", pwdata->data,\n-\t\tpwdata->data ? pwdata->data : \"(null)\");\n+\tif (!pwdata) {\n+\t\tcms->pwdata.source = PW_SOURCE_INVALID;\n+\t\tdprintf(\"pwdata:NULL\");\n+\t} else {\n+\t\tmemmove(&cms->pwdata, pwdata, sizeof(*pwdata));\n+\t\tdprintf(\"pwdata:%p\", pwdata);\n+\t\tdprintf(\"pwdata->source:%d\", pwdata->source);\n+\t\tdprintf(\"pwdata->data:%p (\\\"%s\\\")\", pwdata->data,\n+\t\t\tpwdata->data ? pwdata->data : \"(null)\");\n+\t}\n+\n \tegress();\n }\n ",
  "func": "void cms_set_pw_data(cms_context *cms, secuPWData *pwdata)\n{\n\tingress();\n\n\tswitch (cms->pwdata.source) {\n\tcase PW_SOURCE_INVALID:\n\tcase PW_PROMPT:\n\tcase PW_DEVICE:\n\tcase PW_SOURCE_MAX:\n\t\tbreak;\n\n\tcase PW_FROMFD:\n\t\tif (cms->pwdata.intdata >= 0 &&\n\t\t    !(pwdata->source == PW_FROMFD &&\n\t\t      cms->pwdata.intdata == pwdata->intdata))\n\t\t\tclose(cms->pwdata.intdata);\n\t\tbreak;\n\n\tcase PW_FROMFILEDB:\n\tcase PW_FROMENV:\n\tcase PW_FROMFILE:\n\tcase PW_PLAINTEXT:\n\t\tmemset(cms->pwdata.data, 0, strlen(cms->pwdata.data));\n\t\txfree(cms->pwdata.data);\n\t\tbreak;\n\n\tcase PW_DATABASE:\n\t\txfree(cms->pwdata.data);\n\t\tbreak;\n\t}\n\tmemmove(&cms->pwdata, pwdata, sizeof(*pwdata));\n\n\tdprintf(\"pwdata:%p\", pwdata);\n\tdprintf(\"pwdata->source:%d\", pwdata->source);\n\tdprintf(\"pwdata->data:%p (\\\"%s\\\")\", pwdata->data,\n\t\tpwdata->data ? pwdata->data : \"(null)\");\n\tegress();\n}",
  "project": "pesign",
  "hash": 114679687783740689335214625108343607963,
  "size": 38,
  "commit_id": "b879dda52f8122de697d145977c285fb0a022d76",
  "message": "Handle NULL pwdata in cms_set_pw_data()\n\nWhen 12f16710ee44ef64ddb044a3523c3c4c4d90039a rewrote this function, it\ndidn't handle the NULL pwdata invocation from daemon.c.  This leads to a\nexplicit NULL dereference and crash on all attempts to daemonize pesign.\n\nSigned-off-by: Robbie Harwood <rharwood@redhat.com>",
  "target": 1,
  "dataset": "other",
  "idx": 198317
}