{
  "cve_id": "CVE-2022-41954",
  "cwe_ids": [
    "CWE-377",
    "CWE-200"
  ],
  "cvss_vector": "CVSS:3.1/AV:L/AC:L/PR:L/UI:N/S:U/C:L/I:N/A:N",
  "cvss_is_v3": true,
  "repo_name": "joniles/mpxj",
  "commit_msg": "vuln-fix: Temporary File Information Disclosure\n\n\n\nThis fixes temporary file information disclosure vulnerability due to the use\nof the vulnerable `File.createTempFile()` method. The vulnerability is fixed by\nusing the `Files.createTempFile()` method which sets the correct posix permissions.\n\nWeakness: CWE-377: Insecure Temporary File\nSeverity: Medium\nCVSSS: 5.5\nDetection: CodeQL & OpenRewrite (https://public.moderne.io/recipes/org.openrewrite.java.security.SecureTempFileCreation)\n\nReported-by: Jonathan Leitschuh <Jonathan.Leitschuh@gmail.com>\nSigned-off-by: Jonathan Leitschuh <Jonathan.Leitschuh@gmail.com>\n\nBug-tracker: https://github.com/JLLeitschuh/security-research/issues/18\n\n\nCo-authored-by: Moderne <team@moderne.io>",
  "commit_hash": "ae0af24345d79ad45705265d9927fe55e94a5721",
  "git_url": "https://github.com/joniles/mpxj/commit/ae0af24345d79ad45705265d9927fe55e94a5721",
  "file_path": "src/main/java/net/sf/mpxj/common/InputStreamHelper.java",
  "func_name": "writeStreamToTempFile",
  "func_before": "public static File writeStreamToTempFile(InputStream inputStream, String tempFileSuffix) throws IOException\n   {\n      FileOutputStream outputStream = null;\n\n      try\n      {\n         File file = File.createTempFile(\"mpxj\", tempFileSuffix);\n         outputStream = new FileOutputStream(file);\n         byte[] buffer = new byte[1024];\n         while (true)\n         {\n            int bytesRead = inputStream.read(buffer);\n            if (bytesRead == -1)\n            {\n               break;\n            }\n            outputStream.write(buffer, 0, bytesRead);\n         }\n         return file;\n      }\n\n      finally\n      {\n         if (outputStream != null)\n         {\n            outputStream.close();\n         }\n      }\n   }",
  "abstract_func_before": "public static File writeStreamToTempFile(InputStream VAR_0, String VAR_1) throws IOException\n   {\n      FileOutputStream VAR_2 = null;\n\n      try\n      {\n         File VAR_3 = VAR_4.createTempFile(\"mpxj\", VAR_1);\n         VAR_2 = new FileOutputStream(VAR_3);\n         byte[] VAR_5 = new byte[1024];\n         while (true)\n         {\n            int VAR_6 = VAR_0.read(VAR_5);\n            if (VAR_6 == -1)\n            {\n               break;\n            }\n            VAR_2.write(VAR_5, 0, VAR_6);\n         }\n         return VAR_3;\n      }\n\n      finally\n      {\n         if (VAR_2 != null)\n         {\n            VAR_2.close();\n         }\n      }\n   }",
  "func_graph_path_before": "joniles/mpxj/ae0af24345d79ad45705265d9927fe55e94a5721/InputStreamHelper.java/vul/before/0.json",
  "func": "public static File writeStreamToTempFile(InputStream inputStream, String tempFileSuffix) throws IOException\n   {\n      FileOutputStream outputStream = null;\n\n      try\n      {\n         File file = Files.createTempFile(\"mpxj\", tempFileSuffix).toFile();\n         outputStream = new FileOutputStream(file);\n         byte[] buffer = new byte[1024];\n         while (true)\n         {\n            int bytesRead = inputStream.read(buffer);\n            if (bytesRead == -1)\n            {\n               break;\n            }\n            outputStream.write(buffer, 0, bytesRead);\n         }\n         return file;\n      }\n\n      finally\n      {\n         if (outputStream != null)\n         {\n            outputStream.close();\n         }\n      }\n   }",
  "abstract_func": "public static File writeStreamToTempFile(InputStream VAR_0, String VAR_1) throws IOException\n   {\n      FileOutputStream VAR_2 = null;\n\n      try\n      {\n         File VAR_3 = VAR_4.createTempFile(\"mpxj\", VAR_1).toFile();\n         VAR_2 = new FileOutputStream(VAR_3);\n         byte[] VAR_5 = new byte[1024];\n         while (true)\n         {\n            int VAR_6 = VAR_0.read(VAR_5);\n            if (VAR_6 == -1)\n            {\n               break;\n            }\n            VAR_2.write(VAR_5, 0, VAR_6);\n         }\n         return VAR_3;\n      }\n\n      finally\n      {\n         if (VAR_2 != null)\n         {\n            VAR_2.close();\n         }\n      }\n   }",
  "func_graph_path": "joniles/mpxj/ae0af24345d79ad45705265d9927fe55e94a5721/InputStreamHelper.java/vul/after/0.json",
  "diff_func": "--- func_before\n+++ func_after\n@@ -4,7 +4,7 @@\n \n       try\n       {\n-         File file = File.createTempFile(\"mpxj\", tempFileSuffix);\n+         File file = Files.createTempFile(\"mpxj\", tempFileSuffix).toFile();\n          outputStream = new FileOutputStream(file);\n          byte[] buffer = new byte[1024];\n          while (true)",
  "diff_line_info": {
    "deleted_lines": [
      "         File file = File.createTempFile(\"mpxj\", tempFileSuffix);"
    ],
    "added_lines": [
      "         File file = Files.createTempFile(\"mpxj\", tempFileSuffix).toFile();"
    ]
  },
  "is_vul": true,
  "pr_url": "https://github.com/joniles/mpxj/pull/396",
  "description": {
    "pr_info": {
      "title": "[SECURITY] Fix Temporary File Information Disclosure Vulnerability\n",
      "number": 396
    },
    "comment": [
      "\n# Security Vulnerability Fix\n\nThis pull request fixes a Temporary File Information Disclosure Vulnerability, which existed in this project.\n\n## Preamble\n\nThe system temporary directory is shared between all users on most unix-like systems (not MacOS, or Windows). Thus, code interacting with the system temporary directory must be careful about file interactions in this directory, and must ensure that the correct file posix permissions are set.\n\nThis PR was generated because a call to `File.createTempFile(..)` was detected in this repository in a way that makes this project vulnerable to local information disclosure.\nWith the default uname configuration, `File.createTempFile(..)` creates a file with the permissions `-rw-r--r--`. This means that any other user on the system can read the contents of this file.\n\n### Impact\n\nInformation in this file is visible to other local users, allowing a malicious actor co-resident on the same machine to view potentially sensitive files.\n\n#### Other Examples\n\n - [CVE-2020-15250](https://github.com/advisories/GHSA-269g-pwp5-87pp) - junit-team/junit\n - [CVE-2021-21364](https://github.com/advisories/GHSA-hpv8-9rq5-hq7w) - swagger-api/swagger-codegen\n - [CVE-2022-24823](https://github.com/advisories/GHSA-5mcr-gq6c-3hq2) - netty/netty\n - [CVE-2022-24823](https://github.com/advisories/GHSA-269q-hmxg-m83q) - netty/netty\n\n# The Fix\n\nThe fix has been to convert the logic above to use the following API that was introduced in Java 1.7.\n\n```java\nFile tmpDir = Files.createTempFile(\"temp dir\").toFile();\n```\n\nThe API both creates the file securely, ie. with a random, non-conflicting name, with file permissions that only allow the currently executing user to read or write the contents of this file.\nBy default, `Files.createTempFile(\"temp dir\")` will create a file with the permissions `-rw-------`, which only allows the user that created the file to view/write the file contents.\n\n# :arrow_right: Vulnerability Disclosure :arrow_left:\n\n:wave: Vulnerability disclosure is a super important part of the vulnerability handling process and should not be skipped! This may be completely new to you, and that's okay, I'm here to assist!\n\nFirst question, do we need to perform vulnerability disclosure? It depends!\n\n 1. Is the vulnerable code only in tests or example code? No disclosure required!\n 2. Is the vulnerable code in code shipped to your end users? Vulnerability disclosure is probably required!\n\n## Vulnerability Disclosure How-To\n\nYou have a few options options to perform vulnerability disclosure. However, I'd like to suggest the following 2 options:\n\n 1. Request a CVE number from GitHub by creating a repository-level [GitHub Security Advisory](https://docs.github.com/en/code-security/repository-security-advisories/creating-a-repository-security-advisory). This has the advantage that, if you provide sufficient information, GitHub will automatically generate Dependabot alerts for your downstream consumers, resolving this vulnerability more quickly.\n 2. Reach out to the team at Snyk to assist with CVE issuance. They can be reached at the [Snyk's Disclosure Email](mailto:report@snyk.io).\n\n## Detecting this and Future Vulnerabilities\n\nThis vulnerability was automatically detected by GitHub's CodeQL using this [CodeQL Query](https://codeql.github.com/codeql-query-help/java/java-local-temp-file-or-directory-information-disclosure/).\n\nYou can automatically detect future vulnerabilities like this by enabling the free (for open-source) [GitHub Action](https://github.com/github/codeql-action).\n\nI'm not an employee of GitHub, I'm simply an open-source security researcher.\n\n## Source\n\nThis contribution was automatically generated with an [OpenRewrite](https://github.com/openrewrite/rewrite) [refactoring recipe](https://docs.openrewrite.org/), which was lovingly hand crafted to bring this security fix to your repository.\n\nThe source code that generated this PR can be found here:\n[SecureTempFileCreation](https://github.com/openrewrite/rewrite-java-security/blob/main/src/main/java/org/openrewrite/java/security/SecureTempFileCreation.java)\n\n## Opting-Out\n\nIf you'd like to opt-out of future automated security vulnerability fixes like this, please consider adding a file called\n`.github/GH-ROBOTS.txt` to your repository with the line:\n\n```\nUser-agent: JLLeitschuh/security-research\nDisallow: *\n```\n\nThis bot will respect the [ROBOTS.txt](https://moz.com/learn/seo/robotstxt) format for future contributions.\n\nAlternatively, if this project is no longer actively maintained, consider [archiving](https://help.github.com/en/github/creating-cloning-and-archiving-repositories/about-archiving-repositories) the repository.\n\n## CLA Requirements\n\n_This section is only relevant if your project requires contributors to sign a Contributor License Agreement (CLA) for external contributions._\n\nIt is unlikely that I'll be able to directly sign CLAs. However, all contributed commits are already automatically signed-off.\n\n> The meaning of a signoff depends on the project, but it typically certifies that committer has the rights to submit this work under the same license and agrees to a Developer Certificate of Origin\n> (see [https://developercertificate.org/](https://developercertificate.org/) for more information).\n>\n> \\- [Git Commit Signoff documentation](https://developercertificate.org/)\n\nIf signing your organization's CLA is a strict-requirement for merging this contribution, please feel free to close this PR.\n\n## Sponsorship & Support\n\nThis contribution is sponsored by HUMAN Security Inc. and the new Dan Kaminsky Fellowship, a fellowship created to celebrate Dan's memory and legacy by funding open-source work that makes the world a better (and more secure) place.\n\nThis PR was generated by [Moderne](https://www.moderne.io/), a free-for-open source SaaS offering that uses format-preserving AST transformations to fix bugs, standardize code style, apply best practices, migrate library versions, and fix common security vulnerabilities at scale.\n\n## Tracking\n\nAll PR's generated as part of this fix are tracked here: https://github.com/JLLeitschuh/security-research/issues/18\n",
      "Thanks for the PR. I've been assigned CVE-2022-41954 for this issue. I'll be making a new release of MPXJ containing this fix today."
    ]
  },
  "Bug Filter": "Security Vulnerability Fix  \nConfidence Score: 1.0",
  "Bug Filter Confidence": 1.0,
  "Bug Filter Response": "\n\nThe patch addresses a security vulnerability by replacing an insecure method for creating temporary files with a more secure alternative, thereby mitigating the risk of information disclosure.\n\n**Final Output:**\n\nAnalysis: The patch replaces the use of `File.createTempFile()` with `Files.createTempFile()`, which sets more secure file permissions, fixing a temporary file information disclosure vulnerability.\n\nFinal Classification: Security Vulnerability Fix  \nConfidence Score: 1.0"
}