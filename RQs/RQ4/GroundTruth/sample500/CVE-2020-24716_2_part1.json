{
  "cve_id": "CVE-2020-24716",
  "cwe_ids": [
    "CWE-863",
    "CWE-276"
  ],
  "cvss_vector": "AV:L/AC:L/Au:N/C:P/I:P/A:P",
  "cvss_is_v3": false,
  "repo_name": "openzfs/zfs",
  "commit_msg": "FreeBSD: Fix UNIX permissions checking\n\nReviewed-by: Ryan Moeller <ryan@iXsystems.com>\r\nReviewed-by: Brian Behlendorf <behlendorf1@llnl.gov>\r\nSigned-off-by: Matt Macy <mmacy@FreeBSD.org>\r\nCloses #10727",
  "commit_hash": "716b53d0a14c72bda16c0872565dd1909757e73f",
  "git_url": "https://github.com/openzfs/zfs/commit/716b53d0a14c72bda16c0872565dd1909757e73f",
  "file_path": "module/os/freebsd/zfs/zfs_acl.c",
  "func_name": "zfs_fastaccesschk_execute",
  "func_before": "int\nzfs_fastaccesschk_execute(znode_t *zdp, cred_t *cr)\n{\n\tboolean_t owner = B_FALSE;\n\tboolean_t groupmbr = B_FALSE;\n\tboolean_t is_attr;\n\tuid_t uid = crgetuid(cr);\n\n\tif (zdp->z_pflags & ZFS_AV_QUARANTINED)\n\t\treturn (1);\n\n\tis_attr = ((zdp->z_pflags & ZFS_XATTR) &&\n\t    (ZTOV(zdp)->v_type == VDIR));\n\tif (is_attr)\n\t\treturn (1);\n\n\tif (zdp->z_pflags & ZFS_NO_EXECS_DENIED)\n\t\treturn (0);\n\n\tmutex_enter(&zdp->z_acl_lock);\n\tif (FUID_INDEX(zdp->z_uid) != 0 || FUID_INDEX(zdp->z_gid) != 0) {\n\t\tgoto out_slow;\n\t}\n\n\tif (uid == zdp->z_uid) {\n\t\towner = B_TRUE;\n\t\tif (zdp->z_mode & S_IXUSR) {\n\t\t\tgoto out;\n\t\t} else {\n\t\t\tgoto out_slow;\n\t\t}\n\t}\n\tif (groupmember(zdp->z_gid, cr)) {\n\t\tgroupmbr = B_TRUE;\n\t\tif (zdp->z_mode & S_IXGRP) {\n\t\t\tgoto out;\n\t\t} else {\n\t\t\tgoto out_slow;\n\t\t}\n\t}\n\tif (!owner && !groupmbr) {\n\t\tif (zdp->z_mode & S_IXOTH) {\n\t\t\tgoto out;\n\t\t}\n\t}\nout:\n\tmutex_exit(&zdp->z_acl_lock);\n\treturn (0);\nout_slow:\n\tmutex_exit(&zdp->z_acl_lock);\n\treturn (1);\n}",
  "abstract_func_before": "int\nzfs_fastaccesschk_execute(znode_t *VAR_0, cred_t *VAR_1)\n{\n\tboolean_t VAR_2 = VAR_3;\n\tboolean_t VAR_4 = VAR_3;\n\tboolean_t VAR_5;\n\tuid_t VAR_6 = crgetuid(VAR_1);\n\n\tif (VAR_0->z_pflags & VAR_7)\n\t\treturn (1);\n\n\tVAR_5 = ((VAR_0->z_pflags & VAR_8) &&\n\t    (ZTOV(VAR_0)->v_type == VAR_9));\n\tif (VAR_5)\n\t\treturn (1);\n\n\tif (VAR_0->z_pflags & VAR_10)\n\t\treturn (0);\n\n\tmutex_enter(&VAR_0->z_acl_lock);\n\tif (FUID_INDEX(VAR_0->z_uid) != 0 || FUID_INDEX(VAR_0->z_gid) != 0) {\n\t\tgoto out_slow;\n\t}\n\n\tif (VAR_6 == VAR_0->z_uid) {\n\t\tVAR_2 = VAR_11;\n\t\tif (VAR_0->z_mode & VAR_12) {\n\t\t\tgoto out;\n\t\t} else {\n\t\t\tgoto out_slow;\n\t\t}\n\t}\n\tif (groupmember(VAR_0->z_gid, VAR_1)) {\n\t\tVAR_4 = VAR_11;\n\t\tif (VAR_0->z_mode & VAR_13) {\n\t\t\tgoto out;\n\t\t} else {\n\t\t\tgoto out_slow;\n\t\t}\n\t}\n\tif (!VAR_2 && !VAR_4) {\n\t\tif (VAR_0->z_mode & VAR_14) {\n\t\t\tgoto out;\n\t\t}\n\t}\nout:\n\tmutex_exit(&VAR_0->z_acl_lock);\n\treturn (0);\nout_slow:\n\tmutex_exit(&VAR_0->z_acl_lock);\n\treturn (1);\n}",
  "func_graph_path_before": "openzfs/zfs/716b53d0a14c72bda16c0872565dd1909757e73f/zfs_acl.c/vul/before/0.json",
  "func": "int\nzfs_fastaccesschk_execute(znode_t *zdp, cred_t *cr)\n{\n\tboolean_t is_attr;\n\n\tif (zdp->z_pflags & ZFS_AV_QUARANTINED)\n\t\treturn (1);\n\n\tis_attr = ((zdp->z_pflags & ZFS_XATTR) &&\n\t    (ZTOV(zdp)->v_type == VDIR));\n\tif (is_attr)\n\t\treturn (1);\n\n\tif (zdp->z_pflags & ZFS_NO_EXECS_DENIED)\n\t\treturn (0);\n\n\treturn (1);\n}",
  "abstract_func": "int\nzfs_fastaccesschk_execute(znode_t *VAR_0, cred_t *VAR_1)\n{\n\tboolean_t VAR_2;\n\n\tif (VAR_0->z_pflags & VAR_3)\n\t\treturn (1);\n\n\tVAR_2 = ((VAR_0->z_pflags & VAR_4) &&\n\t    (ZTOV(VAR_0)->v_type == VAR_5));\n\tif (VAR_2)\n\t\treturn (1);\n\n\tif (VAR_0->z_pflags & VAR_6)\n\t\treturn (0);\n\n\treturn (1);\n}",
  "func_graph_path": "openzfs/zfs/716b53d0a14c72bda16c0872565dd1909757e73f/zfs_acl.c/vul/after/0.json",
  "diff_func": "--- func_before\n+++ func_after\n@@ -1,10 +1,7 @@\n int\n zfs_fastaccesschk_execute(znode_t *zdp, cred_t *cr)\n {\n-\tboolean_t owner = B_FALSE;\n-\tboolean_t groupmbr = B_FALSE;\n \tboolean_t is_attr;\n-\tuid_t uid = crgetuid(cr);\n \n \tif (zdp->z_pflags & ZFS_AV_QUARANTINED)\n \t\treturn (1);\n@@ -17,36 +14,5 @@\n \tif (zdp->z_pflags & ZFS_NO_EXECS_DENIED)\n \t\treturn (0);\n \n-\tmutex_enter(&zdp->z_acl_lock);\n-\tif (FUID_INDEX(zdp->z_uid) != 0 || FUID_INDEX(zdp->z_gid) != 0) {\n-\t\tgoto out_slow;\n-\t}\n-\n-\tif (uid == zdp->z_uid) {\n-\t\towner = B_TRUE;\n-\t\tif (zdp->z_mode & S_IXUSR) {\n-\t\t\tgoto out;\n-\t\t} else {\n-\t\t\tgoto out_slow;\n-\t\t}\n-\t}\n-\tif (groupmember(zdp->z_gid, cr)) {\n-\t\tgroupmbr = B_TRUE;\n-\t\tif (zdp->z_mode & S_IXGRP) {\n-\t\t\tgoto out;\n-\t\t} else {\n-\t\t\tgoto out_slow;\n-\t\t}\n-\t}\n-\tif (!owner && !groupmbr) {\n-\t\tif (zdp->z_mode & S_IXOTH) {\n-\t\t\tgoto out;\n-\t\t}\n-\t}\n-out:\n-\tmutex_exit(&zdp->z_acl_lock);\n-\treturn (0);\n-out_slow:\n-\tmutex_exit(&zdp->z_acl_lock);\n \treturn (1);\n }",
  "diff_line_info": {
    "deleted_lines": [
      "\tboolean_t owner = B_FALSE;",
      "\tboolean_t groupmbr = B_FALSE;",
      "\tuid_t uid = crgetuid(cr);",
      "\tmutex_enter(&zdp->z_acl_lock);",
      "\tif (FUID_INDEX(zdp->z_uid) != 0 || FUID_INDEX(zdp->z_gid) != 0) {",
      "\t\tgoto out_slow;",
      "\t}",
      "",
      "\tif (uid == zdp->z_uid) {",
      "\t\towner = B_TRUE;",
      "\t\tif (zdp->z_mode & S_IXUSR) {",
      "\t\t\tgoto out;",
      "\t\t} else {",
      "\t\t\tgoto out_slow;",
      "\t\t}",
      "\t}",
      "\tif (groupmember(zdp->z_gid, cr)) {",
      "\t\tgroupmbr = B_TRUE;",
      "\t\tif (zdp->z_mode & S_IXGRP) {",
      "\t\t\tgoto out;",
      "\t\t} else {",
      "\t\t\tgoto out_slow;",
      "\t\t}",
      "\t}",
      "\tif (!owner && !groupmbr) {",
      "\t\tif (zdp->z_mode & S_IXOTH) {",
      "\t\t\tgoto out;",
      "\t\t}",
      "\t}",
      "out:",
      "\tmutex_exit(&zdp->z_acl_lock);",
      "\treturn (0);",
      "out_slow:",
      "\tmutex_exit(&zdp->z_acl_lock);"
    ],
    "added_lines": []
  },
  "is_vul": true,
  "pr_url": "https://github.com/openzfs/zfs/pull/10727",
  "description": {
    "pr_info": {
      "title": "FreeBSD: Fix UNIX permissions checking",
      "number": 10727
    },
    "comment": [
      "Signed-off-by: Matt Macy <mmacy@FreeBSD.org>\r\n\r\n<!--- Please fill out the following template, which will help other contributors review your Pull Request. -->\r\n\r\n<!--- Provide a general summary of your changes in the Title above -->\r\n\r\n<!---\r\nDocumentation on ZFS Buildbot options can be found at\r\nhttps://openzfs.github.io/openzfs-docs/Developer%20Resources/Buildbot%20Options.html\r\n-->\r\n\r\n### Motivation and Context\r\n<!--- Why is this change required? What problem does it solve? -->\r\n<!--- If it fixes an open issue, please link to the issue here. -->\r\n\r\n### Description\r\n<!--- Describe your changes in detail -->\r\n\r\n### How Has This Been Tested?\r\n<!--- Please describe in detail how you tested your changes. -->\r\n<!--- Include details of your testing environment, and the tests you ran to -->\r\n<!--- see how your change affects other areas of the code, etc. -->\r\n<!--- If your change is a performance enhancement, please provide benchmarks here. -->\r\n<!--- Please think about using the draft PR feature if appropriate -->\r\n\r\n### Types of changes\r\n<!--- What types of changes does your code introduce? Put an `x` in all the boxes that apply: -->\r\n- [ ] Bug fix (non-breaking change which fixes an issue)\r\n- [ ] New feature (non-breaking change which adds functionality)\r\n- [ ] Performance enhancement (non-breaking change which improves efficiency)\r\n- [ ] Code cleanup (non-breaking change which makes code smaller or more readable)\r\n- [ ] Breaking change (fix or feature that would cause existing functionality to change)\r\n- [ ] Documentation (a change to man pages or other documentation)\r\n\r\n### Checklist:\r\n<!--- Go over all the following points, and put an `x` in all the boxes that apply. -->\r\n<!--- If you're unsure about any of these, don't hesitate to ask. We're here to help! -->\r\n- [ ] My code follows the ZFS on Linux [code style requirements](https://github.com/zfsonlinux/zfs/blob/master/.github/CONTRIBUTING.md#coding-conventions).\r\n- [ ] I have updated the documentation accordingly.\r\n- [ ] I have read the [**contributing** document](https://github.com/zfsonlinux/zfs/blob/master/.github/CONTRIBUTING.md).\r\n- [ ] I have added [tests](https://github.com/zfsonlinux/zfs/tree/master/tests) to cover my changes.\r\n- [ ] I have run the ZFS Test Suite with this change applied.\r\n- [ ] All commit messages are properly formatted and contain [`Signed-off-by`](https://github.com/zfsonlinux/zfs/blob/master/.github/CONTRIBUTING.md#signed-off-by).\r\n",
      "# [Codecov](https://codecov.io/gh/openzfs/zfs/pull/10727?src=pr&el=h1) Report\n> Merging [#10727](https://codecov.io/gh/openzfs/zfs/pull/10727?src=pr&el=desc) into [master](https://codecov.io/gh/openzfs/zfs/commit/fc34dfba8e8238683e90e3fa83d16be3343886f6&el=desc) will **decrease** coverage by `0.08%`.\n> The diff coverage is `80.00%`.\n\n[![Impacted file tree graph](https://codecov.io/gh/openzfs/zfs/pull/10727/graphs/tree.svg?width=650&height=150&src=pr&token=NGfxvvG2io)](https://codecov.io/gh/openzfs/zfs/pull/10727?src=pr&el=tree)\n\n```diff\n@@            Coverage Diff             @@\n##           master   #10727      +/-   ##\n==========================================\n- Coverage   79.72%   79.63%   -0.09%     \n==========================================\n  Files         394      394              \n  Lines      124665   124666       +1     \n==========================================\n- Hits        99390    99279     -111     \n- Misses      25275    25387     +112     \n```\n\n| Flag | Coverage Δ | |\n|---|---|---|\n| #kernel | `80.34% <100.00%> (-0.05%)` | :arrow_down: |\n| #user | `65.10% <0.00%> (-0.70%)` | :arrow_down: |\n\nFlags with carried forward coverage won't be shown. [Click here](https://docs.codecov.io/docs/carryforward-flags#carryforward-flags-in-the-pull-request-comment) to find out more.\n\n| [Impacted Files](https://codecov.io/gh/openzfs/zfs/pull/10727?src=pr&el=tree) | Coverage Δ | |\n|---|---|---|\n| [module/zfs/arc.c](https://codecov.io/gh/openzfs/zfs/pull/10727/diff?src=pr&el=tree#diff-bW9kdWxlL3pmcy9hcmMuYw==) | `89.52% <66.66%> (+<0.01%)` | :arrow_up: |\n| [module/zfs/zfs\\_fuid.c](https://codecov.io/gh/openzfs/zfs/pull/10727/diff?src=pr&el=tree#diff-bW9kdWxlL3pmcy96ZnNfZnVpZC5j) | `14.85% <100.00%> (ø)` | |\n| [module/os/linux/spl/spl-zlib.c](https://codecov.io/gh/openzfs/zfs/pull/10727/diff?src=pr&el=tree#diff-bW9kdWxlL29zL2xpbnV4L3NwbC9zcGwtemxpYi5j) | `55.35% <0.00%> (-28.58%)` | :arrow_down: |\n| [cmd/zvol\\_id/zvol\\_id\\_main.c](https://codecov.io/gh/openzfs/zfs/pull/10727/diff?src=pr&el=tree#diff-Y21kL3p2b2xfaWQvenZvbF9pZF9tYWluLmM=) | `76.31% <0.00%> (-5.27%)` | :arrow_down: |\n| [module/zfs/vdev\\_removal.c](https://codecov.io/gh/openzfs/zfs/pull/10727/diff?src=pr&el=tree#diff-bW9kdWxlL3pmcy92ZGV2X3JlbW92YWwuYw==) | `94.40% <0.00%> (-3.20%)` | :arrow_down: |\n| [module/zfs/vdev\\_rebuild.c](https://codecov.io/gh/openzfs/zfs/pull/10727/diff?src=pr&el=tree#diff-bW9kdWxlL3pmcy92ZGV2X3JlYnVpbGQuYw==) | `93.69% <0.00%> (-2.83%)` | :arrow_down: |\n| [module/icp/api/kcf\\_mac.c](https://codecov.io/gh/openzfs/zfs/pull/10727/diff?src=pr&el=tree#diff-bW9kdWxlL2ljcC9hcGkva2NmX21hYy5j) | `37.14% <0.00%> (-1.72%)` | :arrow_down: |\n| [module/zfs/vdev\\_indirect\\_mapping.c](https://codecov.io/gh/openzfs/zfs/pull/10727/diff?src=pr&el=tree#diff-bW9kdWxlL3pmcy92ZGV2X2luZGlyZWN0X21hcHBpbmcuYw==) | `97.10% <0.00%> (-1.45%)` | :arrow_down: |\n| [module/zfs/zap\\_micro.c](https://codecov.io/gh/openzfs/zfs/pull/10727/diff?src=pr&el=tree#diff-bW9kdWxlL3pmcy96YXBfbWljcm8uYw==) | `85.35% <0.00%> (-1.26%)` | :arrow_down: |\n| [module/zfs/spa\\_log\\_spacemap.c](https://codecov.io/gh/openzfs/zfs/pull/10727/diff?src=pr&el=tree#diff-bW9kdWxlL3pmcy9zcGFfbG9nX3NwYWNlbWFwLmM=) | `91.97% <0.00%> (-1.15%)` | :arrow_down: |\n| ... and [46 more](https://codecov.io/gh/openzfs/zfs/pull/10727/diff?src=pr&el=tree-more) | |\n\n------\n\n[Continue to review full report at Codecov](https://codecov.io/gh/openzfs/zfs/pull/10727?src=pr&el=continue).\n> **Legend** - [Click here to learn more](https://docs.codecov.io/docs/codecov-delta)\n> `Δ = absolute <relative> (impact)`, `ø = not affected`, `? = missing data`\n> Powered by [Codecov](https://codecov.io/gh/openzfs/zfs/pull/10727?src=pr&el=footer). Last update [9352d8c...c2a93c3](https://codecov.io/gh/openzfs/zfs/pull/10727?src=pr&el=lastupdated). Read the [comment docs](https://docs.codecov.io/docs/pull-request-comments).\n"
    ]
  },
  "Bug Filter": "Defect Remediation & Feature Upgrades",
  "Bug Filter Confidence": 0.8,
  "Bug Filter Response": "**Final Classification:** Defect Remediation & Feature Upgrades;  \n**Confidence:** 0.8\n\nThe patch modifies the `zfs_fastaccesschk_execute` function to fix UNIX permissions, which is a non-security defect fix improving the logic. The code changes focus on simplifying and optimizing permission checks rather than addressing a security vulnerability."
}