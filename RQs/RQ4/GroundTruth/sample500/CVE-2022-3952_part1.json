{
  "cve_id": "CVE-2022-3952",
  "cwe_ids": [
    "CWE-668"
  ],
  "cvss_vector": "CVSS:3.1/AV:L/AC:L/PR:L/UI:N/S:U/C:H/I:H/A:N",
  "cvss_is_v3": true,
  "repo_name": "ManyDesigns/Portofino",
  "commit_msg": "vuln-fix: Temporary Directory Hijacking or Information Disclosure\n\n\n\nThis fixes either Temporary Directory Hijacking, or Temporary Directory Local Information Disclosure.\n\nWeakness: CWE-379: Creation of Temporary File in Directory with Insecure Permissions\nSeverity: High\nCVSSS: 7.3\nDetection: CodeQL & OpenRewrite (https://public.moderne.io/recipes/org.openrewrite.java.security.UseFilesCreateTempDirectory)\n\nReported-by: Jonathan Leitschuh <Jonathan.Leitschuh@gmail.com>\nSigned-off-by: Jonathan Leitschuh <Jonathan.Leitschuh@gmail.com>\n\nBug-tracker: https://github.com/JLLeitschuh/security-research/issues/10\n\n\nCo-authored-by: Moderne <team@moderne.io>",
  "commit_hash": "94653cb357806c9cf24d8d294e6afea33f8f0775",
  "git_url": "https://github.com/ManyDesigns/Portofino/commit/94653cb357806c9cf24d8d294e6afea33f8f0775",
  "file_path": "microservices/launcher/src/main/java/com/manydesigns/portofino/microservices/launcher/WarFileLauncher.java",
  "func_name": "createTempDir",
  "func_before": "public static File createTempDir(int port) throws IOException {\n        File tempDir = File.createTempFile(\"portofino.tomcat.\", \".\" + port);\n        tempDir.delete();\n        tempDir.mkdir();\n        tempDir.deleteOnExit();\n        return tempDir;\n    }",
  "abstract_func_before": "public static File createTempDir(int VAR_0) throws IOException {\n        File VAR_1 = VAR_2.createTempFile(\"portofino.tomcat.\", \".\" + VAR_0);\n        VAR_1.delete();\n        VAR_1.mkdir();\n        VAR_1.deleteOnExit();\n        return VAR_1;\n    }",
  "func_graph_path_before": "ManyDesigns/Portofino/94653cb357806c9cf24d8d294e6afea33f8f0775/WarFileLauncher.java/vul/before/0.json",
  "func": "public static File createTempDir(int port) throws IOException {\n        File tempDir = Files.createTempDirectory(\"portofino.tomcat.\" + \".\" + port).toFile();\n        tempDir.deleteOnExit();\n        return tempDir;\n    }",
  "abstract_func": "public static File createTempDir(int VAR_0) throws IOException {\n        File VAR_1 = VAR_2.createTempDirectory(\"portofino.tomcat.\" + \".\" + VAR_0).toFile();\n        VAR_1.deleteOnExit();\n        return VAR_1;\n    }",
  "func_graph_path": "ManyDesigns/Portofino/94653cb357806c9cf24d8d294e6afea33f8f0775/WarFileLauncher.java/vul/after/0.json",
  "diff_func": "--- func_before\n+++ func_after\n@@ -1,7 +1,5 @@\n public static File createTempDir(int port) throws IOException {\n-        File tempDir = File.createTempFile(\"portofino.tomcat.\", \".\" + port);\n-        tempDir.delete();\n-        tempDir.mkdir();\n+        File tempDir = Files.createTempDirectory(\"portofino.tomcat.\" + \".\" + port).toFile();\n         tempDir.deleteOnExit();\n         return tempDir;\n     }",
  "diff_line_info": {
    "deleted_lines": [
      "        File tempDir = File.createTempFile(\"portofino.tomcat.\", \".\" + port);",
      "        tempDir.delete();",
      "        tempDir.mkdir();"
    ],
    "added_lines": [
      "        File tempDir = Files.createTempDirectory(\"portofino.tomcat.\" + \".\" + port).toFile();"
    ]
  },
  "is_vul": true,
  "pr_url": "https://github.com/ManyDesigns/Portofino/pull/580",
  "description": {
    "pr_info": {
      "title": "[SECURITY] Fix Temporary Directory Hijacking or Information Disclosure Vulnerability\n",
      "number": 580
    },
    "comment": [
      "\n# Security Vulnerability Fix\n\nThis pull request fixes either 1.) Temporary Directory Hijacking Vulnerability, or 2.) Temporary Directory Information Disclosure Vulnerability, which existed in this project.\n\n## Preamble\n\nThe system temporary directory is shared between all users on most unix-like systems (not MacOS, or Windows). Thus, code interacting with the system temporary directory must be careful about file interactions in this directory, and must ensure that the correct file permissions are set.\n\nThis PR was generated because the following chain of calls was detected in this repository in a way that leaves this project vulnerable.\n`File.createTempFile(..)` -> `file.delete()` -> either `file.mkdir()` or `file.mkdirs()`.\n\n### Impact\n\nThis vulnerability can have one of two impacts depending upon which vulnerability it is.\n\n 1. Temporary Directory Information Disclosure - Information in this directory is visable to other local users, allowing a malicious actor co-resident on the same machine to view potentially sensitive files.\n 2. Temporary Directory Hijacking Vulnerability - Same impact as 1. above, but also, ther local users can manipulate/add contents to this directory. If code is being executed out of this temporary directory, it can lead to local priviledge escalation.\n\n## Temporary Directory Hijacking\n\nThis vulnerability exists because the return value from `file.mkdir()` or `file.mkdirs()` is not checked to determine if the call succeeded. Say, for example, because another local user created the directory before this process.\n\n```java\nFile tmpDir = File.createTempFile(\"temp\", \".dir\"); // Attacker knows the full path of the directory that will be later created\n// delete the file that was created\ntmpDir.delete(); // Attacker sees file is deleted and begins a race to create their own directory before the java code.\n// and makes a directory of the same name\n// SECURITY VULNERABILITY: Race Condition! - Attacker beats java code and now owns this directory\ntmpDir.mkdirs(); // This method returns 'false' because it was unable to create the directory. No exception is thrown.\n// Attacker can write any new files to this directory that they wish.\n// Attacker can read any files created within this directory.\n```\n\n### Other Examples\n\n - [CVE-2021-20202](https://github.com/advisories/GHSA-6xp6-fmc8-pmmr) - Keycloak/Keycloak\n - [CVE-2020-27216](https://github.com/advisories/GHSA-g3wg-6mcf-8jj6) - eclipse/jetty.project\n\n## Temporary Directory Information Disclosure\n\nThis vulnerability exists because, although the return values of `file.mkdir()` or `file.mkdirs()` are correctly checked, the permissions of the directory that is created follows the default system `uname` settings. Thus, the directory is created with everyone-readable permissions. As such, any files/directories written into this directory are viewable by all other local users on the system.\n\n```java\nFile tmpDir = File.createTempFile(\"temp\", \".dir\");\ntmpDir.delete();\nif (!tmpDir.mkdirs()) { // Guard correctly prevents temporary directory hijacking, but directory contents are everyone-readable.\n    throw new IOException(\"Failed to create temporary directory\");\n}\n```\n\n### Other Examples\n\n - [CVE-2020-15250](https://github.com/advisories/GHSA-269g-pwp5-87pp) - junit-team/junit\n - [CVE-2021-21364](https://github.com/advisories/GHSA-hpv8-9rq5-hq7w) - swagger-api/swagger-codegen\n - [CVE-2022-24823](https://github.com/advisories/GHSA-5mcr-gq6c-3hq2) - netty/netty\n - [CVE-2022-24823](https://github.com/advisories/GHSA-269q-hmxg-m83q) - netty/netty\n\n# The Fix\n\nThe fix has been to convert the logic above to use the following API that was introduced in Java 1.7.\n\n```java\nFile tmpDir = Files.createTempDirectory(\"temp dir\").toFile();\n```\n\nThe API both created the directory securely, ie with a random, non-conflicting name, with directory permissions that only allow the currently executing user to read or write the contents of this directory.\n\n# :arrow_right: Vulnerability Disclosure :arrow_left:\n\n:wave: Vulnerability disclosure is a super important part of the vulnerability handling process and should not be skipped! This may be completely new to you, and that's okay, I'm here to assist!\n\nFirst question, do we need to perform vulnerability disclosure? It depends!\n\n 1. Is the vulnerable code only in tests or example code? No disclosure required!\n 2. Is the vulnerable code in code shipped to your end users? Vulnerability disclosure is probably required!\n\n## Vulnerability Disclosure How-To\n\nYou have a few options options to perform vulnerability disclosure. However, I'd like to suggest the following 2 options:\n\n 1. Request a CVE number from GitHub by creating a repository-level [GitHub Security Advisory](https://docs.github.com/en/code-security/repository-security-advisories/creating-a-repository-security-advisory). This has the advantage that, if you provide sufficient information, GitHub will automatically generate Dependabot alerts for your downstream consumers, resolving this vulnerability more quickly.\n 2. Reach out to the team at Snyk to assist with CVE issuance. They can be reached at the [Snyk's Disclosure Email](mailto:report@snyk.io).\n\n## Detecting this and Future Vulnerabilities\n\nThis vulnerability was automatically detected by GitHub's [LGTM.com](https://lgtm.com) using this [CodeQL Query](https://lgtm.com/rules/1515014784717/).\n\nYou can automatically detect future vulnerabilities like this by enabling the free (for open-source) [GitHub Action](https://github.com/github/codeql-action).\n\nI'm not an employee of GitHub, I'm simply an open-source security researcher.\n\n## Source\n\nThis contribution was automatically generated with an [OpenRewrite](https://github.com/openrewrite/rewrite) [refactoring recipe](https://docs.openrewrite.org/), which was lovingly hand crafted to bring this security fix to your repository.\n\nThe source code that generated this PR can be found here:\n[UseFilesCreateTempDirectory](https://github.com/openrewrite/rewrite-java-security/blob/main/src/main/java/org/openrewrite/java/security/UseFilesCreateTempDirectory.java)\n\n## Opting-Out\n\nIf you'd like to opt-out of future automated security vulnerability fixes like this, please consider adding a file called\n`.github/GH-ROBOTS.txt` to your repository with the line:\n\n```\nUser-agent: JLLeitschuh/security-research\nDisallow: *\n```\n\nThis bot will respect the [ROBOTS.txt](https://moz.com/learn/seo/robotstxt) format for future contributions.\n\nAlternatively, if this project is no longer actively maintained, consider [archiving](https://help.github.com/en/github/creating-cloning-and-archiving-repositories/about-archiving-repositories) the repository.\n\n## CLA Requirements\n\n_This section is only relevant if your project requires contributors to sign a Contributor License Agreement (CLA) for external contributions._\n\nIt is unlikely that I'll be able to directly sign CLAs. However, all contributed commits are already automatically signed-off.\n\n> The meaning of a signoff depends on the project, but it typically certifies that committer has the rights to submit this work under the same license and agrees to a Developer Certificate of Origin \n> (see [https://developercertificate.org/](https://developercertificate.org/) for more information).\n>\n> \\- [Git Commit Signoff documentation](https://developercertificate.org/)\n\nIf signing your organization's CLA is a strict-requirement for merging this contribution, please feel free to close this PR.\n\n## Sponsorship & Support\n\nThis contribution is sponsored by HUMAN Security Inc. and the new Dan Kaminsky Fellowship, a fellowship created to celebrate Dan's memory and legacy by funding open-source work that makes the world a better (and more secure) place.\n\nThis PR was generated by [Moderne](https://www.moderne.io/), a free-for-open source SaaS offering that uses format-preserving AST transformations to fix bugs, standardize code style, apply best practices, migrate library versions, and fix common security vulnerabilities at scale.\n\n## Tracking\n\nAll PR's generated as part of this fix are tracked here: https://github.com/JLLeitschuh/security-research/issues/10\n",
      "Hi @alessiostalla,\r\n\r\nDo you believe this fixed a valid security vulnerability? Do you need assistance with vulnerability disclosure and CVE issuance?",
      "Hi, yes it's a security vulnerability in theory. However, it only interests a newish, undocumented deployment option, that most probably has zero real-world usage right now, and given the evolution of the project, it's unlikely it will see much use in the future as well.",
      "Regardless of how low you believe the risk of this logics use us, if you still consider it a vulnerability, it's still worth getting a CVE for it. I can put you in touch with the Snyk team and they can take care of most of the heavy lifting here."
    ]
  },
  "Bug Filter": "Security Vulnerability Fix",
  "Bug Filter Confidence": 1.0,
  "Bug Filter Response": "**Final Classification:** Security Vulnerability Fix; **Confidence:** 1.0"
}