{
  "cve_id": "CVE-2016-9177",
  "cwe_ids": [
    "CWE-22"
  ],
  "cvss_vector": "AV:N/AC:L/Au:N/C:P/I:N/A:N",
  "cvss_is_v3": false,
  "repo_name": "perwendel/spark",
  "commit_msg": "Fix for #700 - Arbitrary File Read Vulnerability",
  "commit_hash": "26b57d0596ee73c14c558463943ef0857e53b91f",
  "git_url": "https://github.com/perwendel/spark/commit/26b57d0596ee73c14c558463943ef0857e53b91f",
  "file_path": "src/main/java/spark/staticfiles/StaticFilesConfiguration.java",
  "func_name": "consumeWithFileResourceHandlers",
  "func_before": "private boolean consumeWithFileResourceHandlers(HttpServletRequest httpRequest,\n                                                    HttpServletResponse httpResponse) throws IOException {\n        if (staticResourceHandlers != null) {\n\n            for (AbstractResourceHandler staticResourceHandler : staticResourceHandlers) {\n\n                AbstractFileResolvingResource resource = staticResourceHandler.getResource(httpRequest);\n\n                if (resource != null && resource.isReadable()) {\n                    httpResponse.setHeader(MimeType.CONTENT_TYPE, MimeType.fromResource(resource));\n                    customHeaders.forEach(httpResponse::setHeader); //add all user-defined headers to response\n                    OutputStream wrappedOutputStream = GzipUtils.checkAndWrap(httpRequest, httpResponse, false);\n                    \n                    IOUtils.copy(resource.getInputStream(), wrappedOutputStream);\n                    wrappedOutputStream.flush();\n                    wrappedOutputStream.close();\n                    return true;\n                }\n            }\n\n        }\n        return false;\n    }",
  "abstract_func_before": "private boolean consumeWithFileResourceHandlers(HttpServletRequest VAR_0,\n                                                    HttpServletResponse VAR_1) throws IOException {\n        if (VAR_2 != null) {\n\n            for (AbstractResourceHandler VAR_3 : VAR_2) {\n\n                AbstractFileResolvingResource VAR_4 = VAR_3.getResource(VAR_0);\n\n                if (VAR_4 != null && VAR_4.isReadable()) {\n                    VAR_1.setHeader(VAR_5.CONTENT_TYPE, VAR_5.fromResource(VAR_4));\n                    VAR_6.forEach(VAR_1::VAR_7); /* COMMENT_0 */\n                    OutputStream VAR_8 = VAR_9.checkAndWrap(VAR_0, VAR_1, false);\n                    \n                    VAR_10.copy(VAR_4.getInputStream(), VAR_8);\n                    VAR_8.flush();\n                    VAR_8.close();\n                    return true;\n                }\n            }\n\n        }\n        return false;\n    }",
  "func_graph_path_before": "perwendel/spark/26b57d0596ee73c14c558463943ef0857e53b91f/StaticFilesConfiguration.java/vul/before/3.json",
  "func": "private boolean consumeWithFileResourceHandlers(HttpServletRequest httpRequest,\n                                                    HttpServletResponse httpResponse) throws IOException {\n        if (staticResourceHandlers != null) {\n\n            for (AbstractResourceHandler staticResourceHandler : staticResourceHandlers) {\n\n                AbstractFileResolvingResource resource = staticResourceHandler.getResource(httpRequest);\n\n                if (resource != null && resource.isReadable()) {\n                    httpResponse.setHeader(MimeType.CONTENT_TYPE, MimeType.fromResource(resource));\n                    customHeaders.forEach(httpResponse::setHeader); //add all user-defined headers to response\n                    OutputStream wrappedOutputStream = GzipUtils.checkAndWrap(httpRequest, httpResponse, false);\n\n                    IOUtils.copy(resource.getInputStream(), wrappedOutputStream);\n                    wrappedOutputStream.flush();\n                    wrappedOutputStream.close();\n                    return true;\n                }\n            }\n\n        }\n        return false;\n    }",
  "abstract_func": "private boolean consumeWithFileResourceHandlers(HttpServletRequest VAR_0,\n                                                    HttpServletResponse VAR_1) throws IOException {\n        if (VAR_2 != null) {\n\n            for (AbstractResourceHandler VAR_3 : VAR_2) {\n\n                AbstractFileResolvingResource VAR_4 = VAR_3.getResource(VAR_0);\n\n                if (VAR_4 != null && VAR_4.isReadable()) {\n                    VAR_1.setHeader(VAR_5.CONTENT_TYPE, VAR_5.fromResource(VAR_4));\n                    VAR_6.forEach(VAR_1::VAR_7); /* COMMENT_0 */\n                    OutputStream VAR_8 = VAR_9.checkAndWrap(VAR_0, VAR_1, false);\n\n                    VAR_10.copy(VAR_4.getInputStream(), VAR_8);\n                    VAR_8.flush();\n                    VAR_8.close();\n                    return true;\n                }\n            }\n\n        }\n        return false;\n    }",
  "func_graph_path": "perwendel/spark/26b57d0596ee73c14c558463943ef0857e53b91f/StaticFilesConfiguration.java/vul/after/3.json",
  "diff_func": "--- func_before\n+++ func_after\n@@ -10,7 +10,7 @@\n                     httpResponse.setHeader(MimeType.CONTENT_TYPE, MimeType.fromResource(resource));\n                     customHeaders.forEach(httpResponse::setHeader); //add all user-defined headers to response\n                     OutputStream wrappedOutputStream = GzipUtils.checkAndWrap(httpRequest, httpResponse, false);\n-                    \n+\n                     IOUtils.copy(resource.getInputStream(), wrappedOutputStream);\n                     wrappedOutputStream.flush();\n                     wrappedOutputStream.close();",
  "diff_line_info": {
    "deleted_lines": [
      "                    "
    ],
    "added_lines": [
      ""
    ]
  },
  "is_vul": true,
  "pr_url": "https://github.com/perwendel/spark/pull/701",
  "description": {
    "pr_info": {
      "title": "Fix for #700 - Arbitrary File Read Vulnerability",
      "number": 701
    },
    "comment": [
      "Fix for #700 \r\nThis is my take on the directory traversal problem.\r\nPlease review and try out.",
      "I've just verified it for Windows, didn't have time to test for linux etc.\nWhen travis CI built it didn't detect directory traversal for the test case for external resources. There's probably an issue with how path handling differs in unix-like OSs and windows.\n",
      "DISCLAIMER: Didn't really have time to look closely, so I could be talking out of my arse so to speak, but: wouldn't using `File.getCanonicalPath()` be safer than string manipulation? I'd certainly trust JDK library methods more than my own code, especially when it comes to security. Also, there are all kinds of clever ways (encodings, escapes and what not) of defeating checking strings for \"..\", \"/\", \"\\\" etc.\n",
      "@jakaarl Sorry, merged before I saw your comment. The guy making the post emailed and said it was a good solution. But I'll follow your advise and see if I can make it better. New PR will be created if you're right!\n"
    ]
  },
  "Bug Filter": "Security Vulnerability Fix",
  "Bug Filter Confidence": 1.0,
  "Bug Filter Response": "**Final Classification:** Security Vulnerability Fix  \n**Confidence:** 1.0"
}