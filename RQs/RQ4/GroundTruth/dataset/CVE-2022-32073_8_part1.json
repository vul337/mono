{
  "cve_id": "CVE-2022-32073",
  "cwe_ids": [
    "CWE-190"
  ],
  "cvss_vector": "AV:N/AC:L/Au:N/C:P/I:P/A:P",
  "cvss_is_v3": false,
  "repo_name": "wolfSSL/wolfssh",
  "commit_msg": "ASAN SFTP Fixes\nWhen decoding SFTP messages, fix the size checks so they don't wrap. (ZD12766)",
  "commit_hash": "edb272e35ee57e7b89f3e127222c6981b6a1e730",
  "git_url": "https://github.com/wolfSSL/wolfssh/commit/edb272e35ee57e7b89f3e127222c6981b6a1e730",
  "file_path": "src/wolfsftp.c",
  "func_name": "wolfSSH_SFTP_RecvSetSTAT",
  "func_before": "int wolfSSH_SFTP_RecvSetSTAT(WOLFSSH* ssh, int reqId, byte* data, word32 maxSz)\n{\n    WS_SFTP_FILEATRB atr;\n    char* name = NULL;\n    int   ret = WS_SUCCESS;\n\n    word32 sz;\n    word32 idx = 0;\n\n    byte*  out = NULL;\n    word32 outSz = 0;\n\n    char  suc[] = \"Set Attirbutes\";\n    char  ser[] = \"Unable to set attributes error\";\n    char  per[] = \"Unable to parse attributes error\";\n    char* res   = suc;\n    byte  type  = WOLFSSH_FTP_OK;\n\n    if (ssh == NULL) {\n        return WS_BAD_ARGUMENT;\n    }\n\n    WLOG(WS_LOG_SFTP, \"Receiving WOLFSSH_FTP_SETSTAT\");\n\n    ato32(data + idx, &sz); idx += UINT32_SZ;\n    if (sz + idx > maxSz) {\n        return WS_BUFFER_E;\n    }\n\n    /* plus one to make sure is null terminated */\n    name = (char*)WMALLOC(sz + 1, ssh->ctx->heap, DYNTYPE_BUFFER);\n    if (name == NULL) {\n        return WS_MEMORY_E;\n    }\n    WMEMCPY(name, data + idx, sz); idx += sz;\n    name[sz] = '\\0';\n    if (wolfSSH_CleanPath(ssh, name) < 0) {\n        ret = WS_FATAL_ERROR;\n    }\n\n    if (ret == WS_SUCCESS &&\n            SFTP_ParseAtributes_buffer(ssh, &atr, data, &idx, maxSz) != 0) {\n        type = WOLFSSH_FTP_FAILURE;\n        res  = per;\n        ret  = WS_BAD_FILE_E;\n    }\n\n    /* try to set file attributes and send status back to client */\n    if (ret == WS_SUCCESS && (ret = SFTP_SetFileAttributes(ssh, name, &atr))\n            != WS_SUCCESS) {\n        /* tell peer that was not ok */\n        WLOG(WS_LOG_SFTP, \"Unable to get set attributes of file/directory\");\n        type = WOLFSSH_FTP_FAILURE;\n        res  = ser;\n        ret  = WS_BAD_FILE_E;\n    }\n    WFREE(name, ssh->ctx->heap, DYNTYPE_BUFFER);\n\n    if (wolfSSH_SFTP_CreateStatus(ssh, type, reqId, res, \"English\", NULL,\n                &outSz) != WS_SIZE_ONLY) {\n        return WS_FATAL_ERROR;\n    }\n    out = (byte*)WMALLOC(outSz, ssh->ctx->heap, DYNTYPE_BUFFER);\n    if (out == NULL) {\n        return WS_MEMORY_E;\n    }\n    if (wolfSSH_SFTP_CreateStatus(ssh, type, reqId, res, \"English\", out,\n                &outSz) != WS_SUCCESS) {\n        WFREE(out, ssh->ctx->heap, DYNTYPE_BUFFER);\n        return WS_FATAL_ERROR;\n    }\n\n    /* set send out buffer, \"out\" is taken by ssh  */\n    wolfSSH_SFTP_RecvSetSend(ssh, out, outSz);\n    return ret;\n}",
  "abstract_func_before": "int wolfSSH_SFTP_RecvSetSTAT(WOLFSSH* VAR_0, int VAR_1, byte* VAR_2, word32 VAR_3)\n{\n    WS_SFTP_FILEATRB VAR_4;\n    char* VAR_5 = NULL;\n    int   VAR_6 = VAR_7;\n\n    word32 VAR_8;\n    word32 VAR_9 = 0;\n\n    byte*  VAR_10 = NULL;\n    word32 VAR_11 = 0;\n\n    char  VAR_12[] = \"Set Attirbutes\";\n    char  VAR_13[] = \"Unable to set attributes error\";\n    char  VAR_14[] = \"Unable to parse attributes error\";\n    char* VAR_15   = VAR_12;\n    byte  VAR_16  = VAR_17;\n\n    if (VAR_0 == NULL) {\n        return VAR_18;\n    }\n\n    WLOG(VAR_19, \"Receiving WOLFSSH_FTP_SETSTAT\");\n\n    ato32(VAR_2 + VAR_9, &VAR_8); VAR_9 += VAR_20;\n    if (VAR_8 + VAR_9 > VAR_3) {\n        return VAR_21;\n    }\n\n    /* COMMENT_0 */\n    VAR_5 = (char*)WMALLOC(VAR_8 + 1, VAR_0->ctx->heap, VAR_22);\n    if (VAR_5 == NULL) {\n        return VAR_23;\n    }\n    WMEMCPY(VAR_5, VAR_2 + VAR_9, VAR_8); VAR_9 += VAR_8;\n    VAR_5[VAR_8] = '\\0';\n    if (wolfSSH_CleanPath(VAR_0, VAR_5) < 0) {\n        VAR_6 = VAR_24;\n    }\n\n    if (VAR_6 == VAR_7 &&\n            SFTP_ParseAtributes_buffer(VAR_0, &VAR_4, VAR_2, &VAR_9, VAR_3) != 0) {\n        VAR_16 = VAR_25;\n        VAR_15  = VAR_14;\n        VAR_6  = VAR_26;\n    }\n\n    /* COMMENT_1 */\n    if (VAR_6 == VAR_7 && (VAR_6 = SFTP_SetFileAttributes(VAR_0, VAR_5, &VAR_4))\n            != VAR_7) {\n        /* COMMENT_2 */\n        WLOG(VAR_19, \"Unable to get set attributes of file/directory\");\n        VAR_16 = VAR_25;\n        VAR_15  = VAR_13;\n        VAR_6  = VAR_26;\n    }\n    WFREE(VAR_5, VAR_0->ctx->heap, VAR_22);\n\n    if (wolfSSH_SFTP_CreateStatus(VAR_0, VAR_16, VAR_1, VAR_15, \"English\", NULL,\n                &VAR_11) != VAR_27) {\n        return VAR_24;\n    }\n    VAR_10 = (byte*)WMALLOC(VAR_11, VAR_0->ctx->heap, VAR_22);\n    if (VAR_10 == NULL) {\n        return VAR_23;\n    }\n    if (wolfSSH_SFTP_CreateStatus(VAR_0, VAR_16, VAR_1, VAR_15, \"English\", VAR_10,\n                &VAR_11) != VAR_7) {\n        WFREE(VAR_10, VAR_0->ctx->heap, VAR_22);\n        return VAR_24;\n    }\n\n    /* COMMENT_3 */\n    wolfSSH_SFTP_RecvSetSend(VAR_0, VAR_10, VAR_11);\n    return VAR_6;\n}",
  "func_graph_path_before": "wolfSSL/wolfssh/edb272e35ee57e7b89f3e127222c6981b6a1e730/wolfsftp.c/vul/before/9.json",
  "func": "int wolfSSH_SFTP_RecvSetSTAT(WOLFSSH* ssh, int reqId, byte* data, word32 maxSz)\n{\n    WS_SFTP_FILEATRB atr;\n    char* name = NULL;\n    int   ret = WS_SUCCESS;\n\n    word32 sz;\n    word32 idx = 0;\n\n    byte*  out = NULL;\n    word32 outSz = 0;\n\n    char  suc[] = \"Set Attirbutes\";\n    char  ser[] = \"Unable to set attributes error\";\n    char  per[] = \"Unable to parse attributes error\";\n    char* res   = suc;\n    byte  type  = WOLFSSH_FTP_OK;\n\n    if (ssh == NULL) {\n        return WS_BAD_ARGUMENT;\n    }\n\n    WLOG(WS_LOG_SFTP, \"Receiving WOLFSSH_FTP_SETSTAT\");\n\n    ato32(data + idx, &sz); idx += UINT32_SZ;\n    if (sz > maxSz - idx) {\n        return WS_BUFFER_E;\n    }\n\n    /* plus one to make sure is null terminated */\n    name = (char*)WMALLOC(sz + 1, ssh->ctx->heap, DYNTYPE_BUFFER);\n    if (name == NULL) {\n        return WS_MEMORY_E;\n    }\n    WMEMCPY(name, data + idx, sz); idx += sz;\n    name[sz] = '\\0';\n    if (wolfSSH_CleanPath(ssh, name) < 0) {\n        ret = WS_FATAL_ERROR;\n    }\n\n    if (ret == WS_SUCCESS &&\n            SFTP_ParseAtributes_buffer(ssh, &atr, data, &idx, maxSz) != 0) {\n        type = WOLFSSH_FTP_FAILURE;\n        res  = per;\n        ret  = WS_BAD_FILE_E;\n    }\n\n    /* try to set file attributes and send status back to client */\n    if (ret == WS_SUCCESS && (ret = SFTP_SetFileAttributes(ssh, name, &atr))\n            != WS_SUCCESS) {\n        /* tell peer that was not ok */\n        WLOG(WS_LOG_SFTP, \"Unable to get set attributes of file/directory\");\n        type = WOLFSSH_FTP_FAILURE;\n        res  = ser;\n        ret  = WS_BAD_FILE_E;\n    }\n    WFREE(name, ssh->ctx->heap, DYNTYPE_BUFFER);\n\n    if (wolfSSH_SFTP_CreateStatus(ssh, type, reqId, res, \"English\", NULL,\n                &outSz) != WS_SIZE_ONLY) {\n        return WS_FATAL_ERROR;\n    }\n    out = (byte*)WMALLOC(outSz, ssh->ctx->heap, DYNTYPE_BUFFER);\n    if (out == NULL) {\n        return WS_MEMORY_E;\n    }\n    if (wolfSSH_SFTP_CreateStatus(ssh, type, reqId, res, \"English\", out,\n                &outSz) != WS_SUCCESS) {\n        WFREE(out, ssh->ctx->heap, DYNTYPE_BUFFER);\n        return WS_FATAL_ERROR;\n    }\n\n    /* set send out buffer, \"out\" is taken by ssh  */\n    wolfSSH_SFTP_RecvSetSend(ssh, out, outSz);\n    return ret;\n}",
  "abstract_func": "int wolfSSH_SFTP_RecvSetSTAT(WOLFSSH* VAR_0, int VAR_1, byte* VAR_2, word32 VAR_3)\n{\n    WS_SFTP_FILEATRB VAR_4;\n    char* VAR_5 = NULL;\n    int   VAR_6 = VAR_7;\n\n    word32 VAR_8;\n    word32 VAR_9 = 0;\n\n    byte*  VAR_10 = NULL;\n    word32 VAR_11 = 0;\n\n    char  VAR_12[] = \"Set Attirbutes\";\n    char  VAR_13[] = \"Unable to set attributes error\";\n    char  VAR_14[] = \"Unable to parse attributes error\";\n    char* VAR_15   = VAR_12;\n    byte  VAR_16  = VAR_17;\n\n    if (VAR_0 == NULL) {\n        return VAR_18;\n    }\n\n    WLOG(VAR_19, \"Receiving WOLFSSH_FTP_SETSTAT\");\n\n    ato32(VAR_2 + VAR_9, &VAR_8); VAR_9 += VAR_20;\n    if (VAR_8 > VAR_3 - VAR_9) {\n        return VAR_21;\n    }\n\n    /* COMMENT_0 */\n    VAR_5 = (char*)WMALLOC(VAR_8 + 1, VAR_0->ctx->heap, VAR_22);\n    if (VAR_5 == NULL) {\n        return VAR_23;\n    }\n    WMEMCPY(VAR_5, VAR_2 + VAR_9, VAR_8); VAR_9 += VAR_8;\n    VAR_5[VAR_8] = '\\0';\n    if (wolfSSH_CleanPath(VAR_0, VAR_5) < 0) {\n        VAR_6 = VAR_24;\n    }\n\n    if (VAR_6 == VAR_7 &&\n            SFTP_ParseAtributes_buffer(VAR_0, &VAR_4, VAR_2, &VAR_9, VAR_3) != 0) {\n        VAR_16 = VAR_25;\n        VAR_15  = VAR_14;\n        VAR_6  = VAR_26;\n    }\n\n    /* COMMENT_1 */\n    if (VAR_6 == VAR_7 && (VAR_6 = SFTP_SetFileAttributes(VAR_0, VAR_5, &VAR_4))\n            != VAR_7) {\n        /* COMMENT_2 */\n        WLOG(VAR_19, \"Unable to get set attributes of file/directory\");\n        VAR_16 = VAR_25;\n        VAR_15  = VAR_13;\n        VAR_6  = VAR_26;\n    }\n    WFREE(VAR_5, VAR_0->ctx->heap, VAR_22);\n\n    if (wolfSSH_SFTP_CreateStatus(VAR_0, VAR_16, VAR_1, VAR_15, \"English\", NULL,\n                &VAR_11) != VAR_27) {\n        return VAR_24;\n    }\n    VAR_10 = (byte*)WMALLOC(VAR_11, VAR_0->ctx->heap, VAR_22);\n    if (VAR_10 == NULL) {\n        return VAR_23;\n    }\n    if (wolfSSH_SFTP_CreateStatus(VAR_0, VAR_16, VAR_1, VAR_15, \"English\", VAR_10,\n                &VAR_11) != VAR_7) {\n        WFREE(VAR_10, VAR_0->ctx->heap, VAR_22);\n        return VAR_24;\n    }\n\n    /* COMMENT_3 */\n    wolfSSH_SFTP_RecvSetSend(VAR_0, VAR_10, VAR_11);\n    return VAR_6;\n}",
  "func_graph_path": "wolfSSL/wolfssh/edb272e35ee57e7b89f3e127222c6981b6a1e730/wolfsftp.c/vul/after/9.json",
  "diff_func": "--- func_before\n+++ func_after\n@@ -23,7 +23,7 @@\n     WLOG(WS_LOG_SFTP, \"Receiving WOLFSSH_FTP_SETSTAT\");\n \n     ato32(data + idx, &sz); idx += UINT32_SZ;\n-    if (sz + idx > maxSz) {\n+    if (sz > maxSz - idx) {\n         return WS_BUFFER_E;\n     }\n ",
  "diff_line_info": {
    "deleted_lines": [
      "    if (sz + idx > maxSz) {"
    ],
    "added_lines": [
      "    if (sz > maxSz - idx) {"
    ]
  },
  "is_vul": true,
  "pr_url": "https://github.com/wolfSSL/wolfssh/pull/360",
  "description": "Failed to get PR details: HTTP Request Error for PR https://github.com/wolfSSL/wolfssh/pull/360: 403 Client Error: Forbidden for url: https://api.github.com/repos/wolfSSL/wolfssh/pulls/360",
  "Bug Filter": "Security Vulnerability Fix",
  "Bug Filter Confidence": 0.9,
  "Bug Filter Response": "**Final Output:**  \n- **Final Classification:** Security Vulnerability Fix  \n- **Confidence:** 0.9  \n\nThe patch addresses a buffer overflow issue during SFTP message decoding, preventing integer overflow which is a security risk. The code change is consistent with the commit message, indicating a security fix."
}