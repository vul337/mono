{
  "cve_id": "CVE-2019-25052",
  "cwe_ids": [
    "CWE-327"
  ],
  "cvss_vector": "AV:N/AC:L/Au:N/C:P/I:N/A:P",
  "cvss_is_v3": false,
  "repo_name": "OP-TEE/optee_os",
  "commit_msg": "cryp: prevent direct calls to update and final functions\n\nWith inconsistent or malformed data it has been possible to call\n\"update\" and \"final\" crypto functions directly. Using a fuzzer tool [1]\nwe have seen that this results in asserts, i.e., a crash that\npotentially could leak sensitive information.\n\nBy setting the state (initialized) in the crypto context (i.e., the\ntee_cryp_state) at the end of all syscall_*_init functions and then add\na check of the state at the beginning of all update and final functions,\n  we prevent direct entrance to the \"update\" and \"final\" functions.\n\n[1] https://github.com/MartijnB/optee_fuzzer\n\nFixes: OP-TEE-2019-0021\n\nSigned-off-by: Joakim Bech <joakim.bech@linaro.org>\nReported-by: Martijn Bogaard <bogaard@riscure.com>\nAcked-by: Jerome Forissier <jerome.forissier@linaro.org>\nReviewed-by: Jens Wiklander <jens.wiklander@linaro.org>",
  "commit_hash": "34a08bec755670ea0490cb53bbc68058cafc69b6",
  "git_url": "https://github.com/OP-TEE/optee_os/commit/34a08bec755670ea0490cb53bbc68058cafc69b6",
  "file_path": "core/tee/tee_svc_cryp.c",
  "func_name": "syscall_authenc_update_aad",
  "func_before": "TEE_Result syscall_authenc_update_aad(unsigned long state,\n\t\t\tconst void *aad_data, size_t aad_data_len)\n{\n\tTEE_Result res;\n\tstruct tee_cryp_state *cs;\n\tstruct tee_ta_session *sess;\n\n\tres = tee_ta_get_current_session(&sess);\n\tif (res != TEE_SUCCESS)\n\t\treturn res;\n\n\tres = tee_mmu_check_access_rights(to_user_ta_ctx(sess->ctx),\n\t\t\t\t\t  TEE_MEMORY_ACCESS_READ |\n\t\t\t\t\t  TEE_MEMORY_ACCESS_ANY_OWNER,\n\t\t\t\t\t  (uaddr_t) aad_data,\n\t\t\t\t\t  aad_data_len);\n\tif (res != TEE_SUCCESS)\n\t\treturn res;\n\n\tres = tee_svc_cryp_get_state(sess, tee_svc_uref_to_vaddr(state), &cs);\n\tif (res != TEE_SUCCESS)\n\t\treturn res;\n\n\tif (TEE_ALG_GET_CLASS(cs->algo) != TEE_OPERATION_AE)\n\t\treturn TEE_ERROR_BAD_STATE;\n\n\tres = crypto_authenc_update_aad(cs->ctx, cs->algo, cs->mode,\n\t\t\t\t\taad_data, aad_data_len);\n\tif (res != TEE_SUCCESS)\n\t\treturn res;\n\n\treturn TEE_SUCCESS;\n}",
  "abstract_func_before": "TEE_Result syscall_authenc_update_aad(unsigned long VAR_0,\n\t\t\tconst void *VAR_1, size_t VAR_2)\n{\n\tTEE_Result VAR_3;\n\tstruct tee_cryp_state *VAR_4;\n\tstruct tee_ta_session *VAR_5;\n\n\tVAR_3 = tee_ta_get_current_session(&VAR_5);\n\tif (VAR_3 != VAR_6)\n\t\treturn VAR_3;\n\n\tVAR_3 = tee_mmu_check_access_rights(to_user_ta_ctx(VAR_5->ctx),\n\t\t\t\t\t  VAR_7 |\n\t\t\t\t\t  VAR_8,\n\t\t\t\t\t  (uaddr_t) VAR_1,\n\t\t\t\t\t  VAR_2);\n\tif (VAR_3 != VAR_6)\n\t\treturn VAR_3;\n\n\tVAR_3 = tee_svc_cryp_get_state(VAR_5, tee_svc_uref_to_vaddr(VAR_0), &VAR_4);\n\tif (VAR_3 != VAR_6)\n\t\treturn VAR_3;\n\n\tif (TEE_ALG_GET_CLASS(VAR_4->algo) != VAR_9)\n\t\treturn VAR_10;\n\n\tVAR_3 = crypto_authenc_update_aad(VAR_4->ctx, VAR_4->algo, VAR_4->mode,\n\t\t\t\t\tVAR_1, VAR_2);\n\tif (VAR_3 != VAR_6)\n\t\treturn VAR_3;\n\n\treturn VAR_6;\n}",
  "func_graph_path_before": "OP-TEE/optee_os/34a08bec755670ea0490cb53bbc68058cafc69b6/tee_svc_cryp.c/vul/before/0.json",
  "func": "TEE_Result syscall_authenc_update_aad(unsigned long state,\n\t\t\tconst void *aad_data, size_t aad_data_len)\n{\n\tTEE_Result res;\n\tstruct tee_cryp_state *cs;\n\tstruct tee_ta_session *sess;\n\n\tres = tee_ta_get_current_session(&sess);\n\tif (res != TEE_SUCCESS)\n\t\treturn res;\n\n\tres = tee_mmu_check_access_rights(to_user_ta_ctx(sess->ctx),\n\t\t\t\t\t  TEE_MEMORY_ACCESS_READ |\n\t\t\t\t\t  TEE_MEMORY_ACCESS_ANY_OWNER,\n\t\t\t\t\t  (uaddr_t) aad_data,\n\t\t\t\t\t  aad_data_len);\n\tif (res != TEE_SUCCESS)\n\t\treturn res;\n\n\tres = tee_svc_cryp_get_state(sess, tee_svc_uref_to_vaddr(state), &cs);\n\tif (res != TEE_SUCCESS)\n\t\treturn res;\n\n\tif (cs->state != CRYP_STATE_INITIALIZED)\n\t\treturn TEE_ERROR_BAD_STATE;\n\n\tif (TEE_ALG_GET_CLASS(cs->algo) != TEE_OPERATION_AE)\n\t\treturn TEE_ERROR_BAD_STATE;\n\n\tres = crypto_authenc_update_aad(cs->ctx, cs->algo, cs->mode,\n\t\t\t\t\taad_data, aad_data_len);\n\tif (res != TEE_SUCCESS)\n\t\treturn res;\n\n\treturn TEE_SUCCESS;\n}",
  "abstract_func": "TEE_Result syscall_authenc_update_aad(unsigned long VAR_0,\n\t\t\tconst void *VAR_1, size_t VAR_2)\n{\n\tTEE_Result VAR_3;\n\tstruct tee_cryp_state *VAR_4;\n\tstruct tee_ta_session *VAR_5;\n\n\tVAR_3 = tee_ta_get_current_session(&VAR_5);\n\tif (VAR_3 != VAR_6)\n\t\treturn VAR_3;\n\n\tVAR_3 = tee_mmu_check_access_rights(to_user_ta_ctx(VAR_5->ctx),\n\t\t\t\t\t  VAR_7 |\n\t\t\t\t\t  VAR_8,\n\t\t\t\t\t  (uaddr_t) VAR_1,\n\t\t\t\t\t  VAR_2);\n\tif (VAR_3 != VAR_6)\n\t\treturn VAR_3;\n\n\tVAR_3 = tee_svc_cryp_get_state(VAR_5, tee_svc_uref_to_vaddr(VAR_0), &VAR_4);\n\tif (VAR_3 != VAR_6)\n\t\treturn VAR_3;\n\n\tif (VAR_4->state != VAR_9)\n\t\treturn VAR_10;\n\n\tif (TEE_ALG_GET_CLASS(VAR_4->algo) != VAR_11)\n\t\treturn VAR_10;\n\n\tVAR_3 = crypto_authenc_update_aad(VAR_4->ctx, VAR_4->algo, VAR_4->mode,\n\t\t\t\t\tVAR_1, VAR_2);\n\tif (VAR_3 != VAR_6)\n\t\treturn VAR_3;\n\n\treturn VAR_6;\n}",
  "func_graph_path": "OP-TEE/optee_os/34a08bec755670ea0490cb53bbc68058cafc69b6/tee_svc_cryp.c/vul/after/0.json",
  "diff_func": "--- func_before\n+++ func_after\n@@ -21,6 +21,9 @@\n \tif (res != TEE_SUCCESS)\n \t\treturn res;\n \n+\tif (cs->state != CRYP_STATE_INITIALIZED)\n+\t\treturn TEE_ERROR_BAD_STATE;\n+\n \tif (TEE_ALG_GET_CLASS(cs->algo) != TEE_OPERATION_AE)\n \t\treturn TEE_ERROR_BAD_STATE;\n ",
  "diff_line_info": {
    "deleted_lines": [],
    "added_lines": [
      "\tif (cs->state != CRYP_STATE_INITIALIZED)",
      "\t\treturn TEE_ERROR_BAD_STATE;",
      ""
    ]
  },
  "is_vul": true,
  "pr_url": "https://github.com/OP-TEE/optee_os/pull/3316",
  "description": "Failed to get PR details: HTTP Request Error for PR https://github.com/OP-TEE/optee_os/pull/3316: 403 Client Error: Forbidden for url: https://api.github.com/repos/OP-TEE/optee_os/pulls/3316",
  "Bug Filter": "Security Vulnerability Fix",
  "Bug Filter Confidence": 1.0,
  "Bug Filter Response": "**Final Classification:** Security Vulnerability Fix  \n**Confidence:** 1.0  \n\n**Step-by-Step Explanation:**\n\n1. **Input Analysis:** The commit message discusses preventing direct calls to crypto functions that could lead to crashes and information leakage. The code adds state checks to ensure functions are called correctly.\n\n2. **Consistency Check:** The commit message aligns with the code changes, adding necessary security checks.\n\n3. **Purpose Evaluation:** The changes are aimed at fixing a security issue by enforcing proper usage of functions.\n\n4. **Security Assessment:** Fixes a potential security issue found via fuzzing, preventing unauthorized access to sensitive functions.\n\n5. **Confidence:** High (1.0) as all elements clearly indicate a security-related fix."
}