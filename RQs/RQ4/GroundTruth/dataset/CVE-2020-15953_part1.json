{
  "cve_id": "CVE-2020-15953",
  "cwe_ids": [
    "CWE-74"
  ],
  "cvss_vector": "AV:N/AC:M/Au:N/C:P/I:P/A:N",
  "cvss_is_v3": false,
  "repo_name": "dinhvh/libetpan",
  "commit_msg": "Detect extra data after STLS response and return error",
  "commit_hash": "6068b0fa8310bced874b322b20ac470472c64784",
  "git_url": "https://github.com/dinhvh/libetpan/commit/6068b0fa8310bced874b322b20ac470472c64784",
  "file_path": "src/low-level/pop3/mailpop3.c",
  "func_name": "mailpop3_stls",
  "func_before": "int mailpop3_stls(mailpop3 * f)\n{\n  char command[POP3_STRING_SIZE];\n  int r;\n  char * response;\n\n  snprintf(command, POP3_STRING_SIZE, \"STLS\\r\\n\");\n  r = send_command(f, command);\n  if (r == -1)\n    return MAILPOP3_ERROR_STREAM;\n\n  response = read_line(f);\n  if (response == NULL)\n    return MAILPOP3_ERROR_STREAM;\n  r = parse_response(f, response);\n\n  if (r != RESPONSE_OK)\n    return MAILPOP3_ERROR_STLS_NOT_SUPPORTED;\n  \n  return MAILPOP3_NO_ERROR;\n}",
  "abstract_func_before": "int mailpop3_stls(mailpop3 * VAR_0)\n{\n  char VAR_1[VAR_2];\n  int VAR_3;\n  char * VAR_4;\n\n  snprintf(VAR_1, VAR_2, \"STLS\\r\\n\");\n  VAR_3 = send_command(VAR_0, VAR_1);\n  if (VAR_3 == -1)\n    return VAR_5;\n\n  VAR_4 = read_line(VAR_0);\n  if (VAR_4 == NULL)\n    return VAR_5;\n  VAR_3 = parse_response(VAR_0, VAR_4);\n\n  if (VAR_3 != VAR_6)\n    return VAR_7;\n  \n  return VAR_8;\n}",
  "func_graph_path_before": "dinhvh/libetpan/6068b0fa8310bced874b322b20ac470472c64784/mailpop3.c/vul/before/0.json",
  "func": "int mailpop3_stls(mailpop3 * f)\n{\n  char command[POP3_STRING_SIZE];\n  int r;\n  char * response;\n\n  snprintf(command, POP3_STRING_SIZE, \"STLS\\r\\n\");\n  r = send_command(f, command);\n  if (r == -1)\n    return MAILPOP3_ERROR_STREAM;\n\n  response = read_line(f);\n  if (response == NULL)\n    return MAILPOP3_ERROR_STREAM;\n  r = parse_response(f, response);\n\n  if (r != RESPONSE_OK)\n    return MAILPOP3_ERROR_STLS_NOT_SUPPORTED;\n\n  // Detect if the server send extra data after the STLS response.\n  // This *may* be a \"response injection attack\".\n  if (f->pop3_stream->read_buffer_len != 0) {\n    // Since it is also protocol violation, exit.\n    // There is no error type for STARTTLS errors in POP3\n    return MAILPOP3_ERROR_SSL;\n  }\n  \n  return MAILPOP3_NO_ERROR;\n}",
  "abstract_func": "int mailpop3_stls(mailpop3 * VAR_0)\n{\n  char VAR_1[VAR_2];\n  int VAR_3;\n  char * VAR_4;\n\n  snprintf(VAR_1, VAR_2, \"STLS\\r\\n\");\n  VAR_3 = send_command(VAR_0, VAR_1);\n  if (VAR_3 == -1)\n    return VAR_5;\n\n  VAR_4 = read_line(VAR_0);\n  if (VAR_4 == NULL)\n    return VAR_5;\n  VAR_3 = parse_response(VAR_0, VAR_4);\n\n  if (VAR_3 != VAR_6)\n    return VAR_7;\n\n  /* COMMENT_0 */\n  /* COMMENT_1 */\n  if (VAR_0->pop3_stream->read_buffer_len != 0) {\n    /* COMMENT_2 */\n    /* COMMENT_3 */\n    return VAR_8;\n  }\n  \n  return VAR_9;\n}",
  "func_graph_path": "dinhvh/libetpan/6068b0fa8310bced874b322b20ac470472c64784/mailpop3.c/vul/after/0.json",
  "diff_func": "--- func_before\n+++ func_after\n@@ -16,6 +16,14 @@\n \n   if (r != RESPONSE_OK)\n     return MAILPOP3_ERROR_STLS_NOT_SUPPORTED;\n+\n+  // Detect if the server send extra data after the STLS response.\n+  // This *may* be a \"response injection attack\".\n+  if (f->pop3_stream->read_buffer_len != 0) {\n+    // Since it is also protocol violation, exit.\n+    // There is no error type for STARTTLS errors in POP3\n+    return MAILPOP3_ERROR_SSL;\n+  }\n   \n   return MAILPOP3_NO_ERROR;\n }",
  "diff_line_info": {
    "deleted_lines": [],
    "added_lines": [
      "",
      "  // Detect if the server send extra data after the STLS response.",
      "  // This *may* be a \"response injection attack\".",
      "  if (f->pop3_stream->read_buffer_len != 0) {",
      "    // Since it is also protocol violation, exit.",
      "    // There is no error type for STARTTLS errors in POP3",
      "    return MAILPOP3_ERROR_SSL;",
      "  }"
    ]
  },
  "is_vul": true,
  "pr_url": "https://github.com/dinhvh/libetpan/pull/388",
  "description": "Failed to get PR details: HTTP Request Error for PR https://github.com/dinhvh/libetpan/pull/388: 403 Client Error: Forbidden for url: https://api.github.com/repos/dinhvh/libetpan/pulls/388",
  "Bug Filter": "Security Vulnerability Fix",
  "Bug Filter Confidence": 0.9,
  "Bug Filter Response": "**Final Classification:** Security Vulnerability Fix  \n**Confidence:** 0.9"
}