{
  "cve_id": "CVE-2020-36636",
  "cwe_ids": [
    "CWE-79"
  ],
  "cvss_vector": "CVSS:3.1/AV:N/AC:L/PR:N/UI:R/S:C/C:L/I:L/A:N",
  "cvss_is_v3": true,
  "repo_name": "openmrs/openmrs-module-adminui",
  "commit_msg": "RA-1865: Fix possible xss in account setup (#57)",
  "commit_hash": "702fbfdac7c4418f23bb5f6452482b4a88020061",
  "git_url": "https://github.com/openmrs/openmrs-module-adminui/commit/702fbfdac7c4418f23bb5f6452482b4a88020061",
  "file_path": "omod/src/main/java/org/openmrs/module/adminui/page/controller/systemadmin/accounts/AccountPageController.java",
  "func_name": "setJsonFormData",
  "func_before": "private void setJsonFormData(PageModel model, Account account, OtherAccountData otherAccountData) throws IOException {\n\t\t\n\t\tObjectMapper mapper = new ObjectMapper();\n\t\tSimpleObject simplePerson = new SimpleObject();\n\t\tsimplePerson.put(\"familyName\", account.getFamilyName());\n\t\tsimplePerson.put(\"givenName\", account.getGivenName());\n\t\tsimplePerson.put(\"gender\", account.getGender() != null ? account.getGender() : \"\");\n\t\tmodel.addAttribute(\"personJson\", mapper.writeValueAsString(simplePerson));\n\t\t\n\t\tSimpleObject simpleUser = new SimpleObject();\n\t\tSimpleObject simpleProvider = new SimpleObject();\n\t\tif (otherAccountData != null) {\n\t\t\tif (otherAccountData.getAddUserAccount()) {\n\t\t\t\tUser u = account.getUserAccounts().get(0);\n\t\t\t\tsimpleUser.put(\"username\", u.getUsername());\n\t\t\t\tsimpleUser.put(\"privilegeLevel\", account.getPrivilegeLevel(u).getUuid());\n\t\t\t\tSimpleObject userProperties = new SimpleObject();\n\t\t\t\tuserProperties\n\t\t\t\t        .put(OpenmrsConstants.USER_PROPERTY_CHANGE_PASSWORD, otherAccountData.getForceChangePassword());\n\t\t\t\tsimpleUser.put(\"userProperties\", userProperties);\n\t\t\t\tSimpleObject simpleUserCapabilities = new SimpleObject();\n\t\t\t\tfor (Role cap : account.getCapabilities(u)) {\n\t\t\t\t\tsimpleUserCapabilities.put(cap.getUuid(), true);\n\t\t\t\t}\n\t\t\t\tsimpleUser.put(\"capabilities\", simpleUserCapabilities);\n\t\t\t}\n\t\t\t\n\t\t\tif (otherAccountData.getAddProviderAccount()) {\n\t\t\t\tProvider prov = (Provider) account.getProviderAccounts().get(0);\n\t\t\t\tsimpleProvider.put(\"identifier\", prov.getIdentifier());\n\t\t\t\tsimpleProvider.put(\"providerRole\", prov.getProviderRole().getUuid());\n\t\t\t}\n\t\t}\n\t\t\n\t\tmodel.addAttribute(\"userJson\", mapper.writeValueAsString(simpleUser));\n\t\tmodel.addAttribute(\"providerJson\", mapper.writeValueAsString(simpleProvider));\n\t}",
  "abstract_func_before": "private void setJsonFormData(PageModel VAR_0, Account VAR_1, OtherAccountData VAR_2) throws IOException {\n\t\t\n\t\tObjectMapper VAR_3 = new ObjectMapper();\n\t\tSimpleObject VAR_4 = new SimpleObject();\n\t\tVAR_4.put(\"familyName\", VAR_1.getFamilyName());\n\t\tVAR_4.put(\"givenName\", VAR_1.getGivenName());\n\t\tVAR_4.put(\"gender\", VAR_1.getGender() != null ? VAR_1.getGender() : \"\");\n\t\tVAR_0.addAttribute(\"personJson\", VAR_3.writeValueAsString(VAR_4));\n\t\t\n\t\tSimpleObject VAR_5 = new SimpleObject();\n\t\tSimpleObject VAR_6 = new SimpleObject();\n\t\tif (VAR_2 != null) {\n\t\t\tif (VAR_2.getAddUserAccount()) {\n\t\t\t\tUser VAR_7 = VAR_1.getUserAccounts().get(0);\n\t\t\t\tVAR_5.put(\"username\", VAR_7.getUsername());\n\t\t\t\tVAR_5.put(\"privilegeLevel\", VAR_1.getPrivilegeLevel(VAR_7).getUuid());\n\t\t\t\tSimpleObject VAR_8 = new SimpleObject();\n\t\t\t\tVAR_8\n\t\t\t\t        .put(VAR_9.USER_PROPERTY_CHANGE_PASSWORD, VAR_2.getForceChangePassword());\n\t\t\t\tVAR_5.put(\"userProperties\", VAR_8);\n\t\t\t\tSimpleObject VAR_10 = new SimpleObject();\n\t\t\t\tfor (Role VAR_11 : VAR_1.getCapabilities(VAR_7)) {\n\t\t\t\t\tVAR_10.put(VAR_11.getUuid(), true);\n\t\t\t\t}\n\t\t\t\tVAR_5.put(\"capabilities\", VAR_10);\n\t\t\t}\n\t\t\t\n\t\t\tif (VAR_2.getAddProviderAccount()) {\n\t\t\t\tProvider VAR_12 = (Provider) VAR_1.getProviderAccounts().get(0);\n\t\t\t\tVAR_6.put(\"identifier\", VAR_12.getIdentifier());\n\t\t\t\tVAR_6.put(\"providerRole\", VAR_12.getProviderRole().getUuid());\n\t\t\t}\n\t\t}\n\t\t\n\t\tVAR_0.addAttribute(\"userJson\", VAR_3.writeValueAsString(VAR_5));\n\t\tVAR_0.addAttribute(\"providerJson\", VAR_3.writeValueAsString(VAR_6));\n\t}",
  "func_graph_path_before": "openmrs/openmrs-module-adminui/702fbfdac7c4418f23bb5f6452482b4a88020061/AccountPageController.java/vul/before/2.json",
  "func": "private void setJsonFormData(PageModel model, Account account, OtherAccountData otherAccountData, UiUtils uu) throws IOException {\n\t\t\n\t\tObjectMapper mapper = new ObjectMapper();\n\t\tSimpleObject simplePerson = new SimpleObject();\n\t\tsimplePerson.put(\"familyName\", uu.encodeHtml(account.getFamilyName()));\n\t\tsimplePerson.put(\"givenName\", uu.encodeHtml(account.getGivenName()));\n\t\tsimplePerson.put(\"gender\", uu.encodeHtml(account.getGender()) != null ? uu.encodeHtml(account.getGender()) : \"\");\n\t\tmodel.addAttribute(\"personJson\", mapper.writeValueAsString(simplePerson));\n\t\t\n\t\tSimpleObject simpleUser = new SimpleObject();\n\t\tSimpleObject simpleProvider = new SimpleObject();\n\t\tif (otherAccountData != null) {\n\t\t\tif (otherAccountData.getAddUserAccount()) {\n\t\t\t\tUser u = account.getUserAccounts().get(0);\n\t\t\t\tsimpleUser.put(\"username\", uu.encodeHtml(u.getUsername()));\n\t\t\t\tsimpleUser.put(\"privilegeLevel\", account.getPrivilegeLevel(u).getUuid());\n\t\t\t\tSimpleObject userProperties = new SimpleObject();\n\t\t\t\tuserProperties\n\t\t\t\t        .put(OpenmrsConstants.USER_PROPERTY_CHANGE_PASSWORD, otherAccountData.getForceChangePassword());\n\t\t\t\tsimpleUser.put(\"userProperties\", userProperties);\n\t\t\t\tSimpleObject simpleUserCapabilities = new SimpleObject();\n\t\t\t\tfor (Role cap : account.getCapabilities(u)) {\n\t\t\t\t\tsimpleUserCapabilities.put(cap.getUuid(), true);\n\t\t\t\t}\n\t\t\t\tsimpleUser.put(\"capabilities\", simpleUserCapabilities);\n\t\t\t}\n\t\t\t\n\t\t\tif (otherAccountData.getAddProviderAccount()) {\n\t\t\t\tProvider prov = (Provider) account.getProviderAccounts().get(0);\n\t\t\t\tsimpleProvider.put(\"identifier\", prov.getIdentifier());\n\t\t\t\tsimpleProvider.put(\"providerRole\", prov.getProviderRole().getUuid());\n\t\t\t}\n\t\t}\n\t\t\n\t\tmodel.addAttribute(\"userJson\", mapper.writeValueAsString(simpleUser));\n\t\tmodel.addAttribute(\"providerJson\", mapper.writeValueAsString(simpleProvider));\n\t}",
  "abstract_func": "private void setJsonFormData(PageModel VAR_0, Account VAR_1, OtherAccountData VAR_2, UiUtils VAR_3) throws IOException {\n\t\t\n\t\tObjectMapper VAR_4 = new ObjectMapper();\n\t\tSimpleObject VAR_5 = new SimpleObject();\n\t\tVAR_5.put(\"familyName\", VAR_3.encodeHtml(VAR_1.getFamilyName()));\n\t\tVAR_5.put(\"givenName\", VAR_3.encodeHtml(VAR_1.getGivenName()));\n\t\tVAR_5.put(\"gender\", VAR_3.encodeHtml(VAR_1.getGender()) != null ? VAR_3.encodeHtml(VAR_1.getGender()) : \"\");\n\t\tVAR_0.addAttribute(\"personJson\", VAR_4.writeValueAsString(VAR_5));\n\t\t\n\t\tSimpleObject VAR_6 = new SimpleObject();\n\t\tSimpleObject VAR_7 = new SimpleObject();\n\t\tif (VAR_2 != null) {\n\t\t\tif (VAR_2.getAddUserAccount()) {\n\t\t\t\tUser VAR_8 = VAR_1.getUserAccounts().get(0);\n\t\t\t\tVAR_6.put(\"username\", VAR_3.encodeHtml(VAR_8.getUsername()));\n\t\t\t\tVAR_6.put(\"privilegeLevel\", VAR_1.getPrivilegeLevel(VAR_8).getUuid());\n\t\t\t\tSimpleObject VAR_9 = new SimpleObject();\n\t\t\t\tVAR_9\n\t\t\t\t        .put(VAR_10.USER_PROPERTY_CHANGE_PASSWORD, VAR_2.getForceChangePassword());\n\t\t\t\tVAR_6.put(\"userProperties\", VAR_9);\n\t\t\t\tSimpleObject VAR_11 = new SimpleObject();\n\t\t\t\tfor (Role VAR_12 : VAR_1.getCapabilities(VAR_8)) {\n\t\t\t\t\tVAR_11.put(VAR_12.getUuid(), true);\n\t\t\t\t}\n\t\t\t\tVAR_6.put(\"capabilities\", VAR_11);\n\t\t\t}\n\t\t\t\n\t\t\tif (VAR_2.getAddProviderAccount()) {\n\t\t\t\tProvider VAR_13 = (Provider) VAR_1.getProviderAccounts().get(0);\n\t\t\t\tVAR_7.put(\"identifier\", VAR_13.getIdentifier());\n\t\t\t\tVAR_7.put(\"providerRole\", VAR_13.getProviderRole().getUuid());\n\t\t\t}\n\t\t}\n\t\t\n\t\tVAR_0.addAttribute(\"userJson\", VAR_4.writeValueAsString(VAR_6));\n\t\tVAR_0.addAttribute(\"providerJson\", VAR_4.writeValueAsString(VAR_7));\n\t}",
  "func_graph_path": "openmrs/openmrs-module-adminui/702fbfdac7c4418f23bb5f6452482b4a88020061/AccountPageController.java/vul/after/2.json",
  "diff_func": "--- func_before\n+++ func_after\n@@ -1,10 +1,10 @@\n-private void setJsonFormData(PageModel model, Account account, OtherAccountData otherAccountData) throws IOException {\n+private void setJsonFormData(PageModel model, Account account, OtherAccountData otherAccountData, UiUtils uu) throws IOException {\n \t\t\n \t\tObjectMapper mapper = new ObjectMapper();\n \t\tSimpleObject simplePerson = new SimpleObject();\n-\t\tsimplePerson.put(\"familyName\", account.getFamilyName());\n-\t\tsimplePerson.put(\"givenName\", account.getGivenName());\n-\t\tsimplePerson.put(\"gender\", account.getGender() != null ? account.getGender() : \"\");\n+\t\tsimplePerson.put(\"familyName\", uu.encodeHtml(account.getFamilyName()));\n+\t\tsimplePerson.put(\"givenName\", uu.encodeHtml(account.getGivenName()));\n+\t\tsimplePerson.put(\"gender\", uu.encodeHtml(account.getGender()) != null ? uu.encodeHtml(account.getGender()) : \"\");\n \t\tmodel.addAttribute(\"personJson\", mapper.writeValueAsString(simplePerson));\n \t\t\n \t\tSimpleObject simpleUser = new SimpleObject();\n@@ -12,7 +12,7 @@\n \t\tif (otherAccountData != null) {\n \t\t\tif (otherAccountData.getAddUserAccount()) {\n \t\t\t\tUser u = account.getUserAccounts().get(0);\n-\t\t\t\tsimpleUser.put(\"username\", u.getUsername());\n+\t\t\t\tsimpleUser.put(\"username\", uu.encodeHtml(u.getUsername()));\n \t\t\t\tsimpleUser.put(\"privilegeLevel\", account.getPrivilegeLevel(u).getUuid());\n \t\t\t\tSimpleObject userProperties = new SimpleObject();\n \t\t\t\tuserProperties",
  "diff_line_info": {
    "deleted_lines": [
      "private void setJsonFormData(PageModel model, Account account, OtherAccountData otherAccountData) throws IOException {",
      "\t\tsimplePerson.put(\"familyName\", account.getFamilyName());",
      "\t\tsimplePerson.put(\"givenName\", account.getGivenName());",
      "\t\tsimplePerson.put(\"gender\", account.getGender() != null ? account.getGender() : \"\");",
      "\t\t\t\tsimpleUser.put(\"username\", u.getUsername());"
    ],
    "added_lines": [
      "private void setJsonFormData(PageModel model, Account account, OtherAccountData otherAccountData, UiUtils uu) throws IOException {",
      "\t\tsimplePerson.put(\"familyName\", uu.encodeHtml(account.getFamilyName()));",
      "\t\tsimplePerson.put(\"givenName\", uu.encodeHtml(account.getGivenName()));",
      "\t\tsimplePerson.put(\"gender\", uu.encodeHtml(account.getGender()) != null ? uu.encodeHtml(account.getGender()) : \"\");",
      "\t\t\t\tsimpleUser.put(\"username\", uu.encodeHtml(u.getUsername()));"
    ]
  },
  "is_vul": true,
  "pr_url": "https://github.com/openmrs/openmrs-module-adminui/pull/57",
  "description": {
    "pr_info": {
      "title": "RA-1865: Fix possible xss in account setup",
      "number": 57
    },
    "comment": [
      "**Why?**\r\n\r\nPossible XSS bug identified by NC State team in account setup pages\r\n\r\n**What Changed?**\r\n\r\nAdded HTML encoding before user-controlled variables such as username are added to the model.\r\n\r\n**Decisions Made**\r\n\r\nDecided to do the most aggressive html-encoding because the values in question should not have any html-encodable characters anyway. In the unlikely event that this causes anything to break, though, more targeted xss prevention can be done in the .gsp frontend",
      "Thanks @isears 👍 "
    ]
  },
  "Bug Filter": "Security Vulnerability Fix",
  "Bug Filter Confidence": 1.0,
  "Bug Filter Response": "**Final Classification:** Security Vulnerability Fix  \n**Confidence:** 1.0"
}