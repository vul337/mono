{
  "cve_id": "CVE-2021-23514",
  "cwe_ids": [
    "CWE-79",
    "CWE-22"
  ],
  "cvss_vector": "AV:N/AC:L/Au:N/C:P/I:N/A:N",
  "cvss_is_v3": false,
  "repo_name": "CrowCpp/Crow",
  "commit_msg": "Fix vulnrabilities in mustache and static",
  "commit_hash": "0a160214424d5ca708b8e2eaea061924d8fb0c38",
  "git_url": "https://github.com/CrowCpp/Crow/commit/0a160214424d5ca708b8e2eaea061924d8fb0c38",
  "file_path": "include/crow/http_response.h",
  "func_name": "set_static_file_info",
  "func_before": "void set_static_file_info(std::string path)\n        {\n            file_info.path = path;\n            file_info.statResult = stat(file_info.path.c_str(), &file_info.statbuf);\n#ifdef CROW_ENABLE_COMPRESSION\n            compressed = false;\n#endif\n            if (file_info.statResult == 0)\n            {\n                std::size_t last_dot = path.find_last_of(\".\");\n                std::string extension = path.substr(last_dot + 1);\n                std::string mimeType = \"\";\n                code = 200;\n                this->add_header(\"Content-length\", std::to_string(file_info.statbuf.st_size));\n\n                if (extension != \"\")\n                {\n                    mimeType = mime_types.at(extension);\n                    if (mimeType != \"\")\n                        this->add_header(\"Content-Type\", mimeType);\n                    else\n                        this->add_header(\"content-Type\", \"text/plain\");\n                }\n            }\n            else\n            {\n                code = 404;\n                this->end();\n            }\n        }",
  "abstract_func_before": "void set_static_file_info(std::string VAR_0)\n        {\n            VAR_1.path = VAR_0;\n            VAR_1.statResult = stat(VAR_1.path.c_str(), &VAR_1.statbuf);\n#ifdef VAR_2\n            VAR_3 = false;\n#endif\n            if (VAR_1.statResult == 0)\n            {\n                std::size_t VAR_4 = VAR_0.find_last_of(\".\");\n                std::string VAR_5 = VAR_0.substr(VAR_4 + 1);\n                std::string VAR_6 = \"\";\n                VAR_7 = 200;\n                this->add_header(\"Content-length\", std::to_string(VAR_1.statbuf.st_size));\n\n                if (VAR_5 != \"\")\n                {\n                    VAR_6 = VAR_8.at(VAR_5);\n                    if (VAR_6 != \"\")\n                        this->add_header(\"Content-Type\", VAR_6);\n                    else\n                        this->add_header(\"content-Type\", \"text/plain\");\n                }\n            }\n            else\n            {\n                VAR_7 = 404;\n                this->end();\n            }\n        }",
  "func_graph_path_before": "CrowCpp/Crow/0a160214424d5ca708b8e2eaea061924d8fb0c38/http_response.h/vul/before/0.json",
  "func": "void set_static_file_info(std::string path)\n        {\n            path = utility::sanitize_filename(path); //TODO create a no_copy function instead\n            file_info.path = path;\n            file_info.statResult = stat(file_info.path.c_str(), &file_info.statbuf);\n#ifdef CROW_ENABLE_COMPRESSION\n            compressed = false;\n#endif\n            if (file_info.statResult == 0)\n            {\n                std::size_t last_dot = path.find_last_of(\".\");\n                std::string extension = path.substr(last_dot + 1);\n                std::string mimeType = \"\";\n                code = 200;\n                this->add_header(\"Content-length\", std::to_string(file_info.statbuf.st_size));\n\n                if (extension != \"\")\n                {\n                    mimeType = mime_types.at(extension);\n                    if (mimeType != \"\")\n                        this->add_header(\"Content-Type\", mimeType);\n                    else\n                        this->add_header(\"content-Type\", \"text/plain\");\n                }\n            }\n            else\n            {\n                code = 404;\n                this->end();\n            }\n        }",
  "abstract_func": "void set_static_file_info(std::string VAR_0)\n        {\n            VAR_0 = utility::sanitize_filename(VAR_0); /* COMMENT_0 */\n            VAR_1.path = VAR_0;\n            VAR_1.statResult = stat(VAR_1.path.c_str(), &VAR_1.statbuf);\n#ifdef VAR_2\n            VAR_3 = false;\n#endif\n            if (VAR_1.statResult == 0)\n            {\n                std::size_t VAR_4 = VAR_0.find_last_of(\".\");\n                std::string VAR_5 = VAR_0.substr(VAR_4 + 1);\n                std::string VAR_6 = \"\";\n                VAR_7 = 200;\n                this->add_header(\"Content-length\", std::to_string(VAR_1.statbuf.st_size));\n\n                if (VAR_5 != \"\")\n                {\n                    VAR_6 = VAR_8.at(VAR_5);\n                    if (VAR_6 != \"\")\n                        this->add_header(\"Content-Type\", VAR_6);\n                    else\n                        this->add_header(\"content-Type\", \"text/plain\");\n                }\n            }\n            else\n            {\n                VAR_7 = 404;\n                this->end();\n            }\n        }",
  "func_graph_path": "CrowCpp/Crow/0a160214424d5ca708b8e2eaea061924d8fb0c38/http_response.h/vul/after/0.json",
  "diff_func": "--- func_before\n+++ func_after\n@@ -1,5 +1,6 @@\n void set_static_file_info(std::string path)\n         {\n+            path = utility::sanitize_filename(path); //TODO create a no_copy function instead\n             file_info.path = path;\n             file_info.statResult = stat(file_info.path.c_str(), &file_info.statbuf);\n #ifdef CROW_ENABLE_COMPRESSION",
  "diff_line_info": {
    "deleted_lines": [],
    "added_lines": [
      "            path = utility::sanitize_filename(path); //TODO create a no_copy function instead"
    ]
  },
  "is_vul": true,
  "pr_url": "https://github.com/CrowCpp/Crow/pull/317",
  "description": {
    "pr_info": {
      "title": "Fix vulnerabilities",
      "number": 317
    },
    "comment": [
      "The PR fixes 2 Vulnerabilities found in Crow.\r\n1. A Path Traversal exploit made possible by Crow's default `static` directory and Mustache's `templates` directory.\r\n2. A Content Injection exploit made possible by Crow's Mustache implementation not escaping some characters.\r\n\r\nOnce merged, This PR, along with #292, #296, and #304 Will be released immediately as part of `v0.3+4`.\r\n\r\nNote: This PR introduces a slowdown between `50Âµs` and `1.5ms` for any static file or template being loaded (depending on the length of the filename). Therefore I would advise optimization of the `sanitize_filename()` function before the next minor/major release.\r\n\r\nA special Thank you to the [Snyk Security team](https://snyk.io) for their effort in identifying and reporting these vulnerabilities."
    ]
  },
  "Bug Filter": "Security Vulnerability Fix",
  "Bug Filter Confidence": 1.0,
  "Bug Filter Response": "The commit clearly addresses two security vulnerabilities by sanitizing filenames to prevent Path Traversal and Content Injection attacks. \n\n**Final Classification:** Security Vulnerability Fix;\n**Confidence:** 1.0"
}