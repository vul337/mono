{
  "cve_id": "CVE-2017-11704",
  "cwe_ids": [
    "CWE-125"
  ],
  "cvss_vector": "AV:N/AC:M/Au:N/C:N/I:N/A:P",
  "cvss_is_v3": false,
  "repo_name": "libming",
  "commit_msg": "Fix various overflows in util/ (CVE-2017-11704)\n\n* Add a check in decompileIF to avoid overflows.\n\n    Avoid processing block when sact->numActions is 0, as\n    sact->numActions - 1 may be used as index when accessing\n    sact->Actions array.\n\n* Fix overflow in readUInt32.\n\n    o Fix declaration of readUInt32 and readSInt32 in util/read.h:\n      return types should be unsigned long and long.\n    o readUInt32: Avoid calling all readUInt8(f) in one line, order of\n      evaluation is not guaranteed in the C standard.\n    o readUInt32: Cast result of readUInt8(f) before << 24 to avoid\n      overflow.\n\n* Fix overflow in readMovie.\n\n    length has int type but according to the specification it should be able\n    to store unsigned 32bit numbers. Instead of changing the type of\n    length, which would be a major refactoring, we verify that the value\n    returned by readUInt32 is smaller than INT_MAX and update length if\n    it's the case. Otherwise we print a warning and ignore the block.\n\nThis commit fixes CVE-2017-11704.",
  "commit_hash": "7fed314748be817c7ded84854acb649786625cb6",
  "git_url": "https://github.com/libming/libming/commit/7fed314748be817c7ded84854acb649786625cb6",
  "file_path": "util/read.c",
  "func_name": "readUInt32",
  "func_before": "unsigned long readUInt32(FILE *f)\n{\n  return (unsigned long)(readUInt8(f) + (readUInt8(f)<<8) + (readUInt8(f)<<16) + (readUInt8(f)<<24));\n}",
  "abstract_func_before": "unsigned long readUInt32(FILE *VAR_0)\n{\n  return (unsigned long)(readUInt8(VAR_0) + (readUInt8(VAR_0)<<8) + (readUInt8(VAR_0)<<16) + (readUInt8(VAR_0)<<24));\n}",
  "func_graph_path_before": "libming/7fed314748be817c7ded84854acb649786625cb6/read.c/vul/before/0.json",
  "func": "unsigned long readUInt32(FILE *f)\n{\n  int part1 = readUInt8(f);\n  int part2 = readUInt8(f) << 8;\n  int part3 = readUInt8(f) << 16;\n  unsigned long part4 = ((unsigned long)readUInt8(f)) << 24;\n  return part1 + part2 + part3 + part4;\n}",
  "abstract_func": "unsigned long readUInt32(FILE *VAR_0)\n{\n  int VAR_1 = readUInt8(VAR_0);\n  int VAR_2 = readUInt8(VAR_0) << 8;\n  int VAR_3 = readUInt8(VAR_0) << 16;\n  unsigned long VAR_4 = ((unsigned long)readUInt8(VAR_0)) << 24;\n  return VAR_1 + VAR_2 + VAR_3 + VAR_4;\n}",
  "func_graph_path": "libming/7fed314748be817c7ded84854acb649786625cb6/read.c/vul/after/0.json",
  "diff_func": "--- func_before\n+++ func_after\n@@ -1,4 +1,8 @@\n unsigned long readUInt32(FILE *f)\n {\n-  return (unsigned long)(readUInt8(f) + (readUInt8(f)<<8) + (readUInt8(f)<<16) + (readUInt8(f)<<24));\n+  int part1 = readUInt8(f);\n+  int part2 = readUInt8(f) << 8;\n+  int part3 = readUInt8(f) << 16;\n+  unsigned long part4 = ((unsigned long)readUInt8(f)) << 24;\n+  return part1 + part2 + part3 + part4;\n }",
  "diff_line_info": {
    "deleted_lines": [
      "  return (unsigned long)(readUInt8(f) + (readUInt8(f)<<8) + (readUInt8(f)<<16) + (readUInt8(f)<<24));"
    ],
    "added_lines": [
      "  int part1 = readUInt8(f);",
      "  int part2 = readUInt8(f) << 8;",
      "  int part3 = readUInt8(f) << 16;",
      "  unsigned long part4 = ((unsigned long)readUInt8(f)) << 24;",
      "  return part1 + part2 + part3 + part4;"
    ]
  },
  "is_vul": true,
  "pr_url": "https://github.com/libming/libming/pull/88",
  "description": {
    "pr_info": {
      "title": "Fix various overflows in util/ (CVE-2017-11704)",
      "number": 88
    },
    "comment": [
      "Avoid processing block when `sact->numActions` is 0, as `sact->numActions - 1` may be used as index when accessing `sact->Actions` array.\r\n\r\nI wasn't sure whether 0 was a good return value, or whether `decompileIF` was the right place for this check.\r\n\r\nThis should be partial fix of CVE-2017-11704, see issue #76.",
      "Also, fix overflow in `readUInt32`.\r\n\r\n* Fix declaration of `readUInt32` and `readSInt32` in `util/read.h`: return types should be unsigned long and long.\r\n* readUInt32: Avoid calling all `readUInt8(f)` in one line, order of evaluation is not guaranteed in the C standard.\r\n* readUInt32: Cast result of `readUInt8(f)` before `<< 24` to avoid overflow.",
      "Do you plan to add more fixes to completely address CVE-2017-11704\nbefore I merge ?\n",
      "You should be able to get a successful travis build by rebasing to current master",
      "Fine, rebase fixed travis build.\r\n\r\nYes, I am planning to add more fixes to completely address CVE-2017-11704 if possible.",
      "Hum, I've looked into changing the type of `length` from `int` to `unsigned long`, but I'm not sure it's the right solution. This looks like a major refactoring and since I'm preparing the fix in sight of a Debian LTS security update, this is not exactly what I want.\r\n\r\nWhat about simply declaring length > `INT_MAX` unsupported ? This is already quite big (especially when `sizeof(int)` = 4) and could be a temporary solution. And, anyway, it would still be better than what we have now.",
      "In this case I'd suggest something like\r\n\r\n```\r\ndiff --git a/util/main.c b/util/main.c\r\nindex cb277804..923d4c75 100644\r\n--- a/util/main.c\r\n+++ b/util/main.c\r\n@@ -253,7 +253,16 @@ static void readMovie(FILE *f)\r\n                {\r\n                        if(filelen_check_fails(4))\r\n                                break;\r\n-                       length = readUInt32 (f);\r\n+                       unsigned long real_length = readUInt32 (f);\r\n+\r\n+                        if (real_length > INT_MAX) {\r\n+                           SWF_warn(\" Could not process long block with length %lu:\"\r\n+                                     \" blocks with length > %d not supported on this system\\n\",\r\n+                                     real_length, INT_MAX);\r\n+                            continue;\r\n+                        } else {\r\n+                            length = (int) real_length;\r\n+                        }\r\n                }\r\n                \r\n                //      printf (\"Found Block: %s (%i), %i bytes\\n\", blockName (type), type, length);\r\n```",
      "I have updated the PR to ship previously discussed patch. This PR should completely address CVE-2017-11704.",
      "Thank! Merged.\n"
    ]
  },
  "Bug Filter": "Security Vulnerability Fix",
  "Bug Filter Confidence": 1.0,
  "Bug Filter Response": "**Final Classification:** Security Vulnerability Fix  \n**Confidence:** 1.0"
}