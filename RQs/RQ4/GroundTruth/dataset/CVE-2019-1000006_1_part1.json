{
  "cve_id": "CVE-2019-1000006",
  "cwe_ids": [
    "CWE-787"
  ],
  "cvss_vector": "AV:N/AC:L/Au:N/C:P/I:P/A:P",
  "cvss_is_v3": false,
  "repo_name": "RIOT-OS/RIOT",
  "commit_msg": "sock_dns: fix out-of-bound errors\n\nFixes #10739",
  "commit_hash": "2840b3825eb6e0b7320fb111d06832ca9a9e3148",
  "git_url": "https://github.com/RIOT-OS/RIOT/commit/2840b3825eb6e0b7320fb111d06832ca9a9e3148",
  "file_path": "sys/net/application_layer/dns/dns.c",
  "func_name": "_skip_hostname",
  "func_before": "static size_t _skip_hostname(uint8_t *buf)\n{\n    uint8_t *bufpos = buf;\n\n    /* handle DNS Message Compression */\n    if (*bufpos >= 192) {\n        return 2;\n    }\n\n    while(*bufpos) {\n        bufpos += *bufpos + 1;\n    }\n    return (bufpos - buf + 1);\n}",
  "abstract_func_before": "static size_t _skip_hostname(uint8_t *VAR_0)\n{\n    uint8_t *VAR_1 = VAR_0;\n\n    /* COMMENT_0 */\n    if (*VAR_1 >= 192) {\n        return 2;\n    }\n\n    while(*VAR_1) {\n        VAR_1 += *VAR_1 + 1;\n    }\n    return (VAR_1 - VAR_0 + 1);\n}",
  "func_graph_path_before": "RIOT-OS/RIOT/2840b3825eb6e0b7320fb111d06832ca9a9e3148/dns.c/vul/before/0.json",
  "func": "static ssize_t _skip_hostname(const uint8_t *buf, size_t len, uint8_t *bufpos)\n{\n    const uint8_t *buflim = buf + len;\n    unsigned res = 0;\n\n    if (bufpos >= buflim) {\n        /* out-of-bound */\n        return -EBADMSG;\n    }\n    /* handle DNS Message Compression */\n    if (*bufpos >= 192) {\n        if ((bufpos + 2) >= buflim) {\n            return -EBADMSG;\n        }\n        return 2;\n    }\n\n    while (bufpos[res]) {\n        res += bufpos[res] + 1;\n        if ((&bufpos[res]) >= buflim) {\n            /* out-of-bound */\n            return -EBADMSG;\n        }\n    }\n    return res + 1;\n}",
  "abstract_func": "static ssize_t _skip_hostname(const uint8_t *VAR_0, size_t VAR_1, uint8_t *VAR_2)\n{\n    const uint8_t *VAR_3 = VAR_0 + VAR_1;\n    unsigned VAR_4 = 0;\n\n    if (VAR_2 >= VAR_3) {\n        /* COMMENT_0 */\n        return -VAR_5;\n    }\n    /* COMMENT_1 */\n    if (*VAR_2 >= 192) {\n        if ((VAR_2 + 2) >= VAR_3) {\n            return -VAR_5;\n        }\n        return 2;\n    }\n\n    while (VAR_2[VAR_4]) {\n        VAR_4 += VAR_2[VAR_4] + 1;\n        if ((&VAR_2[VAR_4]) >= VAR_3) {\n            /* COMMENT_0 */\n            return -VAR_5;\n        }\n    }\n    return VAR_4 + 1;\n}",
  "func_graph_path": "RIOT-OS/RIOT/2840b3825eb6e0b7320fb111d06832ca9a9e3148/dns.c/vul/after/0.json",
  "diff_func": "--- func_before\n+++ func_after\n@@ -1,14 +1,26 @@\n-static size_t _skip_hostname(uint8_t *buf)\n+static ssize_t _skip_hostname(const uint8_t *buf, size_t len, uint8_t *bufpos)\n {\n-    uint8_t *bufpos = buf;\n+    const uint8_t *buflim = buf + len;\n+    unsigned res = 0;\n \n+    if (bufpos >= buflim) {\n+        /* out-of-bound */\n+        return -EBADMSG;\n+    }\n     /* handle DNS Message Compression */\n     if (*bufpos >= 192) {\n+        if ((bufpos + 2) >= buflim) {\n+            return -EBADMSG;\n+        }\n         return 2;\n     }\n \n-    while(*bufpos) {\n-        bufpos += *bufpos + 1;\n+    while (bufpos[res]) {\n+        res += bufpos[res] + 1;\n+        if ((&bufpos[res]) >= buflim) {\n+            /* out-of-bound */\n+            return -EBADMSG;\n+        }\n     }\n-    return (bufpos - buf + 1);\n+    return res + 1;\n }",
  "diff_line_info": {
    "deleted_lines": [
      "static size_t _skip_hostname(uint8_t *buf)",
      "    uint8_t *bufpos = buf;",
      "    while(*bufpos) {",
      "        bufpos += *bufpos + 1;",
      "    return (bufpos - buf + 1);"
    ],
    "added_lines": [
      "static ssize_t _skip_hostname(const uint8_t *buf, size_t len, uint8_t *bufpos)",
      "    const uint8_t *buflim = buf + len;",
      "    unsigned res = 0;",
      "    if (bufpos >= buflim) {",
      "        /* out-of-bound */",
      "        return -EBADMSG;",
      "    }",
      "        if ((bufpos + 2) >= buflim) {",
      "            return -EBADMSG;",
      "        }",
      "    while (bufpos[res]) {",
      "        res += bufpos[res] + 1;",
      "        if ((&bufpos[res]) >= buflim) {",
      "            /* out-of-bound */",
      "            return -EBADMSG;",
      "        }",
      "    return res + 1;"
    ]
  },
  "is_vul": true,
  "pr_url": "https://github.com/RIOT-OS/RIOT/pull/10740",
  "description": {
    "pr_info": {
      "title": "sock_dns: fix out-of-bound errors",
      "number": 10740
    },
    "comment": [
      "\r\n<!--\r\nThe RIOT community cares a lot about code quality.\r\nTherefore, before describing what your contribution is about, we would like\r\nyou to make sure that your modifications are compliant with the RIOT\r\ncoding conventions, see https://github.com/RIOT-OS/RIOT/wiki/Coding-conventions.\r\n-->\r\n\r\n### Contribution description\r\nFixes #10739\r\n\r\n<!--\r\nPut here the description of your contribution:\r\n- describe which part(s) of RIOT is (are) involved\r\n- if it's a bug fix, describe the bug that it solves and how it is solved\r\n- you can also give more information to reviewers about how to test your changes\r\n-->\r\n\r\n\r\n### Testing procedure\r\nI compiled `tests/gnrc_sock_dns` with the following patch:\r\n\r\n```diff\r\ndiff --git a/tests/gnrc_sock_dns/Makefile b/tests/gnrc_sock_dns/Makefile\r\nindex 4ef2c75..0b3824e 100644\r\n--- a/tests/gnrc_sock_dns/Makefile\r\n+++ b/tests/gnrc_sock_dns/Makefile\r\n@@ -11,7 +11,11 @@ USEMODULE += sock_dns\r\n USEMODULE += gnrc_sock_udp\r\n USEMODULE += gnrc_ipv6_default\r\n USEMODULE += gnrc_ipv6_nib_dns\r\n-USEMODULE += gnrc_netdev_default\r\n+USEMODULE += ethos\r\n+\r\n+# ethos baudrate can be configured from make command\r\n+ETHOS_BAUDRATE ?= 115200\r\n+CFLAGS += -DETHOS_BAUDRATE=$(ETHOS_BAUDRATE) -DUSE_ETHOS_FOR_STDIO\r\n USEMODULE += auto_init_gnrc_netif\r\n \r\n USEMODULE += shell_commands\r\ndiff --git a/tests/gnrc_sock_dns/main.c b/tests/gnrc_sock_dns/main.c\r\nindex 52700fe..b8c2ad5 100644\r\n--- a/tests/gnrc_sock_dns/main.c\r\n+++ b/tests/gnrc_sock_dns/main.c\r\n@@ -40,7 +40,7 @@ int main(void)\r\n     uint8_t addr[16] = {0};\r\n \r\n     puts(\"waiting for router advertisement...\");\r\n-    xtimer_usleep(1U*1000000);\r\n+    xtimer_usleep(5U*1000000);\r\n \r\n     /* print network addresses */\r\n     puts(\"Configured network interfaces:\");\r\n```\r\n\r\nflashed a `samr21-xpro` (alternatively `pba-d-01-kw2x` as described in #10739 is also possible), and connected an ethos terminal to the node\r\n\r\n```\r\nsudo ./dist/tools/ethos/start_network.sh /dev/ttyACM0 tap0 affe:abe::/48\r\n```\r\n\r\nI reset the node to get its link-local address for later.\r\n\r\nThen I started a RADVD with the following config:\r\n\r\n```\r\ninterface tap0 {\r\n        AdvSendAdvert on;\r\n        MinRtrAdvInterval 3;\r\n        MaxRtrAdvInterval 10;\r\n        prefix affe:abe::/64 {\r\n                AdvOnLink off;\r\n                AdvAutonomous on;\r\n                AdvRouterAddr on;\r\n        };\r\n        RDNSS <a global address on your host> {\r\n            AdvRDNSSLifetime 60;\r\n        };\r\n};\r\n```\r\n\r\nand reconfigured the correct route to the host (the preconfigured route by `start_network.sh` does not work, since uhcpc is not available on the node):\r\n\r\n```sh\r\nsudo ip route del affe:abe::/64\r\nsudo ip route add affe:abe::/64 via \"<link-local address of node>\" dev tap0\r\n```\r\n\r\nThen I start the exploit script described in #10739 (or provided by https://github.com/beduino-project/exploit-riot-dns) and reset the node again to start the test. Without this PR the node will crash (note that the exploit described in #10739 does not work but only crashes the node since due to the usage of `ethos` the binary is different), withit it will just report `error resolving example.org`.\r\n\r\nI also tested expected operation as described in the application's README.\r\n\r\n<!--\r\nDetails steps to test your contribution:\r\n- which test/example to compile for which board and is there a 'test' command\r\n- how to know that it was not working/available in master\r\n- the expected success test output\r\n-->\r\n\r\n\r\n### Issues/PRs references\r\nFixes #10739.\r\n<!--\r\nExamples: Fixes #1234. See also #5678. Depends on PR #9876.\r\n\r\nPlease use keywords (e.g., fixes, resolve) with the links to the issues you\r\nresolved, this way they will be automatically closed when your pull request\r\nis merged. See https://help.github.com/articles/closing-issues-using-keywords/.\r\n-->\r\n",
      "Fixed some typos and unrelated changes that snuck in. Should be good for review now.",
      "How I sometimes wish C had exceptions.",
      "> How I sometimes wish C had exceptions.\r\n\r\nThose don't make your life any better and bloat the code (even Rust [does something else](https://doc.rust-lang.org/book/ch09-02-recoverable-errors-with-result.html))",
      "Addressed newest comments",
      "@kaspar030 backport to 2018.10?",
      "> @kaspar030 backport to 2018.10?\r\n\r\nYeah, I seem to remember that we intent to provide security fixes for the current release?",
      "I think this can be squashed?",
      "Squashed on top of original merge base.",
      "Fixed and squashed whitespace error reported by Murdock",
      "(here is the diff https://github.com/RIOT-OS/RIOT/compare/b1de000aef472e9508c0dd6b7a00ec9cd4124a34..1a61b8aadf18d437bb85660506aeb104313e79d0)",
      "@riot-ci is happy. @nmeum @pyropeter @kaspar030 @maribu are you?",
      "I just tried the test on native, it returns \"error resolving example.org\".\r\n\r\ndnsmasq seems to have gotten the request:\r\n\r\n```\r\n[kaspar@ng riot (minimize)]$ sudo dnsmasq -d -2 -z -i riot0 -q --no-resolv \\                                                                 \r\n>         --dhcp-range=::1,constructor:riot0,ra-only \\\r\n>         --listen-address 2001:db8::1 \\\r\n>         --host-record=example.org,10.0.0.1,2001:db8::1\r\ndnsmasq: started, version 2.80 cachesize 150\r\ndnsmasq: compile time options: IPv6 GNU-getopt DBus i18n IDN2 DHCP DHCPv6 no-Lua TFTP conntrack ipset auth DNSSEC loop-detect inotify dumpfile\r\ndnsmasq: warning: no upstream servers configured\r\ndnsmasq-dhcp: router advertisement on riot0\r\ndnsmasq-dhcp: router advertisement on 2001:db8::, constructed for riot0                                                                      \r\ndnsmasq-dhcp: RTR-ADVERT(riot0) 2001:db8::\r\ndnsmasq: read /etc/hosts - 0 addresses\r\ndnsmasq-dhcp: RTR-SOLICIT(riot0)\r\ndnsmasq-dhcp: RTR-ADVERT(riot0) 2001:db8::\r\ndnsmasq: config example.org is 2001:db8::1\r\ndnsmasq: config example.org is 10.0.0.1\r\ndnsmasq: config example.org is 2001:db8::1\r\ndnsmasq: config example.org is 10.0.0.1\r\n```\r\n",
      "dns.c line 124 returns ```-EMULTIHOP```",
      "> dns.c line 124 returns `-EMULTIHOP`\r\n\r\nsorry, ```-EBADMSG```",
      "Nope, it got moved to line 158. However, I found the bug (the return in l\n101 is wrong as it does not return the length of the hostname, but the\noffset of the end of the hostname).\n\n>\n",
      ">\n> I just tried the test on native, it returns \"error resolving example.org\".\n>\nPlease try again with 4c507e909d9b326801e2632f84c73ae89dfd5675\n",
      "> Please try again with [4c507e9](https://github.com/RIOT-OS/RIOT/commit/4c507e909d9b326801e2632f84c73ae89dfd5675)\r\n\r\nworks now. pls squash!",
      "Squashed. Diff of force push should show no difference ;) ",
      "Thanks everyone involved, and thanks @miri64 for dealing with the mess I created!\r\n\r\nLessons I learned:\r\n\r\n- sure it's fun to quickly hack together something like a DNS client. But just because it is working doesn't mean that it is safe. *always* double check when sharing it .\r\n- RIOT's review process needs a security tag. The buffer overflows in this code were so obvious...\r\n- even community members don't know about security@riot-os.org. Maybe we should add a big(er) note in the issue template?\r\n",
      "> Thanks everyone involved, and thanks @miri64 for dealing with the mess I created!\r\n\r\nWelp, I merged the mess IIRC, so I was as obligated as you ;-).",
      "> * sure it's fun to quickly hack together something like a DNS client. But just because it is working doesn't mean that it is safe. _always_ double check when sharing it .\r\n\r\nFailure tests, failure tests, failure tests. If I find some time tomorrow I will provide a PR for that (in a similar way as #10382 and #10392) before I tackle @maribu's suggestions in https://github.com/RIOT-OS/RIOT/pull/10740#pullrequestreview-190923775.",
      "Backport provided in #10757",
      "(forgot about that)"
    ]
  },
  "Bug Filter": "Security Vulnerability Fix",
  "Bug Filter Confidence": 0.95,
  "Bug Filter Response": "**Step-by-Step Explanation:**\n\n1. **Input Analysis:** Commit message mentions fixing out-of-bound errors, which are often security issues. The vulnerability description discusses an exploit causing a crash, implying a security flaw.\n\n2. **Consistency Check:** The code changes introduce bounds checking in the `_skip_hostname` function, directly addressing buffer overflow risks. The commit message aligns with these changes.\n\n3. **Purpose Evaluation:** The code modifies core logic related to DNS handling, which affects security by preventing overflows.\n\n4. **Security Assessment:** The patch prevents out-of-bound access, mitigating potential crashes or exploits. The presence of an exploit script indicates a security concern.\n\n5. **Non-Security Check:** Not applicable, as it's a security fix.\n\n6. **Confidence Scoring:** High confidence due to clear alignment between commit message, code changes, and security context.\n\n**Final Classification:** Security Vulnerability Fix; Confidence: 0.95"
}