{
  "cve_id": "CVE-2019-15784",
  "cwe_ids": [
    "CWE-129"
  ],
  "cvss_vector": "AV:N/AC:L/Au:N/C:P/I:P/A:P",
  "cvss_is_v3": false,
  "repo_name": "Haivision/srt",
  "commit_msg": "[core] Fixed sender list to reallocate on insert\nif required",
  "commit_hash": "47e589072c44350b0305c05066c224d1cbda992d",
  "git_url": "https://github.com/Haivision/srt/commit/47e589072c44350b0305c05066c224d1cbda992d",
  "file_path": "srtcore/queue.cpp",
  "func_name": "CSndUList::pop",
  "func_before": "int CSndUList::pop(sockaddr*& addr, CPacket& pkt)\n{\n   CGuard listguard(m_ListLock);\n\n   if (-1 == m_iLastEntry)\n      return -1;\n\n   // no pop until the next schedulled time\n   uint64_t ts;\n   CTimer::rdtsc(ts);\n   if (ts < m_pHeap[0]->m_llTimeStamp_tk)\n      return -1;\n\n   CUDT* u = m_pHeap[0]->m_pUDT;\n   remove_(u);\n\n#define UST(field) ( (u->m_b##field) ? \"+\" : \"-\" ) << #field << \" \"\n\n   HLOGC(mglog.Debug, log << \"SND:pop: requesting packet from @\" << u->socketID()\n           << \" STATUS: \"\n           << UST(Listening)\n           << UST(Connecting)\n           << UST(Connected)\n           << UST(Closing)\n           << UST(Shutdown)\n           << UST(Broken)\n           << UST(PeerHealth)\n           << UST(Opened)\n        );\n#undef UST\n\n   if (!u->m_bConnected || u->m_bBroken)\n      return -1;\n\n   // pack a packet from the socket\n   if (u->packData(pkt, ts) <= 0)\n      return -1;\n\n   addr = u->m_pPeerAddr;\n\n   // insert a new entry, ts is the next processing time\n   if (ts > 0)\n      insert_(ts, u);\n\n   return 1;\n}",
  "abstract_func_before": "int CSndUList::pop(sockaddr*& VAR_0, CPacket& VAR_1)\n{\n   CGuard listguard(m_ListLock);\n\n   if (-1 == VAR_2)\n      return -1;\n\n   /* COMMENT_0 */\n   uint64_t VAR_3;\n   CTimer::rdtsc(VAR_3);\n   if (VAR_3 < VAR_4[0]->m_llTimeStamp_tk)\n      return -1;\n\n   CUDT* VAR_5 = VAR_4[0]->m_pUDT;\n   remove_(VAR_5);\n\n#define UST(VAR_6) ( (u->m_b##field) ? \"+\" : \"-\" ) << #field << \" \"\n\n   HLOGC(VAR_7.Debug, VAR_8 << \"SND:pop: requesting packet from @\" << VAR_5->socketID()\n           << \" STATUS: \"\n           << UST(VAR_9)\n           << UST(VAR_10)\n           << UST(VAR_11)\n           << UST(VAR_12)\n           << UST(VAR_13)\n           << UST(VAR_14)\n           << UST(VAR_15)\n           << UST(VAR_16)\n        );\n#undef UST\n\n   if (!VAR_5->m_bConnected || VAR_5->m_bBroken)\n      return -1;\n\n   /* COMMENT_1 */\n   if (VAR_5->packData(VAR_1, VAR_3) <= 0)\n      return -1;\n\n   VAR_0 = VAR_5->m_pPeerAddr;\n\n   /* COMMENT_2 */\n   if (VAR_3 > 0)\n      insert_(VAR_3, VAR_5);\n\n   return 1;\n}",
  "func_graph_path_before": "Haivision/srt/47e589072c44350b0305c05066c224d1cbda992d/queue.cpp/vul/before/2.json",
  "func": "int CSndUList::pop(sockaddr*& addr, CPacket& pkt)\n{\n   CGuard listguard(m_ListLock);\n\n   if (-1 == m_iLastEntry)\n      return -1;\n\n   // no pop until the next schedulled time\n   uint64_t ts;\n   CTimer::rdtsc(ts);\n   if (ts < m_pHeap[0]->m_llTimeStamp_tk)\n      return -1;\n\n   CUDT* u = m_pHeap[0]->m_pUDT;\n   remove_(u);\n\n#define UST(field) ( (u->m_b##field) ? \"+\" : \"-\" ) << #field << \" \"\n\n   HLOGC(mglog.Debug, log << \"SND:pop: requesting packet from @\" << u->socketID()\n           << \" STATUS: \"\n           << UST(Listening)\n           << UST(Connecting)\n           << UST(Connected)\n           << UST(Closing)\n           << UST(Shutdown)\n           << UST(Broken)\n           << UST(PeerHealth)\n           << UST(Opened)\n        );\n#undef UST\n\n   if (!u->m_bConnected || u->m_bBroken)\n      return -1;\n\n   // pack a packet from the socket\n   if (u->packData(pkt, ts) <= 0)\n      return -1;\n\n   addr = u->m_pPeerAddr;\n\n   // insert a new entry, ts is the next processing time\n   if (ts > 0)\n      insert_norealloc(ts, u);\n\n   return 1;\n}",
  "abstract_func": "int CSndUList::pop(sockaddr*& VAR_0, CPacket& VAR_1)\n{\n   CGuard listguard(m_ListLock);\n\n   if (-1 == VAR_2)\n      return -1;\n\n   /* COMMENT_0 */\n   uint64_t VAR_3;\n   CTimer::rdtsc(VAR_3);\n   if (VAR_3 < VAR_4[0]->m_llTimeStamp_tk)\n      return -1;\n\n   CUDT* VAR_5 = VAR_4[0]->m_pUDT;\n   remove_(VAR_5);\n\n#define UST(VAR_6) ( (u->m_b##field) ? \"+\" : \"-\" ) << #field << \" \"\n\n   HLOGC(VAR_7.Debug, VAR_8 << \"SND:pop: requesting packet from @\" << VAR_5->socketID()\n           << \" STATUS: \"\n           << UST(VAR_9)\n           << UST(VAR_10)\n           << UST(VAR_11)\n           << UST(VAR_12)\n           << UST(VAR_13)\n           << UST(VAR_14)\n           << UST(VAR_15)\n           << UST(VAR_16)\n        );\n#undef UST\n\n   if (!VAR_5->m_bConnected || VAR_5->m_bBroken)\n      return -1;\n\n   /* COMMENT_1 */\n   if (VAR_5->packData(VAR_1, VAR_3) <= 0)\n      return -1;\n\n   VAR_0 = VAR_5->m_pPeerAddr;\n\n   /* COMMENT_2 */\n   if (VAR_3 > 0)\n      insert_norealloc(VAR_3, VAR_5);\n\n   return 1;\n}",
  "func_graph_path": "Haivision/srt/47e589072c44350b0305c05066c224d1cbda992d/queue.cpp/vul/after/2.json",
  "diff_func": "--- func_before\n+++ func_after\n@@ -40,7 +40,7 @@\n \n    // insert a new entry, ts is the next processing time\n    if (ts > 0)\n-      insert_(ts, u);\n+      insert_norealloc(ts, u);\n \n    return 1;\n }",
  "diff_line_info": {
    "deleted_lines": [
      "      insert_(ts, u);"
    ],
    "added_lines": [
      "      insert_norealloc(ts, u);"
    ]
  },
  "is_vul": true,
  "pr_url": "https://github.com/Haivision/srt/pull/811",
  "description": {
    "pr_info": {
      "title": "Potential CSndUList array overflow",
      "number": 811
    },
    "comment": [
      "This is a rework of #724 (closes #724).\r\nThe default size of `CSndUList` was 4096 elements. The list is a heap of SRT sockets, that are to be processed in the sender's thread.\r\nIt is very unlikely to have mare than 4096 SRT connections, that is why checking if there is a place to insert a new socket is not required most of the time. However, if there is no place, then there will be an overflow and out-of-border operations.\r\nThis PR fixes this.\r\n\r\n- [x] `CSndUList::update(...)` increases list size if required.\r\n- [x] Reduced default size of the `CSndUList` from 4096 to 512.\r\n- [x] `CSndUList::remove_(...)` now uses `std::swap`\r\n- [x] `CSndUList::insert_norealloc_(...)` now uses `std::swap`",
      "This vulnerability is tracked in [CVE-2019-15784](https://nvd.nist.gov/vuln/detail/CVE-2019-15784)\r\n@ethouris: Do you plan to make a new release soon? Thanks"
    ]
  },
  "Bug Filter": "Security Vulnerability Fix",
  "Bug Filter Confidence": 0.9,
  "Bug Filter Response": "**Final Classification:** Security Vulnerability Fix  \n**Confidence:** 0.9"
}