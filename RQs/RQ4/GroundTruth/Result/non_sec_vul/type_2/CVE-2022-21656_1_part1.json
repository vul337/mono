{
  "cve_id": "CVE-2022-21656",
  "cwe_ids": [
    "CWE-843"
  ],
  "cvss_vector": "AV:N/AC:M/Au:N/C:P/I:P/A:N",
  "cvss_is_v3": false,
  "repo_name": "envoyproxy/envoy",
  "commit_msg": "Specify type for matching Subject Alternative Name. (#18628)\n\n\r\nSigned-off-by: Pradeep Rao <pcrao@google.com>",
  "commit_hash": "bb95af848c939cfe5b5ee33c5b1770558077e64e",
  "git_url": "https://github.com/envoyproxy/envoy/commit/bb95af848c939cfe5b5ee33c5b1770558077e64e",
  "file_path": "source/common/ssl/certificate_validation_context_config_impl.cc",
  "func_name": "CertificateValidationContextConfigImpl::CertificateValidationContextConfigImpl",
  "func_before": "CertificateValidationContextConfigImpl::CertificateValidationContextConfigImpl(\n    const envoy::extensions::transport_sockets::tls::v3::CertificateValidationContext& config,\n    Api::Api& api)\n    : ca_cert_(Config::DataSource::read(config.trusted_ca(), true, api)),\n      ca_cert_path_(Config::DataSource::getPath(config.trusted_ca())\n                        .value_or(ca_cert_.empty() ? EMPTY_STRING : INLINE_STRING)),\n      certificate_revocation_list_(Config::DataSource::read(config.crl(), true, api)),\n      certificate_revocation_list_path_(\n          Config::DataSource::getPath(config.crl())\n              .value_or(certificate_revocation_list_.empty() ? EMPTY_STRING : INLINE_STRING)),\n      subject_alt_name_matchers_(config.match_subject_alt_names().begin(),\n                                 config.match_subject_alt_names().end()),\n      verify_certificate_hash_list_(config.verify_certificate_hash().begin(),\n                                    config.verify_certificate_hash().end()),\n      verify_certificate_spki_list_(config.verify_certificate_spki().begin(),\n                                    config.verify_certificate_spki().end()),\n      allow_expired_certificate_(config.allow_expired_certificate()),\n      trust_chain_verification_(config.trust_chain_verification()),\n      custom_validator_config_(\n          config.has_custom_validator_config()\n              ? absl::make_optional<envoy::config::core::v3::TypedExtensionConfig>(\n                    config.custom_validator_config())\n              : absl::nullopt),\n      api_(api), only_verify_leaf_cert_crl_(config.only_verify_leaf_cert_crl()) {\n  if (ca_cert_.empty() && custom_validator_config_ == absl::nullopt) {\n    if (!certificate_revocation_list_.empty()) {\n      throw EnvoyException(fmt::format(\"Failed to load CRL from {} without trusted CA\",\n                                       certificateRevocationListPath()));\n    }\n    if (!subject_alt_name_matchers_.empty()) {\n      throw EnvoyException(\"SAN-based verification of peer certificates without \"\n                           \"trusted CA is insecure and not allowed\");\n    }\n    if (allow_expired_certificate_) {\n      throw EnvoyException(\"Certificate validity period is always ignored without trusted CA\");\n    }\n  }\n}",
  "abstract_func_before": "CertificateValidationContextConfigImpl::CertificateValidationContextConfigImpl(\n    const envoy::extensions::transport_sockets::tls::v3::CertificateValidationContext& VAR_0,\n    Api::Api& VAR_1)\n    : ca_cert_(Config::DataSource::read(VAR_0.trusted_ca(), true, VAR_1)),\n      ca_cert_path_(Config::DataSource::getPath(VAR_0.trusted_ca())\n                        .value_or(VAR_2.empty() ? VAR_3 : VAR_4)),\n      certificate_revocation_list_(Config::DataSource::read(VAR_0.crl(), true, VAR_1)),\n      certificate_revocation_list_path_(\n          Config::DataSource::getPath(VAR_0.crl())\n              .value_or(VAR_5.empty() ? VAR_3 : VAR_4)),\n      subject_alt_name_matchers_(VAR_0.match_subject_alt_names().begin(),\n                                 VAR_0.match_subject_alt_names().end()),\n      verify_certificate_hash_list_(VAR_0.verify_certificate_hash().begin(),\n                                    VAR_0.verify_certificate_hash().end()),\n      verify_certificate_spki_list_(VAR_0.verify_certificate_spki().begin(),\n                                    VAR_0.verify_certificate_spki().end()),\n      allow_expired_certificate_(VAR_0.allow_expired_certificate()),\n      trust_chain_verification_(VAR_0.trust_chain_verification()),\n      custom_validator_config_(\n          VAR_0.has_custom_validator_config()\n              ? absl::VAR_6<envoy::config::core::v3::TypedExtensionConfig>(\n                    VAR_0.custom_validator_config())\n              : absl::nullopt),\n      api_(VAR_1), only_verify_leaf_cert_crl_(VAR_0.only_verify_leaf_cert_crl()) {\n  if (VAR_2.empty() && VAR_7 == absl::nullopt) {\n    if (!VAR_5.empty()) {\n      throw EnvoyException(fmt::format(\"Failed to load CRL from {} without trusted CA\",\n                                       certificateRevocationListPath()));\n    }\n    if (!VAR_8.empty()) {\n      throw EnvoyException(\"SAN-based verification of peer certificates without \"\n                           \"trusted CA is insecure and not allowed\");\n    }\n    if (VAR_9) {\n      throw EnvoyException(\"Certificate validity period is always ignored without trusted CA\");\n    }\n  }\n}",
  "func_graph_path_before": "envoyproxy/envoy/bb95af848c939cfe5b5ee33c5b1770558077e64e/certificate_validation_context_config_impl.cc/vul/before/0.json",
  "func": "CertificateValidationContextConfigImpl::CertificateValidationContextConfigImpl(\n    const envoy::extensions::transport_sockets::tls::v3::CertificateValidationContext& config,\n    Api::Api& api)\n    : ca_cert_(Config::DataSource::read(config.trusted_ca(), true, api)),\n      ca_cert_path_(Config::DataSource::getPath(config.trusted_ca())\n                        .value_or(ca_cert_.empty() ? EMPTY_STRING : INLINE_STRING)),\n      certificate_revocation_list_(Config::DataSource::read(config.crl(), true, api)),\n      certificate_revocation_list_path_(\n          Config::DataSource::getPath(config.crl())\n              .value_or(certificate_revocation_list_.empty() ? EMPTY_STRING : INLINE_STRING)),\n      subject_alt_name_matchers_(getSubjectAltNameMatchers(config)),\n      verify_certificate_hash_list_(config.verify_certificate_hash().begin(),\n                                    config.verify_certificate_hash().end()),\n      verify_certificate_spki_list_(config.verify_certificate_spki().begin(),\n                                    config.verify_certificate_spki().end()),\n      allow_expired_certificate_(config.allow_expired_certificate()),\n      trust_chain_verification_(config.trust_chain_verification()),\n      custom_validator_config_(\n          config.has_custom_validator_config()\n              ? absl::make_optional<envoy::config::core::v3::TypedExtensionConfig>(\n                    config.custom_validator_config())\n              : absl::nullopt),\n      api_(api), only_verify_leaf_cert_crl_(config.only_verify_leaf_cert_crl()) {\n  if (ca_cert_.empty() && custom_validator_config_ == absl::nullopt) {\n    if (!certificate_revocation_list_.empty()) {\n      throw EnvoyException(fmt::format(\"Failed to load CRL from {} without trusted CA\",\n                                       certificateRevocationListPath()));\n    }\n    if (!subject_alt_name_matchers_.empty()) {\n      throw EnvoyException(\"SAN-based verification of peer certificates without \"\n                           \"trusted CA is insecure and not allowed\");\n    }\n    if (allow_expired_certificate_) {\n      throw EnvoyException(\"Certificate validity period is always ignored without trusted CA\");\n    }\n  }\n}",
  "abstract_func": "CertificateValidationContextConfigImpl::CertificateValidationContextConfigImpl(\n    const envoy::extensions::transport_sockets::tls::v3::CertificateValidationContext& VAR_0,\n    Api::Api& VAR_1)\n    : ca_cert_(Config::DataSource::read(VAR_0.trusted_ca(), true, VAR_1)),\n      ca_cert_path_(Config::DataSource::getPath(VAR_0.trusted_ca())\n                        .value_or(VAR_2.empty() ? VAR_3 : VAR_4)),\n      certificate_revocation_list_(Config::DataSource::read(VAR_0.crl(), true, VAR_1)),\n      certificate_revocation_list_path_(\n          Config::DataSource::getPath(VAR_0.crl())\n              .value_or(VAR_5.empty() ? VAR_3 : VAR_4)),\n      subject_alt_name_matchers_(getSubjectAltNameMatchers(VAR_0)),\n      verify_certificate_hash_list_(VAR_0.verify_certificate_hash().begin(),\n                                    VAR_0.verify_certificate_hash().end()),\n      verify_certificate_spki_list_(VAR_0.verify_certificate_spki().begin(),\n                                    VAR_0.verify_certificate_spki().end()),\n      allow_expired_certificate_(VAR_0.allow_expired_certificate()),\n      trust_chain_verification_(VAR_0.trust_chain_verification()),\n      custom_validator_config_(\n          VAR_0.has_custom_validator_config()\n              ? absl::VAR_6<envoy::config::core::v3::TypedExtensionConfig>(\n                    VAR_0.custom_validator_config())\n              : absl::nullopt),\n      api_(VAR_1), only_verify_leaf_cert_crl_(VAR_0.only_verify_leaf_cert_crl()) {\n  if (VAR_2.empty() && VAR_7 == absl::nullopt) {\n    if (!VAR_5.empty()) {\n      throw EnvoyException(fmt::format(\"Failed to load CRL from {} without trusted CA\",\n                                       certificateRevocationListPath()));\n    }\n    if (!VAR_8.empty()) {\n      throw EnvoyException(\"SAN-based verification of peer certificates without \"\n                           \"trusted CA is insecure and not allowed\");\n    }\n    if (VAR_9) {\n      throw EnvoyException(\"Certificate validity period is always ignored without trusted CA\");\n    }\n  }\n}",
  "func_graph_path": "envoyproxy/envoy/bb95af848c939cfe5b5ee33c5b1770558077e64e/certificate_validation_context_config_impl.cc/vul/after/0.json",
  "diff_func": "--- func_before\n+++ func_after\n@@ -8,8 +8,7 @@\n       certificate_revocation_list_path_(\n           Config::DataSource::getPath(config.crl())\n               .value_or(certificate_revocation_list_.empty() ? EMPTY_STRING : INLINE_STRING)),\n-      subject_alt_name_matchers_(config.match_subject_alt_names().begin(),\n-                                 config.match_subject_alt_names().end()),\n+      subject_alt_name_matchers_(getSubjectAltNameMatchers(config)),\n       verify_certificate_hash_list_(config.verify_certificate_hash().begin(),\n                                     config.verify_certificate_hash().end()),\n       verify_certificate_spki_list_(config.verify_certificate_spki().begin(),",
  "diff_line_info": {
    "deleted_lines": [
      "      subject_alt_name_matchers_(config.match_subject_alt_names().begin(),",
      "                                 config.match_subject_alt_names().end()),"
    ],
    "added_lines": [
      "      subject_alt_name_matchers_(getSubjectAltNameMatchers(config)),"
    ]
  },
  "is_vul": true,
  "pr_url": "https://github.com/envoyproxy/envoy/pull/18628",
  "description": {
    "pr_info": {
      "title": "Specify type for matching Subject Alternative Name.",
      "number": 18628
    },
    "comment": [
      "Fixes #18259 \r\n\r\nSigned-off-by: Pradeep Rao <pcrao@google.com>\r\n\r\nCommit Message:\r\nAdditional Description:\r\nRisk Level: Low\r\nTesting: Added test\r\nDocs Changes: \r\nRelease Notes:\r\nPlatform Specific Features:\r\n\r\n",
      "CC @envoyproxy/api-shepherds: Your approval is needed for changes made to `api/envoy/`.\nenvoyproxy/api-shepherds assignee is @adisuissa\nCC @envoyproxy/api-watchers: FYI only for changes made to `api/envoy/`.\n\n\n<details>\n\t<summary>:cat:</summary>\n\nCaused by: https://github.com/envoyproxy/envoy/pull/18628 was opened by pradeepcrao.\n\nsee: [more](https://github.com/envoyproxy/envoy/pull/18628), [trace](https://prod.repokitteh.app/traces/ui/envoyproxy/envoy/43f59d30-2d01-11ec-9ba6-f409c4fc1d41).\n</details>",
      "With regards to having enum + StringMatcher, the enums would need to be one of the pound defines here: https://boringssl.googlesource.com/boringssl/+/refs/heads/master/include/openssl/x509v3.h#174 or an identifier type from here https://datatracker.ietf.org/doc/html/rfc6125#section-1.8\r\n\r\nThe issue is that a Stringmatcher would not make sense for every enum value, just the ones we support today. \r\n\r\nMy initial implementation was exactly that : enum + Stringmatcher instead of a typed config. I changed it when the above was pointed out to me.\r\n\r\nDoes that sound reasonable?",
      "> With regards to having enum + StringMatcher, the enums would need to be one of the pound defines here: https://boringssl.googlesource.com/boringssl/+/refs/heads/master/include/openssl/x509v3.h#174 or an identifier type from here https://datatracker.ietf.org/doc/html/rfc6125#section-1.8\r\n> \r\n> The issue is that a Stringmatcher would not make sense for every enum value, just the ones we support today.\r\n> \r\n> My initial implementation was exactly that : enum + Stringmatcher instead of a typed config. I changed it when the above was pointed out to me.\r\n> \r\n> Does that sound reasonable?\r\n\r\nI guess that if most use just a string matcher, then an enum + StringMatcher should be used to simplify the code, and a TypedExtension can be used to define the Other or some alternative that we don't support out of the box.\r\nSpecifically I suggest to have a generic string matcher message:\r\n```\r\nmessage StringSanMatcher {\r\n  MatcherTypeEnum type = 1;\r\n  type.matcher.v3.StringMatcher matcher = 2;\r\n}\r\n```\r\nand the wrapper message message will use either the string matcher or the TypedExtension:\r\n```\r\nmessage SubjectAltNameMatcher {\r\n  oneof {\r\n    StringSanMatcher string_matcher = 1;\r\n    core.v3.TypedExtensionConfig typed_config = 2;\r\n  }\r\n}\r\n```\r\n\r\nNote that this holds as long as we don't expect additional fields to the derived types (e.g., if `UriSanMatcher` will probably have an additional field later, then the current design may be better).\r\n",
      "CC @envoyproxy/api-shepherds: Your approval is needed for changes made to `(api/envoy/|docs/root/api-docs/)`.\nenvoyproxy/api-shepherds assignee is @adisuissa\nCC @envoyproxy/api-watchers: FYI only for changes made to `(api/envoy/|docs/root/api-docs/)`.\n\n\n<details>\n\t<summary>:cat:</summary>\n\nCaused by: https://github.com/envoyproxy/envoy/pull/18628 was synchronize by pradeepcrao.\n\nsee: [more](https://github.com/envoyproxy/envoy/pull/18628), [trace](https://prod.repokitteh.app/traces/ui/envoyproxy/envoy/0f3a1410-3718-11ec-8595-8e0fcd532110).\n</details>",
      "Hi @ggreenway, did you have any more comments about the PR? Are the changes satisfactory?\r\n\r\nI'm investigating the test that's failing in CI. On the face of it, it seems unrelated to this PR, as I have another PR for stats that has the same failure.",
      "/retest",
      "Retrying Azure Pipelines:\nRetried failed jobs in: [envoy-presubmit](https://dev.azure.com/cncf/4684fb3d-0389-4e0b-8251-221942316e06/_build/results?buildId=94394&view=results)\n\n\n<details>\n\t<summary>:cat:</summary>\n\nCaused by: a https://github.com/envoyproxy/envoy/pull/18628#issuecomment-967507609 was created by @pradeepcrao.\n\nsee: [more](https://github.com/envoyproxy/envoy/pull/18628#issuecomment-967507609), [trace](https://prod.repokitteh.app/traces/ui/envoyproxy/envoy/3e4962f0-43f8-11ec-9dea-a99363924994).\n</details>",
      "/retest",
      "Retrying Azure Pipelines:\nRetried failed jobs in: [envoy-presubmit](https://dev.azure.com/cncf/4684fb3d-0389-4e0b-8251-221942316e06/_build/results?buildId=94394&view=results)\n\n\n<details>\n\t<summary>:cat:</summary>\n\nCaused by: a https://github.com/envoyproxy/envoy/pull/18628#issuecomment-969174118 was created by @adisuissa.\n\nsee: [more](https://github.com/envoyproxy/envoy/pull/18628#issuecomment-969174118), [trace](https://prod.repokitteh.app/traces/ui/envoyproxy/envoy/33998ae0-463e-11ec-8f3e-725bde3b3c41).\n</details>",
      "The CI failure is due to a flaky test (see #19005). Will restart CI once Ryan's temporary fix #19007 is merged.",
      "/retest",
      "Retrying Azure Pipelines:\nCheck [envoy-presubmit](https://dev.azure.com/cncf/4684fb3d-0389-4e0b-8251-221942316e06/_build/results?buildId=94658&view=results) didn't fail.\n\n\n\n<details>\n\t<summary>:cat:</summary>\n\nCaused by: a https://github.com/envoyproxy/envoy/pull/18628#issuecomment-971612189 was created by @pradeepcrao.\n\nsee: [more](https://github.com/envoyproxy/envoy/pull/18628#issuecomment-971612189), [trace](https://prod.repokitteh.app/traces/ui/envoyproxy/envoy/32f15b50-47af-11ec-9c7f-1f1794953fc7).\n</details>",
      "/retest",
      "Retrying Azure Pipelines:\nRetried failed jobs in: [envoy-presubmit](https://dev.azure.com/cncf/4684fb3d-0389-4e0b-8251-221942316e06/_build/results?buildId=94835&view=results)\n\n\n<details>\n\t<summary>:cat:</summary>\n\nCaused by: a https://github.com/envoyproxy/envoy/pull/18628#issuecomment-974107254 was created by @pradeepcrao.\n\nsee: [more](https://github.com/envoyproxy/envoy/pull/18628#issuecomment-974107254), [trace](https://prod.repokitteh.app/traces/ui/envoyproxy/envoy/d0eb1820-4942-11ec-970c-ec4654e01002).\n</details>",
      "Hi @ggreenway, does this look good now? Do you have any pending concerns?"
    ]
  },
  "Bug Filter": "Defect Remediation & Feature Upgrades",
  "Bug Filter Confidence": 0.8,
  "Bug Filter Response": "\n\n**Final Output:**\n\nAnalysis: The patch modifies how subject alternative names are matched during certificate validation by introducing a helper function. The commit message focuses on specifying the type for matching, suggesting a functional improvement rather than addressing a security issue. The code change likely fixes a bug or enhances functionality without explicit security implications.\n\nFinal Classification: Defect Remediation & Feature Upgrades  \nConfidence Score: 0.8"
}