{
  "cve_id": "CVE-2022-23476",
  "cwe_ids": [
    "CWE-252",
    "CWE-476"
  ],
  "cvss_vector": "CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:N/I:N/A:H",
  "cvss_is_v3": true,
  "repo_name": "sparklemotion/nokogiri",
  "commit_msg": "fix(cruby): XML::Reader#attribute_hash returns nil on error\n\nNote that on JRuby, the namespaces are still returned because the\nparse error would raised on the subsequent node expansion.\n\nThis restores the behavior from v1.13.7",
  "commit_hash": "9fe0761c47c0d4270d1a5220cfd25de080350d50",
  "git_url": "https://github.com/sparklemotion/nokogiri/commit/9fe0761c47c0d4270d1a5220cfd25de080350d50",
  "file_path": "ext/nokogiri/xml_reader.c",
  "func_name": "rb_xml_reader_attribute_hash",
  "func_before": "static VALUE\nrb_xml_reader_attribute_hash(VALUE rb_reader)\n{\n  VALUE rb_attributes = rb_hash_new();\n  xmlTextReaderPtr c_reader;\n  xmlNodePtr c_node;\n  xmlAttrPtr c_property;\n\n  Data_Get_Struct(rb_reader, xmlTextReader, c_reader);\n\n  if (!has_attributes(c_reader)) {\n    return rb_attributes;\n  }\n\n  c_node = xmlTextReaderExpand(c_reader);\n  c_property = c_node->properties;\n  while (c_property != NULL) {\n    VALUE rb_name = NOKOGIRI_STR_NEW2(c_property->name);\n    VALUE rb_value = Qnil;\n    xmlChar *c_value = xmlNodeGetContent((xmlNode *)c_property);\n\n    if (c_value) {\n      rb_value = NOKOGIRI_STR_NEW2(c_value);\n      xmlFree(c_value);\n    }\n\n    rb_hash_aset(rb_attributes, rb_name, rb_value);\n\n    c_property = c_property->next;\n  }\n\n  return rb_attributes;\n}",
  "abstract_func_before": "static VALUE\nrb_xml_reader_attribute_hash(VALUE VAR_0)\n{\n  VALUE VAR_1 = rb_hash_new();\n  xmlTextReaderPtr VAR_2;\n  xmlNodePtr VAR_3;\n  xmlAttrPtr VAR_4;\n\n  Data_Get_Struct(VAR_0, VAR_5, VAR_2);\n\n  if (!has_attributes(VAR_2)) {\n    return VAR_1;\n  }\n\n  VAR_3 = xmlTextReaderExpand(VAR_2);\n  VAR_4 = VAR_3->properties;\n  while (VAR_4 != NULL) {\n    VALUE VAR_6 = NOKOGIRI_STR_NEW2(VAR_4->name);\n    VALUE VAR_7 = VAR_8;\n    xmlChar *VAR_9 = xmlNodeGetContent((xmlNode *)VAR_4);\n\n    if (VAR_9) {\n      VAR_7 = NOKOGIRI_STR_NEW2(VAR_9);\n      xmlFree(VAR_9);\n    }\n\n    rb_hash_aset(VAR_1, VAR_6, VAR_7);\n\n    VAR_4 = VAR_4->next;\n  }\n\n  return VAR_1;\n}",
  "func_graph_path_before": "sparklemotion/nokogiri/9fe0761c47c0d4270d1a5220cfd25de080350d50/xml_reader.c/vul/before/0.json",
  "func": "static VALUE\nrb_xml_reader_attribute_hash(VALUE rb_reader)\n{\n  VALUE rb_attributes = rb_hash_new();\n  xmlTextReaderPtr c_reader;\n  xmlNodePtr c_node;\n  xmlAttrPtr c_property;\n\n  Data_Get_Struct(rb_reader, xmlTextReader, c_reader);\n\n  if (!has_attributes(c_reader)) {\n    return rb_attributes;\n  }\n\n  c_node = xmlTextReaderExpand(c_reader);\n  if (c_node == NULL) {\n    return Qnil;\n  }\n\n  c_property = c_node->properties;\n  while (c_property != NULL) {\n    VALUE rb_name = NOKOGIRI_STR_NEW2(c_property->name);\n    VALUE rb_value = Qnil;\n    xmlChar *c_value = xmlNodeGetContent((xmlNode *)c_property);\n\n    if (c_value) {\n      rb_value = NOKOGIRI_STR_NEW2(c_value);\n      xmlFree(c_value);\n    }\n\n    rb_hash_aset(rb_attributes, rb_name, rb_value);\n\n    c_property = c_property->next;\n  }\n\n  return rb_attributes;\n}",
  "abstract_func": "static VALUE\nrb_xml_reader_attribute_hash(VALUE VAR_0)\n{\n  VALUE VAR_1 = rb_hash_new();\n  xmlTextReaderPtr VAR_2;\n  xmlNodePtr VAR_3;\n  xmlAttrPtr VAR_4;\n\n  Data_Get_Struct(VAR_0, VAR_5, VAR_2);\n\n  if (!has_attributes(VAR_2)) {\n    return VAR_1;\n  }\n\n  VAR_3 = xmlTextReaderExpand(VAR_2);\n  if (VAR_3 == NULL) {\n    return VAR_6;\n  }\n\n  VAR_4 = VAR_3->properties;\n  while (VAR_4 != NULL) {\n    VALUE VAR_7 = NOKOGIRI_STR_NEW2(VAR_4->name);\n    VALUE VAR_8 = VAR_6;\n    xmlChar *VAR_9 = xmlNodeGetContent((xmlNode *)VAR_4);\n\n    if (VAR_9) {\n      VAR_8 = NOKOGIRI_STR_NEW2(VAR_9);\n      xmlFree(VAR_9);\n    }\n\n    rb_hash_aset(VAR_1, VAR_7, VAR_8);\n\n    VAR_4 = VAR_4->next;\n  }\n\n  return VAR_1;\n}",
  "func_graph_path": "sparklemotion/nokogiri/9fe0761c47c0d4270d1a5220cfd25de080350d50/xml_reader.c/vul/after/0.json",
  "diff_func": "--- func_before\n+++ func_after\n@@ -13,6 +13,10 @@\n   }\n \n   c_node = xmlTextReaderExpand(c_reader);\n+  if (c_node == NULL) {\n+    return Qnil;\n+  }\n+\n   c_property = c_node->properties;\n   while (c_property != NULL) {\n     VALUE rb_name = NOKOGIRI_STR_NEW2(c_property->name);",
  "diff_line_info": {
    "deleted_lines": [],
    "added_lines": [
      "  if (c_node == NULL) {",
      "    return Qnil;",
      "  }",
      ""
    ]
  },
  "is_vul": true,
  "pr_url": "https://github.com/sparklemotion/nokogiri/pull/2715",
  "description": {
    "pr_info": {
      "title": "fix: XML::Reader#attribute_hash returns nil on error",
      "number": 2715
    },
    "comment": [
      "**What problem is this PR intended to solve?**\r\n\r\n`Reader#attribute_hash` does not behave the same way `Reader#attribute_nodes` behaved when parse errors are encountered.\r\n\r\nFor callers of `Reader#attributes` this restores the behavior from v1.13.7 before #2602.\r\n\r\nSee also the related change in #2714 which will land in v1.14.0 that raises a `SyntaxError` instead of returning `nil`.\r\n\r\n**Have you included adequate test coverage?**\r\n\r\nYes, coverage added.\r\n\r\n\r\n**Does this change affect the behavior of either the C or the Java implementations?**\r\n\r\nThe C and Java parsers differ in when they detect a syntax error in this case. libxml2 indicates an error when we try to expand a start tag that does not have a matching end tag, but xerces will defer the error until later. The tests reflect that difference.\r\n"
    ]
  },
  "Bug Filter": "Defect Remediation & Feature Upgrades",
  "Bug Filter Confidence": 0.8,
  "Bug Filter Response": "\n\n**Final Output:**\n\nAnalysis: The patch addresses a bug where XML::Reader#attribute_hash returned nil on error. The code change adds a null check to prevent accessing a null pointer, which fixes a potential crash or incorrect return value. This is a functional bug fix rather than a security vulnerability.\n\nFinal Classification: Defect Remediation & Feature Upgrades\n\nConfidence Score: 0.8"
}