{
  "cve_id": "CVE-2018-9862",
  "cwe_ids": [
    "CWE-838"
  ],
  "cvss_vector": "AV:L/AC:L/Au:N/C:C/I:C/A:C",
  "cvss_is_v3": false,
  "repo_name": "hyperhq/hyperstart",
  "commit_msg": "Security: fix a issue (similar to  runc CVE-2016-3697)\n\nSigned-off-by: y00316549 <yangshukui@huawei.com>",
  "commit_hash": "ad6e43325da7d5f8048f23451bef26fdf4c0f93d",
  "git_url": "https://github.com/hyperhq/hyperstart/commit/ad6e43325da7d5f8048f23451bef26fdf4c0f93d",
  "file_path": "src/util.c",
  "func_name": "hyper_getgrnam",
  "func_before": "struct group *hyper_getgrnam(const char *name)\n{\n\tgid_t gid = (gid_t)id_or_max(name);\n\tFILE *file = fopen(\"/etc/group\", \"r\");\n\tif (!file) {\n\t\tperror(\"faile to open /etc/group\");\n\t\treturn NULL;\n\t}\n\tfor (;;) {\n\t\tstruct group *gr = fgetgrent(file);\n\t\tif (!gr)\n\t\t\tbreak;\n\t\tif (!strcmp(gr->gr_name, name) || gr->gr_gid == gid) {\n\t\t\tfclose(file);\n\t\t\treturn gr;\n\t\t}\n\t}\n\tfclose(file);\n\treturn NULL;\n}",
  "abstract_func_before": "struct group *hyper_getgrnam(const char *VAR_0)\n{\n\tgid_t VAR_1 = (gid_t)id_or_max(VAR_0);\n\tFILE *VAR_2 = fopen(\"/etc/group\", \"r\");\n\tif (!VAR_2) {\n\t\tperror(\"faile to open /etc/group\");\n\t\treturn NULL;\n\t}\n\tfor (;;) {\n\t\tstruct group *VAR_3 = fgetgrent(VAR_2);\n\t\tif (!VAR_3)\n\t\t\tbreak;\n\t\tif (!strcmp(VAR_3->gr_name, VAR_0) || VAR_3->gr_gid == VAR_1) {\n\t\t\tfclose(VAR_2);\n\t\t\treturn VAR_3;\n\t\t}\n\t}\n\tfclose(VAR_2);\n\treturn NULL;\n}",
  "func_graph_path_before": "hyperhq/hyperstart/ad6e43325da7d5f8048f23451bef26fdf4c0f93d/util.c/vul/before/1.json",
  "func": "struct group *hyper_getgrnam(const char *name)\n{\n\tgid_t gid;\n\tFILE *file;\n\tstruct group *gr = NULL;\n\n\tgid = (gid_t)id_or_max(name);\n\tfile = fopen(\"/etc/group\", \"r\");\n\tif (!file) {\n\t\tperror(\"faile to open /etc/group\");\n\t\treturn NULL;\n\t}\n\tfor (;;) {\n\t\tgr = fgetgrent(file);\n\t\tif (!gr)\n\t\t\tbreak;\n\t\tif (gr->gr_gid == gid ||\n\t\t  (!strcmp(gr->gr_name, name) &&  (gid_t)INVALID_UGID == gid)) {\n\t\t\tfclose(file);\n\t\t\treturn gr;\n\t\t}\n\t}\n\tfclose(file);\n\treturn NULL;\n}",
  "abstract_func": "struct group *hyper_getgrnam(const char *VAR_0)\n{\n\tgid_t VAR_1;\n\tFILE *VAR_2;\n\tstruct group *VAR_3 = NULL;\n\n\tVAR_1 = (gid_t)id_or_max(VAR_0);\n\tVAR_2 = fopen(\"/etc/group\", \"r\");\n\tif (!VAR_2) {\n\t\tperror(\"faile to open /etc/group\");\n\t\treturn NULL;\n\t}\n\tfor (;;) {\n\t\tVAR_3 = fgetgrent(VAR_2);\n\t\tif (!VAR_3)\n\t\t\tbreak;\n\t\tif (VAR_3->gr_gid == VAR_1 ||\n\t\t  (!strcmp(VAR_3->gr_name, VAR_0) &&  (gid_t)VAR_4 == VAR_1)) {\n\t\t\tfclose(VAR_2);\n\t\t\treturn VAR_3;\n\t\t}\n\t}\n\tfclose(VAR_2);\n\treturn NULL;\n}",
  "func_graph_path": "hyperhq/hyperstart/ad6e43325da7d5f8048f23451bef26fdf4c0f93d/util.c/vul/after/1.json",
  "diff_func": "--- func_before\n+++ func_after\n@@ -1,16 +1,21 @@\n struct group *hyper_getgrnam(const char *name)\n {\n-\tgid_t gid = (gid_t)id_or_max(name);\n-\tFILE *file = fopen(\"/etc/group\", \"r\");\n+\tgid_t gid;\n+\tFILE *file;\n+\tstruct group *gr = NULL;\n+\n+\tgid = (gid_t)id_or_max(name);\n+\tfile = fopen(\"/etc/group\", \"r\");\n \tif (!file) {\n \t\tperror(\"faile to open /etc/group\");\n \t\treturn NULL;\n \t}\n \tfor (;;) {\n-\t\tstruct group *gr = fgetgrent(file);\n+\t\tgr = fgetgrent(file);\n \t\tif (!gr)\n \t\t\tbreak;\n-\t\tif (!strcmp(gr->gr_name, name) || gr->gr_gid == gid) {\n+\t\tif (gr->gr_gid == gid ||\n+\t\t  (!strcmp(gr->gr_name, name) &&  (gid_t)INVALID_UGID == gid)) {\n \t\t\tfclose(file);\n \t\t\treturn gr;\n \t\t}",
  "diff_line_info": {
    "deleted_lines": [
      "\tgid_t gid = (gid_t)id_or_max(name);",
      "\tFILE *file = fopen(\"/etc/group\", \"r\");",
      "\t\tstruct group *gr = fgetgrent(file);",
      "\t\tif (!strcmp(gr->gr_name, name) || gr->gr_gid == gid) {"
    ],
    "added_lines": [
      "\tgid_t gid;",
      "\tFILE *file;",
      "\tstruct group *gr = NULL;",
      "",
      "\tgid = (gid_t)id_or_max(name);",
      "\tfile = fopen(\"/etc/group\", \"r\");",
      "\t\tgr = fgetgrent(file);",
      "\t\tif (gr->gr_gid == gid ||",
      "\t\t  (!strcmp(gr->gr_name, name) &&  (gid_t)INVALID_UGID == gid)) {"
    ]
  },
  "is_vul": true,
  "pr_url": "https://github.com/hyperhq/hyperstart/pull/348",
  "description": {
    "pr_info": {
      "title": "Security: fix a issue (similar to  runc CVE-2016-3697)",
      "number": 348
    },
    "comment": [
      "It's a issue that is similar to runc CVE-2016-3697.\r\n\r\nBefore this pr,\r\n```\r\n[root@localhost ~]# docker run --rm -ti ... 797fd343ef02 bash\r\n[root@167b67fea278 /]# echo \"10:x:0:0:root:/root:/bin/bash\">/etc/passwd\r\n[root@167b67fea278 /]# cat /etc/passwd\r\n10:x:0:0:root:/root:/bin/bash\r\n\r\nanother console,\r\n[root@localhost ~]# docker exec -ti -u 10 hello  bash\r\nbash: /etc/profile.d/colorgrep.sh: Interrupted system call\r\n[10@167b67fea278 /]# id\r\nuid=0(10) gid=0(root) groups=0(root)\r\n```\r\n\r\nAfter this pr,\r\n```\r\n[root@localhost ~]# docker run --rm -ti ... 797fd343ef02 bash\r\n[root@167b67fea278 /]# echo \"10:x:0:0:root:/root:/bin/bash\">/etc/passwd\r\n[root@167b67fea278 /]# cat /etc/passwd\r\n10:x:0:0:root:/root:/bin/bash\r\n\r\nanother console,\r\n[root@localhost ~]# docker exec -ti -u 10 hello  bash\r\nbash: /etc/profile.d/colorgrep.sh: Interrupted system call\r\n[10@167b67fea278 /]# id\r\nuid=10(10) gid=0(root) groups=0(root)\r\n```\r\n\r\n\r\n\r\nSigned-off-by: y00316549 <yangshukui@huawei.com>",
      "Can one of the admins verify this patch?",
      "LGTM\r\ncc @laijs ",
      "Hello, Thanks for the fixing.\r\n\r\nCould you fix hyper_getpwnam() hyper_getgrnam() instead?\r\n(change it to: if the id is numeric, don't compare the name)\r\n\r\nOther info is needed from /etc/passwd even the id is numeric.",
      "I have improved it. thank you.",
      "I don't think there are any differents in the new code. How do you test it?"
    ]
  },
  "Bug Filter": "Security Vulnerability Fix",
  "Bug Filter Confidence": 1.0,
  "Bug Filter Response": "The patch addresses a security issue by fixing a vulnerability related to user privilege escalation, similar to a known CVE. The code modifications enforce stricter group and user ID checks, preventing unauthorized elevation of privileges.\n\n**Final Classification:** Security Vulnerability Fix\n**Confidence:** 1.0"
}