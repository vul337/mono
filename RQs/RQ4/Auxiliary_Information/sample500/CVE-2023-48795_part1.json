{
  "cve_id": "CVE-2023-48795",
  "cwe_ids": [
    "CWE-354"
  ],
  "cvss_vector": "CVSS:3.1/AV:N/AC:H/PR:N/UI:N/S:U/C:N/I:H/A:N",
  "cvss_is_v3": true,
  "repo_name": "hierynomus/sshj",
  "commit_msg": "Implement OpenSSH strict key exchange extension",
  "commit_hash": "94fcc960e0fb198ddec0f7efc53f95ac627fe083",
  "git_url": "https://github.com/hierynomus/sshj/commit/94fcc960e0fb198ddec0f7efc53f95ac627fe083",
  "file_path": "src/itest/java/com/hierynomus/sshj/SshdContainer.java",
  "func_name": "accept",
  "func_before": "public void accept(@NotNull DockerfileBuilder builder) {\n            builder.from(\"alpine:3.18.3\");\n            builder.run(\"apk add --no-cache openssh\");\n            builder.expose(22);\n            builder.copy(\"entrypoint.sh\", \"/entrypoint.sh\");\n\n            builder.add(\"authorized_keys\", \"/home/sshj/.ssh/authorized_keys\");\n            builder.copy(\"test-container/trusted_ca_keys\", \"/etc/ssh/trusted_ca_keys\");\n\n            for (String hostKey : hostKeys) {\n                builder.copy(hostKey, \"/etc/ssh/\" + Paths.get(hostKey).getFileName());\n                builder.copy(hostKey + \".pub\", \"/etc/ssh/\" + Paths.get(hostKey).getFileName() + \".pub\");\n            }\n\n            for (String certificate : certificates) {\n                builder.copy(certificate, \"/etc/ssh/\" + Paths.get(certificate).getFileName());\n            }\n\n\n            builder.run(\"apk add --no-cache tini\"\n                    + \" && echo \\\"root:smile\\\" | chpasswd\"\n                    + \" && adduser -D -s /bin/ash sshj\"\n                    + \" && passwd -u sshj\"\n                    + \" && echo \\\"sshj:ultrapassword\\\" | chpasswd\"\n                    + \" && chmod 600 /home/sshj/.ssh/authorized_keys\"\n                    + \" && chmod 600 /etc/ssh/ssh_host_*_key\"\n                    + \" && chmod 644 /etc/ssh/*.pub\"\n                    + \" && chmod 755 /entrypoint.sh\"\n                    + \" && chown -R sshj:sshj /home/sshj\");\n            builder.entryPoint(\"/sbin/tini\", \"/entrypoint.sh\", \"-o\", \"LogLevel=DEBUG2\");\n\n            builder.add(\"sshd_config\", \"/etc/ssh/sshd_config\");\n        }",
  "abstract_func_before": "public void accept(@NotNull DockerfileBuilder VAR_0) {\n            VAR_0.from(\"alpine:3.18.3\");\n            VAR_0.run(\"apk add --no-cache openssh\");\n            VAR_0.expose(22);\n            VAR_0.copy(\"entrypoint.sh\", \"/entrypoint.sh\");\n\n            VAR_0.add(\"authorized_keys\", \"/home/sshj/.ssh/authorized_keys\");\n            VAR_0.copy(\"test-container/trusted_ca_keys\", \"/etc/ssh/trusted_ca_keys\");\n\n            for (String VAR_1 : VAR_2) {\n                VAR_0.copy(VAR_1, \"/etc/ssh/\" + VAR_3.get(VAR_1).getFileName());\n                VAR_0.copy(VAR_1 + \".pub\", \"/etc/ssh/\" + VAR_3.get(VAR_1).getFileName() + \".pub\");\n            }\n\n            for (String VAR_4 : VAR_5) {\n                VAR_0.copy(VAR_4, \"/etc/ssh/\" + VAR_3.get(VAR_4).getFileName());\n            }\n\n\n            VAR_0.run(\"apk add --no-cache tini\"\n                    + \" && echo \\\"root:smile\\\" | chpasswd\"\n                    + \" && adduser -D -s /bin/ash sshj\"\n                    + \" && passwd -u sshj\"\n                    + \" && echo \\\"sshj:ultrapassword\\\" | chpasswd\"\n                    + \" && chmod 600 /home/sshj/.ssh/authorized_keys\"\n                    + \" && chmod 600 /etc/ssh/ssh_host_*_key\"\n                    + \" && chmod 644 /etc/ssh/*.pub\"\n                    + \" && chmod 755 /entrypoint.sh\"\n                    + \" && chown -R sshj:sshj /home/sshj\");\n            VAR_0.entryPoint(\"/sbin/tini\", \"/entrypoint.sh\", \"-o\", \"LogLevel=DEBUG2\");\n\n            VAR_0.add(\"sshd_config\", \"/etc/ssh/sshd_config\");\n        }",
  "func_graph_path_before": "hierynomus/sshj/94fcc960e0fb198ddec0f7efc53f95ac627fe083/SshdContainer.java/vul/before/0.json",
  "func": "@Override\n        public void accept(@NotNull DockerfileBuilder builder) {\n            builder.from(\"alpine:3.19.0\");\n            builder.run(\"apk add --no-cache openssh\");\n            builder.expose(22);\n            builder.copy(\"entrypoint.sh\", \"/entrypoint.sh\");\n\n            builder.add(\"authorized_keys\", \"/home/sshj/.ssh/authorized_keys\");\n            builder.copy(\"test-container/trusted_ca_keys\", \"/etc/ssh/trusted_ca_keys\");\n\n            for (String hostKey : hostKeys) {\n                builder.copy(hostKey, \"/etc/ssh/\" + Paths.get(hostKey).getFileName());\n                builder.copy(hostKey + \".pub\", \"/etc/ssh/\" + Paths.get(hostKey).getFileName() + \".pub\");\n            }\n\n            for (String certificate : certificates) {\n                builder.copy(certificate, \"/etc/ssh/\" + Paths.get(certificate).getFileName());\n            }\n\n\n            builder.run(\"apk add --no-cache tini\"\n                    + \" && echo \\\"root:smile\\\" | chpasswd\"\n                    + \" && adduser -D -s /bin/ash sshj\"\n                    + \" && passwd -u sshj\"\n                    + \" && echo \\\"sshj:ultrapassword\\\" | chpasswd\"\n                    + \" && chmod 600 /home/sshj/.ssh/authorized_keys\"\n                    + \" && chmod 600 /etc/ssh/ssh_host_*_key\"\n                    + \" && chmod 644 /etc/ssh/*.pub\"\n                    + \" && chmod 755 /entrypoint.sh\"\n                    + \" && chown -R sshj:sshj /home/sshj\");\n            builder.entryPoint(\"/sbin/tini\", \"/entrypoint.sh\", \"-o\", \"LogLevel=DEBUG2\");\n\n            builder.add(\"sshd_config\", \"/etc/ssh/sshd_config\");\n        }",
  "abstract_func": "@Override\n        public void accept(@NotNull DockerfileBuilder VAR_0) {\n            VAR_0.from(\"alpine:3.19.0\");\n            VAR_0.run(\"apk add --no-cache openssh\");\n            VAR_0.expose(22);\n            VAR_0.copy(\"entrypoint.sh\", \"/entrypoint.sh\");\n\n            VAR_0.add(\"authorized_keys\", \"/home/sshj/.ssh/authorized_keys\");\n            VAR_0.copy(\"test-container/trusted_ca_keys\", \"/etc/ssh/trusted_ca_keys\");\n\n            for (String VAR_1 : VAR_2) {\n                VAR_0.copy(VAR_1, \"/etc/ssh/\" + VAR_3.get(VAR_1).getFileName());\n                VAR_0.copy(VAR_1 + \".pub\", \"/etc/ssh/\" + VAR_3.get(VAR_1).getFileName() + \".pub\");\n            }\n\n            for (String VAR_4 : VAR_5) {\n                VAR_0.copy(VAR_4, \"/etc/ssh/\" + VAR_3.get(VAR_4).getFileName());\n            }\n\n\n            VAR_0.run(\"apk add --no-cache tini\"\n                    + \" && echo \\\"root:smile\\\" | chpasswd\"\n                    + \" && adduser -D -s /bin/ash sshj\"\n                    + \" && passwd -u sshj\"\n                    + \" && echo \\\"sshj:ultrapassword\\\" | chpasswd\"\n                    + \" && chmod 600 /home/sshj/.ssh/authorized_keys\"\n                    + \" && chmod 600 /etc/ssh/ssh_host_*_key\"\n                    + \" && chmod 644 /etc/ssh/*.pub\"\n                    + \" && chmod 755 /entrypoint.sh\"\n                    + \" && chown -R sshj:sshj /home/sshj\");\n            VAR_0.entryPoint(\"/sbin/tini\", \"/entrypoint.sh\", \"-o\", \"LogLevel=DEBUG2\");\n\n            VAR_0.add(\"sshd_config\", \"/etc/ssh/sshd_config\");\n        }",
  "func_graph_path": "hierynomus/sshj/94fcc960e0fb198ddec0f7efc53f95ac627fe083/SshdContainer.java/vul/after/0.json",
  "diff_func": "--- func_before\n+++ func_after\n@@ -1,5 +1,6 @@\n-public void accept(@NotNull DockerfileBuilder builder) {\n-            builder.from(\"alpine:3.18.3\");\n+@Override\n+        public void accept(@NotNull DockerfileBuilder builder) {\n+            builder.from(\"alpine:3.19.0\");\n             builder.run(\"apk add --no-cache openssh\");\n             builder.expose(22);\n             builder.copy(\"entrypoint.sh\", \"/entrypoint.sh\");",
  "diff_line_info": {
    "deleted_lines": [
      "public void accept(@NotNull DockerfileBuilder builder) {",
      "            builder.from(\"alpine:3.18.3\");"
    ],
    "added_lines": [
      "@Override",
      "        public void accept(@NotNull DockerfileBuilder builder) {",
      "            builder.from(\"alpine:3.19.0\");"
    ]
  },
  "is_vul": true,
  "pr_url": "https://github.com/hierynomus/sshj/pull/917",
  "description": {
    "pr_info": {
      "title": "Implement OpenSSH strict key exchange extension",
      "number": 917
    },
    "comment": [
      "Resolves #916 \r\n\r\nThe PR implements the algorithm described in section 1.9 of https://github.com/openssh/openssh-portable/blob/master/PROTOCOL and also follows the changes implemented in the commit https://github.com/openssh/openssh-portable/commit/1edb00c58f8a6875fad6a497aa2bacf37f9e6cd5.\r\n\r\nAll tests are successful. The integration tests work both against the current container and a custom built container with OpenSSH 9.6p1. When run against the latter, the log also show that the resets of sequence numbers are happening, and working correctly as otherwise ChaCha20-Poly1305 should break.\r\n\r\nThe jsch fork of mwiede also implemented config switches to disable or enforce the strict key exchange extension. But I'm not sure whether it makes sense to maintain such flags long term when OpenSSH itself doesn't have them: https://github.com/mwiede/jsch/pull/461\r\n\r\nThe Terrapin Scanner referenced in #916 is happy, but I think it only checks whether the additional pseudo-key exchange `kex-strict-c-v00@openssh.com` is being advertised by the client:\r\n\r\n```\r\n================================================================================\r\n==================================== Report ====================================\r\n================================================================================\r\n\r\nRemote Banner: SSH-2.0-SSHJ_0.18.0\r\n\r\nChaCha20-Poly1305 support:   true\r\nCBC-EtM support:             true\r\n\r\nStrict key exchange support: true\r\n\r\n==> The scanned peer supports Terrapin mitigations and can establish\r\n    connections that are NOT VULNERABLE to Terrapin. Glad to see this.\r\n    For strict key exchange to take effect, both peers must support it.\r\n\r\nNote: This tool is provided as is, with no warranty whatsoever. It determines\r\n      the vulnerability of a peer by checking the supported algorithms and\r\n      support for strict key exchange. It may falsely claim a peer to be\r\n      vulnerable if the vendor supports countermeasures other than strict key\r\n      exchange.\r\n\r\nFor more details visit our website available at https://terrapin-attack.com\r\n```\r\n\r\n",
      "Thanks for the PR. It would be great to have some unit and/or integration tests attached!",
      "Yes, I still need to find a good approach for them. 😄 \r\n\r\nThe integration tests cover most of the changes automatically, but the interesting bits only if the openssh version is new enough. I'll have a look whether there is a way to test things specifically, e.g. by assertions on the logs. Unit tests that are not too brittle might be harder.",
      "## [Codecov](https://app.codecov.io/gh/hierynomus/sshj/pull/917?src=pr&el=h1&utm_medium=referral&utm_source=github&utm_content=comment&utm_campaign=pr+comments&utm_term=Jeroen+van+Erp) Report\nAttention: `17 lines` in your changes are missing coverage. Please review.\n> Comparison is base [(`50c753d`)](https://app.codecov.io/gh/hierynomus/sshj/commit/50c753dc5801612bec33ff6fa205c3d8a17d854a?el=desc&utm_medium=referral&utm_source=github&utm_content=comment&utm_campaign=pr+comments&utm_term=Jeroen+van+Erp) 68.85% compared to head [(`94fcc96`)](https://app.codecov.io/gh/hierynomus/sshj/pull/917?src=pr&el=desc&utm_medium=referral&utm_source=github&utm_content=comment&utm_campaign=pr+comments&utm_term=Jeroen+van+Erp) 68.77%.\n\n| [Files](https://app.codecov.io/gh/hierynomus/sshj/pull/917?src=pr&el=tree&utm_medium=referral&utm_source=github&utm_content=comment&utm_campaign=pr+comments&utm_term=Jeroen+van+Erp) | Patch % | Lines |\n|---|---|---|\n| [.../java/net/schmizz/sshj/transport/KeyExchanger.java](https://app.codecov.io/gh/hierynomus/sshj/pull/917?src=pr&el=tree&utm_medium=referral&utm_source=github&utm_content=comment&utm_campaign=pr+comments&utm_term=Jeroen+van+Erp#diff-c3JjL21haW4vamF2YS9uZXQvc2NobWl6ei9zc2hqL3RyYW5zcG9ydC9LZXlFeGNoYW5nZXIuamF2YQ==) | 47.05% | [6 Missing and 3 partials :warning: ](https://app.codecov.io/gh/hierynomus/sshj/pull/917?src=pr&el=tree&utm_medium=referral&utm_source=github&utm_content=comment&utm_campaign=pr+comments&utm_term=Jeroen+van+Erp) |\n| [...java/net/schmizz/sshj/transport/TransportImpl.java](https://app.codecov.io/gh/hierynomus/sshj/pull/917?src=pr&el=tree&utm_medium=referral&utm_source=github&utm_content=comment&utm_campaign=pr+comments&utm_term=Jeroen+van+Erp#diff-c3JjL21haW4vamF2YS9uZXQvc2NobWl6ei9zc2hqL3RyYW5zcG9ydC9UcmFuc3BvcnRJbXBsLmphdmE=) | 37.50% | [2 Missing and 3 partials :warning: ](https://app.codecov.io/gh/hierynomus/sshj/pull/917?src=pr&el=tree&utm_medium=referral&utm_source=github&utm_content=comment&utm_campaign=pr+comments&utm_term=Jeroen+van+Erp) |\n| [...ain/java/net/schmizz/sshj/transport/Converter.java](https://app.codecov.io/gh/hierynomus/sshj/pull/917?src=pr&el=tree&utm_medium=referral&utm_source=github&utm_content=comment&utm_campaign=pr+comments&utm_term=Jeroen+van+Erp#diff-c3JjL21haW4vamF2YS9uZXQvc2NobWl6ei9zc2hqL3RyYW5zcG9ydC9Db252ZXJ0ZXIuamF2YQ==) | 0.00% | [2 Missing and 1 partial :warning: ](https://app.codecov.io/gh/hierynomus/sshj/pull/917?src=pr&el=tree&utm_medium=referral&utm_source=github&utm_content=comment&utm_campaign=pr+comments&utm_term=Jeroen+van+Erp) |\n\n<details><summary>Additional details and impacted files</summary>\n\n\n```diff\n@@             Coverage Diff              @@\n##             master     #917      +/-   ##\n============================================\n- Coverage     68.85%   68.77%   -0.09%     \n- Complexity     1430     1438       +8     \n============================================\n  Files           208      208              \n  Lines          7574     7602      +28     \n  Branches        651      658       +7     \n============================================\n+ Hits           5215     5228      +13     \n- Misses         2012     2019       +7     \n- Partials        347      355       +8     \n```\n\n\n\n</details>\n\n[:umbrella: View full report in Codecov by Sentry](https://app.codecov.io/gh/hierynomus/sshj/pull/917?src=pr&el=continue&utm_medium=referral&utm_source=github&utm_content=comment&utm_campaign=pr+comments&utm_term=Jeroen+van+Erp).   \n:loudspeaker: Have feedback on the report? [Share it here](https://about.codecov.io/codecov-pr-comment-feedback/?utm_medium=referral&utm_source=github&utm_content=comment&utm_campaign=pr+comments&utm_term=Jeroen+van+Erp).\n",
      "I updated the alpine base image for the integration tests to 3.19.0 so that they now use OpenSSH 9.6. I also added an integration test that makes specific assertions on the logs.",
      "Great work! I'm going to merge it."
    ]
  },
  "Bug Filter": "Security Vulnerability Fix",
  "Bug Filter Confidence": 0.7,
  "Bug Filter Response": "**Final Classification:** Security Vulnerability Fix  \n**Confidence:** 0.7  \n\nThe patch addresses a security vulnerability related to the Terrapin attack by updating the OpenSSH configuration. The Dockerfile update to a newer image likely includes necessary security patches, though the direct code changes are not explicitly shown."
}