{
  "cve_id": "CVE-2021-37155",
  "cwe_ids": [
    "CWE-Other"
  ],
  "cvss_vector": "AV:N/AC:L/Au:N/C:P/I:P/A:P",
  "cvss_is_v3": false,
  "repo_name": "wolfSSL/wolfssl",
  "commit_msg": "Fix CompareOcspReqResp.\n\nThere was a bug in this function that could cause a match to be reported even\nwhen the OCSP request and response in fact had a mismatch.",
  "commit_hash": "73076940af8904f98eee085994c176fe1876b95a",
  "git_url": "https://github.com/wolfSSL/wolfssl/commit/73076940af8904f98eee085994c176fe1876b95a",
  "file_path": "src/ssl.c",
  "func_name": "wolfSSL_CertManagerCheckOCSPResponse",
  "func_before": "WOLFSSL_API int wolfSSL_CertManagerCheckOCSPResponse(WOLFSSL_CERT_MANAGER *cm,\n                                                    byte *response, int responseSz, buffer *responseBuffer,\n                                                    CertStatus *status, OcspEntry *entry, OcspRequest *ocspRequest)\n{\n    int ret;\n\n    WOLFSSL_ENTER(\"wolfSSL_CertManagerCheckOCSP_Staple\");\n    if (cm == NULL || response == NULL)\n        return BAD_FUNC_ARG;\n    if (cm->ocspEnabled == 0)\n        return WOLFSSL_SUCCESS;\n\n    ret = CheckOcspResponse(cm->ocsp, response, responseSz, responseBuffer, status,\n                        entry, ocspRequest);\n\n    return ret == 0 ? WOLFSSL_SUCCESS : ret;\n}",
  "abstract_func_before": "WOLFSSL_API VAR_0 wolfSSL_CertManagerCheckOCSPResponse(WOLFSSL_CERT_MANAGER *VAR_1,\n                                                    byte *VAR_2, int VAR_3, buffer *VAR_4,\n                                                    CertStatus *VAR_5, OcspEntry *VAR_6, OcspRequest *VAR_7)\n{\n    int VAR_8;\n\n    WOLFSSL_ENTER(\"wolfSSL_CertManagerCheckOCSP_Staple\");\n    if (VAR_1 == NULL || VAR_2 == NULL)\n        return VAR_9;\n    if (VAR_1->ocspEnabled == 0)\n        return VAR_10;\n\n    VAR_8 = CheckOcspResponse(VAR_1->ocsp, VAR_2, VAR_3, VAR_4, VAR_5,\n                        VAR_6, VAR_7);\n\n    return VAR_8 == 0 ? VAR_10 : VAR_8;\n}",
  "func_graph_path_before": null,
  "func": "WOLFSSL_API int wolfSSL_CertManagerCheckOCSPResponse(WOLFSSL_CERT_MANAGER *cm,\n                                                    byte *response, int responseSz, buffer *responseBuffer,\n                                                    CertStatus *status, OcspEntry *entry, OcspRequest *ocspRequest)\n{\n    int ret;\n\n    WOLFSSL_ENTER(\"wolfSSL_CertManagerCheckOCSPResponse\");\n    if (cm == NULL || response == NULL)\n        return BAD_FUNC_ARG;\n    if (cm->ocspEnabled == 0)\n        return WOLFSSL_SUCCESS;\n\n    ret = CheckOcspResponse(cm->ocsp, response, responseSz, responseBuffer, status,\n                        entry, ocspRequest);\n\n    return ret == 0 ? WOLFSSL_SUCCESS : ret;\n}",
  "abstract_func": "WOLFSSL_API VAR_0 wolfSSL_CertManagerCheckOCSPResponse(WOLFSSL_CERT_MANAGER *VAR_1,\n                                                    byte *VAR_2, int VAR_3, buffer *VAR_4,\n                                                    CertStatus *VAR_5, OcspEntry *VAR_6, OcspRequest *VAR_7)\n{\n    int VAR_8;\n\n    WOLFSSL_ENTER(\"wolfSSL_CertManagerCheckOCSPResponse\");\n    if (VAR_1 == NULL || VAR_2 == NULL)\n        return VAR_9;\n    if (VAR_1->ocspEnabled == 0)\n        return VAR_10;\n\n    VAR_8 = CheckOcspResponse(VAR_1->ocsp, VAR_2, VAR_3, VAR_4, VAR_5,\n                        VAR_6, VAR_7);\n\n    return VAR_8 == 0 ? VAR_10 : VAR_8;\n}",
  "func_graph_path": null,
  "diff_func": "--- func_before\n+++ func_after\n@@ -4,7 +4,7 @@\n {\n     int ret;\n \n-    WOLFSSL_ENTER(\"wolfSSL_CertManagerCheckOCSP_Staple\");\n+    WOLFSSL_ENTER(\"wolfSSL_CertManagerCheckOCSPResponse\");\n     if (cm == NULL || response == NULL)\n         return BAD_FUNC_ARG;\n     if (cm->ocspEnabled == 0)",
  "diff_line_info": {
    "deleted_lines": [
      "    WOLFSSL_ENTER(\"wolfSSL_CertManagerCheckOCSP_Staple\");"
    ],
    "added_lines": [
      "    WOLFSSL_ENTER(\"wolfSSL_CertManagerCheckOCSPResponse\");"
    ]
  },
  "is_vul": true,
  "pr_url": "https://github.com/wolfSSL/wolfssl/pull/3990",
  "description": {
    "pr_info": {
      "title": "Fix CompareOcspReqResp.",
      "number": 3990
    },
    "comment": [
      "There was a bug in this function that could cause a match to be reported even\r\nwhen the OCSP request and response in fact had a mismatch.\r\nZD 12148",
      "@haydenroche5 , this PR now appears to be causing failures in master with --enable-all?\r\n\r\n```\r\n./configure --enable-all && make\r\n\r\n./scripts/unit.test\r\nstarting unit tests...\r\n\r\n-----------------Porting tests------------------\r\n Begin API Tests\r\n   wolfSSL_Init(): passed\r\n   wolfSSL_CTX_use_certificate_buffer(): passed\r\n   wolfSSL_CertManagerCheckOCSPResponse():\r\nERROR - tests/api.c line 1254 failed with:\r\n    expected: wolfSSL_CertManagerCheckOCSPResponse(cm, response, sizeof(response), ((void *)0), status, entry, request) == WOLFSSL_SUCCESS\r\n    result:   -367 != 1\r\n```\r\n\r\nGuessing it has to do with the date in the captured OCSP response? Can you look into this? Thanks",
      "This also appears to be the same issue without having to do enable all:\r\n\r\n```\r\n./configure --enable-jni && make\r\n\r\n./tests/unit.test\r\nERROR - tests/api.c line 1254 failed with:\r\n    expected: wolfSSL_CertManagerCheckOCSPResponse(cm, response, sizeof(response), ((void *)0), status, entry, request) == WOLFSSL_SUCCESS\r\n    result:   -367 != 1\r\nzsh: abort      ./scripts/unit.test\r\n```",
      "For anyone else late to the party it seems the test failure got addressed in 822aa92fccf77558e250131c1c6e9bb84d07afe8"
    ]
  },
  "Bug Filter": "Security Vulnerability Fix",
  "Bug Filter Confidence": 0.7,
  "Bug Filter Response": "**Final Classification:** Security Vulnerability Fix; **Confidence:** 0.7  \n**Confidence Reasons:** The patch addresses a bug in certificate validation affecting OCSP responses, which could have security implications if allowing invalid certificates. The code diff, though minimal, supports this as a potential security fix."
}