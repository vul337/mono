{
  "cve_id": "CVE-2018-20552",
  "cwe_ids": [
    "CWE-125"
  ],
  "cvss_vector": "AV:N/AC:M/Au:N/C:P/I:P/A:P",
  "cvss_is_v3": false,
  "repo_name": "appneta/tcpreplay",
  "commit_msg": "Bug #520 Fix heap overflow on zero or 0xFFFF packet length\n\nAdd check for packets that report zero packet length. Example\nof fix:\n\n    src/tcpprep --auto=bridge --pcap=poc16-get_l2len-heapoverflow --cachefile=/dev/null\n    Warning: poc16-get_l2len-heapoverflow was captured using a snaplen of 17 bytes.  This may mean you have truncated packets.\n    safe_pcap_next ERROR: Invalid packet length in tcpprep.c:process_raw_packets() line 334: packet length=0 capture length=0",
  "commit_hash": "6b830a1640ca20528032c89a4fdd8291a4d2d8b2",
  "git_url": "https://github.com/appneta/tcpreplay/commit/6b830a1640ca20528032c89a4fdd8291a4d2d8b2",
  "file_path": "src/common/utils.c",
  "func_name": "_our_safe_pcap_next",
  "func_before": "u_char *_our_safe_pcap_next(pcap_t *pcap,  struct pcap_pkthdr *pkthdr,\n        const char *funcname, const int line, const char *file)\n{\n    u_char *pktdata = (u_char *)pcap_next(pcap, pkthdr);\n\n    if (pktdata) {\n        if (pkthdr->len > MAXPACKET) {\n            fprintf(stderr, \"safe_pcap_next ERROR: Invalid packet length in %s:%s() line %d: %u is greater than maximum %u\\n\",\n                    file, funcname, line, pkthdr->len, MAXPACKET);\n            exit(-1);\n        }\n\n        if (pkthdr->len < pkthdr->caplen) {\n            fprintf(stderr, \"safe_pcap_next ERROR: Invalid packet length in %s:%s() line %d: packet length %u is less than capture length %u\\n\",\n                    file, funcname, line, pkthdr->len, pkthdr->caplen);\n            exit(-1);\n        }\n    }\n\n    return pktdata;\n}",
  "abstract_func_before": "u_char *_our_safe_pcap_next(pcap_t *VAR_0,  struct pcap_pkthdr *VAR_1,\n        const char *VAR_2, const int VAR_3, const char *VAR_4)\n{\n    u_char *VAR_5 = (u_char *)pcap_next(VAR_0, VAR_1);\n\n    if (VAR_5) {\n        if (VAR_1->len > VAR_6) {\n            fprintf(VAR_7, \"safe_pcap_next ERROR: Invalid packet length in %s:%s() line %d: %u is greater than maximum %u\\n\",\n                    VAR_4, VAR_2, VAR_3, VAR_1->len, VAR_6);\n            exit(-1);\n        }\n\n        if (VAR_1->len < VAR_1->caplen) {\n            fprintf(VAR_7, \"safe_pcap_next ERROR: Invalid packet length in %s:%s() line %d: packet length %u is less than capture length %u\\n\",\n                    VAR_4, VAR_2, VAR_3, VAR_1->len, VAR_1->caplen);\n            exit(-1);\n        }\n    }\n\n    return VAR_5;\n}",
  "func_graph_path_before": "appneta/tcpreplay/6b830a1640ca20528032c89a4fdd8291a4d2d8b2/utils.c/vul/before/0.json",
  "func": "u_char *_our_safe_pcap_next(pcap_t *pcap,  struct pcap_pkthdr *pkthdr,\n        const char *funcname, const int line, const char *file)\n{\n    u_char *pktdata = (u_char *)pcap_next(pcap, pkthdr);\n\n    if (pktdata) {\n        if (pkthdr->len > MAXPACKET) {\n            fprintf(stderr, \"safe_pcap_next ERROR: Invalid packet length in %s:%s() line %d: %u is greater than maximum %u\\n\",\n                    file, funcname, line, pkthdr->len, MAXPACKET);\n            exit(-1);\n        }\n\n        if (!pkthdr->len || pkthdr->len < pkthdr->caplen) {\n            fprintf(stderr, \"safe_pcap_next ERROR: Invalid packet length in %s:%s() line %d: packet length=%u capture length=%u\\n\",\n                    file, funcname, line, pkthdr->len, pkthdr->caplen);\n            exit(-1);\n        }\n    }\n\n    return pktdata;\n}",
  "abstract_func": "u_char *_our_safe_pcap_next(pcap_t *VAR_0,  struct pcap_pkthdr *VAR_1,\n        const char *VAR_2, const int VAR_3, const char *VAR_4)\n{\n    u_char *VAR_5 = (u_char *)pcap_next(VAR_0, VAR_1);\n\n    if (VAR_5) {\n        if (VAR_1->len > VAR_6) {\n            fprintf(VAR_7, \"safe_pcap_next ERROR: Invalid packet length in %s:%s() line %d: %u is greater than maximum %u\\n\",\n                    VAR_4, VAR_2, VAR_3, VAR_1->len, VAR_6);\n            exit(-1);\n        }\n\n        if (!VAR_1->len || VAR_1->len < VAR_1->caplen) {\n            fprintf(VAR_7, \"safe_pcap_next ERROR: Invalid packet length in %s:%s() line %d: packet length=%u capture length=%u\\n\",\n                    VAR_4, VAR_2, VAR_3, VAR_1->len, VAR_1->caplen);\n            exit(-1);\n        }\n    }\n\n    return VAR_5;\n}",
  "func_graph_path": "appneta/tcpreplay/6b830a1640ca20528032c89a4fdd8291a4d2d8b2/utils.c/vul/after/0.json",
  "diff_func": "--- func_before\n+++ func_after\n@@ -10,8 +10,8 @@\n             exit(-1);\n         }\n \n-        if (pkthdr->len < pkthdr->caplen) {\n-            fprintf(stderr, \"safe_pcap_next ERROR: Invalid packet length in %s:%s() line %d: packet length %u is less than capture length %u\\n\",\n+        if (!pkthdr->len || pkthdr->len < pkthdr->caplen) {\n+            fprintf(stderr, \"safe_pcap_next ERROR: Invalid packet length in %s:%s() line %d: packet length=%u capture length=%u\\n\",\n                     file, funcname, line, pkthdr->len, pkthdr->caplen);\n             exit(-1);\n         }",
  "diff_line_info": {
    "deleted_lines": [
      "        if (pkthdr->len < pkthdr->caplen) {",
      "            fprintf(stderr, \"safe_pcap_next ERROR: Invalid packet length in %s:%s() line %d: packet length %u is less than capture length %u\\n\","
    ],
    "added_lines": [
      "        if (!pkthdr->len || pkthdr->len < pkthdr->caplen) {",
      "            fprintf(stderr, \"safe_pcap_next ERROR: Invalid packet length in %s:%s() line %d: packet length=%u capture length=%u\\n\","
    ]
  },
  "is_vul": true,
  "pr_url": "https://github.com/appneta/tcpreplay/pull/532",
  "description": {
    "pr_info": {
      "title": "Bug #530 Fix heap overflow on zero or 0xFFFF packet length",
      "number": 532
    },
    "comment": [
      "Add check for packets that report zero packet length. Example\r\nof fix:\r\n\r\n    src/tcpprep --auto=bridge --pcap=poc16-get_l2len-heapoverflow --cachefile=/dev/null\r\n    Warning: poc16-get_l2len-heapoverflow was captured using a snaplen of 17 bytes.  This may mean you have truncated packets.\r\n    safe_pcap_next ERROR: Invalid packet length in tcpprep.c:process_raw_packets() line 334: packet length=0 capture length=0"
    ]
  },
  "Bug Filter": "Security Vulnerability Fix",
  "Bug Filter Confidence": 0.95,
  "Bug Filter Response": "**Final Classification:** Security Vulnerability Fix; **Confidence:** 0.95"
}