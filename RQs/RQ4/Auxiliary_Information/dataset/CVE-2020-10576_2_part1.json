{
  "cve_id": "CVE-2020-10576",
  "cwe_ids": [
    "CWE-362"
  ],
  "cvss_vector": "AV:N/AC:M/Au:N/C:N/I:N/A:P",
  "cvss_is_v3": false,
  "repo_name": "meetecho/janus-gateway",
  "commit_msg": "Fixes to leaks and race conditions in VoiceMail plugin",
  "commit_hash": "eb99ac8674c554bab6775f4378b24e991b4a2fa1",
  "git_url": "https://github.com/meetecho/janus-gateway/commit/eb99ac8674c554bab6775f4378b24e991b4a2fa1",
  "file_path": "plugins/janus_voicemail.c",
  "func_name": "janus_voicemail_hangup_media_internal",
  "func_before": "static void janus_voicemail_hangup_media_internal(janus_plugin_session *handle) {\n\tif(g_atomic_int_get(&stopping) || !g_atomic_int_get(&initialized))\n\t\treturn;\n\tjanus_voicemail_session *session = janus_voicemail_lookup_session(handle);\n\tif(!session) {\n\t\tJANUS_LOG(LOG_ERR, \"No session associated with this handle...\\n\");\n\t\treturn;\n\t}\n\tsession->started = FALSE;\n\tif(g_atomic_int_get(&session->destroyed))\n\t\treturn;\n\tif(!g_atomic_int_compare_and_exchange(&session->hangingup, 0, 1))\n\t\treturn;\n\t/* Close and reset stuff */\n\tif(session->file)\n\t\tfclose(session->file);\n\tsession->file = NULL;\n\tif(session->stream)\n\t\togg_stream_destroy(session->stream);\n\tsession->stream = NULL;\n\tg_atomic_int_set(&session->hangingup, 0);\n}",
  "abstract_func_before": "static void janus_voicemail_hangup_media_internal(janus_plugin_session *VAR_0) {\n\tif(g_atomic_int_get(&VAR_1) || !g_atomic_int_get(&VAR_2))\n\t\treturn;\n\tjanus_voicemail_session *VAR_3 = janus_voicemail_lookup_session(VAR_0);\n\tif(!VAR_3) {\n\t\tJANUS_LOG(VAR_4, \"No session associated with this handle...\\n\");\n\t\treturn;\n\t}\n\tVAR_3->started = FALSE;\n\tif(g_atomic_int_get(&VAR_3->destroyed))\n\t\treturn;\n\tif(!g_atomic_int_compare_and_exchange(&VAR_3->hangingup, 0, 1))\n\t\treturn;\n\t/* COMMENT_0 */\n\tif(VAR_3->file)\n\t\tfclose(VAR_3->file);\n\tVAR_3->file = NULL;\n\tif(VAR_3->stream)\n\t\togg_stream_destroy(VAR_3->stream);\n\tVAR_3->stream = NULL;\n\tg_atomic_int_set(&VAR_3->hangingup, 0);\n}",
  "func_graph_path_before": "meetecho/janus-gateway/eb99ac8674c554bab6775f4378b24e991b4a2fa1/janus_voicemail.c/vul/before/3.json",
  "func": "static void janus_voicemail_hangup_media_internal(janus_plugin_session *handle) {\n\tif(g_atomic_int_get(&stopping) || !g_atomic_int_get(&initialized))\n\t\treturn;\n\tjanus_voicemail_session *session = janus_voicemail_lookup_session(handle);\n\tif(!session) {\n\t\tJANUS_LOG(LOG_ERR, \"No session associated with this handle...\\n\");\n\t\treturn;\n\t}\n\tg_atomic_int_set(&session->started, 0);\n\tif(g_atomic_int_get(&session->destroyed))\n\t\treturn;\n\tif(!g_atomic_int_compare_and_exchange(&session->hangingup, 0, 1))\n\t\treturn;\n\t/* Close and reset stuff */\n\tif(session->file)\n\t\tfclose(session->file);\n\tsession->file = NULL;\n\tif(session->stream)\n\t\togg_stream_destroy(session->stream);\n\tsession->stream = NULL;\n\tg_atomic_int_set(&session->hangingup, 0);\n}",
  "abstract_func": "static void janus_voicemail_hangup_media_internal(janus_plugin_session *VAR_0) {\n\tif(g_atomic_int_get(&VAR_1) || !g_atomic_int_get(&VAR_2))\n\t\treturn;\n\tjanus_voicemail_session *VAR_3 = janus_voicemail_lookup_session(VAR_0);\n\tif(!VAR_3) {\n\t\tJANUS_LOG(VAR_4, \"No session associated with this handle...\\n\");\n\t\treturn;\n\t}\n\tg_atomic_int_set(&VAR_3->started, 0);\n\tif(g_atomic_int_get(&VAR_3->destroyed))\n\t\treturn;\n\tif(!g_atomic_int_compare_and_exchange(&VAR_3->hangingup, 0, 1))\n\t\treturn;\n\t/* COMMENT_0 */\n\tif(VAR_3->file)\n\t\tfclose(VAR_3->file);\n\tVAR_3->file = NULL;\n\tif(VAR_3->stream)\n\t\togg_stream_destroy(VAR_3->stream);\n\tVAR_3->stream = NULL;\n\tg_atomic_int_set(&VAR_3->hangingup, 0);\n}",
  "func_graph_path": "meetecho/janus-gateway/eb99ac8674c554bab6775f4378b24e991b4a2fa1/janus_voicemail.c/vul/after/3.json",
  "diff_func": "--- func_before\n+++ func_after\n@@ -6,7 +6,7 @@\n \t\tJANUS_LOG(LOG_ERR, \"No session associated with this handle...\\n\");\n \t\treturn;\n \t}\n-\tsession->started = FALSE;\n+\tg_atomic_int_set(&session->started, 0);\n \tif(g_atomic_int_get(&session->destroyed))\n \t\treturn;\n \tif(!g_atomic_int_compare_and_exchange(&session->hangingup, 0, 1))",
  "diff_line_info": {
    "deleted_lines": [
      "\tsession->started = FALSE;"
    ],
    "added_lines": [
      "\tg_atomic_int_set(&session->started, 0);"
    ]
  },
  "is_vul": true,
  "pr_url": "https://github.com/meetecho/janus-gateway/pull/1993",
  "description": {
    "pr_info": {
      "title": "Fixes to leaks and race conditions in VoiceMail plugin",
      "number": 1993
    },
    "comment": [
      "Ref: CVE-2020-10576\r\n\r\nWe've been notified about some issues with the VoiceMail plugin, which in part didn't surprise me as it hasn't been touched much since it was first created, and we very rarely use it ourselves. Specifically, there was a race condition that could cause a crash in the server. This patch addresses that issue, and also takes care of leaks that the VoiceMail plugin was apparently causing consistently, whether the issue showed up or not.\r\n\r\nI can't replicate the issue anymore, so I'm planning to merge soon. Feedback welcome!",
      "Merging."
    ]
  },
  "Bug Filter": "Security Vulnerability Fix",
  "Bug Filter Confidence": 0.95,
  "Bug Filter Response": "**Step-by-Step Explanation:**\n\n1. **Security Focus**: The commit addresses \"leaks\" and \"race conditions,\" which are security issues. The reference to CVE-2020-10576 confirms it's a security vulnerability.\n2. **Code Change**: Using atomic operations fixes the race condition, ensuring thread safety and preventing crashes, directly addressing the CVE.\n3. **Confidence**: High confidence due to clear indicators and consistent code changes.\n\n**Final Classification:** Security Vulnerability Fix; **Confidence:** 0.95"
}