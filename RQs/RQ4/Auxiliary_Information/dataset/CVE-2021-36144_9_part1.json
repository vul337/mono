{
  "cve_id": "CVE-2021-36144",
  "cwe_ids": [
    "CWE-416"
  ],
  "cvss_vector": "AV:N/AC:L/Au:N/C:N/I:N/A:P",
  "cvss_is_v3": false,
  "repo_name": "projectacrn/acrn-hypervisor",
  "commit_msg": "dm: Reset virtio device before release\n\nWith virtio polling mode enabled, a timer is running in the virtio\nbackend service. And the timer will also be triggered if its frondend\ndriver didn't do the device reset in shutdown. A freed virtio device\nwill be accessed in the polling timer handler.\n\nDo the virtio reset() callback specifically to clear the polling timer\nbefore the free.\n\nTracked-On: #6147\nSigned-off-by: Shuo A Liu <shuo.a.liu@intel.com>\nSigned-off-by: Yonghua Huang <yonghua.huang@intel.com>",
  "commit_hash": "dd88504804e186029f845a166dc5c31695e2cca2",
  "git_url": "https://github.com/projectacrn/acrn-hypervisor/commit/dd88504804e186029f845a166dc5c31695e2cca2",
  "file_path": "devicemodel/hw/pci/virtio/virtio_rnd.c",
  "func_name": "virtio_rnd_deinit",
  "func_before": "static void\nvirtio_rnd_deinit(struct vmctx *ctx, struct pci_vdev *dev, char *opts)\n{\n\tstruct virtio_rnd *rnd;\n\tvoid *jval;\n\n\trnd = dev->arg;\n\tif (rnd == NULL) {\n\t\tDPRINTF((\"%s: rnd is NULL\\n\", __func__));\n\t\treturn;\n\t}\n\n\tpthread_cancel(rnd->rx_tid);\n\tpthread_join(rnd->rx_tid, &jval);\n\n\tif (rnd->vbs_k.status == VIRTIO_DEV_STARTED) {\n\t\tDPRINTF((\"%s: deinit virtio_rnd_k!\\n\", __func__));\n\t\tvirtio_rnd_kernel_stop(rnd);\n\t\tvirtio_rnd_kernel_reset(rnd);\n\t\trnd->vbs_k.status = VIRTIO_DEV_INITIAL;\n\t\tif (rnd->vbs_k.fd >= 0) {\n\t\t\tclose(rnd->vbs_k.fd);\n\t\t\trnd->vbs_k.fd = -1;\n\t\t}\n\t}\n\n\tif (rnd->fd >= 0) {\n\t\tclose(rnd->fd);\n\t\trnd->fd = -1;\n\t}\n\tDPRINTF((\"%s: free struct virtio_rnd!\\n\", __func__));\n\tfree(rnd);\n}",
  "abstract_func_before": "static void\nvirtio_rnd_deinit(struct vmctx *VAR_0, struct pci_vdev *VAR_1, char *VAR_2)\n{\n\tstruct virtio_rnd *VAR_3;\n\tvoid *VAR_4;\n\n\tVAR_3 = VAR_1->arg;\n\tif (VAR_3 == NULL) {\n\t\tDPRINTF((\"%s: rnd is NULL\\n\", VAR_5));\n\t\treturn;\n\t}\n\n\tpthread_cancel(VAR_3->rx_tid);\n\tpthread_join(VAR_3->rx_tid, &VAR_4);\n\n\tif (VAR_3->vbs_k.status == VAR_6) {\n\t\tDPRINTF((\"%s: deinit virtio_rnd_k!\\n\", VAR_5));\n\t\tvirtio_rnd_kernel_stop(VAR_3);\n\t\tvirtio_rnd_kernel_reset(VAR_3);\n\t\tVAR_3->vbs_k.status = VAR_7;\n\t\tif (VAR_3->vbs_k.fd >= 0) {\n\t\t\tclose(VAR_3->vbs_k.fd);\n\t\t\tVAR_3->vbs_k.fd = -1;\n\t\t}\n\t}\n\n\tif (VAR_3->fd >= 0) {\n\t\tclose(VAR_3->fd);\n\t\tVAR_3->fd = -1;\n\t}\n\tDPRINTF((\"%s: free struct virtio_rnd!\\n\", VAR_5));\n\tfree(VAR_3);\n}",
  "func_graph_path_before": "projectacrn/acrn-hypervisor/dd88504804e186029f845a166dc5c31695e2cca2/virtio_rnd.c/vul/before/0.json",
  "func": "static void\nvirtio_rnd_deinit(struct vmctx *ctx, struct pci_vdev *dev, char *opts)\n{\n\tstruct virtio_rnd *rnd;\n\tvoid *jval;\n\n\trnd = dev->arg;\n\tif (rnd == NULL) {\n\t\tDPRINTF((\"%s: rnd is NULL\\n\", __func__));\n\t\treturn;\n\t}\n\n\tpthread_cancel(rnd->rx_tid);\n\tpthread_join(rnd->rx_tid, &jval);\n\n\tif (rnd->vbs_k.status == VIRTIO_DEV_STARTED) {\n\t\tDPRINTF((\"%s: deinit virtio_rnd_k!\\n\", __func__));\n\t\tvirtio_rnd_kernel_stop(rnd);\n\t\tvirtio_rnd_kernel_reset(rnd);\n\t\trnd->vbs_k.status = VIRTIO_DEV_INITIAL;\n\t\tif (rnd->vbs_k.fd >= 0) {\n\t\t\tclose(rnd->vbs_k.fd);\n\t\t\trnd->vbs_k.fd = -1;\n\t\t}\n\t}\n\n\tif (rnd->fd >= 0) {\n\t\tclose(rnd->fd);\n\t\trnd->fd = -1;\n\t}\n\tvirtio_rnd_reset(rnd);\n\tDPRINTF((\"%s: free struct virtio_rnd!\\n\", __func__));\n\tfree(rnd);\n}",
  "abstract_func": "static void\nvirtio_rnd_deinit(struct vmctx *VAR_0, struct pci_vdev *VAR_1, char *VAR_2)\n{\n\tstruct virtio_rnd *VAR_3;\n\tvoid *VAR_4;\n\n\tVAR_3 = VAR_1->arg;\n\tif (VAR_3 == NULL) {\n\t\tDPRINTF((\"%s: rnd is NULL\\n\", VAR_5));\n\t\treturn;\n\t}\n\n\tpthread_cancel(VAR_3->rx_tid);\n\tpthread_join(VAR_3->rx_tid, &VAR_4);\n\n\tif (VAR_3->vbs_k.status == VAR_6) {\n\t\tDPRINTF((\"%s: deinit virtio_rnd_k!\\n\", VAR_5));\n\t\tvirtio_rnd_kernel_stop(VAR_3);\n\t\tvirtio_rnd_kernel_reset(VAR_3);\n\t\tVAR_3->vbs_k.status = VAR_7;\n\t\tif (VAR_3->vbs_k.fd >= 0) {\n\t\t\tclose(VAR_3->vbs_k.fd);\n\t\t\tVAR_3->vbs_k.fd = -1;\n\t\t}\n\t}\n\n\tif (VAR_3->fd >= 0) {\n\t\tclose(VAR_3->fd);\n\t\tVAR_3->fd = -1;\n\t}\n\tvirtio_rnd_reset(VAR_3);\n\tDPRINTF((\"%s: free struct virtio_rnd!\\n\", VAR_5));\n\tfree(VAR_3);\n}",
  "func_graph_path": "projectacrn/acrn-hypervisor/dd88504804e186029f845a166dc5c31695e2cca2/virtio_rnd.c/vul/after/0.json",
  "diff_func": "--- func_before\n+++ func_after\n@@ -28,6 +28,7 @@\n \t\tclose(rnd->fd);\n \t\trnd->fd = -1;\n \t}\n+\tvirtio_rnd_reset(rnd);\n \tDPRINTF((\"%s: free struct virtio_rnd!\\n\", __func__));\n \tfree(rnd);\n }",
  "diff_line_info": {
    "deleted_lines": [],
    "added_lines": [
      "\tvirtio_rnd_reset(rnd);"
    ]
  },
  "is_vul": true,
  "pr_url": "https://github.com/projectacrn/acrn-hypervisor/pull/6268",
  "description": {
    "pr_info": {
      "title": "dm: Reset virtio device before release",
      "number": 6268
    },
    "comment": [
      "With virtio polling mode enabled, a timer is running in the virtio\r\nbackend service. And the timer will also be triggered if its frondend\r\ndriver didn't do the device reset in shutdown. A freed virtio device\r\nwill be accessed in the polling timer handler.\r\n\r\nDo the virtio reset() callback specifically to clear the polling timer\r\nbefore the free.\r\n\r\nTracked-On: #6147\r\nSigned-off-by: Shuo A Liu <shuo.a.liu@intel.com>\r\nSigned-off-by: Yonghua Huang <yonghua.huang@intel.com>",
      "@shuox  @ywan170  this PR to back backport from release_2.5 branch, please review.",
      "No new violations to the coding guideline detected.<br>No New Name Conflict<br>No New Function Declaration/Definition Mismatch"
    ]
  },
  "Bug Filter": "Defect Remediation & Feature Upgrades",
  "Bug Filter Confidence": 0.8,
  "Bug Filter Response": "**Final Classification:** Defect Remediation & Feature Upgrades  \n**Confidence:** 0.8"
}