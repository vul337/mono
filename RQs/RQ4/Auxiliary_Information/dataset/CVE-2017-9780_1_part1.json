{
  "cve_id": "CVE-2017-9780",
  "cwe_ids": [
    "CWE-732"
  ],
  "cvss_vector": "AV:L/AC:L/Au:N/C:C/I:C/A:C",
  "cvss_is_v3": false,
  "repo_name": "flatpak",
  "commit_msg": "Use new libostree APIs to reject world-writable/suid content\n\nThis uses the new libostree APIs that landed recently to ensure\nthat we reject any files with mode outside of `0775` for system\nhelper pulls, and we also mask directory modes during checkout.\n\nHowever, this does *not* fix up any already downloaded content.\nFor that, one could uninstall/reinstall; or a future patch could\ndo a one-time fixup pass.\n\nNote that I am not aware of a way for flatpak applications to escalate their\nprivileges directly with this flaw; the bubblewrap `PR_SET_NO_NEW_PRIVS` turns\nof setuid. However, in combination with code execution on the host via another\nmechanism (e.g. unsandboxed app), a setuid app injected could be used to gain\nfull host privileges.\n\nAt this time we're not aware of any flatpak content exploiting this issue.\n\nCloses: https://github.com/flatpak/flatpak/issues/845",
  "commit_hash": "aed5d0919830c02e490f669fc36bd9af42e632d6",
  "git_url": "https://github.com/flatpak/flatpak/commit/aed5d0919830c02e490f669fc36bd9af42e632d6",
  "file_path": "common/flatpak-dir.c",
  "func_name": "repo_pull_one_untrusted",
  "func_before": "static gboolean\nrepo_pull_one_untrusted (OstreeRepo          *self,\n                         const char          *remote_name,\n                         const char          *url,\n                         const char         **dirs_to_pull,\n                         const char          *ref,\n                         const char          *checksum,\n                         OstreeAsyncProgress *progress,\n                         GCancellable        *cancellable,\n                         GError             **error)\n{\n  OstreeRepoPullFlags flags = OSTREE_REPO_PULL_FLAGS_UNTRUSTED;\n  GVariantBuilder builder;\n  g_auto(GLnxConsoleRef) console = { 0, };\n  g_autoptr(OstreeAsyncProgress) console_progress = NULL;\n  gboolean res;\n  g_variant_builder_init (&builder, G_VARIANT_TYPE (\"a{sv}\"));\n  const char *refs[2] = { NULL, NULL };\n  const char *commits[2] = { NULL, NULL };\n\n  if (progress == NULL)\n    {\n      glnx_console_lock (&console);\n      if (console.is_tty)\n        {\n          console_progress = ostree_async_progress_new_and_connect (default_progress_changed, &console);\n          progress = console_progress;\n        }\n    }\n\n  refs[0] = ref;\n  commits[0] = checksum;\n\n  g_variant_builder_add (&builder, \"{s@v}\", \"flags\",\n                         g_variant_new_variant (g_variant_new_int32 (flags)));\n  g_variant_builder_add (&builder, \"{s@v}\", \"refs\",\n                         g_variant_new_variant (g_variant_new_strv ((const char * const *) refs, -1)));\n  g_variant_builder_add (&builder, \"{s@v}\", \"override-commit-ids\",\n                         g_variant_new_variant (g_variant_new_strv ((const char * const *) commits, -1)));\n  g_variant_builder_add (&builder, \"{s@v}\", \"override-remote-name\",\n                         g_variant_new_variant (g_variant_new_string (remote_name)));\n  g_variant_builder_add (&builder, \"{s@v}\", \"gpg-verify\",\n                         g_variant_new_variant (g_variant_new_boolean (TRUE)));\n  g_variant_builder_add (&builder, \"{s@v}\", \"gpg-verify-summary\",\n                         g_variant_new_variant (g_variant_new_boolean (TRUE)));\n  g_variant_builder_add (&builder, \"{s@v}\", \"inherit-transaction\",\n                         g_variant_new_variant (g_variant_new_boolean (TRUE)));\n  g_variant_builder_add (&builder, \"{s@v}\", \"update-frequency\",\n                         g_variant_new_variant (g_variant_new_uint32 (FLATPAK_DEFAULT_UPDATE_FREQUENCY)));\n\n  if (dirs_to_pull)\n    {\n      g_variant_builder_add (&builder, \"{s@v}\", \"subdirs\",\n                             g_variant_new_variant (g_variant_new_strv ((const char * const *)dirs_to_pull, -1)));\n      g_variant_builder_add (&builder, \"{s@v}\", \"disable-static-deltas\",\n                             g_variant_new_variant (g_variant_new_boolean (TRUE)));\n    }\n\n  res = ostree_repo_pull_with_options (self, url, g_variant_builder_end (&builder),\n                                       progress, cancellable, error);\n\n  if (progress)\n    ostree_async_progress_finish (progress);\n\n  return res;\n}",
  "abstract_func_before": "static gboolean\nrepo_pull_one_untrusted (OstreeRepo          *VAR_0,\n                         const char          *VAR_1,\n                         const char          *VAR_2,\n                         const char         **VAR_3,\n                         const char          *VAR_4,\n                         const char          *VAR_5,\n                         OstreeAsyncProgress *VAR_6,\n                         GCancellable        *VAR_7,\n                         GError             **VAR_8)\n{\n  OstreeRepoPullFlags VAR_9 = VAR_10;\n  GVariantBuilder VAR_11;\n  VAR_12(GLnxConsoleRef) VAR_13 = { 0, };\n  VAR_14(OstreeAsyncProgress) VAR_15 = NULL;\n  gboolean VAR_16;\n  g_variant_builder_init (&VAR_11, G_VARIANT_TYPE (\"a{sv}\"));\n  const char *VAR_17[2] = { NULL, NULL };\n  const char *VAR_18[2] = { NULL, NULL };\n\n  if (VAR_6 == NULL)\n    {\n      glnx_console_lock (&VAR_13);\n      if (VAR_13.is_tty)\n        {\n          VAR_15 = ostree_async_progress_new_and_connect (VAR_19, &VAR_13);\n          VAR_6 = VAR_15;\n        }\n    }\n\n  VAR_17[0] = VAR_4;\n  VAR_18[0] = VAR_5;\n\n  g_variant_builder_add (&VAR_11, \"{s@v}\", \"flags\",\n                         g_variant_new_variant (g_variant_new_int32 (VAR_9)));\n  g_variant_builder_add (&VAR_11, \"{s@v}\", \"refs\",\n                         g_variant_new_variant (g_variant_new_strv ((const char * const *) VAR_17, -1)));\n  g_variant_builder_add (&VAR_11, \"{s@v}\", \"override-commit-ids\",\n                         g_variant_new_variant (g_variant_new_strv ((const char * const *) VAR_18, -1)));\n  g_variant_builder_add (&VAR_11, \"{s@v}\", \"override-remote-name\",\n                         g_variant_new_variant (g_variant_new_string (VAR_1)));\n  g_variant_builder_add (&VAR_11, \"{s@v}\", \"gpg-verify\",\n                         g_variant_new_variant (g_variant_new_boolean (TRUE)));\n  g_variant_builder_add (&VAR_11, \"{s@v}\", \"gpg-verify-summary\",\n                         g_variant_new_variant (g_variant_new_boolean (TRUE)));\n  g_variant_builder_add (&VAR_11, \"{s@v}\", \"inherit-transaction\",\n                         g_variant_new_variant (g_variant_new_boolean (TRUE)));\n  g_variant_builder_add (&VAR_11, \"{s@v}\", \"update-frequency\",\n                         g_variant_new_variant (g_variant_new_uint32 (VAR_20)));\n\n  if (VAR_3)\n    {\n      g_variant_builder_add (&VAR_11, \"{s@v}\", \"subdirs\",\n                             g_variant_new_variant (g_variant_new_strv ((const char * const *)VAR_3, -1)));\n      g_variant_builder_add (&VAR_11, \"{s@v}\", \"disable-static-deltas\",\n                             g_variant_new_variant (g_variant_new_boolean (TRUE)));\n    }\n\n  VAR_16 = ostree_repo_pull_with_options (VAR_0, VAR_2, g_variant_builder_end (&VAR_11),\n                                       VAR_6, VAR_7, VAR_8);\n\n  if (VAR_6)\n    ostree_async_progress_finish (VAR_6);\n\n  return VAR_16;\n}",
  "func_graph_path_before": "flatpak/aed5d0919830c02e490f669fc36bd9af42e632d6/flatpak-dir.c/vul/before/2.json",
  "func": "static gboolean\nrepo_pull_one_untrusted (OstreeRepo          *self,\n                         const char          *remote_name,\n                         const char          *url,\n                         const char         **dirs_to_pull,\n                         const char          *ref,\n                         const char          *checksum,\n                         OstreeAsyncProgress *progress,\n                         GCancellable        *cancellable,\n                         GError             **error)\n{\n  /* The latter flag was introduced in https://github.com/ostreedev/ostree/pull/926 */\n  const OstreeRepoPullFlags flags = OSTREE_REPO_PULL_FLAGS_UNTRUSTED |OSTREE_REPO_PULL_FLAGS_BAREUSERONLY_FILES;\n  GVariantBuilder builder;\n  g_auto(GLnxConsoleRef) console = { 0, };\n  g_autoptr(OstreeAsyncProgress) console_progress = NULL;\n  gboolean res;\n  g_variant_builder_init (&builder, G_VARIANT_TYPE (\"a{sv}\"));\n  const char *refs[2] = { NULL, NULL };\n  const char *commits[2] = { NULL, NULL };\n\n  if (progress == NULL)\n    {\n      glnx_console_lock (&console);\n      if (console.is_tty)\n        {\n          console_progress = ostree_async_progress_new_and_connect (default_progress_changed, &console);\n          progress = console_progress;\n        }\n    }\n\n  refs[0] = ref;\n  commits[0] = checksum;\n\n  g_variant_builder_add (&builder, \"{s@v}\", \"flags\",\n                         g_variant_new_variant (g_variant_new_int32 (flags)));\n  g_variant_builder_add (&builder, \"{s@v}\", \"refs\",\n                         g_variant_new_variant (g_variant_new_strv ((const char * const *) refs, -1)));\n  g_variant_builder_add (&builder, \"{s@v}\", \"override-commit-ids\",\n                         g_variant_new_variant (g_variant_new_strv ((const char * const *) commits, -1)));\n  g_variant_builder_add (&builder, \"{s@v}\", \"override-remote-name\",\n                         g_variant_new_variant (g_variant_new_string (remote_name)));\n  g_variant_builder_add (&builder, \"{s@v}\", \"gpg-verify\",\n                         g_variant_new_variant (g_variant_new_boolean (TRUE)));\n  g_variant_builder_add (&builder, \"{s@v}\", \"gpg-verify-summary\",\n                         g_variant_new_variant (g_variant_new_boolean (TRUE)));\n  g_variant_builder_add (&builder, \"{s@v}\", \"inherit-transaction\",\n                         g_variant_new_variant (g_variant_new_boolean (TRUE)));\n  g_variant_builder_add (&builder, \"{s@v}\", \"update-frequency\",\n                         g_variant_new_variant (g_variant_new_uint32 (FLATPAK_DEFAULT_UPDATE_FREQUENCY)));\n\n  if (dirs_to_pull)\n    {\n      g_variant_builder_add (&builder, \"{s@v}\", \"subdirs\",\n                             g_variant_new_variant (g_variant_new_strv ((const char * const *)dirs_to_pull, -1)));\n      g_variant_builder_add (&builder, \"{s@v}\", \"disable-static-deltas\",\n                             g_variant_new_variant (g_variant_new_boolean (TRUE)));\n    }\n\n  res = ostree_repo_pull_with_options (self, url, g_variant_builder_end (&builder),\n                                       progress, cancellable, error);\n\n  if (progress)\n    ostree_async_progress_finish (progress);\n\n  return res;\n}",
  "abstract_func": "static gboolean\nrepo_pull_one_untrusted (OstreeRepo          *VAR_0,\n                         const char          *VAR_1,\n                         const char          *VAR_2,\n                         const char         **VAR_3,\n                         const char          *VAR_4,\n                         const char          *VAR_5,\n                         OstreeAsyncProgress *VAR_6,\n                         GCancellable        *VAR_7,\n                         GError             **VAR_8)\n{\n  /* COMMENT_0 */\n  const OstreeRepoPullFlags VAR_9 = VAR_10 |VAR_11;\n  GVariantBuilder VAR_12;\n  VAR_13(GLnxConsoleRef) VAR_14 = { 0, };\n  VAR_15(OstreeAsyncProgress) VAR_16 = NULL;\n  gboolean VAR_17;\n  g_variant_builder_init (&VAR_12, G_VARIANT_TYPE (\"a{sv}\"));\n  const char *VAR_18[2] = { NULL, NULL };\n  const char *VAR_19[2] = { NULL, NULL };\n\n  if (VAR_6 == NULL)\n    {\n      glnx_console_lock (&VAR_14);\n      if (VAR_14.is_tty)\n        {\n          VAR_16 = ostree_async_progress_new_and_connect (VAR_20, &VAR_14);\n          VAR_6 = VAR_16;\n        }\n    }\n\n  VAR_18[0] = VAR_4;\n  VAR_19[0] = VAR_5;\n\n  g_variant_builder_add (&VAR_12, \"{s@v}\", \"flags\",\n                         g_variant_new_variant (g_variant_new_int32 (VAR_9)));\n  g_variant_builder_add (&VAR_12, \"{s@v}\", \"refs\",\n                         g_variant_new_variant (g_variant_new_strv ((const char * const *) VAR_18, -1)));\n  g_variant_builder_add (&VAR_12, \"{s@v}\", \"override-commit-ids\",\n                         g_variant_new_variant (g_variant_new_strv ((const char * const *) VAR_19, -1)));\n  g_variant_builder_add (&VAR_12, \"{s@v}\", \"override-remote-name\",\n                         g_variant_new_variant (g_variant_new_string (VAR_1)));\n  g_variant_builder_add (&VAR_12, \"{s@v}\", \"gpg-verify\",\n                         g_variant_new_variant (g_variant_new_boolean (TRUE)));\n  g_variant_builder_add (&VAR_12, \"{s@v}\", \"gpg-verify-summary\",\n                         g_variant_new_variant (g_variant_new_boolean (TRUE)));\n  g_variant_builder_add (&VAR_12, \"{s@v}\", \"inherit-transaction\",\n                         g_variant_new_variant (g_variant_new_boolean (TRUE)));\n  g_variant_builder_add (&VAR_12, \"{s@v}\", \"update-frequency\",\n                         g_variant_new_variant (g_variant_new_uint32 (VAR_21)));\n\n  if (VAR_3)\n    {\n      g_variant_builder_add (&VAR_12, \"{s@v}\", \"subdirs\",\n                             g_variant_new_variant (g_variant_new_strv ((const char * const *)VAR_3, -1)));\n      g_variant_builder_add (&VAR_12, \"{s@v}\", \"disable-static-deltas\",\n                             g_variant_new_variant (g_variant_new_boolean (TRUE)));\n    }\n\n  VAR_17 = ostree_repo_pull_with_options (VAR_0, VAR_2, g_variant_builder_end (&VAR_12),\n                                       VAR_6, VAR_7, VAR_8);\n\n  if (VAR_6)\n    ostree_async_progress_finish (VAR_6);\n\n  return VAR_17;\n}",
  "func_graph_path": "flatpak/aed5d0919830c02e490f669fc36bd9af42e632d6/flatpak-dir.c/vul/after/2.json",
  "diff_func": "--- func_before\n+++ func_after\n@@ -9,7 +9,8 @@\n                          GCancellable        *cancellable,\n                          GError             **error)\n {\n-  OstreeRepoPullFlags flags = OSTREE_REPO_PULL_FLAGS_UNTRUSTED;\n+  /* The latter flag was introduced in https://github.com/ostreedev/ostree/pull/926 */\n+  const OstreeRepoPullFlags flags = OSTREE_REPO_PULL_FLAGS_UNTRUSTED |OSTREE_REPO_PULL_FLAGS_BAREUSERONLY_FILES;\n   GVariantBuilder builder;\n   g_auto(GLnxConsoleRef) console = { 0, };\n   g_autoptr(OstreeAsyncProgress) console_progress = NULL;",
  "diff_line_info": {
    "deleted_lines": [
      "  OstreeRepoPullFlags flags = OSTREE_REPO_PULL_FLAGS_UNTRUSTED;"
    ],
    "added_lines": [
      "  /* The latter flag was introduced in https://github.com/ostreedev/ostree/pull/926 */",
      "  const OstreeRepoPullFlags flags = OSTREE_REPO_PULL_FLAGS_UNTRUSTED |OSTREE_REPO_PULL_FLAGS_BAREUSERONLY_FILES;"
    ]
  },
  "is_vul": true,
  "pr_url": "https://github.com/flatpak/flatpak/pull/848",
  "description": {
    "pr_info": {
      "title": "system-helper: Use new ostree APIs to reject world-writable/suid content",
      "number": 848
    },
    "comment": [
      "This uses the new libostree APIs that landed recently to ensure\r\nthat we reject any files with mode outside of `0775` for system\r\nhelper pulls, and we also neuter directories during checkout.\r\n\r\nHowever, this does *not* fix up any already downloaded content.\r\nFor that, one could uninstall/reinstall; or a future patch could\r\ndo a one-time fixup pass.\r\n\r\nCloses: https://github.com/flatpak/flatpak/issues/845",
      "Side note; I found it double plus confusing that the system helper path actually wasn't using `flatpak_dir_pull_untrusted_local()`...why does the code try to distinguish between \"local repo\" and `file:///` URI?  In libostree they should be the same thing.",
      "Also something I'm not entirely sure of is the appstream stuff; we appear to be doing pulls for that too that go through separate paths? ",
      "It *is* using flatpak_dir_pull_untrusted_local(). There are two codepaths here. \r\n\r\nOne is the case where the system repo has a remote configured with a file: uri. In this case we just do the pull entierly in the system helper. This is the codepath your current patch has implemented.\r\n\r\nThe other case is where the remote has a non-local uri, but the app already downloaded this to a separate local directory, which is specified with arg_repo_path. In this case we're using flatpak_dir_pull_untrusted_local(). The current patch doesn't handle this case.\r\n\r\nThese are not the same, because in one case the sysadmin defined a pathname as \"trusted\" by configuring a remote at that location. In the second case the caller (who is untrusted) passes in the directory in which to read the files from, and we have to be much more careful about what we pull from this. \r\n\r\nFor the appstream we're pulling in the same way as for app, but the deploy is different (because the checkout is to a different location). This looks fine in the patch.",
      "Ah, and because I was testing this with a \"local\" remote from a locally built app I ended up in the other path.  OK.\r\n\r\nI actually did patch `flatpak_dir_pull_untrusted_local()` though.  That's what I tried first and was really confused when it didn't work.\r\n",
      "Or in other words, the patch is correct?",
      "Oh, lemme check.\r\nIt needs a configure check for the new ostree version though.",
      "Ah, yes. It is correct. However, i would like you to also pass that flag in repo_pull_one_dir, so we get nice warnings about this earlier in the process (and for --user installs).",
      "Let's land https://github.com/flatpak/flatpak/pull/849 first.",
      "Like that :arrow_up:  ?",
      "> error: Can't use bareuseronly-files with non-local origin repo\r\n\r\nAh, yes.  Mrm.  I had originally designed this only for the system helper but perhaps it's better to support it for HTTP pulls too.  Will make a change in libostree.\r\n",
      "Now depends on https://github.com/ostreedev/ostree/pull/930",
      "I guess you can rebase this on master now.",
      "Done. :surfing_man: ",
      "OK, let's give things a day or two at least in git master and do releases?"
    ]
  },
  "Bug Filter": "Security Vulnerability Fix",
  "Bug Filter Confidence": 0.95,
  "Bug Filter Response": "**Final Classification:** Security Vulnerability Fix  \n**Confidence:** 0.95"
}