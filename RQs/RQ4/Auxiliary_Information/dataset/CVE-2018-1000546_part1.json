{
  "cve_id": "CVE-2018-1000546",
  "cwe_ids": [
    "CWE-611"
  ],
  "cvss_vector": "AV:N/AC:M/Au:N/C:P/I:P/A:P",
  "cvss_is_v3": false,
  "repo_name": "triplea-game/triplea",
  "commit_msg": "Allow file access\n\nCo-Authored-By: RoiEXLab <8350879+RoiEXLab@users.noreply.github.com>",
  "commit_hash": "0f23875a4c6e166218859a63c884995f15c53895",
  "git_url": "https://github.com/triplea-game/triplea/commit/0f23875a4c6e166218859a63c884995f15c53895",
  "file_path": "game-core/src/main/java/games/strategy/engine/data/GameParser.java",
  "func_name": "getDocument",
  "func_before": "private Document getDocument(final InputStream input) throws SAXException {\n    try {\n      final DocumentBuilderFactory factory = DocumentBuilderFactory.newInstance();\n      factory.setValidating(true);\n      // Not mandatory, but better than relying on the default implementation to prevent XXE\n      factory.setFeature(XMLConstants.FEATURE_SECURE_PROCESSING, true);\n      // get the dtd location\n      final String dtdFile = \"/games/strategy/engine/xml/\" + DTD_FILE_NAME;\n      final URL url = GameParser.class.getResource(dtdFile);\n      if (url == null) {\n        throw new RuntimeException(String.format(\"Map: %s, Could not find in classpath %s\", mapName, dtdFile));\n      }\n      final DocumentBuilder builder = factory.newDocumentBuilder();\n      builder.setErrorHandler(new ErrorHandler() {\n        @Override\n        public void fatalError(final SAXParseException exception) {\n          errorsSax.add(exception);\n        }\n\n        @Override\n        public void error(final SAXParseException exception) {\n          errorsSax.add(exception);\n        }\n\n        @Override\n        public void warning(final SAXParseException exception) {\n          errorsSax.add(exception);\n        }\n      });\n      final String dtdSystem = url.toExternalForm();\n      final String system = dtdSystem.substring(0, dtdSystem.length() - DTD_FILE_NAME.length());\n      return builder.parse(input, system);\n    } catch (final IOException | ParserConfigurationException e) {\n      throw new IllegalStateException(\"Error parsing: \" + mapName, e);\n    }\n  }",
  "abstract_func_before": "private Document getDocument(final InputStream VAR_0) throws SAXException {\n    try {\n      final DocumentBuilderFactory VAR_1 = VAR_2.newInstance();\n      VAR_1.setValidating(true);\n      /* COMMENT_0 */\n      VAR_1.setFeature(VAR_3.FEATURE_SECURE_PROCESSING, true);\n      /* COMMENT_1 */\n      final String VAR_4 = \"/games/strategy/engine/xml/\" + VAR_5;\n      final URL VAR_6 = GameParser.class.getResource(VAR_4);\n      if (VAR_6 == null) {\n        throw new RuntimeException(VAR_7.format(\"Map: %s, Could not find in classpath %s\", VAR_8, VAR_4));\n      }\n      final DocumentBuilder VAR_9 = VAR_1.newDocumentBuilder();\n      VAR_9.setErrorHandler(new ErrorHandler() {\n        @Override\n        public void fatalError(final SAXParseException VAR_10) {\n          VAR_11.add(VAR_10);\n        }\n\n        @Override\n        public void error(final SAXParseException VAR_10) {\n          VAR_11.add(VAR_10);\n        }\n\n        @Override\n        public void warning(final SAXParseException VAR_10) {\n          VAR_11.add(VAR_10);\n        }\n      });\n      final String VAR_12 = VAR_6.toExternalForm();\n      final String VAR_13 = VAR_12.substring(0, VAR_12.length() - VAR_5.length());\n      return VAR_9.parse(VAR_0, VAR_13);\n    } catch (final IOException | ParserConfigurationException VAR_14) {\n      throw new IllegalStateException(\"Error parsing: \" + VAR_8, VAR_14);\n    }\n  }",
  "func_graph_path_before": "triplea-game/triplea/0f23875a4c6e166218859a63c884995f15c53895/GameParser.java/vul/before/0.json",
  "func": "private Document getDocument(final InputStream input) throws SAXException {\n    try {\n      final DocumentBuilderFactory factory = DocumentBuilderFactory.newInstance();\n      factory.setValidating(true);\n      // Not mandatory, but better than relying on the default implementation to prevent XXE\n      factory.setFeature(XMLConstants.FEATURE_SECURE_PROCESSING, true);\n      factory.setAttribute(XMLConstants.ACCESS_EXTERNAL_DTD, \"file\");\n      // get the dtd location\n      final String dtdFile = \"/games/strategy/engine/xml/\" + DTD_FILE_NAME;\n      final URL url = GameParser.class.getResource(dtdFile);\n      if (url == null) {\n        throw new RuntimeException(String.format(\"Map: %s, Could not find in classpath %s\", mapName, dtdFile));\n      }\n      final DocumentBuilder builder = factory.newDocumentBuilder();\n      builder.setErrorHandler(new ErrorHandler() {\n        @Override\n        public void fatalError(final SAXParseException exception) {\n          errorsSax.add(exception);\n        }\n\n        @Override\n        public void error(final SAXParseException exception) {\n          errorsSax.add(exception);\n        }\n\n        @Override\n        public void warning(final SAXParseException exception) {\n          errorsSax.add(exception);\n        }\n      });\n      final String dtdSystem = url.toExternalForm();\n      final String system = dtdSystem.substring(0, dtdSystem.length() - DTD_FILE_NAME.length());\n      return builder.parse(input, system);\n    } catch (final IOException | ParserConfigurationException e) {\n      throw new IllegalStateException(\"Error parsing: \" + mapName, e);\n    }\n  }",
  "abstract_func": "private Document getDocument(final InputStream VAR_0) throws SAXException {\n    try {\n      final DocumentBuilderFactory VAR_1 = VAR_2.newInstance();\n      VAR_1.setValidating(true);\n      /* COMMENT_0 */\n      VAR_1.setFeature(VAR_3.FEATURE_SECURE_PROCESSING, true);\n      VAR_1.setAttribute(VAR_3.ACCESS_EXTERNAL_DTD, \"file\");\n      /* COMMENT_1 */\n      final String VAR_4 = \"/games/strategy/engine/xml/\" + VAR_5;\n      final URL VAR_6 = GameParser.class.getResource(VAR_4);\n      if (VAR_6 == null) {\n        throw new RuntimeException(VAR_7.format(\"Map: %s, Could not find in classpath %s\", VAR_8, VAR_4));\n      }\n      final DocumentBuilder VAR_9 = VAR_1.newDocumentBuilder();\n      VAR_9.setErrorHandler(new ErrorHandler() {\n        @Override\n        public void fatalError(final SAXParseException VAR_10) {\n          VAR_11.add(VAR_10);\n        }\n\n        @Override\n        public void error(final SAXParseException VAR_10) {\n          VAR_11.add(VAR_10);\n        }\n\n        @Override\n        public void warning(final SAXParseException VAR_10) {\n          VAR_11.add(VAR_10);\n        }\n      });\n      final String VAR_12 = VAR_6.toExternalForm();\n      final String VAR_13 = VAR_12.substring(0, VAR_12.length() - VAR_5.length());\n      return VAR_9.parse(VAR_0, VAR_13);\n    } catch (final IOException | ParserConfigurationException VAR_14) {\n      throw new IllegalStateException(\"Error parsing: \" + VAR_8, VAR_14);\n    }\n  }",
  "func_graph_path": "triplea-game/triplea/0f23875a4c6e166218859a63c884995f15c53895/GameParser.java/vul/after/0.json",
  "diff_func": "--- func_before\n+++ func_after\n@@ -4,6 +4,7 @@\n       factory.setValidating(true);\n       // Not mandatory, but better than relying on the default implementation to prevent XXE\n       factory.setFeature(XMLConstants.FEATURE_SECURE_PROCESSING, true);\n+      factory.setAttribute(XMLConstants.ACCESS_EXTERNAL_DTD, \"file\");\n       // get the dtd location\n       final String dtdFile = \"/games/strategy/engine/xml/\" + DTD_FILE_NAME;\n       final URL url = GameParser.class.getResource(dtdFile);",
  "diff_line_info": {
    "deleted_lines": [],
    "added_lines": [
      "      factory.setAttribute(XMLConstants.ACCESS_EXTERNAL_DTD, \"file\");"
    ]
  },
  "is_vul": true,
  "pr_url": "https://github.com/triplea-game/triplea/pull/4516",
  "description": {
    "pr_info": {
      "title": "Ensure XXE security",
      "number": 4516
    },
    "comment": [
      "## Overview\r\nFixes #3442\r\n\r\n## Functional Changes\r\nNone. (See #3442 )\r\n\r\n## Manual Testing Performed\r\nI verified TripleA didn't open an HTTP connection to the specified server.",
      "The build fails. \r\n\r\nSee https://github.com/triplea-game/triplea/issues/3442#issuecomment-451656656 for more information.",
      "@ron-murhammer @ssoloff @DanVanAtta Ideas? (Have a look at #3442 first)",
      "@RoiEXLab With the following change, I was able to get `ProUtilsTest` to pass:\r\n\r\n```diff\r\ndiff --git a/game-core/src/main/java/games/strategy/engine/data/GameParser.java b/game-core/src/main/java/games/strategy/engine/data/GameParser.java\r\nindex 66d2bafd3..40ad3222d 100644\r\n--- a/game-core/src/main/java/games/strategy/engine/data/GameParser.java\r\n+++ b/game-core/src/main/java/games/strategy/engine/data/GameParser.java\r\n@@ -307,6 +307,7 @@ public final class GameParser {\r\n       factory.setValidating(true);\r\n       // Not mandatory, but better than relying on the default implementation to prevent XXE\r\n       factory.setFeature(XMLConstants.FEATURE_SECURE_PROCESSING, true);\r\n+      factory.setAttribute(XMLConstants.ACCESS_EXTERNAL_DTD, \"file\");\r\n       // get the dtd location\r\n       final String dtdFile = \"/games/strategy/engine/xml/\" + DTD_FILE_NAME;\r\n       final URL url = GameParser.class.getResource(dtdFile);\r\n```\r\n\r\nWould you agree that limiting DTD access to the local file system mitigates an XXE attack?",
      "@ssoloff Thanks for finding this option, I tried a couple of things, none of which seemed to work ðŸ‘\r\nI do think that limiting this to the local file system is a good 1st step, but ideally we'd ensure that the only allowed dtd is \"game.dtd\"/no dtds outside of this folder inside the classpath can be used.",
      "Also, would you be so kind to turn your diff into a suggestion?\r\nI'm won't be in front of my pc today anymore, so that would be nice ^^",
      "# [Codecov](https://codecov.io/gh/triplea-game/triplea/pull/4516?src=pr&el=h1) Report\n> Merging [#4516](https://codecov.io/gh/triplea-game/triplea/pull/4516?src=pr&el=desc) into [master](https://codecov.io/gh/triplea-game/triplea/commit/1eed29e75853faed14bd2be30372a5eba16be018?src=pr&el=desc) will **increase** coverage by `0.01%`.\n> The diff coverage is `100%`.\n\n[![Impacted file tree graph](https://codecov.io/gh/triplea-game/triplea/pull/4516/graphs/tree.svg?width=650&token=QPS14q4xnG&height=150&src=pr)](https://codecov.io/gh/triplea-game/triplea/pull/4516?src=pr&el=tree)\n\n```diff\n@@             Coverage Diff             @@\n##             master   #4516      +/-   ##\n===========================================\n+ Coverage     23.09%   23.1%   +0.01%     \n- Complexity     6198    6206       +8     \n===========================================\n  Files           878     878              \n  Lines         70799   70835      +36     \n  Branches      11288   11287       -1     \n===========================================\n+ Hits          16349   16367      +18     \n- Misses        52415   52435      +20     \n+ Partials       2035    2033       -2\n```\n\n\n| [Impacted Files](https://codecov.io/gh/triplea-game/triplea/pull/4516?src=pr&el=tree) | Coverage Î” | Complexity Î” | |\n|---|---|---|---|\n| [...in/java/games/strategy/engine/data/GameParser.java](https://codecov.io/gh/triplea-game/triplea/pull/4516/diff?src=pr&el=tree#diff-Z2FtZS1jb3JlL3NyYy9tYWluL2phdmEvZ2FtZXMvc3RyYXRlZ3kvZW5naW5lL2RhdGEvR2FtZVBhcnNlci5qYXZh) | `70.52% <100%> (+0.07%)` | `180 <0> (Ã¸)` | :arrow_down: |\n| [...tegy/engine/framework/system/SystemProperties.java](https://codecov.io/gh/triplea-game/triplea/pull/4516/diff?src=pr&el=tree#diff-Z2FtZS1jb3JlL3NyYy9tYWluL2phdmEvZ2FtZXMvc3RyYXRlZ3kvZW5naW5lL2ZyYW1ld29yay9zeXN0ZW0vU3lzdGVtUHJvcGVydGllcy5qYXZh) | `33.33% <0%> (-3.04%)` | `4% <0%> (Ã¸)` | |\n| [...ava/org/triplea/server/http/spark/SparkServer.java](https://codecov.io/gh/triplea-game/triplea/pull/4516/diff?src=pr&el=tree#diff-aHR0cC1zZXJ2ZXIvc3JjL21haW4vamF2YS9vcmcvdHJpcGxlYS9zZXJ2ZXIvaHR0cC9zcGFyay9TcGFya1NlcnZlci5qYXZh) | `0% <0%> (Ã¸)` | `0% <0%> (Ã¸)` | :arrow_down: |\n| [...va/games/strategy/engine/framework/GameRunner.java](https://codecov.io/gh/triplea-game/triplea/pull/4516/diff?src=pr&el=tree#diff-Z2FtZS1jb3JlL3NyYy9tYWluL2phdmEvZ2FtZXMvc3RyYXRlZ3kvZW5naW5lL2ZyYW1ld29yay9HYW1lUnVubmVyLmphdmE=) | `0% <0%> (Ã¸)` | `0% <0%> (Ã¸)` | :arrow_down: |\n| [...n/java/games/strategy/triplea/ui/TripleAFrame.java](https://codecov.io/gh/triplea-game/triplea/pull/4516/diff?src=pr&el=tree#diff-Z2FtZS1jb3JlL3NyYy9tYWluL2phdmEvZ2FtZXMvc3RyYXRlZ3kvdHJpcGxlYS91aS9UcmlwbGVBRnJhbWUuamF2YQ==) | `0% <0%> (Ã¸)` | `0% <0%> (Ã¸)` | :arrow_down: |\n| [...n/java/org/triplea/server/ServerConfiguration.java](https://codecov.io/gh/triplea-game/triplea/pull/4516/diff?src=pr&el=tree#diff-aHR0cC1zZXJ2ZXIvc3JjL21haW4vamF2YS9vcmcvdHJpcGxlYS9zZXJ2ZXIvU2VydmVyQ29uZmlndXJhdGlvbi5qYXZh) | `0% <0%> (Ã¸)` | `0% <0%> (Ã¸)` | :arrow_down: |\n| [...a/http/client/github/issues/GithubIssueClient.java](https://codecov.io/gh/triplea-game/triplea/pull/4516/diff?src=pr&el=tree#diff-aHR0cC1jbGllbnQvc3JjL21haW4vamF2YS9vcmcvdHJpcGxlYS9odHRwL2NsaWVudC9naXRodWIvaXNzdWVzL0dpdGh1Yklzc3VlQ2xpZW50LmphdmE=) | `0% <0%> (Ã¸)` | `0% <0%> (Ã¸)` | :arrow_down: |\n| [...va/games/strategy/triplea/ui/menubar/HelpMenu.java](https://codecov.io/gh/triplea-game/triplea/pull/4516/diff?src=pr&el=tree#diff-Z2FtZS1jb3JlL3NyYy9tYWluL2phdmEvZ2FtZXMvc3RyYXRlZ3kvdHJpcGxlYS91aS9tZW51YmFyL0hlbHBNZW51LmphdmE=) | `0% <0%> (Ã¸)` | `0% <0%> (Ã¸)` | :arrow_down: |\n| [...rver/reporting/error/ErrorUploadConfiguration.java](https://codecov.io/gh/triplea-game/triplea/pull/4516/diff?src=pr&el=tree#diff-aHR0cC1zZXJ2ZXIvc3JjL21haW4vamF2YS9vcmcvdHJpcGxlYS9zZXJ2ZXIvcmVwb3J0aW5nL2Vycm9yL0Vycm9yVXBsb2FkQ29uZmlndXJhdGlvbi5qYXZh) | `0% <0%> (Ã¸)` | `0% <0%> (Ã¸)` | :arrow_down: |\n| [...ea/server/reporting/error/ErrorUploadStrategy.java](https://codecov.io/gh/triplea-game/triplea/pull/4516/diff?src=pr&el=tree#diff-aHR0cC1zZXJ2ZXIvc3JjL21haW4vamF2YS9vcmcvdHJpcGxlYS9zZXJ2ZXIvcmVwb3J0aW5nL2Vycm9yL0Vycm9yVXBsb2FkU3RyYXRlZ3kuamF2YQ==) | `88.88% <0%> (Ã¸)` | `3% <0%> (Ã¸)` | :arrow_down: |\n| ... and [11 more](https://codecov.io/gh/triplea-game/triplea/pull/4516/diff?src=pr&el=tree-more) | |\n\n------\n\n[Continue to review full report at Codecov](https://codecov.io/gh/triplea-game/triplea/pull/4516?src=pr&el=continue).\n> **Legend** - [Click here to learn more](https://docs.codecov.io/docs/codecov-delta)\n> `Î” = absolute <relative> (impact)`, `Ã¸ = not affected`, `? = missing data`\n> Powered by [Codecov](https://codecov.io/gh/triplea-game/triplea/pull/4516?src=pr&el=footer). Last update [1eed29e...0f23875](https://codecov.io/gh/triplea-game/triplea/pull/4516?src=pr&el=lastupdated). Read the [comment docs](https://docs.codecov.io/docs/pull-request-comments).\n"
    ]
  },
  "Bug Filter": "Security Vulnerability Fix",
  "Bug Filter Confidence": 0.9,
  "Bug Filter Response": "Final Classification: Security Vulnerability Fix; Confidence: 0.9\n\n**Step-by-Step Explanation:**\n\n1. **Commit Message Analysis:** The message mentions \"Allow file access,\" which might seem neutral but could relate to file permissions.\n\n2. **Code Diff Analysis:** The change adds setting `ACCESS_EXTERNAL_DTD` to \"file,\" which restricts XML parser access to prevent external entity attacksâ€”a security measure against XXE.\n\n3. **Vulnerability Context:** The description refers to issue #3442, and manual testing ensures no HTTP connections, indicating a security concern was addressed.\n\n4. **Security Assessment:** The change directly mitigates an XXE vulnerability by limiting DTD resolution to files, preventing external data access.\n\n**Conclusion:** The fix prevents XXE attacks, thus classified as a security vulnerability fix with high confidence (0.9) due to clear intent and code alignment."
}