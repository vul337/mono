{
  "cve_id": "CVE-2022-36044",
  "cwe_ids": [
    "CWE-787"
  ],
  "cvss_vector": "CVSS:3.1/AV:L/AC:L/PR:N/UI:R/S:U/C:H/I:H/A:H",
  "cvss_is_v3": true,
  "repo_name": "rizinorg/rizin",
  "commit_msg": "Fix oob read on _luac_build_info and luac memleaks",
  "commit_hash": "05bbd147caccc60162d6fba9baaaf24befa281cd",
  "git_url": "https://github.com/rizinorg/rizin/commit/05bbd147caccc60162d6fba9baaaf24befa281cd",
  "file_path": "librz/bin/format/luac/luac_bin.c",
  "func_name": "_luac_build_info",
  "func_before": "void _luac_build_info(LuaProto *proto, LuacBinInfo *info) {\n\t/* process proto header info */\n\tchar *section_name;\n\tchar *symbol_name;\n\tchar *proto_name;\n\tRzListIter *iter;\n\n\tut64 current_offset;\n\tut64 current_size;\n\n\tint i = 0; // iter\n\n\t// 0. check if stripped (proto name is lost)\n\tif (proto->name_size == 0 || proto->proto_name == NULL) {\n\t\t// replace name with current offset\n\t\tproto_name = rz_str_newf(\"fcn.%08llx\", proto->offset);\n\t} else {\n\t\tproto_name = rz_str_new((char *)proto->proto_name);\n\t}\n\n\t// 1.1 set section name as function_name.header\n\tcurrent_offset = proto->offset;\n\tcurrent_size = proto->size;\n\tsection_name = rz_str_newf(\"%s.header\", proto_name);\n\tluac_add_section(info->section_list, section_name, current_offset, current_size, false);\n\tRZ_FREE(section_name);\n\n\t// 1.2 set section name as function_name.code\n\tcurrent_offset = proto->code_offset;\n\tcurrent_size = proto->code_size;\n\tsection_name = rz_str_newf(\"%s.code\", proto_name);\n\tluac_add_section(info->section_list, section_name, current_offset, current_size, true);\n\tRZ_FREE(section_name);\n\n\t// 1.3 set const section\n\tcurrent_offset = proto->const_offset;\n\tcurrent_size = proto->const_size;\n\tsection_name = rz_str_newf(\"%s.const\", proto_name);\n\tluac_add_section(info->section_list, section_name, current_offset, current_size, false);\n\tRZ_FREE(section_name);\n\n\t// 1.4 upvalue section\n\tcurrent_offset = proto->upvalue_offset;\n\tcurrent_size = proto->upvalue_size;\n\tsection_name = rz_str_newf(\"%s.upvalues\", proto_name);\n\tluac_add_section(info->section_list, section_name, current_offset, current_size, false);\n\tRZ_FREE(section_name);\n\n\t// 1.5 inner protos section\n\tcurrent_offset = proto->inner_proto_offset;\n\tcurrent_size = proto->inner_proto_size;\n\tsection_name = rz_str_newf(\"%s.protos\", proto_name);\n\tluac_add_section(info->section_list, section_name, current_offset, current_size, false);\n\tRZ_FREE(section_name);\n\n\t// 1.6 debug section\n\tcurrent_offset = proto->debug_offset;\n\tcurrent_size = proto->debug_size;\n\tsection_name = rz_str_newf(\"%s.debug\", proto_name);\n\tluac_add_section(info->section_list, section_name, current_offset, current_size, false);\n\tRZ_FREE(section_name);\n\n\t// 2.1 parse local var info\n\tLuaLocalVarEntry *local_var_entry;\n\trz_list_foreach (proto->local_var_info_entries, iter, local_var_entry) {\n\t\tluac_add_string(\n\t\t\tinfo->string_list,\n\t\t\t(char *)local_var_entry->varname,\n\t\t\tlocal_var_entry->offset,\n\t\t\tlocal_var_entry->varname_len);\n\t}\n\n\t// 2.2 parse debug_upvalues\n\tchar **upvalue_names;\n\tint real_upvalue_cnt;\n\tLuaDbgUpvalueEntry *debug_upv_entry;\n\treal_upvalue_cnt = rz_list_length(proto->upvalue_entries);\n\tupvalue_names = RZ_NEWS0(char *, real_upvalue_cnt);\n\tif (!upvalue_names) {\n\t\treturn;\n\t}\n\trz_list_foreach (proto->dbg_upvalue_entries, iter, debug_upv_entry) {\n\t\tupvalue_names[i] = (char *)debug_upv_entry->upvalue_name;\n\t\tluac_add_string(\n\t\t\tinfo->string_list,\n\t\t\tupvalue_names[i],\n\t\t\tdebug_upv_entry->offset,\n\t\t\tdebug_upv_entry->name_len);\n\t}\n\n\t// 3.1 construct constant symbols\n\tLuaConstEntry *const_entry;\n\trz_list_foreach (proto->const_entries, iter, const_entry) {\n\t\tsymbol_name = get_constant_symbol_name(proto_name, const_entry);\n\t\tluac_add_symbol(\n\t\t\tinfo->symbol_list,\n\t\t\tsymbol_name,\n\t\t\tconst_entry->offset,\n\t\t\tconst_entry->data_len,\n\t\t\tget_tag_string(const_entry->tag));\n\t\tif (const_entry->tag == LUA_VLNGSTR || const_entry->tag == LUA_VSHRSTR) {\n\t\t\tluac_add_string(\n\t\t\t\tinfo->string_list,\n\t\t\t\t(char *)const_entry->data,\n\t\t\t\tconst_entry->offset,\n\t\t\t\tconst_entry->data_len);\n\t\t}\n\t\tRZ_FREE(symbol_name);\n\t}\n\n\t// 3.2 construct upvalue symbols\n\tLuaUpvalueEntry *upvalue_entry;\n\ti = 0;\n\trz_list_foreach (proto->upvalue_entries, iter, upvalue_entry) {\n\t\tsymbol_name = get_upvalue_symbol_name(proto_name, upvalue_entry, upvalue_names[i++]);\n\t\tluac_add_symbol(\n\t\t\tinfo->symbol_list,\n\t\t\tsymbol_name,\n\t\t\tupvalue_entry->offset,\n\t\t\t3,\n\t\t\t\"UPVALUE\");\n\t\tRZ_FREE(symbol_name);\n\t}\n\n\t// 4. parse sub proto\n\tLuaProto *sub_proto;\n\trz_list_foreach (proto->proto_entries, iter, sub_proto) {\n\t\t_luac_build_info(sub_proto, info);\n\t}\n\n\tRZ_FREE(proto_name);\n}",
  "abstract_func_before": "void _luac_build_info(LuaProto *VAR_0, LuacBinInfo *VAR_1) {\n\t/* COMMENT_0 */\n\tchar *VAR_2;\n\tchar *VAR_3;\n\tchar *VAR_4;\n\tRzListIter *VAR_5;\n\n\tut64 VAR_6;\n\tut64 VAR_7;\n\n\tint VAR_8 = 0; /* COMMENT_1 */\n\n\t/* COMMENT_2 */\n\tif (VAR_0->name_size == 0 || VAR_0->proto_name == NULL) {\n\t\t/* COMMENT_3 */\n\t\tVAR_4 = rz_str_newf(\"fcn.%08llx\", VAR_0->offset);\n\t} else {\n\t\tVAR_4 = rz_str_new((char *)VAR_0->proto_name);\n\t}\n\n\t/* COMMENT_4 */\n\tVAR_6 = VAR_0->offset;\n\tVAR_7 = VAR_0->size;\n\tVAR_2 = rz_str_newf(\"%s.header\", VAR_4);\n\tluac_add_section(VAR_1->section_list, VAR_2, VAR_6, VAR_7, false);\n\tRZ_FREE(VAR_2);\n\n\t/* COMMENT_5 */\n\tVAR_6 = VAR_0->code_offset;\n\tVAR_7 = VAR_0->code_size;\n\tVAR_2 = rz_str_newf(\"%s.code\", VAR_4);\n\tluac_add_section(VAR_1->section_list, VAR_2, VAR_6, VAR_7, true);\n\tRZ_FREE(VAR_2);\n\n\t/* COMMENT_6 */\n\tVAR_6 = VAR_0->const_offset;\n\tVAR_7 = VAR_0->const_size;\n\tVAR_2 = rz_str_newf(\"%s.const\", VAR_4);\n\tluac_add_section(VAR_1->section_list, VAR_2, VAR_6, VAR_7, false);\n\tRZ_FREE(VAR_2);\n\n\t/* COMMENT_7 */\n\tVAR_6 = VAR_0->upvalue_offset;\n\tVAR_7 = VAR_0->upvalue_size;\n\tVAR_2 = rz_str_newf(\"%s.upvalues\", VAR_4);\n\tluac_add_section(VAR_1->section_list, VAR_2, VAR_6, VAR_7, false);\n\tRZ_FREE(VAR_2);\n\n\t/* COMMENT_8 */\n\tVAR_6 = VAR_0->inner_proto_offset;\n\tVAR_7 = VAR_0->inner_proto_size;\n\tVAR_2 = rz_str_newf(\"%s.protos\", VAR_4);\n\tluac_add_section(VAR_1->section_list, VAR_2, VAR_6, VAR_7, false);\n\tRZ_FREE(VAR_2);\n\n\t/* COMMENT_9 */\n\tVAR_6 = VAR_0->debug_offset;\n\tVAR_7 = VAR_0->debug_size;\n\tVAR_2 = rz_str_newf(\"%s.debug\", VAR_4);\n\tluac_add_section(VAR_1->section_list, VAR_2, VAR_6, VAR_7, false);\n\tRZ_FREE(VAR_2);\n\n\t/* COMMENT_10 */\n\tLuaLocalVarEntry *VAR_9;\n\trz_list_foreach (VAR_0->local_var_info_entries, VAR_5, VAR_9) {\n\t\tluac_add_string(\n\t\t\tVAR_1->string_list,\n\t\t\t(char *)VAR_9->varname,\n\t\t\tVAR_9->offset,\n\t\t\tVAR_9->varname_len);\n\t}\n\n\t/* COMMENT_11 */\n\tchar **VAR_10;\n\tint VAR_11;\n\tLuaDbgUpvalueEntry *VAR_12;\n\tVAR_11 = rz_list_length(VAR_0->upvalue_entries);\n\tVAR_10 = RZ_NEWS0(char *, VAR_11);\n\tif (!VAR_10) {\n\t\treturn;\n\t}\n\trz_list_foreach (VAR_0->dbg_upvalue_entries, VAR_5, VAR_12) {\n\t\tVAR_10[VAR_8] = (char *)VAR_12->upvalue_name;\n\t\tluac_add_string(\n\t\t\tVAR_1->string_list,\n\t\t\tVAR_10[VAR_8],\n\t\t\tVAR_12->offset,\n\t\t\tVAR_12->name_len);\n\t}\n\n\t/* COMMENT_12 */\n\tLuaConstEntry *VAR_13;\n\trz_list_foreach (VAR_0->const_entries, VAR_5, VAR_13) {\n\t\tVAR_3 = get_constant_symbol_name(VAR_4, VAR_13);\n\t\tluac_add_symbol(\n\t\t\tVAR_1->symbol_list,\n\t\t\tVAR_3,\n\t\t\tVAR_13->offset,\n\t\t\tVAR_13->data_len,\n\t\t\tget_tag_string(VAR_13->tag));\n\t\tif (VAR_13->tag == VAR_14 || VAR_13->tag == VAR_15) {\n\t\t\tluac_add_string(\n\t\t\t\tVAR_1->string_list,\n\t\t\t\t(char *)VAR_13->data,\n\t\t\t\tVAR_13->offset,\n\t\t\t\tVAR_13->data_len);\n\t\t}\n\t\tRZ_FREE(VAR_3);\n\t}\n\n\t/* COMMENT_13 */\n\tLuaUpvalueEntry *VAR_16;\n\tVAR_8 = 0;\n\trz_list_foreach (VAR_0->upvalue_entries, VAR_5, VAR_16) {\n\t\tVAR_3 = get_upvalue_symbol_name(VAR_4, VAR_16, VAR_10[VAR_8++]);\n\t\tluac_add_symbol(\n\t\t\tVAR_1->symbol_list,\n\t\t\tVAR_3,\n\t\t\tVAR_16->offset,\n\t\t\t3,\n\t\t\t\"UPVALUE\");\n\t\tRZ_FREE(VAR_3);\n\t}\n\n\t/* COMMENT_14 */\n\tLuaProto *VAR_17;\n\trz_list_foreach (VAR_0->proto_entries, VAR_5, VAR_17) {\n\t\t_luac_build_info(VAR_17, VAR_1);\n\t}\n\n\tRZ_FREE(VAR_4);\n}",
  "func_graph_path_before": "rizinorg/rizin/05bbd147caccc60162d6fba9baaaf24befa281cd/luac_bin.c/vul/before/1.json",
  "func": "void _luac_build_info(LuaProto *proto, LuacBinInfo *info) {\n\t/* process proto header info */\n\tchar *section_name;\n\tchar *symbol_name;\n\tchar *proto_name;\n\tchar **upvalue_names = NULL;\n\tRzListIter *iter;\n\tint i = 0; // iter\n\n\tut64 current_offset;\n\tut64 current_size;\n\n\t// 0. check if stripped (proto name is lost)\n\tif (proto->name_size == 0 || proto->proto_name == NULL) {\n\t\t// replace name with current offset\n\t\tproto_name = rz_str_newf(\"fcn.%08llx\", proto->offset);\n\t} else {\n\t\tproto_name = rz_str_new((char *)proto->proto_name);\n\t}\n\n\t// 1.1 set section name as function_name.header\n\tcurrent_offset = proto->offset;\n\tcurrent_size = proto->size;\n\tsection_name = rz_str_newf(\"%s.header\", proto_name);\n\tluac_add_section(info->section_list, section_name, current_offset, current_size, false);\n\tRZ_FREE(section_name);\n\n\t// 1.2 set section name as function_name.code\n\tcurrent_offset = proto->code_offset;\n\tcurrent_size = proto->code_size;\n\tsection_name = rz_str_newf(\"%s.code\", proto_name);\n\tluac_add_section(info->section_list, section_name, current_offset, current_size, true);\n\tRZ_FREE(section_name);\n\n\t// 1.3 set const section\n\tcurrent_offset = proto->const_offset;\n\tcurrent_size = proto->const_size;\n\tsection_name = rz_str_newf(\"%s.const\", proto_name);\n\tluac_add_section(info->section_list, section_name, current_offset, current_size, false);\n\tRZ_FREE(section_name);\n\n\t// 1.4 upvalue section\n\tcurrent_offset = proto->upvalue_offset;\n\tcurrent_size = proto->upvalue_size;\n\tsection_name = rz_str_newf(\"%s.upvalues\", proto_name);\n\tluac_add_section(info->section_list, section_name, current_offset, current_size, false);\n\tRZ_FREE(section_name);\n\n\t// 1.5 inner protos section\n\tcurrent_offset = proto->inner_proto_offset;\n\tcurrent_size = proto->inner_proto_size;\n\tsection_name = rz_str_newf(\"%s.protos\", proto_name);\n\tluac_add_section(info->section_list, section_name, current_offset, current_size, false);\n\tRZ_FREE(section_name);\n\n\t// 1.6 debug section\n\tcurrent_offset = proto->debug_offset;\n\tcurrent_size = proto->debug_size;\n\tsection_name = rz_str_newf(\"%s.debug\", proto_name);\n\tluac_add_section(info->section_list, section_name, current_offset, current_size, false);\n\tRZ_FREE(section_name);\n\n\t// 2.1 parse local var info\n\tLuaLocalVarEntry *local_var_entry;\n\trz_list_foreach (proto->local_var_info_entries, iter, local_var_entry) {\n\t\tluac_add_string(\n\t\t\tinfo->string_list,\n\t\t\t(char *)local_var_entry->varname,\n\t\t\tlocal_var_entry->offset,\n\t\t\tlocal_var_entry->varname_len);\n\t}\n\n\t// 2.2 parse debug_upvalues\n\tsize_t real_upvalue_cnt = rz_list_length(proto->upvalue_entries);\n\tif (real_upvalue_cnt > 0) {\n\t\tLuaDbgUpvalueEntry *debug_upv_entry;\n\t\tupvalue_names = RZ_NEWS0(char *, real_upvalue_cnt);\n\t\tif (!upvalue_names) {\n\t\t\tfree(proto_name);\n\t\t\treturn;\n\t\t}\n\n\t\ti = 0;\n\t\trz_list_foreach (proto->dbg_upvalue_entries, iter, debug_upv_entry) {\n\t\t\tupvalue_names[i] = (char *)debug_upv_entry->upvalue_name;\n\t\t\tluac_add_string(\n\t\t\t\tinfo->string_list,\n\t\t\t\tupvalue_names[i],\n\t\t\t\tdebug_upv_entry->offset,\n\t\t\t\tdebug_upv_entry->name_len);\n\t\t\ti++;\n\t\t}\n\t}\n\n\t// 3.1 construct constant symbols\n\tLuaConstEntry *const_entry;\n\trz_list_foreach (proto->const_entries, iter, const_entry) {\n\t\tsymbol_name = get_constant_symbol_name(proto_name, const_entry);\n\t\tluac_add_symbol(\n\t\t\tinfo->symbol_list,\n\t\t\tsymbol_name,\n\t\t\tconst_entry->offset,\n\t\t\tconst_entry->data_len,\n\t\t\tget_tag_string(const_entry->tag));\n\t\tif (const_entry->tag == LUA_VLNGSTR || const_entry->tag == LUA_VSHRSTR) {\n\t\t\tluac_add_string(\n\t\t\t\tinfo->string_list,\n\t\t\t\t(char *)const_entry->data,\n\t\t\t\tconst_entry->offset,\n\t\t\t\tconst_entry->data_len);\n\t\t}\n\t\tRZ_FREE(symbol_name);\n\t}\n\n\t// 3.2 construct upvalue symbols\n\tLuaUpvalueEntry *upvalue_entry;\n\ti = 0;\n\trz_list_foreach (proto->upvalue_entries, iter, upvalue_entry) {\n\t\tsymbol_name = get_upvalue_symbol_name(proto_name, upvalue_entry, upvalue_names[i++]);\n\t\tluac_add_symbol(\n\t\t\tinfo->symbol_list,\n\t\t\tsymbol_name,\n\t\t\tupvalue_entry->offset,\n\t\t\t3,\n\t\t\t\"UPVALUE\");\n\t\tRZ_FREE(symbol_name);\n\t}\n\n\t// 4. parse sub proto\n\tLuaProto *sub_proto;\n\trz_list_foreach (proto->proto_entries, iter, sub_proto) {\n\t\t_luac_build_info(sub_proto, info);\n\t}\n\n\tfree(upvalue_names);\n\tfree(proto_name);\n}",
  "abstract_func": "void _luac_build_info(LuaProto *VAR_0, LuacBinInfo *VAR_1) {\n\t/* COMMENT_0 */\n\tchar *VAR_2;\n\tchar *VAR_3;\n\tchar *VAR_4;\n\tchar **VAR_5 = NULL;\n\tRzListIter *VAR_6;\n\tint VAR_7 = 0; /* COMMENT_1 */\n\n\tut64 VAR_8;\n\tut64 VAR_9;\n\n\t/* COMMENT_2 */\n\tif (VAR_0->name_size == 0 || VAR_0->proto_name == NULL) {\n\t\t/* COMMENT_3 */\n\t\tVAR_4 = rz_str_newf(\"fcn.%08llx\", VAR_0->offset);\n\t} else {\n\t\tVAR_4 = rz_str_new((char *)VAR_0->proto_name);\n\t}\n\n\t/* COMMENT_4 */\n\tVAR_8 = VAR_0->offset;\n\tVAR_9 = VAR_0->size;\n\tVAR_2 = rz_str_newf(\"%s.header\", VAR_4);\n\tluac_add_section(VAR_1->section_list, VAR_2, VAR_8, VAR_9, false);\n\tRZ_FREE(VAR_2);\n\n\t/* COMMENT_5 */\n\tVAR_8 = VAR_0->code_offset;\n\tVAR_9 = VAR_0->code_size;\n\tVAR_2 = rz_str_newf(\"%s.code\", VAR_4);\n\tluac_add_section(VAR_1->section_list, VAR_2, VAR_8, VAR_9, true);\n\tRZ_FREE(VAR_2);\n\n\t/* COMMENT_6 */\n\tVAR_8 = VAR_0->const_offset;\n\tVAR_9 = VAR_0->const_size;\n\tVAR_2 = rz_str_newf(\"%s.const\", VAR_4);\n\tluac_add_section(VAR_1->section_list, VAR_2, VAR_8, VAR_9, false);\n\tRZ_FREE(VAR_2);\n\n\t/* COMMENT_7 */\n\tVAR_8 = VAR_0->upvalue_offset;\n\tVAR_9 = VAR_0->upvalue_size;\n\tVAR_2 = rz_str_newf(\"%s.upvalues\", VAR_4);\n\tluac_add_section(VAR_1->section_list, VAR_2, VAR_8, VAR_9, false);\n\tRZ_FREE(VAR_2);\n\n\t/* COMMENT_8 */\n\tVAR_8 = VAR_0->inner_proto_offset;\n\tVAR_9 = VAR_0->inner_proto_size;\n\tVAR_2 = rz_str_newf(\"%s.protos\", VAR_4);\n\tluac_add_section(VAR_1->section_list, VAR_2, VAR_8, VAR_9, false);\n\tRZ_FREE(VAR_2);\n\n\t/* COMMENT_9 */\n\tVAR_8 = VAR_0->debug_offset;\n\tVAR_9 = VAR_0->debug_size;\n\tVAR_2 = rz_str_newf(\"%s.debug\", VAR_4);\n\tluac_add_section(VAR_1->section_list, VAR_2, VAR_8, VAR_9, false);\n\tRZ_FREE(VAR_2);\n\n\t/* COMMENT_10 */\n\tLuaLocalVarEntry *VAR_10;\n\trz_list_foreach (VAR_0->local_var_info_entries, VAR_6, VAR_10) {\n\t\tluac_add_string(\n\t\t\tVAR_1->string_list,\n\t\t\t(char *)VAR_10->varname,\n\t\t\tVAR_10->offset,\n\t\t\tVAR_10->varname_len);\n\t}\n\n\t/* COMMENT_11 */\n\tsize_t VAR_11 = rz_list_length(VAR_0->upvalue_entries);\n\tif (VAR_11 > 0) {\n\t\tLuaDbgUpvalueEntry *VAR_12;\n\t\tVAR_5 = RZ_NEWS0(char *, VAR_11);\n\t\tif (!VAR_5) {\n\t\t\tfree(VAR_4);\n\t\t\treturn;\n\t\t}\n\n\t\tVAR_7 = 0;\n\t\trz_list_foreach (VAR_0->dbg_upvalue_entries, VAR_6, VAR_12) {\n\t\t\tVAR_5[VAR_7] = (char *)VAR_12->upvalue_name;\n\t\t\tluac_add_string(\n\t\t\t\tVAR_1->string_list,\n\t\t\t\tVAR_5[VAR_7],\n\t\t\t\tVAR_12->offset,\n\t\t\t\tVAR_12->name_len);\n\t\t\tVAR_7++;\n\t\t}\n\t}\n\n\t/* COMMENT_12 */\n\tLuaConstEntry *VAR_13;\n\trz_list_foreach (VAR_0->const_entries, VAR_6, VAR_13) {\n\t\tVAR_3 = get_constant_symbol_name(VAR_4, VAR_13);\n\t\tluac_add_symbol(\n\t\t\tVAR_1->symbol_list,\n\t\t\tVAR_3,\n\t\t\tVAR_13->offset,\n\t\t\tVAR_13->data_len,\n\t\t\tget_tag_string(VAR_13->tag));\n\t\tif (VAR_13->tag == VAR_14 || VAR_13->tag == VAR_15) {\n\t\t\tluac_add_string(\n\t\t\t\tVAR_1->string_list,\n\t\t\t\t(char *)VAR_13->data,\n\t\t\t\tVAR_13->offset,\n\t\t\t\tVAR_13->data_len);\n\t\t}\n\t\tRZ_FREE(VAR_3);\n\t}\n\n\t/* COMMENT_13 */\n\tLuaUpvalueEntry *VAR_16;\n\tVAR_7 = 0;\n\trz_list_foreach (VAR_0->upvalue_entries, VAR_6, VAR_16) {\n\t\tVAR_3 = get_upvalue_symbol_name(VAR_4, VAR_16, VAR_5[VAR_7++]);\n\t\tluac_add_symbol(\n\t\t\tVAR_1->symbol_list,\n\t\t\tVAR_3,\n\t\t\tVAR_16->offset,\n\t\t\t3,\n\t\t\t\"UPVALUE\");\n\t\tRZ_FREE(VAR_3);\n\t}\n\n\t/* COMMENT_14 */\n\tLuaProto *VAR_17;\n\trz_list_foreach (VAR_0->proto_entries, VAR_6, VAR_17) {\n\t\t_luac_build_info(VAR_17, VAR_1);\n\t}\n\n\tfree(VAR_5);\n\tfree(VAR_4);\n}",
  "func_graph_path": "rizinorg/rizin/05bbd147caccc60162d6fba9baaaf24befa281cd/luac_bin.c/vul/after/1.json",
  "diff_func": "--- func_before\n+++ func_after\n@@ -3,12 +3,12 @@\n \tchar *section_name;\n \tchar *symbol_name;\n \tchar *proto_name;\n+\tchar **upvalue_names = NULL;\n \tRzListIter *iter;\n+\tint i = 0; // iter\n \n \tut64 current_offset;\n \tut64 current_size;\n-\n-\tint i = 0; // iter\n \n \t// 0. check if stripped (proto name is lost)\n \tif (proto->name_size == 0 || proto->proto_name == NULL) {\n@@ -71,21 +71,25 @@\n \t}\n \n \t// 2.2 parse debug_upvalues\n-\tchar **upvalue_names;\n-\tint real_upvalue_cnt;\n-\tLuaDbgUpvalueEntry *debug_upv_entry;\n-\treal_upvalue_cnt = rz_list_length(proto->upvalue_entries);\n-\tupvalue_names = RZ_NEWS0(char *, real_upvalue_cnt);\n-\tif (!upvalue_names) {\n-\t\treturn;\n-\t}\n-\trz_list_foreach (proto->dbg_upvalue_entries, iter, debug_upv_entry) {\n-\t\tupvalue_names[i] = (char *)debug_upv_entry->upvalue_name;\n-\t\tluac_add_string(\n-\t\t\tinfo->string_list,\n-\t\t\tupvalue_names[i],\n-\t\t\tdebug_upv_entry->offset,\n-\t\t\tdebug_upv_entry->name_len);\n+\tsize_t real_upvalue_cnt = rz_list_length(proto->upvalue_entries);\n+\tif (real_upvalue_cnt > 0) {\n+\t\tLuaDbgUpvalueEntry *debug_upv_entry;\n+\t\tupvalue_names = RZ_NEWS0(char *, real_upvalue_cnt);\n+\t\tif (!upvalue_names) {\n+\t\t\tfree(proto_name);\n+\t\t\treturn;\n+\t\t}\n+\n+\t\ti = 0;\n+\t\trz_list_foreach (proto->dbg_upvalue_entries, iter, debug_upv_entry) {\n+\t\t\tupvalue_names[i] = (char *)debug_upv_entry->upvalue_name;\n+\t\t\tluac_add_string(\n+\t\t\t\tinfo->string_list,\n+\t\t\t\tupvalue_names[i],\n+\t\t\t\tdebug_upv_entry->offset,\n+\t\t\t\tdebug_upv_entry->name_len);\n+\t\t\ti++;\n+\t\t}\n \t}\n \n \t// 3.1 construct constant symbols\n@@ -128,5 +132,6 @@\n \t\t_luac_build_info(sub_proto, info);\n \t}\n \n-\tRZ_FREE(proto_name);\n+\tfree(upvalue_names);\n+\tfree(proto_name);\n }",
  "diff_line_info": {
    "deleted_lines": [
      "",
      "\tint i = 0; // iter",
      "\tchar **upvalue_names;",
      "\tint real_upvalue_cnt;",
      "\tLuaDbgUpvalueEntry *debug_upv_entry;",
      "\treal_upvalue_cnt = rz_list_length(proto->upvalue_entries);",
      "\tupvalue_names = RZ_NEWS0(char *, real_upvalue_cnt);",
      "\tif (!upvalue_names) {",
      "\t\treturn;",
      "\t}",
      "\trz_list_foreach (proto->dbg_upvalue_entries, iter, debug_upv_entry) {",
      "\t\tupvalue_names[i] = (char *)debug_upv_entry->upvalue_name;",
      "\t\tluac_add_string(",
      "\t\t\tinfo->string_list,",
      "\t\t\tupvalue_names[i],",
      "\t\t\tdebug_upv_entry->offset,",
      "\t\t\tdebug_upv_entry->name_len);",
      "\tRZ_FREE(proto_name);"
    ],
    "added_lines": [
      "\tchar **upvalue_names = NULL;",
      "\tint i = 0; // iter",
      "\tsize_t real_upvalue_cnt = rz_list_length(proto->upvalue_entries);",
      "\tif (real_upvalue_cnt > 0) {",
      "\t\tLuaDbgUpvalueEntry *debug_upv_entry;",
      "\t\tupvalue_names = RZ_NEWS0(char *, real_upvalue_cnt);",
      "\t\tif (!upvalue_names) {",
      "\t\t\tfree(proto_name);",
      "\t\t\treturn;",
      "\t\t}",
      "",
      "\t\ti = 0;",
      "\t\trz_list_foreach (proto->dbg_upvalue_entries, iter, debug_upv_entry) {",
      "\t\t\tupvalue_names[i] = (char *)debug_upv_entry->upvalue_name;",
      "\t\t\tluac_add_string(",
      "\t\t\t\tinfo->string_list,",
      "\t\t\t\tupvalue_names[i],",
      "\t\t\t\tdebug_upv_entry->offset,",
      "\t\t\t\tdebug_upv_entry->name_len);",
      "\t\t\ti++;",
      "\t\t}",
      "\tfree(upvalue_names);",
      "\tfree(proto_name);"
    ]
  },
  "is_vul": true,
  "pr_url": "https://github.com/rizinorg/rizin/pull/2930",
  "description": {
    "pr_info": {
      "title": "Fix vulnerabilities on several components",
      "number": 2930
    },
    "comment": [
      "# DO NOT SQUASH\r\n\r\n**Your checklist for this pull request**\r\n- [ ] I've read the [guidelines for contributing](https://github.com/rizinorg/rizin/blob/master/DEVELOPERS.md) to this repository\r\n- [ ] I made sure to follow the project's [coding style](https://github.com/rizinorg/rizin/blob/master/DEVELOPERS.md#code-style)\r\n- [ ] I've documented or updated the documentation of every function and struct this PR changes. If not so I've explained why.\r\n- [ ] I've added tests that prove my fix is effective or that my feature works (if possible)\r\n- [ ] I've updated the [rizin book](https://github.com/rizinorg/book) with the relevant information (if needed)\r\n\r\n**Detailed description**\r\n\r\n<!-- Explain the **details** for making this change. Is a new feature implemented? What existing problem does the pull request solve? How does the pull request solve these issues? Please provide enough information so that others can review your pull request. -->\r\n\r\n...\r\n\r\n**Test plan**\r\n\r\n<!-- What steps should the reviewer take to test your pull request? Demonstrate the code is solid. Example: The exact commands you ran and their output, screenshots/videos. This is your time to re-check that everything works and that you covered all the edge cases -->\r\n\r\n...\r\n\r\n**Closing issues**\r\n\r\n<!-- put \"closes #XXXX\" in your comment to auto-close the issue that your PR fixes (if any). -->\r\n\r\n...\r\n",
      "To be cherry-picked for 0.4.1"
    ]
  },
  "Bug Filter": "Security Vulnerability Fix",
  "Bug Filter Confidence": 0.95,
  "Bug Filter Response": "**Final Classification:** Security Vulnerability Fix  \n**Confidence:** 0.95"
}