{
  "cve_id": "CVE-2019-1010279",
  "cwe_ids": [
    "CWE-347"
  ],
  "cvss_vector": "AV:N/AC:L/Au:N/C:N/I:N/A:P",
  "cvss_is_v3": false,
  "repo_name": "OISF/suricata",
  "commit_msg": "stream: fix false negative on bad RST\n\nIf a bad RST was received the stream inspection would not happen\nfor that packet, but it would still move the 'raw progress' tracker\nforward. Following good packets would then fail to detect anything\nbefore the 'raw progress' position.\n\nBug #2770\n\nReported-by: Alexey Vishnyakov",
  "commit_hash": "d8634daf74c882356659addb65fb142b738a186b",
  "git_url": "https://github.com/OISF/suricata/commit/d8634daf74c882356659addb65fb142b738a186b",
  "file_path": "src/detect.c",
  "func_name": "DetectRunCleanup",
  "func_before": "static void DetectRunCleanup(DetectEngineThreadCtx *det_ctx,\n        Packet *p, Flow * const pflow)\n{\n    PACKET_PROFILING_DETECT_START(p, PROF_DETECT_CLEANUP);\n    /* cleanup pkt specific part of the patternmatcher */\n    PacketPatternCleanup(det_ctx);\n\n    if (pflow != NULL) {\n        /* update inspected tracker for raw reassembly */\n        if (p->proto == IPPROTO_TCP && pflow->protoctx != NULL) {\n            StreamReassembleRawUpdateProgress(pflow->protoctx, p,\n                    det_ctx->raw_stream_progress);\n\n            DetectEngineCleanHCBDBuffers(det_ctx);\n        }\n    }\n    PACKET_PROFILING_DETECT_END(p, PROF_DETECT_CLEANUP);\n    SCReturn;\n}",
  "abstract_func_before": "static void DetectRunCleanup(DetectEngineThreadCtx *VAR_0,\n        Packet *VAR_1, Flow * const VAR_2)\n{\n    PACKET_PROFILING_DETECT_START(VAR_1, VAR_3);\n    /* COMMENT_0 */\n    PacketPatternCleanup(VAR_0);\n\n    if (VAR_2 != NULL) {\n        /* COMMENT_1 */\n        if (VAR_1->proto == VAR_4 && VAR_2->protoctx != NULL) {\n            StreamReassembleRawUpdateProgress(VAR_2->protoctx, VAR_1,\n                    VAR_0->raw_stream_progress);\n\n            DetectEngineCleanHCBDBuffers(VAR_0);\n        }\n    }\n    PACKET_PROFILING_DETECT_END(VAR_1, VAR_3);\n    VAR_5;\n}",
  "func_graph_path_before": "OISF/suricata/d8634daf74c882356659addb65fb142b738a186b/detect.c/vul/before/0.json",
  "func": "static void DetectRunCleanup(DetectEngineThreadCtx *det_ctx,\n        Packet *p, Flow * const pflow)\n{\n    PACKET_PROFILING_DETECT_START(p, PROF_DETECT_CLEANUP);\n    /* cleanup pkt specific part of the patternmatcher */\n    PacketPatternCleanup(det_ctx);\n\n    if (pflow != NULL) {\n        /* update inspected tracker for raw reassembly */\n        if (p->proto == IPPROTO_TCP && pflow->protoctx != NULL &&\n            (p->flags & PKT_STREAM_EST))\n        {\n            StreamReassembleRawUpdateProgress(pflow->protoctx, p,\n                    det_ctx->raw_stream_progress);\n\n            DetectEngineCleanHCBDBuffers(det_ctx);\n        }\n    }\n    PACKET_PROFILING_DETECT_END(p, PROF_DETECT_CLEANUP);\n    SCReturn;\n}",
  "abstract_func": "static void DetectRunCleanup(DetectEngineThreadCtx *VAR_0,\n        Packet *VAR_1, Flow * const VAR_2)\n{\n    PACKET_PROFILING_DETECT_START(VAR_1, VAR_3);\n    /* COMMENT_0 */\n    PacketPatternCleanup(VAR_0);\n\n    if (VAR_2 != NULL) {\n        /* COMMENT_1 */\n        if (VAR_1->proto == VAR_4 && VAR_2->protoctx != NULL &&\n            (VAR_1->flags & VAR_5))\n        {\n            StreamReassembleRawUpdateProgress(VAR_2->protoctx, VAR_1,\n                    VAR_0->raw_stream_progress);\n\n            DetectEngineCleanHCBDBuffers(VAR_0);\n        }\n    }\n    PACKET_PROFILING_DETECT_END(VAR_1, VAR_3);\n    VAR_6;\n}",
  "func_graph_path": "OISF/suricata/d8634daf74c882356659addb65fb142b738a186b/detect.c/vul/after/0.json",
  "diff_func": "--- func_before\n+++ func_after\n@@ -7,7 +7,9 @@\n \n     if (pflow != NULL) {\n         /* update inspected tracker for raw reassembly */\n-        if (p->proto == IPPROTO_TCP && pflow->protoctx != NULL) {\n+        if (p->proto == IPPROTO_TCP && pflow->protoctx != NULL &&\n+            (p->flags & PKT_STREAM_EST))\n+        {\n             StreamReassembleRawUpdateProgress(pflow->protoctx, p,\n                     det_ctx->raw_stream_progress);\n ",
  "diff_line_info": {
    "deleted_lines": [
      "        if (p->proto == IPPROTO_TCP && pflow->protoctx != NULL) {"
    ],
    "added_lines": [
      "        if (p->proto == IPPROTO_TCP && pflow->protoctx != NULL &&",
      "            (p->flags & PKT_STREAM_EST))",
      "        {"
    ]
  },
  "is_vul": true,
  "pr_url": "https://github.com/OISF/suricata/pull/3625",
  "description": {
    "pr_info": {
      "title": "Next/20190124/v4",
      "number": 3625
    },
    "comment": [
      "Most intrusive here is the eve.stats decoder events handling to fix ticket 2225. In existing setups it should keep behaving unchanged, although it will show warnings.\r\n\r\nFor new setups using the shipped yaml, the decoder events prefix in the logs will be 'decoder.event' (e.g. decoder.event.ipv6.unknown_next_header).\r\n\r\nWarnings are added to indicate that in 5.0 this will become the overall default.\r\n\r\ncc: @satta\r\n\r\n\r\nLink to [redmine](https://redmine.openinfosecfoundation.org/projects/suricata/issues) ticket:\r\nhttps://redmine.openinfosecfoundation.org/issues/2225\r\nhttps://redmine.openinfosecfoundation.org/issues/2770\r\n\r\nDescribe changes:\r\n- fix stream issue\r\n- add gre over ipv6 support\r\n- fix eve.stats decoder events\r\n- #3599\r\n\r\n[PRScript](https://redmine.openinfosecfoundation.org/projects/suricata/wiki/PRscript) output (if applicable):\r\n- PR victorjulien-pcap: https://buildbot.openinfosecfoundation.org/builders/victorjulien-pcap/builds/216\r\n- PR victorjulien: https://buildbot.openinfosecfoundation.org/builders/victorjulien/builds/218\r\n\r\n",
      "On a first quick look, I don't like seeing the configuration option being in the config and not just in the documentation.  But I suppose that is to keep 4.1.x releases behaving the same?  And we could remove it in 5.0 and just have it in the documentation?",
      "This is how a full run on a busy box looks like in terms of stats. Seems the formatting is off in some places due to the longer names.\r\n\r\n```\r\n\r\n------------------------------------------------------------------------------------\r\nDate: 1/29/2019 -- 08:40:59 (uptime: 0d, 15h 19m 52s)\r\n------------------------------------------------------------------------------------\r\nCounter                                    | TM Name                   | Value\r\n------------------------------------------------------------------------------------\r\ncapture.kernel_packets                     | Total                     | 79119493860\r\ncapture.kernel_drops                       | Total                     | 3211114510\r\ndecoder.pkts                               | Total                     | 75907750281\r\ndecoder.bytes                              | Total                     | 78172804309131\r\ndecoder.invalid                            | Total                     | 36417\r\ndecoder.ipv4                               | Total                     | 69251153090\r\ndecoder.ipv6                               | Total                     | 8947627648\r\ndecoder.ethernet                           | Total                     | 75907750819\r\ndecoder.tcp                                | Total                     | 67763375493\r\ndecoder.udp                                | Total                     | 7623328894\r\ndecoder.icmpv4                             | Total                     | 179169959\r\ndecoder.icmpv6                             | Total                     | 6883013\r\ndecoder.ppp                                | Total                     | 7402598\r\ndecoder.gre                                | Total                     | 2322737532\r\ndecoder.vlan                               | Total                     | 75907728499\r\ndecoder.teredo                             | Total                     | 332253\r\ndecoder.ipv4_in_ipv6                       | Total                     | 76489004\r\ndecoder.avg_pkt_size                       | Total                     | 1029\r\ndecoder.max_pkt_size                       | Total                     | 1514\r\nflow.tcp                                   | Total                     | 1782157180\r\nflow.udp                                   | Total                     | 195786196\r\nflow.icmpv4                                | Total                     | 10048524\r\nflow.icmpv6                                | Total                     | 642933\r\ndefrag.ipv4.fragments                      | Total                     | 35136634\r\ndefrag.ipv4.reassembled                    | Total                     | 17390072\r\ndefrag.ipv6.fragments                      | Total                     | 771399\r\ndefrag.ipv6.reassembled                    | Total                     | 368553\r\ndecoder.event.ipv4.opt_pad_required        | Total                     | 1839\r\ndecoder.event.icmpv4.pkt_too_small         | Total                     | 5\r\ndecoder.event.icmpv4.unknown_type          | Total                     | 3795\r\ndecoder.event.icmpv4.unknown_code          | Total                     | 278\r\ndecoder.event.icmpv4.ipv4_trunc_pkt        | Total                     | 1\r\ndecoder.event.icmpv4.ipv4_unknown_ver      | Total                     | 1515\r\ndecoder.event.icmpv6.unknown_code          | Total                     | 1\r\ndecoder.event.icmpv6.unassigned_type       | Total                     | 4\r\ndecoder.event.ipv6.exthdr_useless_fh       | Total                     | 1752\r\ndecoder.event.ipv6.zero_len_padn           | Total                     | 1000\r\ndecoder.event.ipv6.fh_non_zero_reserved_field | Total                     | 5\r\ndecoder.event.ipv6.data_after_none_header  | Total                     | 225312\r\ndecoder.event.ipv6.unknown_next_header     | Total                     | 10791\r\ndecoder.event.ipv6.icmpv4                  | Total                     | 16\r\ndecoder.event.tcp.hlen_too_small           | Total                     | 25450\r\ndecoder.event.tcp.invalid_optlen           | Total                     | 2637\r\ndecoder.event.tcp.opt_invalid_len          | Total                     | 11211\r\ndecoder.event.tcp.opt_duplicate            | Total                     | 113\r\ndecoder.event.udp.pkt_too_small            | Total                     | 255\r\ndecoder.event.udp.hlen_invalid             | Total                     | 88\r\ndecoder.event.ppp.wrong_type               | Total                     | 7035179\r\ndecoder.event.ppp.unsup_proto              | Total                     | 29236\r\ndecoder.event.gre.version0_recur           | Total                     | 12153\r\ndecoder.event.gre.version0_flags           | Total                     | 17251300\r\ndecoder.event.ipv4.frag_overlap            | Total                     | 1500\r\ndecoder.event.ipv6.frag_overlap            | Total                     | 1\r\ndecoder.event.ipv6.ipv4_in_ipv6_wrong_version | Total                     | 4\r\ndecoder.event.ipv6.ipv6_in_ipv6_wrong_version | Total                     | 2\r\nstream.3whs_right_seq_wrong_ack_evasion    | Total                     | 36166\r\nstream.3whs_synack_in_wrong_direction      | Total                     | 2384\r\nstream.3whs_synack_resend_with_diff_ack    | Total                     | 1035\r\nstream.3whs_synack_toserver_on_syn_recv    | Total                     | 3356\r\nstream.3whs_synack_with_wrong_ack          | Total                     | 130658\r\nstream.3whs_synack_flood                   | Total                     | 2524\r\nstream.3whs_syn_resend_diff_seq_on_syn_recv | Total                     | 129862\r\nstream.3whs_syn_toclient_on_syn_recv       | Total                     | 281\r\nstream.3whs_wrong_seq_wrong_ack            | Total                     | 17196055\r\nstream.4whs_synack_with_wrong_ack          | Total                     | 1\r\nstream.4whs_synack_with_wrong_syn          | Total                     | 18\r\nstream.4whs_wrong_seq                      | Total                     | 2040\r\nstream.4whs_invalid_ack                    | Total                     | 136\r\nstream.closewait_ack_out_of_window         | Total                     | 3077199\r\nstream.closewait_fin_out_of_window         | Total                     | 68808\r\nstream.closewait_pkt_before_last_ack       | Total                     | 1647391\r\nstream.closewait_invalid_ack               | Total                     | 1309036\r\nstream.est_packet_out_of_window            | Total                     | 882206646\r\nstream.est_pkt_before_last_ack             | Total                     | 136932248\r\nstream.est_synack_resend                   | Total                     | 31871\r\nstream.est_synack_resend_with_diff_ack     | Total                     | 10329\r\nstream.est_synack_resend_with_diff_seq     | Total                     | 10055\r\nstream.est_synack_toserver                 | Total                     | 1493\r\nstream.est_syn_resend                      | Total                     | 8864\r\nstream.est_syn_resend_diff_seq             | Total                     | 131976\r\nstream.est_syn_toclient                    | Total                     | 11\r\nstream.est_invalid_ack                     | Total                     | 467681659\r\nstream.fin_invalid_ack                     | Total                     | 127970\r\nstream.fin1_ack_wrong_seq                  | Total                     | 8942\r\nstream.fin1_fin_wrong_seq                  | Total                     | 8362\r\nstream.fin1_invalid_ack                    | Total                     | 5265\r\nstream.fin2_ack_wrong_seq                  | Total                     | 485461\r\nstream.fin2_fin_wrong_seq                  | Total                     | 1623\r\nstream.fin2_invalid_ack                    | Total                     | 286331\r\nstream.fin_but_no_session                  | Total                     | 76381514\r\nstream.fin_out_of_window                   | Total                     | 111499\r\nstream.lastack_ack_wrong_seq               | Total                     | 886\r\nstream.lastack_invalid_ack                 | Total                     | 52377\r\nstream.rst_but_no_session                  | Total                     | 29082495\r\nstream.timewait_ack_wrong_seq              | Total                     | 25238\r\nstream.timewait_invalid_ack                | Total                     | 814\r\nstream.shutdown_syn_resend                 | Total                     | 59708\r\nstream.pkt_invalid_timestamp               | Total                     | 3421946\r\nstream.pkt_invalid_ack                     | Total                     | 469620368\r\nstream.pkt_broken_ack                      | Total                     | 9498484\r\nstream.rst_invalid_ack                     | Total                     | 156688\r\nstream.pkt_retransmission                  | Total                     | 3428533\r\nstream.pkt_bad_window_update               | Total                     | 9126811\r\nstream.suspected_rst_inject                | Total                     | 18383\r\nstream.wrong_thread                        | Total                     | 865\r\nstream.reassembly_segment_before_base_seq  | Total                     | 22\r\nstream.reassembly_seq_gap                  | Total                     | 2927797\r\ntcp.sessions                               | Total                     | 1555726345\r\ntcp.pseudo                                 | Total                     | 1228288\r\ntcp.syn                                    | Total                     | 1583408745\r\ntcp.synack                                 | Total                     | 199060539\r\ntcp.rst                                    | Total                     | 185144369\r\ntcp.pkt_on_wrong_thread                    | Total                     | 22570\r\ntcp.stream_depth_reached                   | Total                     | 2167458\r\ntcp.reassembly_gap                         | Total                     | 2927797\r\ntcp.overlap                                | Total                     | 4263044726\r\ntcp.insert_list_fail                       | Total                     | 22\r\ndetect.alert                               | Total                     | 84337387\r\napp_layer.flow.http                        | Total                     | 15691004\r\napp_layer.tx.http                          | Total                     | 34999943\r\napp_layer.flow.ftp                         | Total                     | 124497\r\napp_layer.flow.smtp                        | Total                     | 2056613\r\napp_layer.tx.smtp                          | Total                     | 2098124\r\napp_layer.flow.tls                         | Total                     | 74524249\r\napp_layer.flow.ssh                         | Total                     | 4013008\r\napp_layer.flow.imap                        | Total                     | 2789\r\napp_layer.flow.smb                         | Total                     | 5074\r\napp_layer.tx.smb                           | Total                     | 276048\r\napp_layer.flow.dcerpc_tcp                  | Total                     | 63909\r\napp_layer.flow.dns_tcp                     | Total                     | 548679\r\napp_layer.tx.dns_tcp                       | Total                     | 1106397\r\napp_layer.flow.nfs_tcp                     | Total                     | 46\r\napp_layer.tx.nfs_tcp                       | Total                     | 766\r\napp_layer.flow.ntp                         | Total                     | 3885831\r\napp_layer.flow.ftp-data                    | Total                     | 100710\r\napp_layer.flow.tftp                        | Total                     | 756878\r\napp_layer.flow.ikev2                       | Total                     | 27310\r\napp_layer.flow.krb5_tcp                    | Total                     | 9447\r\napp_layer.tx.krb5_tcp                      | Total                     | 9438\r\napp_layer.flow.dhcp                        | Total                     | 4758\r\napp_layer.flow.failed_tcp                  | Total                     | 9282345\r\napp_layer.flow.dcerpc_udp                  | Total                     | 5149\r\napp_layer.flow.dns_udp                     | Total                     | 76726664\r\napp_layer.tx.dns_udp                       | Total                     | 157830585\r\napp_layer.tx.ntp                           | Total                     | 5695357\r\napp_layer.tx.tftp                          | Total                     | 789898\r\napp_layer.tx.ikev2                         | Total                     | 141563\r\napp_layer.flow.krb5_udp                    | Total                     | 52457\r\napp_layer.tx.krb5_udp                      | Total                     | 2141\r\napp_layer.tx.dhcp                          | Total                     | 70648\r\napp_layer.flow.failed_udp                  | Total                     | 114327149\r\nflow_mgr.closed_pruned                     | Total                     | 102732712\r\nflow_mgr.new_pruned                        | Total                     | 1761810999\r\nflow_mgr.est_pruned                        | Total                     | 119362206\r\nflow_mgr.bypassed_pruned                   | Total                     | 3863694\r\nflow.spare                                 | Total                     | 80084619\r\nflow.tcp_reuse                             | Total                     | 217654\r\nflow_mgr.flows_checked                     | Total                     | 103183\r\nflow_mgr.flows_notimeout                   | Total                     | 67836\r\nflow_mgr.flows_timeout                     | Total                     | 35347\r\nflow_mgr.flows_timeout_inuse               | Total                     | 3411\r\nflow_mgr.flows_removed                     | Total                     | 31936\r\nflow_mgr.rows_checked                      | Total                     | 16388608\r\nflow_mgr.rows_skipped                      | Total                     | 16258536\r\nflow_mgr.rows_empty                        | Total                     | 31742\r\nflow_mgr.rows_maxlen                       | Total                     | 14\r\nflow_bypassed.closed                       | Total                     | 7699532\r\nflow_bypassed.pkts                         | Total                     | 806673539\r\nflow_bypassed.bytes                        | Total                     | 813537302112\r\ntcp.memuse                                 | Total                     | 2240053144\r\ntcp.reassembly_memuse                      | Total                     | 1490446704\r\nhttp.memuse                                | Total                     | 239080478\r\nftp.memuse                                 | Total                     | 6919359\r\napp_layer.expectations                     | Total                     | 1956\r\nflow.memuse                                | Total                     | 7562635000\r\n\r\n```",
      "Merged this with a doc update and a fix for the stats.log layout. Thanks @jasonish @pevma "
    ]
  },
  "Bug Filter": "Defect Remediation & Feature Upgrades",
  "Bug Filter Confidence": 0.8,
  "Bug Filter Response": "**Final Classification:** Defect Remediation & Feature Upgrades  \n**Confidence:** 0.8\n\n**Step-by-Step Explanation:**\n\n1. **Input Analysis:** The commit message indicates a bug fix regarding stream inspection not occurring after a bad RST packet. The code diff modifies the function to correctly update progress under specific conditions, without security-related changes.\n\n2. **Consistency Check:** The commit message and code changes align, focusing on stream handling rather than security.\n\n3. **Purpose Evaluation:** The changes address a bug in stream inspection, part of core functionality, not related to testing or documentation.\n\n4. **Security Assessment:** No evidence of a security vulnerability; the fix doesn't address any security risks or known CVEs.\n\n5. **Classification:** The patch is a bug fix in the core logic, fitting into Defect Remediation & Feature Upgrades.\n\n6. **Confidence Scoring:** High confidence as the intent and changes are clear, though no CVEs are referenced, leading to a 0.8 score."
}